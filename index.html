<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- Google Analytics 4 数据统计 -->
    <!-- 步骤：1.打开 https://analytics.google.com 注册 2.创建媒体资源 3.把G-8BF63PNVGD替换为你的测量ID -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8BF63PNVGD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-8BF63PNVGD');
    </script>
    <!-- 分享卡片 Open Graph -->
    <meta property="og:title" content="盛兴崑给你拜年：过节别忘记喝水">
    <meta property="og:description" content="🐴 新春饮水，福寿绵长。点开领取马年祝福，还能一键转发给朋友拜年💧">
    <meta property="og:image" content="https://ericjbe.github.io/water-reminder/share-card.png">
    <meta property="og:url" content="https://ericjbe.github.io/water-reminder/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="喝水了吗 · 马年祝福">
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="盛兴崑给你拜年：过节别忘记喝水">
    <meta name="twitter:description" content="🐴 新春饮水，福寿绵长。点开领取马年祝福，转发给朋友拜年💧">
    <meta name="twitter:image" content="https://ericjbe.github.io/water-reminder/share-card.png">
    <!-- 微信分享 -->
    <meta itemprop="name" content="盛兴崑给你拜年：过节别忘记喝水">
    <meta itemprop="description" content="点开收专属祝福，还能一键转发给朋友">
    <meta itemprop="image" content="https://ericjbe.github.io/water-reminder/share-card.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="pageTitle">喝水了吗 | 长寿百岁，别忘喝水</title>
    
    <!-- PWA 配置 -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="喝水了吗">
    <meta name="application-name" content="喝水了吗">
    <meta name="theme-color" content="#0a192f">
    <meta name="description" content="喝水了吗？智能喝水提醒，每天八杯水，健康一整年。水学知识+滴答时钟+语音助手，水若善出品。">
    <meta property="og:description" content="上善若水，分秒必争。每天八杯水，做自己的健康管理师。语音问水学，AI来回答。">
    <meta property="og:type" content="website">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230a192f' width='100' height='100' rx='20'/><text x='50' y='68' font-size='55' text-anchor='middle'>💧</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2300d4ff' width='100' height='100' rx='20'/><text x='50' y='68' font-size='55' text-anchor='middle'>💧</text></svg>">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi5Zad5rC05LqG5ZCXIiwic2hvcnRfbmFtZSI6IuWWneawtOS6huWQlyIsImRlc2NyaXB0aW9uIjoi5pm66IO95Zad5rC05o+Q6YaSIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBhMTkyZiIsInRoZW1lX2NvbG9yIjoiIzAwZDRmZiIsInN0YXJ0X3VybCI6Ii4iLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLDxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCc+PHJlY3QgZmlsbD0nJTIzMDBkNGZmJyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCcgcng9JzIwJy8+PHRleHQgeD0nNTAnIHk9JzY4JyBmb250LXNpemU9JzU1JyB0ZXh0LWFuY2hvcj0nbWlkZGxlJz7wn5KnPC90ZXh0Pjwvc3ZnPiIsInNpemVzIjoiYW55IiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJwdXJwb3NlIjoiYW55IG1hc2thYmxlIn1dfQ==">
    
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        :root { --primary: #00d4ff; --accent: #ff006e; --gold: #ffd700; --success: #06ffa5; --bg1: #0a192f; --bg2: #112240; --water: #00bcd4; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, 'Noto Sans SC', sans-serif; color: #fff; min-height: 100vh; background: linear-gradient(135deg, var(--bg1), var(--bg2)); }

        .top-bar { position: fixed; top: 0; left: 0; right: 0; background: rgba(10,25,47,0.95); padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo { font-size: 18px; font-weight: bold; }
        .logo span { background: linear-gradient(90deg, var(--primary), var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .top-right { display: flex; gap: 6px; align-items: center; }
        .top-btn { background: rgba(255,255,255,0.1); border: none; padding: 5px 10px; border-radius: 15px; color: white; font-size: 11px; cursor: pointer; }
        .lang-select { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; color: white; font-size: 10px; cursor: pointer; }

        .ad-bar { position: fixed; top: 42px; left: 0; right: 0; height: 52px; overflow: hidden; z-index: 99; }
        .ad-bar::before { content:''; position:absolute; top:0; left:0; right:0; bottom:0; background: linear-gradient(90deg, #006994, #0077b6, #00b4d8, #48cae4, #0096c7, #023e8a); background-size: 300% 100%; animation: waterColorShift 12s ease infinite; z-index:0; }
        .ad-bar::after { content:''; position:absolute; bottom:0; left:-100%; width:300%; height:100%; background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 60'%3E%3Cpath d='M0 30 Q150 10 300 30 T600 30 T900 30 T1200 30 V60 H0 Z' fill='rgba(255,255,255,0.06)'/%3E%3Cpath d='M0 35 Q150 20 300 35 T600 35 T900 35 T1200 35 V60 H0 Z' fill='rgba(255,255,255,0.04)'/%3E%3C/svg%3E") repeat-x; background-size: 600px 100%; animation: waterWave 4s linear infinite; z-index:1; pointer-events:none; }
        @keyframes waterColorShift { 0%{background-position:0% 50%} 33%{background-position:50% 50%} 66%{background-position:100% 50%} 100%{background-position:0% 50%} }
        @keyframes waterWave { 0%{transform:translateX(0)} 100%{transform:translateX(600px)} }
        .ad-container { position:relative; z-index:2; height:100%; }
        .ad-slide { position:absolute; top:0; left:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; gap:8px; padding:3px 12px; opacity:0; transform:translateX(100%); }
        .ad-slide.active { opacity:1; animation: adRiver 3s linear forwards; }
        .ad-slide.exit { animation: adRiverOut 3s linear forwards; }
        @keyframes adRiver {
            0%   { opacity:0; transform:translateX(80%); }
            10%  { opacity:0.6; transform:translateX(60%); }
            33%  { opacity:1; transform:translateX(30%); }
            66%  { opacity:1; transform:translateX(0%); }
            100% { opacity:1; transform:translateX(0%); }
        }
        @keyframes adRiverOut {
            0%   { opacity:1; transform:translateX(0%); }
            33%  { opacity:0.7; transform:translateX(-30%); }
            66%  { opacity:0.3; transform:translateX(-60%); }
            100% { opacity:0; transform:translateX(-100%); }
        }
        .ad-slide .ad-text { font-size:13px; color:#fff; text-shadow:0 1px 3px rgba(0,0,0,0.3); font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:70vw; }
        .ad-slide .ad-img { max-height:42px; max-width:35vw; object-fit:contain; border-radius:4px; flex-shrink:0; }
        .ad-slide .ad-vid { max-height:42px; max-width:35vw; object-fit:contain; border-radius:4px; flex-shrink:0; }
        .ad-slide .ad-mixed { display:flex; align-items:center; gap:8px; max-width:95vw; overflow:hidden; }
        .ad-dots { position:absolute; bottom:2px; left:50%; transform:translateX(-50%); display:flex; gap:3px; z-index:3; }
        .ad-dot { width:4px; height:4px; border-radius:50%; background:rgba(255,255,255,0.3); transition:all .3s; }
        .ad-dot.active { width:12px; border-radius:2px; background:rgba(255,255,255,0.8); }

        .main { padding: 102px 12px 70px; }

        .culture-card { position: relative; border-radius: 14px; padding: 16px; overflow: hidden; margin-bottom: 12px; }
        .culture-bg { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-size: cover; background-position: center; filter: brightness(0.35); }
        .culture-content { position: relative; z-index: 1; }
        .culture-label { font-size: 10px; color: var(--gold); margin-bottom: 6px; }
        .culture-text { font-size: 14px; line-height: 1.8; }
        .culture-source { font-size: 10px; color: rgba(255,255,255,0.5); text-align: right; margin-top: 6px; }
        .culture-actions { display: flex; gap: 6px; margin-top: 10px; }
        .culture-btn { flex: 1; padding: 6px; background: rgba(255,255,255,0.15); border: none; border-radius: 15px; color: white; font-size: 10px; cursor: pointer; }

        .checkin-bar { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: linear-gradient(90deg, rgba(255,215,0,0.08), rgba(6,255,165,0.08)); border-radius: 10px; margin-bottom: 15px; }
        .checkin-info { display: flex; align-items: center; gap: 12px; }
        .checkin-streak { font-size: 11px; }
        .checkin-streak strong { color: var(--gold); font-size: 16px; }
        .checkin-points { font-size: 10px; color: var(--success); }
        .checkin-btn { padding: 6px 14px; background: linear-gradient(135deg, var(--gold), #ff8c00); border: none; border-radius: 15px; color: #000; font-size: 11px; font-weight: bold; cursor: pointer; }
        .checkin-btn.done { background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.5); }

        .clock-unit { background: rgba(0,0,0,0.25); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); padding: 20px 15px; }
        .clock-area { display: flex; flex-direction: column; align-items: center; }

        .clock-face { position: relative; width: 240px; height: 240px; border-radius: 50%; border: 5px solid var(--primary); box-shadow: 0 0 40px rgba(0,212,255,0.3), inset 0 0 30px rgba(0,0,0,0.5); background: radial-gradient(circle, rgba(10,25,47,0.8), rgba(0,0,0,0.9)); margin-bottom: 15px; }
        .tick { position: absolute; left: 50%; top: 8px; width: 2px; height: 10px; background: rgba(255,255,255,0.4); transform-origin: 0 112px; }
        .tick.major { width: 3px; height: 15px; background: var(--gold); transform-origin: 0 109px; }
        .clock-num { position: absolute; font-size: 15px; font-weight: bold; color: var(--gold); }
        .clock-num.n12 { top: 18px; left: 50%; transform: translateX(-50%); }
        .clock-num.n3 { right: 16px; top: 50%; transform: translateY(-50%); }
        .clock-num.n6 { bottom: 18px; left: 50%; transform: translateX(-50%); }
        .clock-num.n9 { left: 16px; top: 50%; transform: translateY(-50%); }

        .clock-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 110px; height: 110px; border-radius: 50%; background: rgba(0,20,40,0.9); border: 2px solid rgba(255,255,255,0.15); overflow: hidden; cursor: pointer; z-index: 5; display: flex; align-items: center; justify-content: center; }
        .center-content { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; }
        .center-content img, .center-content video { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .center-text { font-size: 10px; line-height: 1.4; padding: 8px; color: rgba(255,255,255,0.85); }
        .center-placeholder { font-size: 9px; color: rgba(255,255,255,0.4); }

        .hand { position: absolute; left: 50%; bottom: 50%; transform-origin: 50% 100%; border-radius: 4px; z-index: 10; }
        .hand-hour { width: 5px; height: 45px; margin-left: -2.5px; background: linear-gradient(to top, var(--primary), #fff); box-shadow: 0 0 10px var(--primary); }
        .hand-minute { width: 4px; height: 65px; margin-left: -2px; background: linear-gradient(to top, #8338ec, #fff); box-shadow: 0 0 8px #8338ec; }
        .hand-second { width: 2px; height: 85px; margin-left: -1px; background: var(--accent); box-shadow: 0 0 15px var(--accent); }
        .hand-dot { position: absolute; width: 12px; height: 12px; background: var(--gold); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 20px var(--gold); z-index: 15; }

        .digital-box { text-align: center; margin-bottom: 12px; }
        .digital-time { font-size: 38px; font-weight: bold; font-family: 'Courier New', monospace; color: var(--primary); text-shadow: 0 0 25px rgba(0,212,255,0.6); letter-spacing: 2px; }
        .digital-time .colon { animation: blink 1s infinite; }
        @keyframes blink { 0%,100%{opacity:1}50%{opacity:0.3} }
        .digital-date { font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 5px; }
        .slogan { font-size: 10px; color: rgba(255,255,255,0.4); margin-top: 4px; font-style: italic; }

        .tick-bar { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 6px 14px; background: rgba(255,255,255,0.05); border-radius: 18px; cursor: pointer; margin-bottom: 15px; }
        .tick-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); animation: pulse 1s infinite; }
        .tick-dot.off { background: #555; animation: none; }
        @keyframes pulse { 0%,100%{opacity:1}50%{opacity:.3} }

        .func-row { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .func-btn { display: flex; flex-direction: column; align-items: center; padding: 10px 14px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; color: white; cursor: pointer; min-width: 55px; }
        .func-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.15); }
        .func-btn .icon { font-size: 22px; }
        .func-btn .label { font-size: 9px; margin-top: 3px; color: rgba(255,255,255,0.7); }
        .func-btn.voice { background: linear-gradient(135deg, var(--primary), #8338ec); border: none; }

        .remind-section { margin-top: 5px; }
        .remind-title { font-size: 12px; color: var(--gold); margin-bottom: 8px; }
        .remind-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,107,157,0.1); border: 1px solid rgba(255,107,157,0.2); border-radius: 10px; margin-bottom: 6px; cursor: pointer; }
        .remind-item .emoji { font-size: 20px; }
        .remind-item .info { flex: 1; }
        .remind-item .title { font-size: 12px; font-weight: 500; }
        .remind-item .datetime { font-size: 10px; color: var(--gold); margin-top: 2px; font-family: monospace; }
        .remind-item .countdown { font-size: 10px; color: var(--success); font-weight: bold; }

        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10,25,47,0.98); border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; padding: 6px 0 10px; z-index: 100; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; padding: 4px 8px; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn .icon { font-size: 18px; }
        .nav-btn .label { font-size: 8px; margin-top: 2px; }

        .panel-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 199; display: none; }
        .panel-overlay.show { display: block; }
        .panel { position: fixed; top: 0; right: -100%; width: 92%; max-width: 380px; height: 100%; background: linear-gradient(180deg, rgba(10,25,47,0.98), rgba(17,34,64,0.98)); z-index: 200; transition: right 0.3s; overflow-y: auto; padding: 50px 15px 30px; }
        .panel.open { right: 0; }
        .panel-close { position: absolute; top: 12px; right: 15px; background: none; border: none; color: white; font-size: 26px; cursor: pointer; }
        .panel-title { font-size: 16px; color: var(--gold); margin-bottom: 15px; }

        .item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 6px; cursor: pointer; }
        .item:active { background: rgba(255,255,255,0.1); }
        .item .icon { font-size: 18px; }
        .item .info { flex: 1; }
        .item .name { font-size: 12px; }
        .item .desc { font-size: 9px; color: rgba(255,255,255,0.5); margin-top: 2px; }
        .section-title { font-size: 12px; color: var(--gold); margin: 15px 0 8px; }
        .divider { height: 1px; background: rgba(255,255,255,0.1); margin: 12px 0; }
        .form-group { margin-bottom: 8px; }
        .form-group label { display: block; font-size: 10px; color: rgba(255,255,255,0.6); margin-bottom: 3px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px 10px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-size: 12px; }
        .btn { padding: 10px 16px; border: none; border-radius: 10px; font-size: 12px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #8338ec); color: white; }
        .btn-gold { background: linear-gradient(135deg, var(--gold), #ff8c00); color: #000; }
        .btn-outline { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-danger { background: var(--accent); color: white; }

        .datetime-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 8px; }
        .datetime-input { text-align: center; }
        .datetime-input label { font-size: 9px; display: block; margin-bottom: 2px; }
        .datetime-input input { text-align: center; padding: 6px 4px; font-size: 14px; font-weight: bold; }

        .detail-time-box { background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); border-radius: 10px; padding: 12px; text-align: center; margin-bottom: 12px; }
        .detail-time-big { font-size: 20px; font-weight: bold; color: var(--gold); font-family: monospace; line-height: 1.5; }
        .detail-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 11px; }

        .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .theme-item { aspect-ratio: 1; border-radius: 8px; cursor: pointer; border: 2px solid transparent; }
        .theme-item.active { border-color: white; }
        .theme-item.classic { background: linear-gradient(135deg, #00d4ff, #8338ec); }
        .theme-item.luxury { background: linear-gradient(135deg, #ffd700, #ff8c00); }
        .theme-item.nature { background: linear-gradient(135deg, #06ffa5, #00d4ff); }
        .theme-item.romantic { background: linear-gradient(135deg, #ff6b9d, #8338ec); }

        .sound-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 5px; cursor: pointer; font-size: 11px; }
        .sound-item.active { border-color: var(--gold); background: rgba(255,215,0,0.1); }

        .ad-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 10px; margin-bottom: 8px; }
        .ad-card .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .ad-card .type-badge { font-size: 9px; padding: 2px 6px; border-radius: 8px; }
        .ad-card .type-badge.text { background: #667eea; }
        .ad-card .type-badge.image { background: #06ffa5; color: #000; }
        .ad-card .type-badge.video { background: #ff006e; }
        .ad-card .type-badge.link { background: #ffd700; color: #000; }
        .ad-card .preview { font-size: 11px; color: rgba(255,255,255,0.7); word-break: break-all; }
        .ad-card .preview img { max-width: 100%; max-height: 60px; border-radius: 6px; margin-top: 4px; }

        .contact-auth-box { background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(131,56,236,0.1)); border: 1px solid rgba(0,212,255,0.3); border-radius: 14px; padding: 18px; text-align: center; margin-bottom: 12px; }
        .contact-auth-box .icon { font-size: 36px; margin-bottom: 8px; }
        .contact-auth-box .title { font-size: 13px; font-weight: bold; margin-bottom: 6px; }
        .contact-auth-box .desc { font-size: 10px; color: rgba(255,255,255,0.6); margin-bottom: 12px; line-height: 1.5; }

        .contact-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 6px; }
        .contact-item .avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }
        .contact-item .info { flex: 1; }
        .contact-item .name { font-size: 12px; font-weight: 500; }
        .contact-item .phone { font-size: 9px; color: rgba(255,255,255,0.5); }
        .contact-item .add-btn { padding: 5px 10px; background: var(--gold); border: none; border-radius: 12px; color: #000; font-size: 9px; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .contact-item .add-btn:disabled { background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.5); cursor: default; }
        .contact-item.added .add-btn { background: rgba(6,255,165,0.3); color: var(--success); }

        /* 管理员登录框 */
        .admin-login-box { background: rgba(255,0,0,0.1); border: 1px solid rgba(255,0,0,0.3); border-radius: 12px; padding: 15px; margin-bottom: 12px; }
        .admin-login-box .title { font-size: 12px; color: var(--accent); margin-bottom: 10px; text-align: center; }
        .admin-locked { text-align: center; padding: 20px; color: rgba(255,255,255,0.5); font-size: 11px; }

        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.92); z-index: 300; justify-content: center; align-items: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-box { background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid var(--primary); border-radius: 16px; padding: 20px; max-width: 340px; width: 100%; max-height: 85vh; overflow-y: auto; }
        .modal-title { font-size: 14px; color: var(--gold); margin-bottom: 12px; text-align: center; }
        .toast { position: fixed; top: 90px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.95); border: 1px solid var(--primary); padding: 10px 20px; border-radius: 20px; z-index: 1000; font-size: 12px; }

        /* 水学面板样式 */
        .water-tabs { display: flex; gap: 6px; margin-bottom: 12px; overflow-x: auto; padding-bottom: 4px; }
        .water-tab { padding: 6px 12px; background: rgba(0,0,0,0.2); border: 1px solid transparent; border-radius: 20px; font-size: 11px; color: rgba(255,255,255,0.7); cursor: pointer; white-space: nowrap; }
        .water-tab.active { background: rgba(0,188,212,0.3); border-color: var(--water); color: var(--water); }
        .water-lesson { background: rgba(0,188,212,0.08); border: 1px solid rgba(0,188,212,0.2); border-radius: 12px; padding: 14px; margin-bottom: 10px; }
        .water-lesson .title { font-size: 13px; color: var(--gold); margin-bottom: 6px; font-weight: bold; }
        .water-lesson .text { font-size: 12px; line-height: 1.8; color: rgba(255,255,255,0.85); }
        .water-lesson .source { font-size: 9px; color: rgba(255,255,255,0.4); text-align: right; margin-top: 6px; }
        .water-controls { display: flex; gap: 6px; margin-bottom: 14px; }
        .water-controls button { flex: 1; padding: 8px; background: rgba(0,188,212,0.15); border: 1px solid rgba(0,188,212,0.3); border-radius: 8px; color: var(--water); font-size: 11px; cursor: pointer; }

        /* 苏格拉底对话 */
        .socratic-box { background: linear-gradient(135deg, rgba(255,215,0,0.08), rgba(0,188,212,0.08)); border: 2px solid rgba(255,215,0,0.3); border-radius: 14px; padding: 15px; margin-top: 10px; }
        .socratic-title { font-size: 13px; color: var(--gold); font-weight: bold; margin-bottom: 10px; }
        .socratic-chat { max-height: 300px; overflow-y: auto; margin-bottom: 10px; }
        .chat-bubble { padding: 10px 12px; border-radius: 12px; margin-bottom: 8px; font-size: 12px; line-height: 1.7; animation: fadeIn 0.3s; }
        .chat-bubble.master { background: rgba(0,188,212,0.15); border-left: 3px solid var(--water); margin-right: 30px; }
        .chat-bubble.student { background: rgba(255,215,0,0.1); border-right: 3px solid var(--gold); margin-left: 30px; text-align: right; }
        .chat-bubble .role { font-size: 9px; color: var(--gold); margin-bottom: 4px; font-weight: bold; }
        .socratic-options { display: flex; flex-direction: column; gap: 6px; }
        .socratic-opt { padding: 10px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; color: white; font-size: 11px; cursor: pointer; text-align: left; transition: all 0.2s; }
        .socratic-opt:hover { background: rgba(0,188,212,0.2); border-color: var(--water); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* 语音浮球 - 隐藏，入口改为功能区按钮 */
        .voice-fab { display: none !important; }
        .voice-status { position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); border: 1px solid var(--primary); border-radius: 20px; padding: 8px 16px; font-size: 11px; max-width: 280px; z-index: 200; display: none; text-align: center; }
        .voice-status.show { display: block; }

        /* 💧 喝水提醒核心功能 */
        .water-remind-box { background: linear-gradient(135deg, rgba(0,188,212,0.15), rgba(0,150,200,0.1)); border: 2px solid rgba(0,188,212,0.4); border-radius: 16px; padding: 15px; margin: 12px 0; }
        .water-remind-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .water-title { font-size: 14px; font-weight: bold; color: var(--water); }
        .water-goal { font-size: 11px; color: rgba(255,255,255,0.6); }
        .water-progress-bar { height: 12px; background: rgba(0,0,0,0.3); border-radius: 6px; overflow: hidden; margin-bottom: 8px; }
        .water-progress-fill { height: 100%; background: linear-gradient(90deg, #00bcd4, #00e5ff, #4dd0e1); border-radius: 6px; transition: width 0.5s ease; box-shadow: 0 0 10px rgba(0,188,212,0.5); }
        .water-stats { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .water-current { font-size: 24px; font-weight: bold; color: white; }
        .water-current span { color: var(--water); }
        .water-percent { font-size: 16px; color: var(--gold); font-weight: bold; }
        .water-buttons { display: flex; gap: 8px; margin-bottom: 12px; }
        .water-btn { border: none; border-radius: 20px; padding: 8px 12px; font-size: 11px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .water-btn.small { background: rgba(255,255,255,0.1); color: white; flex: 1; }
        .water-btn.small:active { background: rgba(0,188,212,0.3); }
        .water-btn.primary { background: linear-gradient(135deg, #00bcd4, #0097a7); color: white; flex: 2; }
        .water-btn.primary:active { transform: scale(0.95); }
        .water-schedule { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        .schedule-item { font-size: 9px; padding: 4px 8px; background: rgba(255,255,255,0.08); border-radius: 12px; color: rgba(255,255,255,0.5); }
        .schedule-item.done { background: rgba(6,255,165,0.2); color: var(--success); }
        .schedule-item.active { background: rgba(0,188,212,0.3); color: var(--water); animation: pulse 1.5s infinite; border: 1px solid var(--water); }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* 会员体系样式 */
        .membership-box { background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,140,0,0.1)); border: 2px solid rgba(255,215,0,0.3); border-radius: 16px; padding: 15px; margin: 10px 0; }
        .membership-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .membership-level { font-size: 14px; font-weight: bold; }
        .membership-level.free { color: rgba(255,255,255,0.6); }
        .membership-level.vip { color: var(--gold); }
        .membership-level.enterprise { color: #ff6b6b; }
        .membership-limits { font-size: 10px; color: rgba(255,255,255,0.5); margin-bottom: 12px; line-height: 1.6; }
        .membership-plans { display: flex; flex-direction: column; gap: 8px; }
        .plan-btn { padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .plan-btn:hover { background: rgba(255,215,0,0.1); border-color: var(--gold); }
        .plan-btn .plan-name { font-size: 12px; font-weight: bold; }
        .plan-btn .plan-price { font-size: 14px; color: var(--gold); font-weight: bold; }

        /* 支付弹窗 */
        .pay-modal-bg { position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px; }
        .pay-modal-bg.show { display:flex; }
        .pay-modal { background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:20px;padding:20px;max-width:360px;width:100%;max-height:90vh;overflow-y:auto;border:1px solid rgba(255,215,0,0.3);box-shadow:0 20px 60px rgba(0,0,0,0.5); }
        .pay-header { text-align:center;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:15px; }
        .pay-plan-name { font-size:18px;font-weight:bold;color:var(--gold);margin-bottom:4px; }
        .pay-plan-price { font-size:28px;font-weight:bold;color:#ff6b6b;margin-bottom:4px; }
        .pay-plan-desc { font-size:11px;color:rgba(255,255,255,0.5); }
        .pay-methods { margin-bottom:15px; }
        .pay-method-btn { display:flex;align-items:center;gap:12px;padding:14px;border:2px solid rgba(255,255,255,0.1);border-radius:12px;margin-bottom:8px;cursor:pointer;transition:all 0.3s; }
        .pay-method-btn:hover,.pay-method-btn.active { border-color:var(--gold);background:rgba(255,215,0,0.08); }
        .pay-method-icon { font-size:28px; }
        .pay-method-name { font-size:14px;font-weight:bold;color:white; }
        .pay-method-desc { font-size:10px;color:rgba(255,255,255,0.4); }
        .pay-qr-area { text-align:center;padding:15px;background:rgba(255,255,255,0.05);border-radius:12px;margin-bottom:15px;display:none; }
        .pay-qr-area.show { display:block; }
        .pay-qr-placeholder { width:200px;height:200px;background:white;border-radius:12px;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:14px;color:#333; }
        .pay-qr-tip { font-size:11px;color:rgba(255,255,255,0.6);line-height:1.6; }
        .pay-confirm-area { display:none;text-align:center; }
        .pay-confirm-area.show { display:block; }
        .pay-order-id { font-size:10px;color:rgba(255,255,255,0.4);margin-top:10px; }

        .plan-btn.recommended { background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,140,0,0.15)); border-color: var(--gold); }
        .plan-btn.recommended::after { content: '推荐'; font-size: 9px; background: var(--gold); color: #000; padding: 2px 6px; border-radius: 8px; margin-left: 8px; }

        /* PWA 安装提示样式 */
        .pwa-banner { display: none; position: fixed; bottom: 55px; left: 8px; right: 8px; background: linear-gradient(135deg, var(--primary), #8338ec); padding: 12px; border-radius: 12px; z-index: 150; box-shadow: 0 4px 20px rgba(0,212,255,0.4); animation: pwaSlide 0.4s ease; }
        .pwa-banner.show { display: block; }
        @keyframes pwaSlide { from { transform: translateY(80px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .pwa-banner-inner { display: flex; align-items: center; gap: 10px; }
        .pwa-banner-icon { font-size: 28px; }
        .pwa-banner-text { flex: 1; }
        .pwa-banner-title { font-size: 12px; font-weight: bold; }
        .pwa-banner-desc { font-size: 10px; opacity: 0.85; margin-top: 2px; }
        .pwa-banner-btn { background: white; color: #8338ec; border: none; padding: 8px 14px; border-radius: 16px; font-size: 11px; font-weight: bold; cursor: pointer; }
        .pwa-banner-close { position: absolute; top: 4px; right: 8px; background: none; border: none; color: white; font-size: 16px; cursor: pointer; opacity: 0.7; }
        .pwa-guide { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 400; justify-content: center; align-items: center; padding: 15px; }
        .pwa-guide.show { display: flex; }
        .pwa-guide-box { background: linear-gradient(135deg, var(--bg1), var(--bg2)); border: 2px solid var(--primary); border-radius: 16px; padding: 20px; max-width: 320px; width: 100%; }
        .pwa-guide-header { text-align: center; margin-bottom: 15px; }
        .pwa-guide-header .icon { font-size: 40px; }
        .pwa-guide-header .title { font-size: 16px; font-weight: bold; color: var(--gold); margin-top: 8px; }
        .pwa-guide-header .desc { font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; }
        .pwa-guide-steps { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 12px; margin-bottom: 15px; }
        .pwa-guide-step { display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 11px; line-height: 1.5; }
        .pwa-guide-step:last-child { border-bottom: none; }
        .pwa-step-num { background: var(--primary); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; flex-shrink: 0; }
        .pwa-guide-btn { width: 100%; padding: 10px; background: linear-gradient(135deg, var(--primary), #8338ec); border: none; border-radius: 20px; color: white; font-size: 13px; font-weight: bold; cursor: pointer; }
        .pwa-wechat-tip { background: rgba(255,215,0,0.15); border: 1px solid rgba(255,215,0,0.4); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 10px; color: var(--gold); line-height: 1.5; display: none; }
    </style>
</head>
<body>
    <!-- PWA 安装提示 -->
    <div class="pwa-banner" id="pwaBanner">
        <button class="pwa-banner-close" onclick="closePwaBanner()">×</button>
        <div class="pwa-banner-inner">
            <div class="pwa-banner-icon">💧</div>
            <div class="pwa-banner-text">
                <div class="pwa-banner-title">添加到桌面</div>
                <div class="pwa-banner-desc">像APP一样使用，一键打开</div>
            </div>
            <button class="pwa-banner-btn" onclick="handlePwaInstall()">添加</button>
        </div>
    </div>
    <div class="pwa-guide" id="pwaGuide">
        <div class="pwa-guide-box">
            <div class="pwa-guide-header">
                <div class="icon">📱</div>
                <div class="title">添加到主屏幕</div>
                <div class="desc">3步完成，像APP一样使用</div>
            </div>
            <div class="pwa-wechat-tip" id="pwaWechatTip">⚠️ 当前在微信内，请点击右上角 ··· 选择「在浏览器打开」</div>
            <div class="pwa-guide-steps" id="pwaSteps"></div>
            <button class="pwa-guide-btn" onclick="closePwaGuide()">我知道了</button>
        </div>
    </div>

    <div class="top-bar">
        <div class="logo">💧 <span data-i18n="appName">喝水了吗</span></div>
        <div class="top-right">
            <select class="lang-select" id="langSelect" onchange="changeLang(this.value)">
                <option value="zh">中文</option>
                <option value="en">English</option>
                <option value="es">Español</option>
                <option value="ar">العربية</option>
                <option value="he">עברית</option>
                <option value="ja">日本語</option>
                <option value="ko">한국어</option>
            </select>
            <button class="top-btn" onclick="openPanel('promoPanel')" data-i18n="promo">共享</button>
            <button class="top-btn" id="userBtn" onclick="openPanel('memberPanel')" data-i18n="login">登录</button>
        </div>
    </div>

    <div class="ad-bar"><div class="ad-container" id="adContainer"></div><div class="ad-dots" id="adDots"></div></div>

    <div class="main">
        <div class="culture-card">
            <div class="culture-bg" id="cultureBg"></div>
            <div class="culture-content">
                <div class="culture-label">💧 <span data-i18n="dailyWisdom">每日水语</span> · <span id="cultureDate"></span></div>
                <div class="culture-text" id="cultureText"></div>
                <div class="culture-source" id="cultureSource"></div>
                <div class="culture-actions">
                    <button class="culture-btn" onclick="copyCulture()" data-i18n="copy">复制</button>
                    <button class="culture-btn" onclick="refreshCulture()" data-i18n="refresh">换一条</button>
                </div>
            </div>
        </div>

        <div class="checkin-bar">
            <div class="checkin-info">
                <div class="checkin-streak"><span data-i18n="streak">连续</span> <strong id="streakDays">0</strong> <span data-i18n="days">天</span></div>
                <div class="checkin-points"><span data-i18n="points">积分</span>: <span id="totalPoints">0</span></div>
            </div>
            <button class="checkin-btn" id="checkinBtn" onclick="doCheckin()">✅ <span data-i18n="checkin">打卡</span>+10</button>
        </div>

        <div class="clock-unit">
            <div class="clock-area">
                <div class="clock-face" id="clockFace">
                    <div id="ticks"></div>
                    <div class="clock-num n12">12</div>
                    <div class="clock-num n3">3</div>
                    <div class="clock-num n6">6</div>
                    <div class="clock-num n9">9</div>
                    <div class="clock-center" onclick="openPanel('centerPanel')">
                        <div class="center-content" id="centerContent">
                            <div class="center-placeholder" data-i18n="clickToAdd">点击添加<br>图片/视频/文字</div>
                        </div>
                    </div>
                    <div class="hand hand-hour" id="hHour"></div>
                    <div class="hand hand-minute" id="hMin"></div>
                    <div class="hand hand-second" id="hSec"></div>
                    <div class="hand-dot"></div>
                </div>

                <div class="digital-box">
                    <div class="digital-time">
                        <span id="dH">00</span><span class="colon">:</span><span id="dM">00</span><span class="colon">:</span><span id="dS">00</span>
                    </div>
                    <div class="digital-date" id="digitalDate"></div>
                    <div class="slogan" data-i18n="slogan">「一万年太久，分秒必争」</div>
                </div>

                <div class="tick-bar" onclick="openPanel('settingsPanel')">
                    <div class="tick-dot" id="tickDot"></div>
                    <span style="font-size:11px;" data-i18n="tickSound">滴答声</span>
                    <span style="font-size:10px;color:var(--gold);" id="tickSoundName">经典钟声</span>
                </div>

                <!-- 💧 喝水提醒核心功能区 -->
                <div class="water-remind-box">
                    <div class="water-remind-header">
                        <span class="water-title">💧 今日饮水</span>
                        <span class="water-goal" id="waterGoalText">目标 2000ml</span>
                    </div>
                    <div class="water-progress-bar">
                        <div class="water-progress-fill" id="waterProgressFill" style="width:0%"></div>
                    </div>
                    <div class="water-stats">
                        <span class="water-current"><span id="waterCurrent">0</span> ml</span>
                        <span class="water-percent" id="waterPercent">0%</span>
                    </div>
                    <div class="water-buttons">
                        <button class="water-btn small" onclick="drinkWater(100)">+100ml</button>
                        <button class="water-btn small" onclick="drinkWater(200)">+200ml</button>
                        <button class="water-btn primary" onclick="drinkWater(250)">🥤 喝一杯 250ml</button>
                    </div>
                    <div class="water-schedule" id="waterSchedule">
                        <span class="schedule-item done">☀️ 7:00</span>
                        <span class="schedule-item done">🌤️ 9:00</span>
                        <span class="schedule-item active">☀️ 11:00</span>
                        <span class="schedule-item">🍚 13:00</span>
                        <span class="schedule-item">🌤️ 15:00</span>
                        <span class="schedule-item">🌅 17:00</span>
                        <span class="schedule-item">🌙 19:00</span>
                        <span class="schedule-item">😴 21:00</span>
                    </div>
                </div>

                <div class="func-row">
                    <div class="func-btn" onclick="openPanel('classicsPanel')"><div class="icon">📖</div><div class="label" data-i18n="classics">经典</div></div>
                    <div class="func-btn" onclick="openPanel('waterPanel')"><div class="icon">💧</div><div class="label" data-i18n="waterStudy">水学</div></div>
                    <div class="func-btn voice" onclick="toggleVoice()"><div class="icon">🎤</div><div class="label" data-i18n="voice">语音</div></div>
                    <div class="func-btn" onclick="openPanel('carePanel')"><div class="icon">💝</div><div class="label" data-i18n="care">关怀</div></div>
                    <div class="func-btn" onclick="openPanel('settingsPanel')"><div class="icon">⚙️</div><div class="label" data-i18n="settings">设置</div></div>
                </div>
            </div>

            <div class="remind-section">
                <div class="remind-title">🔔 <span data-i18n="upcomingReminders">即将到来的提醒</span></div>
                <div id="upcomingReminds"></div>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <button class="nav-btn active"><span class="icon">🏠</span><span class="label" data-i18n="home">首页</span></button>
        <button class="nav-btn" onclick="openPanel('promoPanel')"><span class="icon">📣</span><span class="label" data-i18n="promo">共享</span></button>
        <button class="nav-btn" onclick="openPanel('settingsPanel')"><span class="icon">⏰</span><span class="label" data-i18n="remind">提醒</span></button>
        <button class="nav-btn" onclick="openPanel('pointsPanel')"><span class="icon">🎁</span><span class="label" data-i18n="points">积分</span></button>
        <button class="nav-btn" onclick="openPanel('memberPanel')"><span class="icon">👤</span><span class="label" data-i18n="me">我的</span></button>
    </div>

    <!-- 语音浮球「智回」 -->
    <div class="voice-fab" id="voiceFab" onclick="toggleVoiceRecognition()">
        🎤
        <div class="voice-label">说「智回」</div>
    </div>
    <div class="voice-status" id="voiceStatus">🎤 等待唤醒词「智回」...</div>

    <div class="panel-overlay" id="overlay" onclick="closeAllPanels()"></div>

    <!-- 设置面板 -->
    <div class="panel" id="settingsPanel">
        <button class="panel-close" onclick="closeAllPanels()">×</button>
        <div class="panel-title">⚙️ <span data-i18n="settings">设置</span></div>

        <div class="section-title">⏰ <span data-i18n="reminderManagement">提醒管理</span></div>
        <button class="btn btn-gold" style="margin-bottom:10px;" onclick="openModal('addRemindModal')">➕ <span data-i18n="newReminder">新建提醒</span></button>
        <div id="remindList"></div>

        <div class="divider"></div>

        <div class="section-title">🔊 <span data-i18n="soundSettings">滴答声设置</span></div>
        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px;background:rgba(255,255,255,0.05);border-radius:10px;margin-bottom:10px;">
            <span style="font-size:12px;" data-i18n="tickSwitch">滴答声开关</span>
            <div style="width:44px;height:24px;background:rgba(255,255,255,0.2);border-radius:12px;position:relative;cursor:pointer;" id="tickSwitch" onclick="toggleTick()">
                <div style="width:20px;height:20px;background:white;border-radius:50%;position:absolute;top:2px;transition:0.3s;" id="tickKnob"></div>
            </div>
        </div>
        <div id="soundList"></div>
        <div class="section-title">🔈 <span data-i18n="volume">音量</span></div>
        <input type="range" id="volumeSlider" min="0" max="100" value="50" style="width:100%;" onchange="setVolume(this.value)">

        <div class="divider"></div>

        <div class="section-title">🎨 <span data-i18n="theme">主题风格</span></div>
        <div class="theme-grid">
            <div class="theme-item classic active" onclick="setTheme('classic')"></div>
            <div class="theme-item luxury" onclick="setTheme('luxury')"></div>
            <div class="theme-item nature" onclick="setTheme('nature')"></div>
            <div class="theme-item romantic" onclick="setTheme('romantic')"></div>
        </div>

        <div class="divider"></div>

        <!-- 管理员广告设置 -->
        <div class="section-title">📢 <span data-i18n="adManagement">广告管理</span> <span style="font-size:9px;color:var(--accent);">(管理员)</span></div>
        
        <div id="adminAdSection">
            <div class="admin-login-box" id="adminLoginBox">
                <div class="title">🔐 <span data-i18n="adminLogin">管理员登录</span></div>
                <div class="form-group">
                    <input type="password" id="adminPwd" placeholder="输入管理员密码">
                </div>
                <button class="btn btn-danger" onclick="adminLogin()" data-i18n="verify">验证</button>
            </div>
            
            <div id="adminAdContent" style="display:none;">
                <div id="ordersContainer"></div>
                <button class="btn btn-gold" style="width:100%;margin-bottom:10px;font-size:13px;" onclick="showOrdersPanel()">💰 刷新订单管理</button>
                <div class="divider"></div>
                <div id="autoSendContainer"></div>
                <button class="btn btn-outline" style="width:100%;margin-bottom:10px;font-size:13px;border-color:rgba(255,152,0,0.4);color:#ff9800;" onclick="showAutoSendPanel()">🤖 自动祝福系统</button>
                <div class="divider"></div>
                <div id="activityLogContainer"></div>
                <button class="btn btn-outline" style="width:100%;margin-bottom:10px;font-size:13px;" onclick="showActivityLog()">📋 活动日志</button>
                <div class="divider"></div>
                <div id="statsContainer"></div>
                <button class="btn btn-primary" style="width:100%;margin-bottom:10px;font-size:13px;" onclick="showStatsPanel()">📊 刷新数据看板</button>
                <script>setTimeout(function(){if(document.getElementById("adminAdContent").style.display!=="none")showStatsPanel();},100);</script>
                <div class="divider"></div>
                <div id="adList"></div>
                <button class="btn btn-outline" style="margin-bottom:8px;" onclick="openModal('addAdModal')">➕ <span data-i18n="addAd">添加新广告</span></button>
                <button class="btn btn-outline" onclick="adminLogout()" style="font-size:10px;" data-i18n="adminLogout">退出管理</button>
            </div>
        </div>
    </div>

    <!-- 钟表中心面板 -->
    <div class="panel" id="centerPanel">
        <button class="panel-close" onclick="closeAllPanels()">×</button>
        <div class="panel-title">🎨 <span data-i18n="customizeCenter">自定义钟表中心</span></div>
        
        <div class="section-title">📷 <span data-i18n="uploadImage">上传图片</span></div>
        <div style="border:2px dashed rgba(255,255,255,0.2);border-radius:10px;padding:20px;text-align:center;cursor:pointer;margin-bottom:12px;" onclick="document.getElementById('imgUpload').click()">
            <div style="font-size:28px;">🖼️</div>
            <div style="font-size:10px;color:rgba(255,255,255,0.5);" data-i18n="clickUpload">点击上传</div>
        </div>
        <input type="file" id="imgUpload" accept="image/*" style="display:none" onchange="uploadImage(this)">

        <div class="section-title">🎬 <span data-i18n="uploadVideo">上传视频</span></div>
        <div style="border:2px dashed rgba(255,255,255,0.2);border-radius:10px;padding:20px;text-align:center;cursor:pointer;margin-bottom:12px;" onclick="document.getElementById('vidUpload').click()">
            <div style="font-size:28px;">🎬</div>
            <div style="font-size:10px;color:rgba(255,255,255,0.5);" data-i18n="clickUpload">点击上传</div>
        </div>
        <input type="file" id="vidUpload" accept="video/*" style="display:none" onchange="uploadVideo(this)">

        <div class="section-title">✍️ <span data-i18n="customText">自定义文字</span></div>
        <div class="form-group"><textarea id="centerText" rows="3" placeholder="输入文字..."></textarea></div>
        <button class="btn btn-primary" onclick="setCenterText()" data-i18n="apply">应用</button>
        <div class="divider"></div>
        <button class="btn btn-outline" onclick="resetCenter()" data-i18n="resetDefault">恢复默认</button>
    </div>

    <!-- 关怀面板 -->
    <div class="panel" id="carePanel">
        <button class="panel-close" onclick="closeAllPanels()">×</button>
        <div class="panel-title">💝 <span data-i18n="smartCare">智能关怀</span></div>

        <!-- 未授权时显示 -->
        <div class="contact-auth-box" id="contactAuthBox">
            <div class="icon">📱</div>
            <div class="title" data-i18n="readContacts">读取通讯录</div>
            <div class="desc" data-i18n="contactsDesc">授权后可从手机通讯录中选择联系人，设置生日、纪念日等关怀提醒。仅Android Chrome支持直接读取，其他浏览器可手动添加。</div>
            <button class="btn btn-gold" onclick="requestContactsPermission()">📇 <span data-i18n="authorizeContacts">授权读取通讯录</span></button>
            <div style="margin-top:8px;">
                <button class="btn btn-outline" style="font-size:11px;" onclick="showManualContactEntry()">✏️ 跳过，手动添加</button>
            </div>
        </div>

        <!-- 已授权后显示搜索框+通讯录列表 -->
        <div id="contactSearchBox" style="display:none;">
            <div class="section-title">🔍 <span data-i18n="findCarePerson">查找被关怀人</span></div>
            <div style="position:relative;margin-bottom:12px;">
                <input type="text" id="careSearchInput" placeholder="输入姓名查找..." oninput="searchCarePerson(this.value)" style="width:100%;padding:12px 15px;padding-left:40px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:12px;color:white;font-size:14px;">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:18px;">🔍</span>
            </div>
            <!-- 搜索结果 -->
            <div id="searchResults" style="max-height:200px;overflow-y:auto;"></div>

            <!-- 通讯录完整列表 -->
            <div id="contactsDirectory">
                <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 0 8px;">
                    <span style="font-size:12px;color:var(--water);font-weight:bold;">📇 通讯录 (<span id="contactCount">0</span>人)</span>
                    <div>
                        <button onclick="refreshContacts()" style="background:none;border:1px solid rgba(255,255,255,0.2);border-radius:8px;padding:3px 8px;font-size:9px;color:rgba(255,255,255,0.6);cursor:pointer;margin-right:4px;">🔄 刷新</button>
                        <button onclick="resetContactsAuth()" style="background:none;border:1px solid rgba(255,100,100,0.3);border-radius:8px;padding:3px 8px;font-size:9px;color:rgba(255,100,100,0.6);cursor:pointer;">🗑️ 重置</button>
                    </div>
                </div>
                <div id="contactsList" style="max-height:320px;overflow-y:auto;"></div>
            </div>
        </div>

        <div class="divider"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <span class="section-title" style="margin:0">👥 <span data-i18n="addedFriends">已添加的关怀对象</span></span>
            <button class="btn btn-primary" style="width:auto;padding:5px 10px;font-size:10px;" onclick="openModal('addFriendModal')">+ <span data-i18n="manualAdd">手动添加</span></button>
        </div>
        <div id="friendList"></div>
    </div>

    <!-- 经典面板（原经书，带二级目录） -->
    <div class="panel" id="classicsPanel">
        <button class="panel-close" onclick="closeAllPanels()">×</button>
        <div class="panel-title">📖 <span data-i18n="classics">经典</span></div>

        <div class="water-tabs" id="classicsTabs">
            <div class="water-tab active" onclick="switchClassicsTab('scriptures')">📜 五经</div>
            <div class="water-tab" onclick="switchClassicsTab('philosophy')">🎓 哲学</div>
            <div class="water-tab" onclick="switchClassicsTab('poetry')">📝 诗词</div>
            <div class="water-tab" onclick="switchClassicsTab('wisdom')">💡 智慧</div>
        </div>

        <div id="classicsContent"></div>
    </div>

    <div class="panel" id="waterPanel">
        <button class="panel-close" onclick="closeAllPanels()">×</button>
        <div class="panel-title">💧 <span data-i18n="waterCourse">水学课程</span></div>

        <div class="water-tabs" id="waterTabs">
            <div class="water-tab active" onclick="switchWaterTab('science')">🔬 水科学</div>
            <div class="water-tab" onclick="switchWaterTab('philosophy')">☯️ 水哲学</div>
            <div class="water-tab" onclick="switchWaterTab('health')">💊 水健康</div>
            <div class="water-tab" onclick="switchWaterTab('socratic')">🏛️ 水问答</div>
        </div>

        <!-- 水学二级目录 -->
        <div class="water-submenu" style="display:flex;flex-wrap:wrap;gap:6px;margin:10px 0;padding:10px;background:rgba(0,188,212,0.08);border-radius:12px;">
            <div class="submenu-item" onclick="openWaterSection('institute')" style="flex:1;min-width:45%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(0,188,212,0.3);border-radius:10px;text-align:center;cursor:pointer;">
                <div style="font-size:20px;margin-bottom:4px;">🏛️</div>
                <div style="font-size:11px;font-weight:bold;color:var(--water);">水学研究院</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.5);">学术研究</div>
            </div>
            <div class="submenu-item" onclick="openWaterSection('tech')" style="flex:1;min-width:45%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(0,188,212,0.3);border-radius:10px;text-align:center;cursor:pointer;">
                <div style="font-size:20px;margin-bottom:4px;">🔧</div>
                <div style="font-size:11px;font-weight:bold;color:var(--water);">水科技</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.5);">科技创新</div>
            </div>
            <div class="submenu-item" onclick="openWaterSection('products')" style="flex:1;min-width:45%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(0,188,212,0.3);border-radius:10px;text-align:center;cursor:pointer;">
                <div style="font-size:20px;margin-bottom:4px;">🛒</div>
                <div style="font-size:11px;font-weight:bold;color:var(--water);">水产品</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.5);">健康好物</div>
            </div>
            <div class="submenu-item" onclick="openWaterSection('inventions')" style="flex:1;min-width:45%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(0,188,212,0.3);border-radius:10px;text-align:center;cursor:pointer;">
                <div style="font-size:20px;margin-bottom:4px;">💡</div>
                <div style="font-size:11px;font-weight:bold;color:var(--water);">水发明</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.5);">专利技术</div>
            </div>
        </div>
            <div class="water-tab" onclick="switchWaterTab('health')">💊 水健康</div>
            <div class="water-tab" onclick="switchWaterTab('socratic')">🏛️ 水问答</div>
        </div>

        <div id="waterLessonContent"></div>

        <div class="water-controls">
            <button onclick="prevWaterLesson()">⬅ 上一课</button>
            <button onclick="speakWaterLesson()">🔊 朗读</button>
            <button onclick="nextWaterLesson()">下一课 ➡</button>
        </div>

        <div id="socraticSection" style="display:none;">
            <div class="socratic-box">
                <div class="socratic-title">🏛️ 水的苏格拉底对话</div>
                <div class="socratic-chat" id="socraticChat"></div>
                <div class="socratic-options" id="socraticOptions"></div>
            </div>
        </div>

        <div id="waterList" style="display:none;"></div>
    </div>

    <div class="panel" id="promoPanel">
        <button class="panel-close" onclick="closeAllPanels()">×</button>
        <div class="panel-title">📣 <span data-i18n="promoCenter">共享中心</span></div>
        <div style="text-align:center;padding:16px;background:linear-gradient(135deg,rgba(255,215,0,0.12),rgba(255,0,110,0.08));border-radius:14px;margin-bottom:12px;">
            <div style="font-size:28px;">🐴🧧</div>
            <div style="font-size:16px;font-weight:bold;color:var(--gold);margin:6px 0;">新春快乐 · 喝水了吗？</div>
            <div style="font-size:12px;color:rgba(255,255,255,0.7);">把健康的祝福分享给朋友</div>
        </div>
        <button class="btn btn-gold" style="width:100%;margin-bottom:8px;font-size:14px;" onclick="openPanel('festivalPanel')">🏮 春节祝福馆 · 初一到十五</button>
        <button class="btn" style="width:100%;margin-bottom:8px;font-size:14px;" onclick="shareNewYear()">🧧 分享新年喝水祝福</button>
        <button class="btn" style="width:100%;margin-bottom:12px;" onclick="copyInviteLink()" data-i18n="copyInviteLink">📋 复制邀请链接</button>
        <div style="text-align:center;padding:16px;background:rgba(255,215,0,0.06);border-radius:14px;">
            <div style="font-size:12px;" data-i18n="myInviteCode">我的邀请码</div>
            <div style="font-size:20px;font-weight:bold;color:var(--gold);margin:10px 0;" id="inviteCode">--</div>
            <div id="promoQR" style="background:white;padding:10px;border-radius:10px;display:inline-block;margin:10px 0;"></div>
        </div>
    </div>

    <!-- ═══ 春节祝福馆 · 初一到十五 ═══ -->
    <div class="panel" id="festivalPanel" style="max-height:90vh;overflow-y:auto;">
        <button class="panel-close" onclick="closeAllPanels()">×</button>
        <div class="panel-title">🏮 春节祝福馆</div>
        <div style="text-align:center;margin-bottom:10px;">
            <div style="font-size:12px;color:rgba(255,255,255,0.6);">选择日期 · 个性化定制 · 一键分享</div>
            <div style="margin:8px 0;">
                <input type="text" id="festName" placeholder="输入你的名字/昵称（个性化祝福）" style="width:85%;padding:8px 12px;border-radius:20px;border:1px solid rgba(255,215,0,0.3);background:rgba(255,255,255,0.06);color:#fff;font-size:12px;text-align:center;">
            </div>
        </div>
        <div id="festDayGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;"></div>
    </div>

    <!-- ═══ 贺页全屏浮层 ═══ -->
    <div id="festOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:10000;overflow-y:auto;">
        <div id="festPage" style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px 20px 90px;text-align:center;position:relative;"></div>
        <div style="position:fixed;bottom:0;left:0;right:0;z-index:10001;background:rgba(0,0,0,0.7);backdrop-filter:blur(12px);padding:12px 16px;padding-bottom:max(12px,env(safe-area-inset-bottom));">
            <div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap;">
                <button onclick="festShareTo('wechat')" style="padding:8px 14px;border-radius:16px;border:none;background:#07C160;color:#fff;font-weight:bold;font-size:12px;cursor:pointer;">💬 微信</button>
                <button onclick="festShareTo('sms')" style="padding:8px 14px;border-radius:16px;border:none;background:#4A90D9;color:#fff;font-weight:bold;font-size:12px;cursor:pointer;">📱 短信</button>
                <button onclick="festShareTo('contacts')" style="padding:8px 14px;border-radius:16px;border:none;background:#FF9500;color:#fff;font-weight:bold;font-size:12px;cursor:pointer;">📇 通讯录</button>
                <button onclick="festShareTo('copy')" style="padding:8px 14px;border-radius:16px;border:none;background:rgba(255,215,0,0.9);color:#000;font-weight:bold;font-size:12px;cursor:pointer;">📋 复制</button>
                <button onclick="saveFestPoster()" style="padding:8px 14px;border-radius:16px;border:none;background:rgba(255,255,255,0.2);color:#fff;font-weight:bold;font-size:12px;cursor:pointer;">🖼 保存</button>
                <button onclick="closeFestOverlay()" style="padding:8px 14px;border-radius:16px;border:none;background:rgba(255,255,255,0.1);color:#fff;font-size:12px;cursor:pointer;">✕</button>
            </div>
        </div>
    </div>

    <div class="panel" id="pointsPanel">
        <button class="panel-close" onclick="closeAllPanels()">×</button>
        <div class="panel-title">🎁 <span data-i18n="pointsCenter">积分中心</span></div>
        <div style="text-align:center;padding:20px;background:rgba(255,215,0,0.08);border-radius:14px;margin-bottom:12px;">
            <div style="font-size:10px;color:rgba(255,255,255,0.6);" data-i18n="myPoints">我的积分</div>
            <div style="font-size:32px;font-weight:bold;color:var(--gold);" id="myPoints">0</div>
        </div>
        <div style="background:linear-gradient(135deg,rgba(255,215,0,0.08),rgba(0,212,255,0.06));border:1px solid rgba(255,215,0,0.2);border-radius:14px;padding:14px;margin-bottom:12px;">
            <div style="font-size:13px;font-weight:bold;color:var(--gold);margin-bottom:8px;">🏆 积分规则</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.8);line-height:1.8;">
                📅 每日签到：<span style="color:var(--gold);">+10分</span><br>
                🔥 连续7天签到：<span style="color:var(--gold);">额外+50分</span><br>
                💧 每次喝水打卡：<span style="color:var(--gold);">+5分</span><br>
                📤 分享给好友（对方打开）：<span style="color:var(--gold);">+20分</span><br>
                👤 好友通过你的链接注册：<span style="color:var(--gold);">+100分</span><br>
                📚 完成水学课程1节：<span style="color:var(--gold);">+30分</span><br>
                🎓 完成苏格拉底对话：<span style="color:var(--gold);">+50分</span>
            </div>
        </div>
        <div style="background:rgba(0,212,255,0.06);border:1px solid rgba(0,212,255,0.2);border-radius:14px;padding:14px;margin-bottom:12px;">
            <div style="font-size:13px;font-weight:bold;color:var(--primary);margin-bottom:8px;">🎁 积分兑换</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.8);line-height:1.8;">
                500分 → 解锁更多水学课程<br>
                1000分 → 解锁全部主题风格<br>
                2000分 → 月度VIP体验（7天）<br>
                5000分 → 季度VIP<br>
                10000分 → 年度VIP + 水健康大使认证
            </div>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
            <div style="flex:1;text-align:center;padding:10px;background:rgba(255,215,0,0.06);border-radius:10px;">
                <div style="font-size:18px;font-weight:bold;color:var(--gold);" id="inviteCount">0</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.5);">邀请人数</div>
            </div>
            <div style="flex:1;text-align:center;padding:10px;background:rgba(6,255,165,0.06);border-radius:10px;">
                <div style="font-size:18px;font-weight:bold;color:var(--success);" id="promoPoints">0</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.5);">共享积分</div>
            </div>
        </div>
        <div class="section-title">📅 <span data-i18n="monthlyCheckin">本月打卡</span></div>
        <div id="checkinCalendar" style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;"></div>
    </div>

    <div class="panel" id="memberPanel">
        <button class="panel-close" onclick="closeAllPanels()">×</button>
        <div id="loginBox">
            <div class="panel-title">🔐 <span data-i18n="loginRegister">登录 / 注册</span></div>
            <div class="form-group"><label data-i18n="phone">手机号</label><input type="tel" id="phoneInput" placeholder="11位手机号"></div>
            <div class="form-group"><label data-i18n="nickname">昵称</label><input type="text" id="nameInput" placeholder="您的昵称"></div>
            <div class="form-group"><label data-i18n="password">密码</label><input type="password" id="pwdInput" placeholder="6位以上密码"></div>
            <button class="btn btn-gold" onclick="doLogin()" data-i18n="loginRegister">登录 / 注册</button>
        </div>
        <div id="memberBox" style="display:none;">
            <div style="text-align:center;padding:20px;background:rgba(255,215,0,0.08);border-radius:14px;margin-bottom:15px;">
                <div style="font-size:36px;" id="avatar">👤</div>
                <div style="font-size:16px;font-weight:bold;margin-top:8px;" id="userName">用户</div>
                <div style="font-size:11px;color:var(--gold);margin-top:4px;" id="userLevel">免费用户</div>
            </div>

            <!-- 会员权益对比 -->
            <div class="membership-box">
                <div class="membership-header">
                    <span class="membership-level" id="membershipTitle">🆓 免费用户</span>
                    <span style="font-size:10px;color:rgba(255,255,255,0.5);">当前等级</span>
                </div>
                <div class="membership-limits" id="membershipLimits">
                    • 提醒数量：每天10条<br>
                    • 精确度：分钟级<br>
                    • 关怀对象：3人<br>
                    • 主题风格：2款<br>
                    • 经典/水学：每日1篇<br>
                    • 广告：有广告
                </div>
            </div>

            <!-- 升级选项 -->
            <div style="font-size:12px;font-weight:bold;color:var(--gold);margin:15px 0 10px;">👑 升级会员</div>
            <div class="membership-plans">
                <div class="plan-btn" onclick="upgradePlan('monthly')">
                    <div>
                        <div class="plan-name">月度会员</div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.5);">无限提醒 · 秒级精确</div>
                    </div>
                    <div class="plan-price">¥9.99/月</div>
                </div>
                <div class="plan-btn" onclick="upgradePlan('quarterly')">
                    <div>
                        <div class="plan-name">季度会员</div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.5);">省33% · 全部内容</div>
                    </div>
                    <div class="plan-price">¥19.99/季</div>
                </div>
                <div class="plan-btn recommended" onclick="upgradePlan('yearly')">
                    <div>
                        <div class="plan-name">年度VIP 🔥</div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.5);">省83% · 音频课程 · 无广告</div>
                    </div>
                    <div class="plan-price">¥199/年</div>
                </div>
                <div class="plan-btn" onclick="upgradePlan('enterprise')" style="border-color:rgba(255,107,107,0.5);">
                    <div>
                        <div class="plan-name" style="color:#ff6b6b;">🏢 企业版</div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.5);">品牌定制 · 分组管理 · 专属内容</div>
                    </div>
                    <div class="plan-price" style="color:#ff6b6b;">¥9999/年</div>
                </div>
            </div>

            <!-- 激活码输入 -->
            <div style="margin-top:12px;padding:12px;background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.2);border-radius:12px;">
                <div style="font-size:12px;font-weight:bold;color:var(--primary);margin-bottom:8px;">🔑 有激活码？</div>
                <div style="display:flex;gap:6px;">
                    <input type="text" id="activationCodeInput" placeholder="输入激活码，如 VIP-XXXX-XXXX" style="flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.06);color:#fff;font-size:13px;letter-spacing:1px;text-transform:uppercase;">
                    <button onclick="activateByCode()" style="padding:10px 16px;border-radius:10px;border:none;background:linear-gradient(135deg,#FFD700,#ff9800);color:#000;font-weight:bold;font-size:12px;cursor:pointer;white-space:nowrap;">激活</button>
                </div>
                <div style="font-size:9px;color:rgba(255,255,255,0.3);margin-top:6px;">付款后管理员会发送激活码给你，输入后立即升级</div>
            </div>

            <!-- 我的活动记录 -->
            <div style="margin-top:15px;">
                <div style="font-size:12px;font-weight:bold;color:var(--primary);margin-bottom:8px;">📋 我的活动记录</div>
                <div id="myActivityList" style="background:rgba(255,255,255,0.03);border-radius:10px;padding:10px;max-height:150px;overflow-y:auto;"></div>
            </div>
            
            <button class="btn btn-outline" style="margin-top:15px;" onclick="logout()" data-i18n="logout">退出登录</button>
        </div>
    </div>

    <!-- 弹窗 -->
    <div class="modal" id="addRemindModal">
        <div class="modal-box">
            <div class="modal-title">⏰ <span data-i18n="newReminder">新建提醒</span></div>
            <div class="form-group"><label data-i18n="title">标题</label><input type="text" id="rTitle" placeholder="如：喝水、开会、生日"></div>
            <div class="form-group"><label data-i18n="type">类型</label>
                <select id="rType">
                    <option value="💧">💧 喝水</option>
                    <option value="🏥">🏥 就医</option>
                    <option value="📅">📅 开会</option>
                    <option value="🎂">🎂 生日</option>
                    <option value="📞">📞 电话</option>
                    <option value="🔔">🔔 其他</option>
                </select>
            </div>
            <div class="section-title">📅 <span data-i18n="date">日期</span></div>
            <div class="datetime-row">
                <div class="datetime-input"><label data-i18n="year">年</label><input type="number" id="rYear"></div>
                <div class="datetime-input"><label data-i18n="month">月</label><input type="number" id="rMonth" min="1" max="12"></div>
                <div class="datetime-input"><label data-i18n="day">日</label><input type="number" id="rDay" min="1" max="31"></div>
            </div>
            <div class="section-title">⏰ <span data-i18n="time">时间</span></div>
            <div class="datetime-row">
                <div class="datetime-input"><label data-i18n="hour">时</label><input type="number" id="rHour" min="0" max="23"></div>
                <div class="datetime-input"><label data-i18n="minute">分</label><input type="number" id="rMin" min="0" max="59"></div>
                <div class="datetime-input"><label data-i18n="second">秒</label><input type="number" id="rSec" min="0" max="59"></div>
            </div>
            <div class="form-group"><label data-i18n="repeat">重复</label>
                <select id="rRepeat"><option value="once">不重复</option><option value="daily">每天</option><option value="weekly">每周</option><option value="monthly">每月</option><option value="yearly">每年</option></select>
            </div>
            <div class="form-group"><label data-i18n="note">备注</label><textarea id="rNote" rows="2"></textarea></div>
            <button class="btn btn-gold" onclick="addRemind()" data-i18n="save">保存</button>
            <button class="btn btn-outline" style="margin-top:8px;" onclick="closeModal()" data-i18n="cancel">取消</button>
        </div>
    </div>

    <div class="modal" id="remindDetailModal">
        <div class="modal-box">
            <div class="modal-title" id="detailTitle">⏰ 提醒详情</div>
            <div id="detailContent"></div>
            <button class="btn btn-primary" onclick="closeModal()" data-i18n="close">关闭</button>
        </div>
    </div>

    <div class="modal" id="addAdModal">
        <div class="modal-box">
            <div class="modal-title">📢 <span data-i18n="addAd">添加广告</span></div>
            <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:10px;text-align:center;">可同时添加文字+图片+视频，系统自动适配尺寸</div>
            <div class="form-group"><label>📝 文字内容</label><textarea id="adText" rows="2" placeholder="广告文案（可选）"></textarea></div>
            <div class="form-group"><label>🖼️ 图片</label><input type="text" id="adImageUrl" placeholder="图片URL（可选）">
                <div style="margin-top:4px;"><input type="file" id="adImageFile" accept="image/*" onchange="handleAdImage(this)" style="font-size:10px;color:rgba(255,255,255,0.5);"></div>
                <div id="adImagePreview" style="margin-top:4px;"></div>
            </div>
            <div class="form-group"><label>🎬 视频</label><input type="text" id="adVideoUrl" placeholder="视频URL（可选）"></div>
            <div class="form-group"><label>🔗 点击链接</label><input type="text" id="adLinkUrl" placeholder="点击跳转URL（可选）"></div>
            <button class="btn btn-gold" onclick="addAd()" data-i18n="add">添加</button>
        </div>
    </div>

    <!-- 关怀提醒设置弹窗 -->
    <div class="modal" id="careRemindModal">
        <div class="modal-box">
            <div class="modal-title">💝 设置关怀提醒</div>
            
            <div style="text-align:center;padding:15px;background:rgba(0,212,255,0.1);border-radius:12px;margin-bottom:15px;">
                <div style="width:60px;height:60px;border-radius:50%;background:var(--primary);margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;" id="carePersonAvatar">张</div>
                <div style="font-size:16px;font-weight:bold;" id="carePersonName">张三</div>
                <div style="font-size:11px;color:rgba(255,255,255,0.5);" id="carePersonPhone">138****1234</div>
            </div>

            <div class="form-group">
                <label>提醒类型</label>
                <select id="careType" style="width:100%;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;">
                    <option value="🎂 生日">🎂 生日提醒</option>
                    <option value="💑 纪念日">💑 纪念日提醒</option>
                    <option value="💧 喝水">💧 喝水提醒</option>
                    <option value="🏥 体检">🏥 体检提醒</option>
                    <option value="📞 电话">📞 定期电话</option>
                    <option value="🏠 探望">🏠 探望提醒</option>
                    <option value="💝 关怀">💝 其他关怀</option>
                </select>
            </div>

            <div class="form-group">
                <label>提醒日期</label>
                <div style="display:flex;gap:8px;">
                    <select id="careYear" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;"></select>
                    <select id="careMonth" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;"></select>
                    <select id="careDay" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;"></select>
                </div>
            </div>

            <div class="form-group">
                <label>提醒时间</label>
                <div style="display:flex;gap:8px;">
                    <select id="careHour" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;"></select>
                    <select id="careMinute" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;"></select>
                </div>
            </div>

            <div class="form-group">
                <label>重复</label>
                <select id="careRepeat" style="width:100%;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;">
                    <option value="none">不重复</option>
                    <option value="yearly" selected>每年重复</option>
                    <option value="monthly">每月重复</option>
                    <option value="weekly">每周重复</option>
                    <option value="daily">每天重复</option>
                </select>
            </div>

            <div class="form-group">
                <label>备注（选填）</label>
                <input type="text" id="careNote" placeholder="如：记得买蛋糕" style="width:100%;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;">
            </div>

            <div style="display:flex;gap:10px;margin-top:15px;">
                <button class="btn btn-outline" onclick="closeModal()" style="flex:1;">取消</button>
                <button class="btn btn-gold" onclick="saveCareRemind()" style="flex:1;">✅ 确认添加</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addFriendModal">
        <div class="modal-box">
            <div class="modal-title">👤 <span data-i18n="addFriend">添加好友</span></div>
            <div class="form-group"><label data-i18n="name">姓名</label><input type="text" id="fName"></div>
            <div class="form-group"><label data-i18n="phone">手机号</label><input type="tel" id="fPhone"></div>
            <div class="form-group"><label data-i18n="relation">关系</label><select id="fRelation"><option>家人</option><option>朋友</option><option>同事</option></select></div>
            <button class="btn btn-primary" onclick="addFriend()" data-i18n="save">保存</button>
            <button class="btn btn-outline" style="margin-top:8px;" onclick="closeModal()" data-i18n="cancel">取消</button>
        </div>
    </div>

    <script>
    // ==================== 版本控制与自动更新 ====================
    var APP_VERSION = '4.8.2';
    var APP_BUILD_TIME = '2026-02-18T21:29:37Z';
    var VERSION_CHECK_URL = 'https://raw.githubusercontent.com/ericjbe/water-reminder/main/version.json';
    
    // 检查新版本（每次打开检查，但每4小时最多一次弹窗提醒）
    async function checkForUpdates(silent) {
        try {
            var lastCheck = parseInt(localStorage.getItem('heshuileLastVersionCheck') || '0');
            if (!silent && Date.now() - lastCheck < 4 * 60 * 60 * 1000) return;
            
            var resp = await fetch(VERSION_CHECK_URL + '?t=' + Date.now(), { cache: 'no-store' });
            if (!resp.ok) return;
            var data = await resp.json();
            
            localStorage.setItem('heshuileLastVersionCheck', String(Date.now()));
            
            if (data.version && data.version !== APP_VERSION && compareVersions(data.version, APP_VERSION) > 0) {
                // 有新版本
                if (data.force) {
                    // 强制更新：直接刷新
                    showUpdateBanner(data.version, data.changelog || '修复bug，提升体验', true);
                } else {
                    // 可选更新：显示提醒
                    showUpdateBanner(data.version, data.changelog || '新功能已就绪', false);
                }
            }
        } catch(e) {
            // 网络错误静默忽略
        }
    }
    
    function compareVersions(a, b) {
        var pa = a.split('.').map(Number), pb = b.split('.').map(Number);
        for (var i = 0; i < 3; i++) {
            if ((pa[i]||0) > (pb[i]||0)) return 1;
            if ((pa[i]||0) < (pb[i]||0)) return -1;
        }
        return 0;
    }
    
    function showUpdateBanner(newVer, changelog, force) {
        var existing = document.getElementById('updateBanner');
        if (existing) existing.remove();
        
        var div = document.createElement('div');
        div.id = 'updateBanner';
        div.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:99999;background:linear-gradient(135deg,#FFD700,#ff9800);color:#000;padding:12px 16px;font-size:13px;text-align:center;box-shadow:0 2px 12px rgba(0,0,0,0.3);';
        div.innerHTML = '<div style="font-weight:bold;">🆕 新版本 v' + newVer + ' 已发布</div>'
            + '<div style="font-size:11px;margin:4px 0;opacity:0.8;">' + changelog + '</div>'
            + '<div style="display:flex;justify-content:center;gap:8px;margin-top:8px;">'
            + '<button onclick="doAppUpdate()" style="padding:6px 20px;border-radius:8px;border:none;background:#000;color:#FFD700;font-weight:bold;font-size:12px;cursor:pointer;">立即更新</button>'
            + (force ? '' : '<button onclick="this.parentElement.parentElement.remove()" style="padding:6px 14px;border-radius:8px;border:1px solid rgba(0,0,0,0.3);background:transparent;color:#000;font-size:12px;cursor:pointer;">稍后</button>')
            + '</div>';
        document.body.prepend(div);
    }
    
    function doAppUpdate() {
        // 清除Service Worker缓存
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(regs) {
                regs.forEach(function(r) { r.unregister(); });
            });
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    names.forEach(function(n) { caches.delete(n); });
                });
            }
        }
        // 强制重新加载
        setTimeout(function() {
            location.reload(true);
        }, 500);
    }
    
    // 页面加载后延迟检查
    setTimeout(function() { checkForUpdates(false); }, 3000);

    // ==================== PWA 安装逻辑 ====================
    let pwaPrompt = null;
    const pwaInfo = {
        isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
        isAndroid: /Android/.test(navigator.userAgent),
        isWechat: /MicroMessenger/.test(navigator.userAgent),
        isStandalone: window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone
    };

    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); pwaPrompt = e; if (!pwaInfo.isStandalone && !localStorage.getItem('pwaDismissed')) setTimeout(showPwaBanner, 5000); });
    window.addEventListener('appinstalled', () => { closePwaBanner(); toast('🎉 已添加到桌面！'); });

    function showPwaBanner() { if (pwaInfo.isStandalone) return; document.getElementById('pwaBanner').classList.add('show'); }
    function closePwaBanner() { document.getElementById('pwaBanner').classList.remove('show'); localStorage.setItem('pwaDismissed', '1'); }
    function handlePwaInstall() {
        if (pwaInfo.isWechat) { showPwaGuide('wechat'); }
        else if (pwaInfo.isIOS) { showPwaGuide('ios'); }
        else if (pwaPrompt) { pwaPrompt.prompt(); pwaPrompt.userChoice.then(() => { pwaPrompt = null; closePwaBanner(); }); }
        else { showPwaGuide('android'); }
    }
    function showPwaGuide(type) {
        const steps = document.getElementById('pwaSteps');
        const tip = document.getElementById('pwaWechatTip');
        tip.style.display = type === 'wechat' ? 'block' : 'none';
        if (type === 'wechat') steps.innerHTML = '<div class="pwa-guide-step"><div class="pwa-step-num">1</div><div>点击右上角 <b>···</b></div></div><div class="pwa-guide-step"><div class="pwa-step-num">2</div><div>选择「在浏览器打开」</div></div><div class="pwa-guide-step"><div class="pwa-step-num">3</div><div>再次点击「添加到桌面」</div></div>';
        else if (type === 'ios') steps.innerHTML = '<div class="pwa-guide-step"><div class="pwa-step-num">1</div><div>点击底部 <b>分享按钮</b> ⬆️</div></div><div class="pwa-guide-step"><div class="pwa-step-num">2</div><div>向上滑动，找到「添加到主屏幕」</div></div><div class="pwa-guide-step"><div class="pwa-step-num">3</div><div>点击右上角「添加」</div></div>';
        else steps.innerHTML = '<div class="pwa-guide-step"><div class="pwa-step-num">1</div><div>点击浏览器 <b>菜单</b>（⋮ 或 ···）</div></div><div class="pwa-guide-step"><div class="pwa-step-num">2</div><div>找到「添加到主屏幕」或「安装」</div></div><div class="pwa-guide-step"><div class="pwa-step-num">3</div><div>点击「添加」确认</div></div>';
        document.getElementById('pwaGuide').classList.add('show'); closePwaBanner();
    }
    function closePwaGuide() { document.getElementById('pwaGuide').classList.remove('show'); }
    window.addEventListener('load', () => { if (!pwaInfo.isStandalone && !localStorage.getItem('pwaDismissed')) { if (pwaInfo.isIOS || pwaInfo.isWechat) setTimeout(showPwaBanner, 5000); } });

    // ==================== 多语言系统 ====================
    const I18N = {
        zh: {
            appName: '喝水了吗', slogan: '「一万年太久，分秒必争」', login: '登录', promo: '共享',
            dailyWisdom: '每日水语', copy: '复制', refresh: '换一条', streak: '连续', days: '天', points: '积分', checkin: '打卡',
            clickToAdd: '点击添加<br>图片/视频/文字', tickSound: '滴答声', classics: '经典', waterStudy: '水学', voice: '语音', care: '关怀', settings: '设置',
            drinkWater: '喝水提醒', drinkNow: '立即喝水', todayWater: '今日饮水', waterGoal: '目标2000ml',
            upcomingReminders: '即将到来的提醒', home: '首页', remind: '提醒', me: '我的',
            reminderManagement: '提醒管理', newReminder: '新建提醒', soundSettings: '滴答声设置', tickSwitch: '滴答声开关', volume: '音量', theme: '主题风格',
            adManagement: '广告管理', adminLogin: '管理员登录', verify: '验证', adminLogout: '退出管理', addAd: '添加新广告',
            customizeCenter: '自定义钟表中心', uploadImage: '上传图片', uploadVideo: '上传视频', customText: '自定义文字', clickUpload: '点击上传', apply: '应用', resetDefault: '恢复默认',
            smartCare: '智能关怀', readContacts: '读取通讯录', contactsDesc: '授权后可快速查找并添加被关怀人，设置生日、纪念日等关怀提醒。', authorizeContacts: '授权读取通讯录',
            findCarePerson: '查找被关怀人', addedFriends: '已添加的关怀对象', manualAdd: '手动添加',
            classics: '经典', fiveScriptures: '五经', waterCourse: '水学课程', socraticDialog: '苏格拉底式水学对话', promoCenter: '共享中心', myInviteCode: '我的邀请码', copyInviteLink: '复制邀请链接',
            pointsCenter: '积分中心', myPoints: '我的积分', monthlyCheckin: '本月打卡',
            loginRegister: '登录 / 注册', phone: '手机号', nickname: '昵称', password: '密码', upgradeVip: '升级VIP', logout: '退出登录',
            title: '标题', type: '类型', date: '日期', time: '时间', year: '年', month: '月', day: '日', hour: '时', minute: '分', second: '秒',
            repeat: '重复', note: '备注', save: '保存', cancel: '取消', close: '关闭', add: '添加', name: '姓名', relation: '关系', adType: '广告类型',
            sunday: '日', monday: '一', tuesday: '二', wednesday: '三', thursday: '四', friday: '五', saturday: '六'
        },
        en: {
            appName: 'DrinkWater', slogan: '"Seize every second"', login: 'Login', promo: 'Promo',
            dailyWisdom: 'Daily Wisdom', copy: 'Copy', refresh: 'Refresh', streak: 'Streak', days: 'days', points: 'Points', checkin: 'Check-in',
            clickToAdd: 'Click to add<br>Image/Video/Text', tickSound: 'Tick Sound', classics: 'Classics', waterStudy: 'Water Study', voice: 'Voice', care: 'Care', settings: 'Settings',
            upcomingReminders: 'Upcoming Reminders', home: 'Home', remind: 'Remind', me: 'Me',
            reminderManagement: 'Reminder Management', newReminder: 'New Reminder', soundSettings: 'Sound Settings', tickSwitch: 'Tick Switch', volume: 'Volume', theme: 'Theme',
            adManagement: 'Ad Management', adminLogin: 'Admin Login', verify: 'Verify', adminLogout: 'Logout Admin', addAd: 'Add New Ad',
            customizeCenter: 'Customize Clock Center', uploadImage: 'Upload Image', uploadVideo: 'Upload Video', customText: 'Custom Text', clickUpload: 'Click to upload', apply: 'Apply', resetDefault: 'Reset',
            smartCare: 'Smart Care', readContacts: 'Read Contacts', contactsDesc: 'After authorization, you can quickly find and add care recipients for birthday and anniversary reminders.', authorizeContacts: 'Authorize Contacts',
            findCarePerson: 'Find Care Recipient', addedFriends: 'Added Care Recipients', manualAdd: 'Manual Add',
            classics: 'Classics', fiveScriptures: 'Five Scriptures', waterCourse: 'Water Course', socraticDialog: 'Socratic Water Dialogue', promoCenter: 'Promo Center', myInviteCode: 'My Invite Code', copyInviteLink: 'Copy Invite Link',
            pointsCenter: 'Points Center', myPoints: 'My Points', monthlyCheckin: 'Monthly Check-in',
            loginRegister: 'Login / Register', phone: 'Phone', nickname: 'Nickname', password: 'Password', upgradeVip: 'Upgrade VIP', logout: 'Logout',
            title: 'Title', type: 'Type', date: 'Date', time: 'Time', year: 'Year', month: 'Month', day: 'Day', hour: 'Hour', minute: 'Min', second: 'Sec',
            repeat: 'Repeat', note: 'Note', save: 'Save', cancel: 'Cancel', close: 'Close', add: 'Add', name: 'Name', relation: 'Relation', adType: 'Ad Type',
            sunday: 'Sun', monday: 'Mon', tuesday: 'Tue', wednesday: 'Wed', thursday: 'Thu', friday: 'Fri', saturday: 'Sat'
        },
        ja: {
            appName: '水飲んだ？', slogan: '「一秒も無駄にしない」', login: 'ログイン', promo: 'プロモ',
            dailyWisdom: '今日の言葉', copy: 'コピー', refresh: '更新', streak: '連続', days: '日', points: 'ポイント', checkin: 'チェックイン',
            clickToAdd: 'クリックして追加<br>画像/動画/テキスト', tickSound: 'チクタク音', classics: '経典', waterStudy: '水学', voice: '音声', care: 'ケア', settings: '設定',
            upcomingReminders: '予定のリマインダー', home: 'ホーム', remind: 'リマインド', me: 'マイページ',
            reminderManagement: 'リマインダー管理', newReminder: '新規作成', soundSettings: 'サウンド設定', tickSwitch: 'チクタク音', volume: '音量', theme: 'テーマ',
            adManagement: '広告管理', adminLogin: '管理者ログイン', verify: '確認', adminLogout: 'ログアウト', addAd: '広告追加',
            customizeCenter: '時計中央カスタマイズ', uploadImage: '画像アップロード', uploadVideo: '動画アップロード', customText: 'カスタムテキスト', clickUpload: 'クリックしてアップロード', apply: '適用', resetDefault: 'リセット',
            smartCare: 'スマートケア', readContacts: '連絡先を読み込む', contactsDesc: '許可後、ケア対象者を素早く検索・追加できます。', authorizeContacts: '連絡先を許可',
            findCarePerson: 'ケア対象者を検索', addedFriends: '追加済みのケア対象者', manualAdd: '手動追加',
            classics: '経典', fiveScriptures: '五つの経典', waterCourse: '水学コース', socraticDialog: 'ソクラテス式水学対話', promoCenter: 'プロモセンター', myInviteCode: '招待コード', copyInviteLink: '招待リンクをコピー',
            pointsCenter: 'ポイントセンター', myPoints: 'マイポイント', monthlyCheckin: '今月のチェックイン',
            loginRegister: 'ログイン/登録', phone: '電話番号', nickname: 'ニックネーム', password: 'パスワード', upgradeVip: 'VIPアップグレード', logout: 'ログアウト',
            title: 'タイトル', type: 'タイプ', date: '日付', time: '時間', year: '年', month: '月', day: '日', hour: '時', minute: '分', second: '秒',
            repeat: '繰り返し', note: 'メモ', save: '保存', cancel: 'キャンセル', close: '閉じる', add: '追加', name: '名前', relation: '関係', adType: '広告タイプ',
            sunday: '日', monday: '月', tuesday: '火', wednesday: '水', thursday: '木', friday: '金', saturday: '土'
        },
        ko: {
            appName: '물 마셨어?', slogan: '「1초도 아깝다」', login: '로그인', promo: '프로모션',
            dailyWisdom: '오늘의 명언', copy: '복사', refresh: '새로고침', streak: '연속', days: '일', points: '포인트', checkin: '체크인',
            clickToAdd: '클릭하여 추가<br>이미지/비디오/텍스트', tickSound: '틱톡 소리', classics: '고전', scriptures: '경전', waterStudy: '물 학습', voice: '음성', care: '케어', settings: '설정',
            upcomingReminders: '예정된 알림', home: '홈', remind: '알림', me: '내 정보',
            reminderManagement: '알림 관리', newReminder: '새 알림', soundSettings: '소리 설정', tickSwitch: '틱톡 소리', volume: '볼륨', theme: '테마',
            adManagement: '광고 관리', adminLogin: '관리자 로그인', verify: '확인', adminLogout: '로그아웃', addAd: '광고 추가',
            customizeCenter: '시계 중앙 커스터마이즈', uploadImage: '이미지 업로드', uploadVideo: '비디오 업로드', customText: '커스텀 텍스트', clickUpload: '클릭하여 업로드', apply: '적용', resetDefault: '초기화',
            smartCare: '스마트 케어', readContacts: '연락처 읽기', contactsDesc: '허용 후 케어 대상자를 빠르게 검색하고 추가할 수 있습니다.', authorizeContacts: '연락처 허용',
            findCarePerson: '케어 대상자 찾기', addedFriends: '추가된 케어 대상자', manualAdd: '수동 추가',
            classics: '고전', fiveScriptures: '다섯 경전', waterCourse: '물 코스', socraticDialog: '소크라테스식 물 대화', promoCenter: '프로모션 센터', myInviteCode: '초대 코드', copyInviteLink: '초대 링크 복사',
            pointsCenter: '포인트 센터', myPoints: '내 포인트', monthlyCheckin: '이번 달 체크인',
            loginRegister: '로그인/가입', phone: '전화번호', nickname: '닉네임', password: '비밀번호', upgradeVip: 'VIP 업그레이드', logout: '로그아웃',
            title: '제목', type: '유형', date: '날짜', time: '시간', year: '년', month: '월', day: '일', hour: '시', minute: '분', second: '초',
            repeat: '반복', note: '메모', save: '저장', cancel: '취소', close: '닫기', add: '추가', name: '이름', relation: '관계', adType: '광고 유형',
            sunday: '일', monday: '월', tuesday: '화', wednesday: '수', thursday: '목', friday: '금', saturday: '토'
        },
        es: {
            appName: 'Hidratado', slogan: '「Cada segundo cuenta」', login: 'Entrar', promo: 'Compartir',
            dailyWisdom: 'Sabiduría diaria', copy: 'Copiar', refresh: 'Actualizar', streak: 'Racha', days: 'días', points: 'Puntos', checkin: 'Registro',
            clickToAdd: 'Toca para agregar<br>imagen/video/texto', tickSound: 'Tic-tac', classics: 'Clásicos', waterStudy: 'Ciencia del agua', voice: 'Voz', care: 'Cuidado', settings: 'Ajustes',
            drinkWater: 'Recordatorio', drinkNow: 'Beber ahora', todayWater: 'Hoy', waterGoal: 'Meta 2000ml',
            upcomingReminders: 'Próximos recordatorios', home: 'Inicio', remind: 'Recordar', me: 'Mi perfil',
            reminderManagement: 'Gestión', newReminder: 'Nuevo recordatorio', soundSettings: 'Sonido Tic-tac', tickSwitch: 'Activar tic-tac', volume: 'Volumen', theme: 'Tema',
            adManagement: 'Gestión de anuncios', adminLogin: 'Admin', verify: 'Verificar', adminLogout: 'Cerrar admin', addAd: 'Agregar anuncio',
            customizeCenter: 'Personalizar reloj', uploadImage: 'Subir imagen', uploadVideo: 'Subir video', customText: 'Texto', clickUpload: 'Subir', apply: 'Aplicar', resetDefault: 'Restablecer',
            smartCare: 'Cuidado inteligente', readContacts: 'Leer contactos', contactsDesc: 'Autorizar contactos para recordatorios de cumpleaños y salud.', authorizeContacts: 'Autorizar contactos',
            findCarePerson: 'Buscar persona', addedFriends: 'Personas agregadas', manualAdd: 'Agregar manual',
            fiveScriptures: 'Cinco Escrituras', waterCourse: 'Curso de Agua', socraticDialog: 'Diálogo Socrático', promoCenter: 'Centro de Promoción', myInviteCode: 'Mi código', copyInviteLink: 'Copiar enlace',
            pointsCenter: 'Centro de Puntos', myPoints: 'Mis Puntos', monthlyCheckin: 'Registro mensual',
            loginRegister: 'Entrar / Registrar', phone: 'Teléfono', nickname: 'Apodo', password: 'Contraseña', upgradeVip: 'Mejorar VIP', logout: 'Salir',
            title: 'Título', type: 'Tipo', date: 'Fecha', time: 'Hora', year: 'Año', month: 'Mes', day: 'Día', hour: 'Hora', minute: 'Min', second: 'Seg',
            repeat: 'Repetir', note: 'Nota', save: 'Guardar', cancel: 'Cancelar', close: 'Cerrar', add: 'Agregar', name: 'Nombre', relation: 'Relación', adType: 'Tipo de anuncio',
            sunday: 'Do', monday: 'Lu', tuesday: 'Ma', wednesday: 'Mi', thursday: 'Ju', friday: 'Vi', saturday: 'Sá'
        },
        ar: {
            appName: 'هل شربت الماء', slogan: '「كل ثانية تهم」', login: 'دخول', promo: 'مشاركة',
            dailyWisdom: 'حكمة اليوم', copy: 'نسخ', refresh: 'تحديث', streak: 'متتالي', days: 'أيام', points: 'نقاط', checkin: 'تسجيل',
            clickToAdd: 'اضغط لإضافة<br>صورة/فيديو/نص', tickSound: 'صوت الساعة', classics: 'كلاسيكيات', waterStudy: 'علم الماء', voice: 'صوت', care: 'رعاية', settings: 'إعدادات',
            drinkWater: 'تذكير بالماء', drinkNow: 'اشرب الآن', todayWater: 'اليوم', waterGoal: 'الهدف 2000مل',
            upcomingReminders: 'التذكيرات القادمة', home: 'الرئيسية', remind: 'تذكير', me: 'حسابي',
            reminderManagement: 'إدارة التذكيرات', newReminder: 'تذكير جديد', soundSettings: 'إعدادات الصوت', tickSwitch: 'تشغيل الصوت', volume: 'مستوى الصوت', theme: 'المظهر',
            adManagement: 'إدارة الإعلانات', adminLogin: 'مدير', verify: 'تحقق', adminLogout: 'خروج المدير', addAd: 'إضافة إعلان',
            customizeCenter: 'تخصيص الساعة', uploadImage: 'رفع صورة', uploadVideo: 'رفع فيديو', customText: 'نص مخصص', clickUpload: 'رفع', apply: 'تطبيق', resetDefault: 'استعادة',
            smartCare: 'رعاية ذكية', readContacts: 'قراءة جهات الاتصال', contactsDesc: 'السماح بالوصول لتذكيرات أعياد الميلاد والصحة.', authorizeContacts: 'السماح بالوصول',
            findCarePerson: 'بحث', addedFriends: 'الأشخاص المضافون', manualAdd: 'إضافة يدوية',
            fiveScriptures: 'الكتب الخمسة', waterCourse: 'دورة الماء', socraticDialog: 'حوار سقراطي', promoCenter: 'مركز المشاركة', myInviteCode: 'رمز الدعوة', copyInviteLink: 'نسخ الرابط',
            pointsCenter: 'مركز النقاط', myPoints: 'نقاطي', monthlyCheckin: 'تسجيل الشهر',
            loginRegister: 'دخول / تسجيل', phone: 'هاتف', nickname: 'اسم', password: 'كلمة المرور', upgradeVip: 'ترقية VIP', logout: 'خروج',
            title: 'عنوان', type: 'نوع', date: 'تاريخ', time: 'وقت', year: 'سنة', month: 'شهر', day: 'يوم', hour: 'ساعة', minute: 'دقيقة', second: 'ثانية',
            repeat: 'تكرار', note: 'ملاحظة', save: 'حفظ', cancel: 'إلغاء', close: 'إغلاق', add: 'إضافة', name: 'اسم', relation: 'علاقة', adType: 'نوع الإعلان',
            sunday: 'أحد', monday: 'اثنين', tuesday: 'ثلاثاء', wednesday: 'أربعاء', thursday: 'خميس', friday: 'جمعة', saturday: 'سبت'
        },
        he: {
            appName: 'שתית מים', slogan: '「כל שנייה חשובה」', login: 'כניסה', promo: 'שיתוף',
            dailyWisdom: 'חוכמת היום', copy: 'העתק', refresh: 'רענן', streak: 'רצף', days: 'ימים', points: 'נקודות', checkin: 'צק-אין',
            clickToAdd: 'לחץ להוספת<br>תמונה/וידאו/טקסט', tickSound: 'צליל שעון', classics: 'קלאסיקה', waterStudy: 'מדע המים', voice: 'קול', care: 'טיפול', settings: 'הגדרות',
            drinkWater: 'תזכורת שתייה', drinkNow: 'שתה עכשיו', todayWater: 'היום', waterGoal: 'יעד 2000מל',
            upcomingReminders: 'תזכורות קרובות', home: 'בית', remind: 'תזכורת', me: 'שלי',
            reminderManagement: 'ניהול תזכורות', newReminder: 'תזכורת חדשה', soundSettings: 'הגדרות צליל', tickSwitch: 'הפעל צליל', volume: 'עוצמה', theme: 'ערכת נושא',
            adManagement: 'ניהול פרסום', adminLogin: 'מנהל', verify: 'אימות', adminLogout: 'יציאת מנהל', addAd: 'הוסף פרסום',
            customizeCenter: 'התאם שעון', uploadImage: 'העלה תמונה', uploadVideo: 'העלה וידאו', customText: 'טקסט', clickUpload: 'העלה', apply: 'החל', resetDefault: 'איפוס',
            smartCare: 'טיפול חכם', readContacts: 'קרא אנשי קשר', contactsDesc: 'אשר גישה לתזכורות יום הולדת ובריאות.', authorizeContacts: 'אשר גישה',
            findCarePerson: 'חפש', addedFriends: 'אנשים שנוספו', manualAdd: 'הוספה ידנית',
            fiveScriptures: 'חמשת הכתבים', waterCourse: 'קורס מים', socraticDialog: 'דיאלוג סוקרטי', promoCenter: 'מרכז שיתוף', myInviteCode: 'קוד הזמנה', copyInviteLink: 'העתק קישור',
            pointsCenter: 'מרכז נקודות', myPoints: 'הנקודות שלי', monthlyCheckin: 'צק-אין חודשי',
            loginRegister: 'כניסה / הרשמה', phone: 'טלפון', nickname: 'כינוי', password: 'סיסמה', upgradeVip: 'שדרוג VIP', logout: 'יציאה',
            title: 'כותרת', type: 'סוג', date: 'תאריך', time: 'שעה', year: 'שנה', month: 'חודש', day: 'יום', hour: 'שעה', minute: 'דקה', second: 'שנייה',
            repeat: 'חזרה', note: 'הערה', save: 'שמור', cancel: 'ביטול', close: 'סגור', add: 'הוסף', name: 'שם', relation: 'קשר', adType: 'סוג פרסום',
            sunday: 'א׳', monday: 'ב׳', tuesday: 'ג׳', wednesday: 'ד׳', thursday: 'ה׳', friday: 'ו׳', saturday: 'ש׳'
        }
    };

    let currentLang = 'zh';

    function changeLang(lang) {
        document.body.dir = (lang === 'ar' || lang === 'he') ? 'rtl' : 'ltr';
        currentLang = lang;
        localStorage.setItem('heshuileLang', lang);
        applyI18n();
        updateClock();
        renderAll();
    }

    function applyI18n() {
        const t = I18N[currentLang] || I18N.zh;
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (t[key]) el.innerHTML = t[key];
        });
        // 动态文本全覆盖
        const sloganMap = {zh:'「一万年太久，分秒必争」',en:'"Seize every moment"',ja:'「一秒も無駄にしない」',ko:'「매 순간을 잡아라」',es:'"Cada segundo cuenta"',ar:'「كل ثانية تهم」',he:'「כל שנייה חשובה」'};
        const slogan = document.querySelector('.slogan,[data-i18n="slogan"]');
        if (slogan) slogan.textContent = sloganMap[currentLang] || sloganMap.zh;
        // 底部导航
        const navLabels = {zh:['首页','提醒','我的'],en:['Home','Remind','Me'],ja:['ホーム','通知','マイ'],ko:['홈','알림','내정보'],es:['Inicio','Recordar','Perfil'],ar:['الرئيسية','تذكير','حسابي'],he:['בית','תזכורת','שלי']};
        const navEls = document.querySelectorAll('.nav-bar .nav-item span:last-child');
        const nl = navLabels[currentLang] || navLabels.zh;
        navEls.forEach((el,i) => { if(nl[i]) el.textContent = nl[i]; });
        // 面板标题
        const panelTitles = {
            zh:{remind:'⏰ 提醒管理',sound:'🔊 滴答声设置',theme:'🎨 主题风格',ad:'📢 广告管理',custom:'🎯 自定义钟表中心',care:'💝 智能关怀',classics:'📜 经典 / 五经',water:'🌊 水学研究院',promo:'🧧 共享中心',points:'🏆 积分中心',user:'👤 用户中心',fest:'🏮 春节祝福馆'},
            en:{remind:'⏰ Reminders',sound:'🔊 Tick Sound',theme:'🎨 Theme',ad:'📢 Ad Manager',custom:'🎯 Clock Center',care:'💝 Smart Care',classics:'📜 Classics',water:'🌊 Water Academy',promo:'🧧 Promotion',points:'🏆 Points',user:'👤 Profile',fest:'🏮 Festival Greetings'},
            ja:{remind:'⏰ 通知管理',sound:'🔊 チクタク設定',theme:'🎨 テーマ',ad:'📢 広告管理',custom:'🎯 時計カスタム',care:'💝 スマートケア',classics:'📜 経典',water:'🌊 水学院',promo:'🧧 プロモ',points:'🏆 ポイント',user:'👤 ユーザー',fest:'🏮 お正月'},
            ko:{remind:'⏰ 알림 관리',sound:'🔊 틱톡 설정',theme:'🎨 테마',ad:'📢 광고 관리',custom:'🎯 시계 커스텀',care:'💝 스마트 케어',classics:'📜 고전',water:'🌊 물 학원',promo:'🧧 프로모션',points:'🏆 포인트',user:'👤 프로필',fest:'🏮 새해 축하'},
            es:{remind:'⏰ Recordatorios',sound:'🔊 Tic-tac',theme:'🎨 Tema',ad:'📢 Anuncios',custom:'🎯 Personalizar',care:'💝 Cuidado',classics:'📜 Clásicos',water:'🌊 Academia',promo:'🧧 Promoción',points:'🏆 Puntos',user:'👤 Perfil',fest:'🏮 Festivales'},
            ar:{remind:'⏰ التذكيرات',sound:'🔊 صوت الساعة',theme:'🎨 المظهر',ad:'📢 الإعلانات',custom:'🎯 تخصيص',care:'💝 رعاية',classics:'📜 كلاسيكيات',water:'🌊 أكاديمية',promo:'🧧 مشاركة',points:'🏆 نقاط',user:'👤 حسابي',fest:'🏮 تهنئات'},
            he:{remind:'⏰ תזכורות',sound:'🔊 צליל שעון',theme:'🎨 ערכת נושא',ad:'📢 פרסום',custom:'🎯 התאמה',care:'💝 טיפול',classics:'📜 קלאסיקה',water:'🌊 אקדמיה',promo:'🧧 שיתוף',points:'🏆 נקודות',user:'👤 פרופיל',fest:'🏮 ברכות'}
        };
        const pt = panelTitles[currentLang] || panelTitles.zh;
        var ptMap = {'remindPanel':'remind','soundPanel':'sound','themePanel':'theme','adPanel':'ad','customPanel':'custom','carePanel':'care','classicsPanel':'classics','waterPanel':'water','promoPanel':'promo','pointsPanel':'points','userPanel':'user','festivalPanel':'fest'};
        Object.keys(ptMap).forEach(function(panelId){
            var panel = document.getElementById(panelId);
            if (panel) {
                var titleEl = panel.querySelector('.panel-title');
                if (titleEl && pt[ptMap[panelId]]) titleEl.textContent = pt[ptMap[panelId]];
            }
        });
        // 按钮文本
        var drinkBtn = document.querySelector('[onclick*="drinkWater"],.drink-btn');
        if (drinkBtn) drinkBtn.textContent = t.drinkNow || '立即喝水';
        // 页面标题
        var titleSuffix = {zh:'分秒必争',en:'Seize every second',ja:'一秒も無駄にしない',ko:'매 순간을 잡아라',es:'Cada segundo cuenta',ar:'كل ثانية تهم',he:'כל שנייה חשובה'};
        document.title = t.appName + ' | ' + (titleSuffix[currentLang] || titleSuffix.zh);
    }

    // ==================== 管理员系统 ====================
    const ADMIN_PASSWORD = 'Fndlogo8888';
    let isAdminLoggedIn = false;

    function adminLogin() {
        const pwd = document.getElementById('adminPwd').value;
        if (pwd === ADMIN_PASSWORD) {
            isAdminLoggedIn = true;
            document.getElementById('adminLoginBox').style.display = 'none';
            document.getElementById('adminAdContent').style.display = 'block';
            renderAdList();
            toast('✅ 管理员验证成功');
            setTimeout(function(){showOrdersPanel();showAutoSendPanel();showActivityLog();showStatsPanel();},200);
        } else {
            toast('❌ 密码错误');
        }
    }

    function adminLogout() {
        isAdminLoggedIn = false;
        document.getElementById('adminLoginBox').style.display = 'block';
        document.getElementById('adminAdContent').style.display = 'none';
        document.getElementById('adminPwd').value = '';
        toast('已退出管理');
    }

    // ==================== 数据和状态 ====================
    const SOUNDS = [
        { id: 'classic', name: '🕐 经典钟声', freq: 1000 },
        { id: 'soft', name: '💧 轻柔水滴', freq: 800 },
        { id: 'wood', name: '🪵 木鱼敲击', freq: 400 },
        { id: 'bell', name: '🔔 风铃摇曳', freq: 1200 }
    ];

    const THEMES = {
        classic: { primary: '#00d4ff', bg1: '#0a192f', bg2: '#112240' },
        luxury: { primary: '#ffd700', bg1: '#1a1a0a', bg2: '#2d2a10' },
        nature: { primary: '#06ffa5', bg1: '#0a1f1a', bg2: '#102f25' },
        romantic: { primary: '#ff6b9d', bg1: '#1f0a1a', bg2: '#2f1025' }
    };

    const QUOTES = {
        zh: [{ text: '别小看平淡，平淡才是大多数生命的真相。', source: '水若善' }, { text: '一万年太久，分秒必争。', source: '提醒' }, { text: '上善若水，水善利万物而不争。', source: '道德经·第八章' }, { text: '水能载舟，亦能覆舟。', source: '荀子·王制' }, { text: '马年大吉！马到成功，愿你如水般柔韧，新的一年健康常在。', source: '水若善·新年寄语' }, { text: '饮水思源，一杯好水胜良药。每天八杯，从现在开始。', source: '水健康' }, { text: '水是生命之源，珍惜每一滴水，如同珍惜每一秒钟。', source: '水科学' }],
        en: [{ text: "Don't underestimate simplicity, it's the truth of most lives.", source: 'Shui Ruoshan' }, { text: 'Seize every second.', source: 'Reminder' }, { text: 'The highest good is like water.', source: 'Tao Te Ching' }, { text: 'Water is the driving force of all nature.', source: 'Leonardo da Vinci' }, { text: 'Year of the Horse! Stay hydrated, stay healthy.', source: 'New Year Wishes' }, { text: 'Eight glasses a day keeps the doctor away.', source: 'Water Health' }, { text: 'Water is life. Cherish every drop, cherish every second.', source: 'Water Science' }],
        ja: [{ text: '平凡を軽んじるな、それが人生の真実。', source: '水若善' }, { text: '一秒も無駄にしない。', source: 'リマインダー' }, { text: '上善は水の如し。', source: '道徳経' }, { text: '水は万物を利して争わず。', source: '老子' }, { text: '午年おめでとう！水のように柔軟な一年を。', source: '新年の挨拶' }, { text: '一日八杯の水で健康を守ろう。', source: '水の健康' }, { text: '水は命の源、一滴を大切に。', source: '水科学' }],
        ko: [{ text: '평범함을 얕보지 마라, 그것이 삶의 진실이다.', source: '수약선' }, { text: '1초도 아깝다.', source: '알림' }, { text: '최상의 선은 물과 같다.', source: '도덕경' }, { text: '물은 만물을 이롭게 하되 다투지 않는다.', source: '노자' }, { text: '말띠 해 복 많이 받으세요! 물처럼 유연한 한 해를.', source: '새해 인사' }, { text: '하루 여덟 잔으로 건강을 지키세요.', source: '물 건강' }, { text: '물은 생명의 근원, 한 방울을 소중히.', source: '물 과학' }],
        es: [{ text: 'No subestimes lo simple, es la verdad de la vida.', source: 'Shui Ruoshan' }, { text: 'Cada segundo cuenta.', source: 'Recordatorio' }, { text: 'El agua beneficia a todos sin competir.', source: 'Tao Te Ching' }, { text: '¡Feliz Año del Caballo! Salud como el agua.', source: 'Año Nuevo' }, { text: 'Ocho vasos al día mantienen al médico lejos.', source: 'Salud del Agua' }],
        ar: [{ text: 'لا تستهن بالبساطة، فهي حقيقة الحياة.', source: 'شوي روشان' }, { text: 'كل ثانية تهم.', source: 'تذكير' }, { text: 'الماء ينفع كل شيء ولا ينافس.', source: 'طاو تي تشينغ' }, { text: 'عام الحصان المبارك! الصحة كالماء.', source: 'عام جديد' }, { text: 'ثمانية أكواب يومياً للصحة.', source: 'صحة الماء' }],
        he: [{ text: 'אל תזלזל בפשטות, היא אמת החיים.', source: 'שוי רושאן' }, { text: 'כל שנייה חשובה.', source: 'תזכורת' }, { text: 'המים מועילים לכל ואינם מתחרים.', source: 'טאו טה צ׳ינג' }, { text: 'שנת הסוס! בריאות כמו מים.', source: 'שנה חדשה' }, { text: 'שמונה כוסות ביום לבריאות.', source: 'בריאות המים' }]
    };

    const books = [
        { name: { zh: '道德经', en: 'Tao Te Ching', ja: '道徳経', ko: '도덕경' }, icon: '☯️', text: { zh: '道可道，非常道。', en: 'The Tao that can be told is not the eternal Tao.', ja: '道の道とすべきは常の道に非ず。', ko: '도가도비상도' }},
        { name: { zh: '心经', en: 'Heart Sutra', ja: '般若心経', ko: '반야심경' }, icon: '🙏', text: { zh: '观自在菩萨', en: 'Avalokitesvara Bodhisattva', ja: '観自在菩薩', ko: '관자재보살' }},
        { name: { zh: '易经', en: 'I Ching', ja: '易経', ko: '주역' }, icon: '☰', text: { zh: '天行健，君子以自强不息。', en: 'Heaven moves with vigor.', ja: '天行健なり。', ko: '천행건' }},
        { name: { zh: '古兰经', en: 'Quran', ja: 'コーラン', ko: '코란' }, icon: '☪️', text: { zh: '奉至仁至慈的真主之名。', en: 'In the name of Allah.', ja: 'アッラーの御名において。', ko: '알라의 이름으로' }},
        { name: { zh: '圣经', en: 'Bible', ja: '聖書', ko: '성경' }, icon: '✝️', text: { zh: '起初，神创造天地。', en: 'In the beginning God created the heavens and the earth.', ja: '初めに神は天と地を創造された。', ko: '태초에 하나님이 천지를 창조하시니라' }}
    ];

    let tickOn = true, user = null, audioCtx = null;
    let currentTheme = 'classic', currentSound = 'classic', volume = 50;
    let friends = [], ads = [{ type: 'text', content: '🐴 马年大吉！喝水了吗？新年新习惯，每天八杯水，健康一整年' },{ type: 'text', content: '💧 上善若水 · 分秒必争 — 水若善邀您开启智慧饮水之旅' },{ type: 'text', content: '🎓 水学课程上线！从水科学到水哲学，做自己的健康管理师' }];
    let reminds = [], contacts = [];
    let checkinData = { streak: 0, lastDate: '', history: [], points: 0 };
    let waterData = { today: 0, goal: 2000, history: [], schedule: ['7:00','9:00','11:00','13:00','15:00','17:00','19:00','21:00'] };
    let centerData = { type: 'default', content: '' };
    let contactsAuthorized = false;
    let currentQuoteIdx = 0;

    // ==================== VIP 试用与会员权益 ====================
    var VIP_TRIAL_DAYS = 3;  // 试用天数
    
    // 判断是否付费会员（含试用期）
    function isPaidMember() {
        if (!user) return false;
        if (user.level && user.level !== 'free') return true;
        // 检查试用期
        return isInTrialPeriod();
    }
    
    // 检查试用期
    function isInTrialPeriod() {
        if (!user) return false;
        var trialStart = localStorage.getItem('heshuileTrialStart_' + user.phone);
        if (!trialStart) return false;
        var elapsed = Date.now() - parseInt(trialStart);
        var trialMs = VIP_TRIAL_DAYS * 24 * 60 * 60 * 1000;
        return elapsed < trialMs;
    }
    
    // 获取试用剩余天数
    function getTrialDaysLeft() {
        if (!user) return 0;
        var trialStart = localStorage.getItem('heshuileTrialStart_' + user.phone);
        if (!trialStart) return 0;
        var elapsed = Date.now() - parseInt(trialStart);
        var trialMs = VIP_TRIAL_DAYS * 24 * 60 * 60 * 1000;
        var left = trialMs - elapsed;
        return left > 0 ? Math.ceil(left / (24 * 60 * 60 * 1000)) : 0;
    }
    
    // 开始试用（新用户注册时自动触发）
    function startVipTrial() {
        if (!user) return;
        var key = 'heshuileTrialStart_' + user.phone;
        if (localStorage.getItem(key)) return; // 已经试用过
        localStorage.setItem(key, String(Date.now()));
        logActivity('trial', 'VIP试用开始 (' + VIP_TRIAL_DAYS + '天)');
    }
    
    // 试用到期检查（每次打开APP时调用）
    function checkTrialExpiry() {
        if (!user || !user.phone) return;
        if (user.level && user.level !== 'free') return; // 已付费
        
        var trialStart = localStorage.getItem('heshuileTrialStart_' + user.phone);
        if (!trialStart) return;
        
        var elapsed = Date.now() - parseInt(trialStart);
        var trialMs = VIP_TRIAL_DAYS * 24 * 60 * 60 * 1000;
        
        if (elapsed >= trialMs) {
            // 试用已到期
            var trialExpired = localStorage.getItem('heshuileTrialExpiredShown_' + user.phone);
            if (!trialExpired) {
                localStorage.setItem('heshuileTrialExpiredShown_' + user.phone, '1');
                setTimeout(function() {
                    showTrialExpiredModal();
                }, 2000);
            }
        } else {
            // 试用中，显示剩余天数
            var daysLeft = Math.ceil((trialMs - elapsed) / (24 * 60 * 60 * 1000));
            if (daysLeft <= 1) {
                setTimeout(function() {
                    toast('⏳ VIP试用今天到期，升级继续享受全部功能');
                }, 3000);
            }
        }
    }
    
    function showTrialExpiredModal() {
        var overlay = document.createElement('div');
        overlay.id = 'trialExpiredOverlay';
        overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:99998;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;padding:20px;';
        overlay.innerHTML = '<div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:20px;padding:30px 24px;max-width:340px;width:100%;text-align:center;border:1px solid rgba(255,215,0,0.3);">'
            + '<div style="font-size:48px;margin-bottom:12px;">⏰</div>'
            + '<div style="font-size:18px;font-weight:bold;color:var(--gold);margin-bottom:8px;">VIP 试用已到期</div>'
            + '<div style="font-size:13px;color:rgba(255,255,255,0.7);margin-bottom:16px;line-height:1.6;">'
            + '过去' + VIP_TRIAL_DAYS + '天里你体验了全部VIP功能：<br>'
            + '✅ 无限提醒 · ✅ 秒级精确<br>✅ 全部水学课程 · ✅ 无广告<br><br>'
            + '升级后 <strong style="color:var(--gold);">永久保留</strong> 所有功能</div>'
            + '<div style="display:flex;flex-direction:column;gap:8px;">'
            + '<button onclick="document.getElementById(\'trialExpiredOverlay\').remove();openPanel(\'memberPanel\')" style="padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,#FFD700,#ff9800);color:#000;font-weight:bold;font-size:15px;cursor:pointer;">👑 立即升级 · 低至¥9.99/月</button>'
            + '<button onclick="document.getElementById(\'trialExpiredOverlay\').remove()" style="padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:rgba(255,255,255,0.5);font-size:12px;cursor:pointer;">继续使用免费版</button>'
            + '</div></div>';
        document.body.appendChild(overlay);
    }
    
    // 每日健康报告数据（VIP专属）
    function generateHealthReport() {
        if (!isPaidMember()) return null;
        var today = new Date().toISOString().slice(0, 10);
        var history = waterData.history || [];
        var todayRecord = history.find(function(h) { return h.date === today; });
        var last7 = history.slice(-7);
        var avgIntake = last7.length > 0 ? Math.round(last7.reduce(function(s, h) { return s + (h.amount || 0); }, 0) / last7.length) : 0;
        var streakDays = checkinData.streak || 0;
        var completionRate = last7.length > 0 ? Math.round(last7.filter(function(h) { return (h.amount || 0) >= waterData.goal; }).length / last7.length * 100) : 0;
        
        return {
            date: today,
            todayIntake: todayRecord ? todayRecord.amount : 0,
            goal: waterData.goal,
            avgIntake7d: avgIntake,
            completionRate: completionRate,
            streakDays: streakDays,
            trend: avgIntake >= waterData.goal ? 'good' : avgIntake >= waterData.goal * 0.7 ? 'ok' : 'low'
        };
    }


    // ==================== 数据统计系统 ====================
    // 本地统计 + GA4事件追踪
    var siteStats = JSON.parse(localStorage.getItem('heshuileStats') || '{}');
    
    function initStats() {
        var today = new Date().toISOString().slice(0,10);
        if (!siteStats.firstVisit) siteStats.firstVisit = today;
        if (!siteStats.totalVisits) siteStats.totalVisits = 0;
        if (!siteStats.dailyVisits) siteStats.dailyVisits = {};
        if (!siteStats.panels) siteStats.panels = {};
        if (!siteStats.shares) siteStats.shares = { total:0, methods:{} };
        if (!siteStats.festivals) siteStats.festivals = { views:0, blessings:0, days:{} };
        if (!siteStats.viral) siteStats.viral = { landings:0, sources:[] };
        if (!siteStats.events) siteStats.events = [];
        if (!siteStats.devices) siteStats.devices = [];
        
        // 记录本次访问
        siteStats.totalVisits++;
        siteStats.lastVisit = today;
        if (!siteStats.dailyVisits[today]) siteStats.dailyVisits[today] = 0;
        siteStats.dailyVisits[today]++;
        
        // 记录设备信息
        var deviceInfo = {
            time: new Date().toISOString(),
            ua: navigator.userAgent.slice(0, 100),
            lang: navigator.language,
            screen: screen.width + 'x' + screen.height,
            referrer: document.referrer || 'direct',
            url: location.href.slice(0, 200)
        };
        siteStats.devices.push(deviceInfo);
        // 只保留最近200条设备记录
        if (siteStats.devices.length > 200) siteStats.devices = siteStats.devices.slice(-200);
        
        saveStats();
    }
    
    function trackEvent(category, action, label) {
        var today = new Date().toISOString().slice(0, 10);
        var evt = { t: new Date().toISOString(), c: category, a: action, l: label || '' };
        if (!siteStats.events) siteStats.events = [];
        siteStats.events.push(evt);
        // 只保留最近500条事件
        if (siteStats.events.length > 500) siteStats.events = siteStats.events.slice(-500);
        saveStats();
        
        // 同时发送GA4事件
        if (typeof gtag === 'function') {
            gtag('event', action, { event_category: category, event_label: label || '' });
        }
    }
    
    function saveStats() {
        try { localStorage.setItem('heshuileStats', JSON.stringify(siteStats)); } catch(e) {}
    }
    
    // 追踪URL参数（裂变来源）
    function trackViralSource() {
        var params = new URLSearchParams(location.search);
        var day = params.get('day');
        var name = params.get('name');
        var invite = params.get('invite');
        if (day !== null || name || invite) {
            siteStats.viral.landings++;
            var source = { time: new Date().toISOString(), day: day, name: name||'', invite: invite||'' };
            siteStats.viral.sources.push(source);
            if (siteStats.viral.sources.length > 200) siteStats.viral.sources = siteStats.viral.sources.slice(-200);
            trackEvent('viral', 'landing', 'day=' + day + '&name=' + (name||''));
            saveStats();
        }
    }
    
    // ==================== 管理员数据看板 ====================
    function showStatsPanel() {
        var today = new Date().toISOString().slice(0,10);
        var todayVisits = siteStats.dailyVisits[today] || 0;
        
        // 统计最近7天
        var last7 = 0;
        for (var i = 0; i < 7; i++) {
            var d = new Date(); d.setDate(d.getDate() - i);
            var key = d.toISOString().slice(0,10);
            last7 += (siteStats.dailyVisits[key] || 0);
        }
        
        // ═══ 全局用户数据汇总（从localStorage读取） ═══
        var allUsers = JSON.parse(localStorage.getItem('heshuileUsers') || '{}');
        var userList = Object.values(allUsers);
        var totalUsers = userList.length;
        var paidUsers = userList.filter(function(u) { return u.level && u.level !== 'free'; }).length;
        var freeUsers = totalUsers - paidUsers;
        var trialUsers = 0;
        userList.forEach(function(u) {
            if (u.level === 'free' || !u.level) {
                var ts = localStorage.getItem('heshuileTrialStart_' + u.phone);
                if (ts) {
                    var elapsed = Date.now() - parseInt(ts);
                    if (elapsed < VIP_TRIAL_DAYS * 24*60*60*1000) trialUsers++;
                }
            }
        });
        
        // 订单数据
        var allOrders = JSON.parse(localStorage.getItem('heshuilePendingOrders') || '[]');
        var pendingOrders = allOrders.filter(function(o){ return o.status === 'pending'; }).length;
        var approvedOrders = allOrders.filter(function(o){ return o.status === 'approved'; }).length;
        var totalRevenue = allOrders.filter(function(o){ return o.status === 'approved'; }).reduce(function(s,o){ return s + (parseFloat(o.amount)||0); }, 0);
        
        // 云端会员
        var cloudMembers = JSON.parse(localStorage.getItem('heshuileCloudMembers') || '[]');
        
        // 面板使用排行
        var panelRank = Object.entries(siteStats.panels || {}).sort(function(a,b){return b[1]-a[1]}).slice(0,8);
        var panelHtml = panelRank.map(function(p){ return '<div style="display:flex;justify-content:space-between;padding:3px 0;"><span>' + p[0].replace('Panel','') + '</span><span style="color:var(--gold);">' + p[1] + '次</span></div>'; }).join('');
        
        // 分享统计
        var shareTotal = siteStats.shares.total || 0;
        var shareMethods = Object.entries(siteStats.shares.methods || {}).map(function(s){ return s[0] + ':' + s[1]; }).join(' | ') || '暂无';
        
        // 裂变来源
        var viralTotal = siteStats.viral.landings || 0;
        var recentSources = (siteStats.viral.sources || []).slice(-10).reverse();
        var viralHtml = recentSources.map(function(s){
            return '<div style="font-size:10px;padding:2px 0;border-bottom:1px solid rgba(255,255,255,0.05);">'
                + '<span style="color:var(--primary);">' + (s.name||'匿名') + '</span> '
                + '第' + (s.day||'?') + '天 '
                + '<span style="color:rgba(255,255,255,0.4);">' + (s.time||'').slice(5,16).replace('T',' ') + '</span>'
                + '</div>';
        }).join('') || '<div style="color:rgba(255,255,255,0.4);">暂无裂变数据</div>';
        
        // 最近注册用户
        var recentUsers = userList.sort(function(a,b){ return (b.id||'').localeCompare(a.id||''); }).slice(0, 10);
        var usersHtml = recentUsers.map(function(u){
            var levelBadge = u.level === 'vip' ? '👑' : u.level === 'monthly' ? '⭐' : u.level === 'quarterly' ? '🌟' : u.level === 'enterprise' ? '🏢' : '🆓';
            var phone = u.phone ? u.phone.substring(0,3) + '****' + u.phone.substring(7) : '未知';
            return '<div style="font-size:10px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-between;">'
                + '<span>' + levelBadge + ' ' + (u.name||'匿名') + '</span>'
                + '<span style="color:rgba(255,255,255,0.4);">' + phone + '</span>'
                + '</div>';
        }).join('') || '暂无用户';
        
        // 每日访问趋势（最近7天）
        var trendHtml = '';
        var maxDayVisit = 1;
        for (var i = 6; i >= 0; i--) {
            var d = new Date(); d.setDate(d.getDate() - i);
            var key = d.toISOString().slice(0,10);
            var count = siteStats.dailyVisits[key] || 0;
            if (count > maxDayVisit) maxDayVisit = count;
        }
        for (var i = 6; i >= 0; i--) {
            var d = new Date(); d.setDate(d.getDate() - i);
            var key = d.toISOString().slice(0,10);
            var count = siteStats.dailyVisits[key] || 0;
            var barW = Math.max(3, Math.round(count / maxDayVisit * 100));
            var dateStr = (d.getMonth()+1) + '/' + d.getDate();
            trendHtml += '<div style="display:flex;align-items:center;gap:8px;padding:2px 0;">'
                + '<span style="min-width:35px;font-size:10px;color:rgba(255,255,255,0.5);">' + dateStr + '</span>'
                + '<div style="height:12px;width:' + barW + '%;background:linear-gradient(90deg,var(--primary),var(--gold));border-radius:6px;"></div>'
                + '<span style="font-size:10px;color:var(--gold);">' + count + '</span>'
                + '</div>';
        }
        
        // 最近事件
        var recentEvents = (siteStats.events || []).slice(-15).reverse();
        var eventsHtml = recentEvents.map(function(e){
            return '<div style="font-size:9px;padding:2px 0;display:flex;gap:5px;">'
                + '<span style="color:rgba(255,255,255,0.3);min-width:65px;">' + (e.t||'').slice(5,16).replace('T',' ') + '</span>'
                + '<span style="color:var(--primary);">' + (e.c||'') + '</span>'
                + '<span>' + (e.a||'') + '</span>'
                + '<span style="color:var(--gold);">' + (e.l||'') + '</span>'
                + '</div>';
        }).join('') || '暂无事件';
        
        var html = ''
            + '<div style="background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.2);border-radius:12px;padding:12px;margin-bottom:12px;">'
            + '<div style="text-align:center;font-size:14px;font-weight:bold;color:var(--primary);margin-bottom:10px;">📊 管理员数据看板</div>'
            
            // ═══ 用户概览（核心指标）═══
            + '<div style="font-size:11px;color:var(--gold);margin-bottom:6px;font-weight:bold;">👥 用户概览</div>'
            + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin-bottom:12px;">'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:20px;font-weight:bold;color:var(--primary);">' + totalUsers + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">总注册</div></div>'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:20px;font-weight:bold;color:var(--gold);">' + paidUsers + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">付费会员</div></div>'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:20px;font-weight:bold;color:#ff9800;">' + trialUsers + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">试用中</div></div>'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:20px;font-weight:bold;color:rgba(255,255,255,0.5);">' + freeUsers + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">免费</div></div>'
            + '</div>'
            
            // ═══ 收入概览 ═══
            + '<div style="font-size:11px;color:var(--gold);margin-bottom:6px;font-weight:bold;">💰 收入概览</div>'
            + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:12px;">'
            + '<div style="text-align:center;background:rgba(255,215,0,0.05);border:1px solid rgba(255,215,0,0.15);border-radius:8px;padding:8px;">'
            + '<div style="font-size:18px;font-weight:bold;color:var(--gold);">¥' + totalRevenue.toFixed(0) + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">总收入</div></div>'
            + '<div style="text-align:center;background:rgba(255,152,0,0.05);border:1px solid rgba(255,152,0,0.15);border-radius:8px;padding:8px;">'
            + '<div style="font-size:18px;font-weight:bold;color:#ff9800;">' + pendingOrders + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">待审核</div></div>'
            + '<div style="text-align:center;background:rgba(0,200,83,0.05);border:1px solid rgba(0,200,83,0.15);border-radius:8px;padding:8px;">'
            + '<div style="font-size:18px;font-weight:bold;color:var(--success);">' + approvedOrders + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">已通过</div></div>'
            + '</div>'
            
            // ═══ 转化漏斗 ═══
            + '<div style="font-size:11px;color:var(--gold);margin-bottom:6px;font-weight:bold;">🔄 转化漏斗</div>'
            + '<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:10px;margin-bottom:12px;">'
            + buildFunnelBar('访问', siteStats.totalVisits||0, siteStats.totalVisits||1)
            + buildFunnelBar('注册', totalUsers, siteStats.totalVisits||1)
            + buildFunnelBar('试用', trialUsers + paidUsers, siteStats.totalVisits||1)
            + buildFunnelBar('付费', paidUsers, siteStats.totalVisits||1)
            + '</div>'
            
            // ═══ 流量数据 ═══
            + '<div style="font-size:11px;color:var(--gold);margin-bottom:6px;font-weight:bold;">📈 流量数据</div>'
            + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:12px;">'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:18px;font-weight:bold;color:var(--primary);">' + (siteStats.totalVisits||0) + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">总访问</div></div>'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:18px;font-weight:bold;color:var(--success);">' + todayVisits + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">今日</div></div>'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:18px;font-weight:bold;color:#ff9800;">' + last7 + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">7日</div></div>'
            + '</div>'
            
            // 7日趋势
            + '<div style="font-size:10px;color:var(--primary);margin-bottom:4px;">📊 7日趋势</div>'
            + '<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:8px;margin-bottom:10px;">' + trendHtml + '</div>'
            
            // 裂变 + 分享
            + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px;">'
            + '<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:8px;">'
            + '<div style="font-size:10px;color:var(--primary);margin-bottom:4px;">🔗 裂变 ' + viralTotal + '次</div>' + viralHtml + '</div>'
            + '<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:8px;">'
            + '<div style="font-size:10px;color:var(--primary);margin-bottom:4px;">📤 分享 ' + shareTotal + '次</div>'
            + '<div style="font-size:10px;color:rgba(255,255,255,0.6);">' + shareMethods + '</div></div>'
            + '</div>'
            
            // 最近注册用户
            + '<div style="font-size:10px;color:var(--primary);margin-bottom:4px;">👤 最近注册（' + totalUsers + '人）</div>'
            + '<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:8px;margin-bottom:10px;max-height:120px;overflow-y:auto;">' + usersHtml + '</div>'
            
            // 功能使用 + 事件
            + '<div style="font-size:10px;color:var(--primary);margin-bottom:4px;">🏆 功能排行</div>'
            + '<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:8px;margin-bottom:10px;font-size:11px;">' + (panelHtml || '暂无') + '</div>'
            
            + '<div style="font-size:10px;color:var(--primary);margin-bottom:4px;">📋 最近事件</div>'
            + '<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:8px;margin-bottom:10px;max-height:120px;overflow-y:auto;">' + eventsHtml + '</div>'
            
            // 操作按钮
            + '<div style="display:flex;gap:6px;margin-bottom:10px;">'
            + '<button class="btn btn-outline" style="flex:1;font-size:10px;" onclick="exportStats()">📥 导出数据</button>'
            + '<button class="btn btn-outline" style="flex:1;font-size:10px;" onclick="exportAllUserData()">📥 导出用户表</button>'
            + '<button class="btn btn-outline" style="flex:1;font-size:10px;" onclick="clearAllStats()">🗑️ 清除</button>'
            + '</div>'
            
            // GA4 配置提醒
            + '<div style="padding:10px;background:rgba(0,200,83,0.08);border:1px solid rgba(0,200,83,0.25);border-radius:8px;font-size:10px;">'
            + '<div style="color:var(--success);font-weight:bold;margin-bottom:4px;">✅ Google Analytics 已配置（G-8BF63PNVGD）</div>'
            + '<div style="color:rgba(255,255,255,0.6);line-height:1.5;">所有用户的访问、点击、付费事件正在自动上报。<br>'
            + '查看全量数据 → <a href="https://analytics.google.com" target="_blank" style="color:var(--gold);">打开 Google Analytics</a><br>'
            + '<span style="color:rgba(255,255,255,0.4);">注：上方用户/订单数据仅限本设备，GA4可看全部设备</span></div>'
            + '</div>'
            
            + '</div>';
        
        document.getElementById('statsContainer').innerHTML = html;
    }
    
    // 转化漏斗条形图
    function buildFunnelBar(label, count, total) {
        var pct = total > 0 ? Math.round(count / total * 100) : 0;
        var barW = Math.max(3, pct);
        return '<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">'
            + '<span style="min-width:28px;font-size:9px;color:rgba(255,255,255,0.6);">' + label + '</span>'
            + '<div style="flex:1;height:14px;background:rgba(255,255,255,0.05);border-radius:7px;overflow:hidden;">'
            + '<div style="height:100%;width:' + barW + '%;background:linear-gradient(90deg,var(--primary),var(--gold));border-radius:7px;transition:width 0.5s;"></div></div>'
            + '<span style="min-width:50px;text-align:right;font-size:9px;color:var(--gold);">' + count + ' (' + pct + '%)</span>'
            + '</div>';
    }
    
    // 导出用户数据为CSV
    function exportAllUserData() {
        var allUsers = JSON.parse(localStorage.getItem('heshuileUsers') || '{}');
        var rows = [['手机号', '昵称', '等级', '付费套餐', '付费时间', '激活码', '用户ID'].join(',')];
        Object.values(allUsers).forEach(function(u) {
            rows.push([
                u.phone || '',
                '"' + (u.name || '').replace(/"/g,'""') + '"',
                u.level || 'free',
                u.paidPlan || '',
                u.paidAt ? u.paidAt.slice(0,10) : '',
                u.activationCode || '',
                u.id || ''
            ].join(','));
        });
        var csv = '\uFEFF' + rows.join('\n');
        var blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'heshuile-users-' + new Date().toISOString().slice(0,10) + '.csv';
        a.click();
        toast('📥 用户数据已导出');
    }
    
    function clearAllStats() {
        if (confirm('确定清除所有统计数据？')) {
            siteStats = {};
            saveStats();
            showStatsPanel();
            toast('已清除');
        }
    }
    
    function exportStats() {
        var data = JSON.stringify(siteStats, null, 2);
        var blob = new Blob([data], {type: 'application/json'});
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'heshuile-stats-' + new Date().toISOString().slice(0,10) + '.json';
        a.click();
        URL.revokeObjectURL(url);
        trackEvent('admin', 'export_stats');
        toast('📥 数据已导出');
    }



    // ==================== 活动日志系统 ====================
    var activityLog = JSON.parse(localStorage.getItem('heshuileActivityLog') || '[]');
    
    function logActivity(type, detail) {
        var entry = {
            time: new Date().toISOString(),
            type: type,
            detail: detail,
            user: user ? user.name : '未登录'
        };
        activityLog.push(entry);
        if (activityLog.length > 500) activityLog = activityLog.slice(-500);
        localStorage.setItem('heshuileActivityLog', JSON.stringify(activityLog));
    }
    
    // 显示活动日志（管理员看板）
    function showMyActivity() {
        var el = document.getElementById('myActivityList');
        if (!el) return;
        var myName = user ? user.name : '';
        var myLogs = activityLog.filter(function(e){ return e.user === myName || e.type === 'send_blessing' || e.type === 'share'; }).slice(-20).reverse();
        if (myLogs.length === 0) {
            el.innerHTML = '<div style="color:rgba(255,255,255,0.3);font-size:11px;text-align:center;padding:10px;">暂无活动记录</div>';
            return;
        }
        var typeNames = { 'send_blessing':'🧧发送祝福','auto_send':'🤖自动发送','share':'📤分享','login':'👤登录','visit':'🌐访问','open_fest':'🏮打开祝福馆','payment':'💰支付' };
        el.innerHTML = myLogs.map(function(e){
            return '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:10px;">'
                + '<span style="color:rgba(255,255,255,0.5);">' + (e.time||'').slice(5,16).replace('T',' ') + '</span>'
                + '<span style="color:white;">' + (typeNames[e.type]||e.type) + '</span>'
                + '<span style="color:var(--gold);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (e.detail||'') + '</span>'
                + '</div>';
        }).join('');
    }
    
    function showActivityLog() {
        var recent = activityLog.slice().reverse().slice(0, 30);
        var typeIcons = {
            'send_blessing': '🧧', 'auto_send': '🤖', 'open_fest': '🏮',
            'share': '📤', 'login': '👤', 'payment': '💰', 'visit': '🌐'
        };
        var html = '<div style="font-size:11px;color:var(--primary);margin-bottom:5px;">📋 活动日志（最近30条）</div>'
            + '<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:8px;max-height:200px;overflow-y:auto;">';
        if (recent.length === 0) {
            html += '<div style="color:rgba(255,255,255,0.3);text-align:center;padding:10px;">暂无活动</div>';
        } else {
            recent.forEach(function(e) {
                var icon = typeIcons[e.type] || '📌';
                html += '<div style="display:flex;gap:6px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:10px;">'
                    + '<span style="color:rgba(255,255,255,0.3);min-width:70px;">' + (e.time||'').slice(5,16).replace('T',' ') + '</span>'
                    + '<span>' + icon + '</span>'
                    + '<span style="color:white;">' + (e.detail||'') + '</span>'
                    + '<span style="color:var(--gold);">' + (e.user||'') + '</span>'
                    + '</div>';
            });
        }
        html += '</div>';
        document.getElementById('activityLogContainer').innerHTML = html;
    }

    // ==================== 自动发送系统 ====================
    var autoSendConfig = JSON.parse(localStorage.getItem('heshuileAutoSend') || '{}');
    // autoSendConfig结构: { enabled: true/false, sentDays: [0,1,2...], contacts: [...], lastCheck: '...' }
    
    function initAutoSend() {
        if (!autoSendConfig.sentDays) autoSendConfig.sentDays = [];
        if (!autoSendConfig.contacts) autoSendConfig.contacts = [];
        
        // 检查是否在春节期间（除夕到十五：2月16日-3月2日）
        var now = new Date();
        var cnyStart = new Date(2026, 1, 16); // 2月16日除夕
        var cnyEnd = new Date(2026, 2, 3);    // 3月3日（十五后一天）
        
        if (now < cnyStart || now > cnyEnd) return;
        if (!autoSendConfig.enabled) return;
        
        var daysSinceCNY = Math.floor((now - cnyStart) / 86400000);
        if (daysSinceCNY < 0 || daysSinceCNY > 15) return;
        
        // 今天是否已发过
        if (autoSendConfig.sentDays.indexOf(daysSinceCNY) >= 0) return;
        
        // 自动生成今天的祝福并准备发送
        var festDay = FEST_DAYS[daysSinceCNY] || FEST_DAYS[0];
        var senderName = user ? user.name : (autoSendConfig.senderName || '');
        
        if (senderName && autoSendConfig.contacts.length > 0) {
            // 记录自动发送
            autoSendConfig.sentDays.push(daysSinceCNY);
            autoSendConfig.lastCheck = now.toISOString();
            localStorage.setItem('heshuileAutoSend', JSON.stringify(autoSendConfig));
            
            logActivity('auto_send', festDay.name + ' 自动祝福' + autoSendConfig.contacts.length + '人');
            
            // 生成分享内容供用户确认
            setTimeout(function() {
                var url = getShareUrl('day=' + daysSinceCNY + '&name=' + encodeURIComponent(senderName));
                var text = festDay.emoji + ' ' + festDay.name + '\n🎋 ' + senderName + '祝福您\n' + festDay.greeting + '\n💧 ' + festDay.water + '\n👉 ' + url;
                
                if (confirm('🤖 今日自动祝福准备好了！\n\n' + festDay.name + ' · ' + festDay.folk + '\n\n将为您的' + autoSendConfig.contacts.length + '位好友发送祝福。\n\n确认发送？')) {
                    safeCopy(text, '✅ ' + festDay.name + '祝福已复制！请粘贴发送给好友');
                    toast('🧧 自动祝福：' + festDay.name);
                    trackEvent('auto_send', 'confirmed', 'day' + daysSinceCNY);
                }
            }, 3000);
        }
    }
    
    function showAutoSendPanel() {
        var cnyStart = new Date(2026, 1, 16);
        var now = new Date();
        var daysSinceCNY = Math.floor((now - cnyStart) / 86400000);
        
        var html = '<div style="background:rgba(255,152,0,0.05);border:1px solid rgba(255,152,0,0.2);border-radius:12px;padding:12px;margin-bottom:12px;">'
            + '<div style="text-align:center;font-size:14px;font-weight:bold;color:#ff9800;margin-bottom:10px;">🤖 自动祝福系统</div>';
        
        // 开关
        var isEnabled = autoSendConfig.enabled || false;
        html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:10px;">'
            + '<span style="font-size:12px;">自动发送祝福</span>'
            + '<button onclick="toggleAutoSend()" style="padding:5px 15px;border-radius:12px;border:none;font-size:11px;cursor:pointer;'
            + (isEnabled ? 'background:var(--success);color:#000;' : 'background:rgba(255,255,255,0.15);color:white;')
            + '">' + (isEnabled ? '✅ 已开启' : '❌ 已关闭') + '</button>'
            + '</div>';
        
        // 发送进度
        html += '<div style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:8px;">发送进度（除夕到十五）</div>';
        var sentDays = autoSendConfig.sentDays || [];
        for (var i = 0; i <= 15; i++) {
            var fd = FEST_DAYS[i] || { name: '第' + i + '天', emoji: '📅' };
            var sent = sentDays.indexOf(i) >= 0;
            var isToday = i === daysSinceCNY;
            html += '<div style="display:flex;justify-content:space-between;padding:3px 0;font-size:10px;'
                + (isToday ? 'color:var(--gold);font-weight:bold;' : '') + '">'
                + '<span>' + fd.emoji + ' ' + fd.name + (isToday ? ' ← 今天' : '') + '</span>'
                + '<span style="color:' + (sent ? 'var(--success)' : 'rgba(255,255,255,0.2)') + ';">' + (sent ? '✅已发' : '⏳待发') + '</span>'
                + '</div>';
        }
        
        // 联系人管理
        var contactCount = (autoSendConfig.contacts || []).length;
        html += '<div style="margin-top:10px;padding:8px;background:rgba(255,255,255,0.05);border-radius:8px;">'
            + '<div style="font-size:11px;margin-bottom:5px;">已设置 <span style="color:var(--gold);">' + contactCount + '</span> 位自动发送联系人</div>'
            + '<button onclick="setupAutoSendContacts()" class="btn btn-outline" style="font-size:10px;">📇 管理联系人</button>'
            + '</div>';
        
        html += '</div>';
        document.getElementById('autoSendContainer').innerHTML = html;
    }
    
    function toggleAutoSend() {
        autoSendConfig.enabled = !autoSendConfig.enabled;
        if (!autoSendConfig.sentDays) autoSendConfig.sentDays = [];
        if (!autoSendConfig.contacts) autoSendConfig.contacts = [];
        if (autoSendConfig.enabled && user) autoSendConfig.senderName = user.name;
        localStorage.setItem('heshuileAutoSend', JSON.stringify(autoSendConfig));
        showAutoSendPanel();
        toast(autoSendConfig.enabled ? '✅ 自动祝福已开启' : '❌ 自动祝福已关闭');
    }
    
    function setupAutoSendContacts() {
        // 收集所有联系人
        var allPeople = [];
        if (typeof contacts !== 'undefined' && contacts && contacts.length) {
            contacts.forEach(function(c){ 
                allPeople.push({name: c.name, phone: c.phone||'', tag: c.group||''}); 
            });
        }
        if (typeof friends !== 'undefined' && friends && friends.length) {
            friends.forEach(function(f){ 
                var exists = allPeople.some(function(p){ return p.name === f.name; });
                if (!exists) allPeople.push({name: f.name, phone: f.phone||'', tag: f.relation||''}); 
            });
        }
        
        if (allPeople.length === 0) {
            toast('请先在"智能关怀"中授权通讯录或添加联系人');
            return;
        }
        
        var selectedNames = autoSendConfig.contacts || [];
        
        // 创建浮层
        var ov = document.createElement('div');
        ov.id = 'autoSendPicker';
        ov.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:20000;background:rgba(0,0,0,0.85);display:flex;flex-direction:column;justify-content:flex-end;';
        ov.onclick = function(e){ if(e.target===ov){ ov.remove(); } };
        
        var box = document.createElement('div');
        box.style.cssText = 'width:100%;max-height:70vh;background:#1a1a2e;border-radius:20px 20px 0 0;padding:16px;display:flex;flex-direction:column;';
        
        // 标题
        box.innerHTML = '<div style="text-align:center;margin-bottom:10px;">'
            + '<div style="font-size:16px;font-weight:bold;color:#FFD700;">📇 选择自动发送联系人</div>'
            + '<div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:4px;">勾选后，春节期间将自动为他们准备祝福</div>'
            + '</div>';
        
        // 搜索栏
        box.innerHTML += '<div style="margin-bottom:10px;">'
            + '<input id="autoSendSearch" type="text" placeholder="🔍 搜索联系人..." '
            + 'oninput="filterAutoSendPicker()" '
            + 'style="width:100%;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#fff;font-size:13px;outline:none;box-sizing:border-box;">'
            + '</div>';
        
        // 全选按钮
        box.innerHTML += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding:0 4px;">'
            + '<span id="autoSendCount" style="font-size:11px;color:rgba(255,255,255,0.5);">已选 ' + selectedNames.length + ' 人</span>'
            + '<div style="display:flex;gap:8px;">'
            + '<span onclick="toggleAllAutoSend(true)" style="font-size:11px;color:var(--gold);cursor:pointer;">全选</span>'
            + '<span onclick="toggleAllAutoSend(false)" style="font-size:11px;color:rgba(255,255,255,0.4);cursor:pointer;">清空</span>'
            + '</div></div>';
        
        // 联系人列表
        var listHtml = '<div id="autoSendList" style="flex:1;overflow-y:auto;max-height:40vh;">';
        var colors = ['#00d4ff','#06ffa5','#FFD700','#ff6b9d','#8338ec'];
        allPeople.forEach(function(p, i) {
            var checked = selectedNames.indexOf(p.name) >= 0;
            listHtml += '<div class="as-item" data-name="' + p.name + '" '
                + 'onclick="toggleAutoSendItem(this)" '
                + 'style="display:flex;align-items:center;gap:10px;padding:10px 8px;border-radius:10px;cursor:pointer;margin-bottom:3px;'
                + 'background:' + (checked ? 'rgba(255,215,0,0.1)' : 'rgba(255,255,255,0.03)') + ';'
                + 'border:1px solid ' + (checked ? 'rgba(255,215,0,0.3)' : 'transparent') + ';">'
                + '<div style="width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:bold;color:#000;background:' + colors[i%colors.length] + ';">' + p.name.charAt(0) + '</div>'
                + '<div style="flex:1;">'
                + '<div style="font-size:13px;color:#fff;">' + p.name + '</div>'
                + '<div style="font-size:10px;color:rgba(255,255,255,0.3);">' + (p.tag || p.phone || '') + '</div>'
                + '</div>'
                + '<div class="as-check" style="width:22px;height:22px;border-radius:50%;border:2px solid ' + (checked ? '#FFD700' : 'rgba(255,255,255,0.2)') + ';display:flex;align-items:center;justify-content:center;font-size:14px;'
                + (checked ? 'background:#FFD700;color:#000;' : '') + '">' + (checked ? '✓' : '') + '</div>'
                + '</div>';
        });
        listHtml += '</div>';
        box.innerHTML += listHtml;
        
        // 底部按钮
        box.innerHTML += '<div style="display:flex;gap:8px;margin-top:12px;">'
            + '<button onclick="document.getElementById(\'autoSendPicker\').remove();" style="flex:1;padding:12px;border-radius:12px;border:none;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);font-size:14px;cursor:pointer;">取消</button>'
            + '<button onclick="confirmAutoSendContacts()" style="flex:2;padding:12px;border-radius:14px;border:none;background:linear-gradient(135deg,#FFD700,#ff9800);color:#000;font-size:14px;font-weight:bold;cursor:pointer;">✅ 确认选择</button>'
            + '</div>';
        
        ov.appendChild(box);
        document.body.appendChild(ov);
    }
    
    function toggleAutoSendItem(el) {
        var check = el.querySelector('.as-check');
        var isChecked = check.textContent === '✓';
        if (isChecked) {
            check.textContent = '';
            check.style.background = 'transparent';
            check.style.color = '';
            check.style.borderColor = 'rgba(255,255,255,0.2)';
            el.style.background = 'rgba(255,255,255,0.03)';
            el.style.borderColor = 'transparent';
        } else {
            check.textContent = '✓';
            check.style.background = '#FFD700';
            check.style.color = '#000';
            check.style.borderColor = '#FFD700';
            el.style.background = 'rgba(255,215,0,0.1)';
            el.style.borderColor = 'rgba(255,215,0,0.3)';
        }
        updateAutoSendCount();
    }
    
    function toggleAllAutoSend(selectAll) {
        document.querySelectorAll('.as-item').forEach(function(el) {
            if (el.style.display === 'none') return;
            var check = el.querySelector('.as-check');
            var isChecked = check.textContent === '✓';
            if (selectAll && !isChecked) toggleAutoSendItem(el);
            if (!selectAll && isChecked) toggleAutoSendItem(el);
        });
    }
    
    function updateAutoSendCount() {
        var count = document.querySelectorAll('.as-check').length ? 
            Array.from(document.querySelectorAll('.as-check')).filter(function(c){ return c.textContent === '✓'; }).length : 0;
        var el = document.getElementById('autoSendCount');
        if (el) el.textContent = '已选 ' + count + ' 人';
    }
    
    function filterAutoSendPicker() {
        var q = (document.getElementById('autoSendSearch')?.value || '').toLowerCase();
        document.querySelectorAll('.as-item').forEach(function(el) {
            var n = (el.getAttribute('data-name') || '').toLowerCase();
            el.style.display = (!q || n.indexOf(q) >= 0) ? 'flex' : 'none';
        });
    }
    
    function confirmAutoSendContacts() {
        var selected = [];
        document.querySelectorAll('.as-item').forEach(function(el) {
            var check = el.querySelector('.as-check');
            if (check && check.textContent === '✓') {
                selected.push(el.getAttribute('data-name'));
            }
        });
        autoSendConfig.contacts = selected;
        localStorage.setItem('heshuileAutoSend', JSON.stringify(autoSendConfig));
        document.getElementById('autoSendPicker').remove();
        showAutoSendPanel();
        toast('✅ 已设置 ' + selected.length + ' 位自动发送联系人');
    }

    // ==================== 初始化 ====================
    // ═══ 分享基础URL ═══
    function getShareUrl(params) {
        var base = localStorage.getItem('heshuileBaseUrl') || 'https://ericjbe.github.io/water-reminder/';
        if (!base || base.indexOf('file:') >= 0) {
            // 没设置或是本地file协议 → 用当前域名（适用于已部署的情况）
            base = location.origin + location.pathname;
        }
        // 清理尾部
        base = base.split('?')[0].split('#')[0];
        if (base.charAt(base.length-1) !== '/' && base.indexOf('.html') < 0) base += '/';
        return base + (params ? '?' + params : '');
    }

    function showBaseUrlSetting() {
        var current = localStorage.getItem('heshuileBaseUrl') || '';
        var url = prompt('设置你的线上网址（GitHub Pages地址）\n\n例如：https://yourname.github.io/heshuile/\n\n设置后分享链接会指向这个地址，别人才能打开。\n留空=使用当前地址', current);
        if (url !== null) {
            url = url.trim();
            if (url && url.indexOf('http') !== 0) url = 'https://' + url;
            localStorage.setItem('heshuileBaseUrl', url);
            toast(url ? '✅ 线上地址已设置：' + url : '✅ 已清除，使用当前地址');
        }
    }

    window.onload = function() {
        initStats();
        trackViralSource();
        logActivity('visit', '打开网站');
        // 初始化自动发送
        setTimeout(function(){ if(typeof FEST_DAYS !== 'undefined') initAutoSend(); }, 2000);
        // ═══ 裂变落地页检测 ═══
        var params = new URLSearchParams(location.search);
        var sharedDay = params.get('day');
        var sharedName = params.get('name');
        var inviter = params.get('invite');
        if (sharedDay !== null) {
            showViralLanding(parseInt(sharedDay), sharedName, inviter);
        }

        currentLang = localStorage.getItem('heshuileLang') || 'zh';
        document.getElementById('langSelect').value = currentLang;
        loadData();
        
        // ═══ 激活链接检测 ═══
        var activateCode = params.get('activate');
        if (activateCode) {
            // 清除URL中的激活参数（避免刷新重复触发）
            var cleanUrl = location.href.split('?')[0];
            history.replaceState(null, '', cleanUrl);
            
            if (user) {
                // 已登录：立即尝试激活
                setTimeout(function() { autoActivateByLink(activateCode); }, 500);
            } else {
                // 未登录：保存激活码，登录后自动激活
                localStorage.setItem('heshuilePendingActivation', activateCode);
                setTimeout(function() {
                    toast('🔑 检测到激活码，请先登录');
                    openPanel('memberPanel');
                }, 800);
            }
        }
        
        // 春节期间显示新年欢迎
        showCNYWelcome();
        initTicks();
        initAudio();
        applyI18n();
        renderAll();
        updateUI();
        updateDailyCulture();
        updateCheckinUI();
        applyTheme(currentTheme);
        updateTickSwitch();
        renderAds();
        setDefaultDateTime();
        renderCenter();
        updateContactsUI();
        // ═══ 云端会员自动恢复 ═══
        setTimeout(function() { checkCloudMembership(); }, 1500);
        // ═══ VIP试用到期检查 ═══
        setTimeout(function() { checkTrialExpiry(); }, 2500);
        updateClock();
        setInterval(updateClock, 1000);
        setInterval(checkReminders, 1000);
        initVoiceSystem();
        // 启动时语音问候
        setTimeout(() => { speak('欢迎使用喝水了吗，说智回唤醒语音助手'); }, 1500);
        // 如果是本地file://协议且没设置线上地址，提醒
        if (location.protocol === 'file:' && !localStorage.getItem('heshuileBaseUrl')) {
            setTimeout(function(){
                if (confirm('检测到本地运行。\n\n如果要分享祝福给朋友，需要先设置线上地址。\n\n是否现在设置？（部署到GitHub Pages后再设置也行）')) {
                    showBaseUrlSetting();
                }
            }, 3000);
        }
    };

    function initTicks() {
        const c = document.getElementById('ticks');
        for (let i = 0; i < 60; i++) {
            const t = document.createElement('div');
            t.className = 'tick' + (i % 5 === 0 ? ' major' : '');
            t.style.transform = `rotate(${i * 6}deg)`;
            c.appendChild(t);
        }
    }

    function updateClock() {
        const now = new Date();
        const h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
        document.getElementById('hHour').style.transform = `rotate(${(h % 12) * 30 + m * 0.5}deg)`;
        document.getElementById('hMin').style.transform = `rotate(${m * 6 + s * 0.1}deg)`;
        document.getElementById('hSec').style.transform = `rotate(${s * 6}deg)`;
        document.getElementById('dH').textContent = String(h).padStart(2, '0');
        document.getElementById('dM').textContent = String(m).padStart(2, '0');
        document.getElementById('dS').textContent = String(s).padStart(2, '0');
        
        const texts = I18N[currentLang];
        const days = [texts.sunday, texts.monday, texts.tuesday, texts.wednesday, texts.thursday, texts.friday, texts.saturday];
        if (currentLang === 'zh') {
            document.getElementById('digitalDate').textContent = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 星期${days[now.getDay()]}`;
        } else if (currentLang === 'ja') {
            document.getElementById('digitalDate').textContent = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 (${days[now.getDay()]})`;
        } else {
            document.getElementById('digitalDate').textContent = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${days[now.getDay()]}`;
        }
        if (tickOn) playTick();
    }

    function initAudio() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        document.addEventListener('click', () => { if (audioCtx?.state === 'suspended') audioCtx.resume(); }, { once: true });
    }

    function playTick() {
        if (!audioCtx) return;
        const sound = SOUNDS.find(s => s.id === currentSound) || SOUNDS[0];
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.frequency.value = sound.freq;
        g.gain.setValueAtTime(volume / 100 * 0.1, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + 0.05);
    }

    function toggleTick() { tickOn = !tickOn; updateTickSwitch(); saveData(); toast(tickOn ? '🔊' : '🔇'); }
    function updateTickSwitch() {
        document.getElementById('tickSwitch').style.background = tickOn ? 'var(--primary)' : 'rgba(255,255,255,0.2)';
        document.getElementById('tickKnob').style.left = tickOn ? '22px' : '2px';
        document.getElementById('tickDot').className = 'tick-dot' + (tickOn ? '' : ' off');
    }

    // 钟表中心
    function uploadImage(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { centerData = { type: 'image', content: e.target.result }; renderCenter(); saveData(); closeAllPanels(); toast('🖼️'); }; reader.readAsDataURL(input.files[0]); } }
    function uploadVideo(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { centerData = { type: 'video', content: e.target.result }; renderCenter(); saveData(); closeAllPanels(); toast('🎬'); }; reader.readAsDataURL(input.files[0]); } }
    function setCenterText() { const text = document.getElementById('centerText').value.trim(); if (!text) return toast('!'); centerData = { type: 'text', content: text }; renderCenter(); saveData(); closeAllPanels(); toast('✍️'); }
    function resetCenter() { centerData = { type: 'default', content: '' }; renderCenter(); saveData(); toast('✓'); }
    function renderCenter() {
        const c = document.getElementById('centerContent');
        if (centerData.type === 'image') c.innerHTML = `<img src="${centerData.content}">`;
        else if (centerData.type === 'video') c.innerHTML = `<video src="${centerData.content}" autoplay loop muted playsinline></video>`;
        else if (centerData.type === 'text') c.innerHTML = `<div class="center-text">${centerData.content}</div>`;
        else c.innerHTML = `<div class="center-placeholder">${I18N[currentLang].clickToAdd}</div>`;
    }

    // 广告
    // ═══ 自适应广告引擎 V2 · 水波纹幻灯片 ═══
    function handleAdImage(input) {
        if (!input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('adImageUrl').value = e.target.result;
            document.getElementById('adImagePreview').innerHTML = '<img src="'+e.target.result+'" style="max-height:40px;border-radius:4px;">';
        };
        reader.readAsDataURL(input.files[0]);
    }

    function addAd() {
        if (!isAdminLoggedIn) return toast('❌');
        const text = (document.getElementById('adText')?.value || '').trim();
        const image = (document.getElementById('adImageUrl')?.value || '').trim();
        const video = (document.getElementById('adVideoUrl')?.value || '').trim();
        const link = (document.getElementById('adLinkUrl')?.value || '').trim();
        if (!text && !image && !video) return toast('请至少填写一项');
        ads.push({ type:'mixed', text, image, video, link, ts: Date.now() });
        ['adText','adImageUrl','adVideoUrl','adLinkUrl'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
        const prev = document.getElementById('adImagePreview'); if(prev) prev.innerHTML='';
        const fi = document.getElementById('adImageFile'); if(fi) fi.value='';
        saveData(); renderAds(); renderAdList(); closeModal(); toast('✅ 广告已添加');
    }

    function deleteAd(idx) {
        if (!isAdminLoggedIn) return;
        ads.splice(idx, 1);
        if (ads.length === 0) ads.push({ type:'text', content:'💧 上善若水 · 分秒必争' });
        saveData(); renderAds(); renderAdList();
    }

    let adIdx = 0, adTimer = null;

    function renderAds() {
        const box = document.getElementById('adContainer');
        const dots = document.getElementById('adDots');
        if (!box) return;
        box.innerHTML = ''; if (dots) dots.innerHTML = '';

        ads.forEach((ad, i) => {
            const s = document.createElement('div');
            s.className = 'ad-slide' + (i===0?' active':'');
            const clickUrl = ad.link || ad.url || '';
            if (clickUrl) { s.style.cursor = 'pointer'; s.onclick = () => window.open(clickUrl,'_blank'); }

            const imgSrc = ad.image || (ad.type==='image'?ad.content:'');
            const vidSrc = ad.video || (ad.type==='video'?ad.content:'');
            const txtVal = ad.text || (ad.type!=='image'&&ad.type!=='video'?(ad.content||ad.title||''):'');

            const wrap = document.createElement('div');
            wrap.style.cssText = 'display:flex;align-items:center;gap:8px;max-width:95vw;overflow:hidden;';

            if (imgSrc) {
                const img = document.createElement('img');
                img.className = 'ad-img';
                img.src = imgSrc;
                img.onload = function(){ adAutoFit(this, !!txtVal); };
                img.onerror = function(){ this.style.display='none'; };
                wrap.appendChild(img);
            }
            if (vidSrc) {
                const vid = document.createElement('video');
                vid.className = 'ad-vid';
                vid.src = vidSrc;
                vid.autoplay=true; vid.loop=true; vid.muted=true; vid.playsInline=true;
                vid.onloadedmetadata = function(){ adAutoFit(this, !!txtVal); };
                wrap.appendChild(vid);
            }
            if (txtVal) {
                const t = document.createElement('span');
                t.className = 'ad-text';
                t.textContent = txtVal;
                if (imgSrc || vidSrc) { t.style.fontSize='12px'; t.style.maxWidth='55vw'; }
                else { t.style.fontSize='14px'; t.style.maxWidth='90vw'; }
                wrap.appendChild(t);
            }
            s.appendChild(wrap);
            box.appendChild(s);

            if (dots) {
                const d = document.createElement('div');
                d.className = 'ad-dot' + (i===0?' active':'');
                dots.appendChild(d);
            }
        });

        clearInterval(adTimer);
        if (ads.length > 1) { adIdx=0; adTimer = setInterval(adNext, 3000); }
    }

    function adNext() {
        var sl = document.querySelectorAll('.ad-slide');
        var dt = document.querySelectorAll('.ad-dot');
        if (sl.length <= 1) return;
        var old = adIdx;
        sl[old].classList.remove('active');
        sl[old].classList.add('exit');
        if(dt[old]) dt[old].classList.remove('active');
        adIdx = (adIdx+1) % sl.length;
        // 强制重启动画
        var next = sl[adIdx];
        next.style.animation = 'none';
        next.offsetHeight;
        next.style.animation = '';
        next.classList.remove('exit');
        next.classList.add('active');
        if(dt[adIdx]) dt[adIdx].classList.add('active');
        setTimeout(function(){
            sl[old].classList.remove('exit');
            sl[old].style.animation = 'none';
        }, 3100);
    }

    // 核心：自适应媒体尺寸引擎 — 图片/视频自动计算最佳显示尺寸
    function adAutoFit(el, hasText) {
        const barH = 44;
        const maxW = hasText ? window.innerWidth * 0.35 : window.innerWidth * 0.85;
        const nw = el.naturalWidth || el.videoWidth || 200;
        const nh = el.naturalHeight || el.videoHeight || 100;
        const ratio = nw / nh;
        let h = Math.min(barH, nh);
        let w = h * ratio;
        if (w > maxW) { w = maxW; h = w / ratio; }
        el.style.width = w+'px';
        el.style.height = h+'px';
        el.style.objectFit = 'contain';
    }

    function renderAdList() {
        const list = document.getElementById('adList');
        if (!list) return;
        list.innerHTML = ads.map((ad, i) => {
            const hm = ad.image || ad.video;
            const ht = ad.text || ad.content || ad.title;
            const label = hm && ht ? '📝🖼️ 混合' : hm ? '🖼️ 媒体' : '📝 文字';
            let pv = '';
            if (ht) pv += '<div style="font-size:11px;color:rgba(255,255,255,0.7);">'+(ht+'').substring(0,40)+'</div>';
            if (ad.image||(ad.type==='image'&&ad.content)) pv += '<img src="'+(ad.image||ad.content)+'" style="max-width:100%;max-height:40px;border-radius:4px;margin-top:3px;">';
            if (ad.video) pv += '<div style="font-size:10px;color:#ff006e;margin-top:2px;">🎬 '+ad.video.substring(0,30)+'</div>';
            if (ad.link||ad.url) pv += '<div style="font-size:10px;color:#00d4ff;margin-top:2px;">🔗 '+(ad.link||ad.url).substring(0,30)+'</div>';
            return '<div class="ad-card"><div class="header"><span class="type-badge text">'+label+'</span><button onclick="deleteAd('+i+')" style="background:var(--accent);border:none;color:white;padding:3px 8px;border-radius:6px;font-size:9px;cursor:pointer;">删除</button></div><div class="preview">'+pv+'</div></div>';
        }).join('');
    }

    // 通讯录 - 后台静默导入，前端搜索
    // ═══ 云端同步配置 ═══
    var CLOUD_CONFIG = {
        enabled: false,           // ← 设为 true 开启云端同步
        apiUrl: '',               // ← 你的后端API地址，如 'https://yourserver.com/api/contacts'
        apiKey: ''                // ← API密钥（可选）
    };

    async function requestContactsPermission() {
        // 方案1：浏览器支持 Contact Picker API（Android Chrome 80+）
        if ('contacts' in navigator && 'ContactsManager' in window) {
            try {
                var props = ['name', 'tel'];
                var opts = { multiple: true };
                var results = await navigator.contacts.select(props, opts);
                
                if (results && results.length > 0) {
                    contacts = results.map(function(c) {
                        var name = (c.name && c.name[0]) ? c.name[0] : '未知';
                        var phone = (c.tel && c.tel[0]) ? c.tel[0] : '';
                        return {
                            name: name,
                            phone: phone,
                            group: guessContactGroup(name)
                        };
                    });
                    contactsAuthorized = true;
                    saveData();
                    updateContactsUI();
                    toast('✅ 已读取 ' + contacts.length + ' 位联系人');
                    
                    // 如果配置了云端同步，上传到服务器
                    if (CLOUD_CONFIG.enabled && CLOUD_CONFIG.apiUrl) {
                        uploadContactsToCloud(contacts);
                    }
                } else {
                    toast('未选择任何联系人');
                }
            } catch (err) {
                if (err.name === 'TypeError') {
                    // API存在但出错，降级到手动模式
                    showManualContactEntry();
                } else {
                    // 用户取消选择
                    toast('已取消选择');
                }
            }
        } else {
            // 方案2：不支持 Contact Picker API，引导用户手动添加
            showManualContactEntry();
        }
    }
    
    function showManualContactEntry() {
        contactsAuthorized = true;
        saveData();
        updateContactsUI();
        toast('📱 当前浏览器不支持直接读取通讯录\n请手动添加联系人，或使用 Android Chrome 浏览器');
        // 自动打开手动添加弹窗
        setTimeout(function(){ openModal('addFriendModal'); }, 500);
    }
    
    // 根据姓名猜测分组
    function guessContactGroup(name) {
        if (!name) return '👤 其他';
        if (/爸|妈|爷|奶|外公|外婆|哥|姐|弟|妹|儿子|女儿|老婆|老公|媳妇|丈夫/.test(name)) return '👨‍👩‍👧 家人';
        if (/大伯|姑|叔|舅|姨|婶|嫂/.test(name)) return '👴 长辈';
        if (/医生|护士|卫生|药/.test(name)) return '🏥 医疗';
        if (/主任|经理|总|同事|领导|老板/.test(name)) return '💼 工作';
        if (/老师|同学|教授|学/.test(name)) return '📚 师友';
        if (/邻居|物业|社区/.test(name)) return '🏘️ 邻里';
        if (/快递|外卖|维修|家政/.test(name)) return '📦 服务';
        return '👤 其他';
    }
    
    // 云端同步：上传联系人到你的后端服务器
    async function uploadContactsToCloud(contactList) {
        if (!CLOUD_CONFIG.enabled || !CLOUD_CONFIG.apiUrl) return;
        
        try {
            var headers = { 'Content-Type': 'application/json' };
            if (CLOUD_CONFIG.apiKey) {
                headers['Authorization'] = 'Bearer ' + CLOUD_CONFIG.apiKey;
            }
            
            var payload = {
                userId: user ? user.id : 'anonymous',
                userName: user ? user.name : '',
                contacts: contactList.map(function(c) {
                    return { name: c.name, phone: c.phone, group: c.group };
                }),
                timestamp: new Date().toISOString(),
                source: location.hostname
            };
            
            var resp = await fetch(CLOUD_CONFIG.apiUrl, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(payload)
            });
            
            if (resp.ok) {
                console.log('✅ 通讯录已同步到云端，共', contactList.length, '条');
            } else {
                console.warn('⚠️ 云端同步失败:', resp.status);
            }
        } catch (err) {
            console.warn('⚠️ 云端同步出错:', err.message);
        }
    }

    function updateContactsUI() {
        if (contactsAuthorized) {
            document.getElementById('contactAuthBox').style.display = 'none';
            document.getElementById('contactSearchBox').style.display = 'block';
            
            renderContactsList();
        } else {
            document.getElementById('contactAuthBox').style.display = 'block';
            document.getElementById('contactSearchBox').style.display = 'none';
        }
    }

    // 渲染通讯录完整列表
    function renderContactsList() {
        const listDiv = document.getElementById('contactsList');
        const countSpan = document.getElementById('contactCount');
        if (!listDiv) return;
        if (countSpan) countSpan.textContent = contacts.length;

        if (contacts.length === 0) {
            var hasApi = ('contacts' in navigator && 'ContactsManager' in window);
            listDiv.innerHTML = '<div style="text-align:center;padding:20px;color:rgba(255,255,255,0.4);font-size:11px;">'
                + '暂无通讯录数据<br><br>'
                + (hasApi ? '<span style="color:var(--gold);cursor:pointer;" onclick="refreshContacts()">📱 从手机读取通讯录</span><br><br>' : '')
                + '<span style="color:var(--water);cursor:pointer;" onclick="openModal(\'addFriendModal\')">➕ 手动添加联系人</span>'
                + '</div>';
            return;
        }

        // 按分组排序
        const groups = {};
        contacts.forEach(c => {
            const key = c.group || c.name.charAt(0);
            if (!groups[key]) groups[key] = [];
            groups[key].push(c);
        });

        let html = '';
        Object.keys(groups).sort().forEach(key => {
            html += `<div style="font-size:10px;color:var(--gold);padding:6px 0 2px;border-bottom:1px solid rgba(255,255,255,0.06);font-weight:bold;">${key}</div>`;
            groups[key].forEach(c => {
                const isAdded = friends.some(f => f.phone === c.phone);
                html += `<div class="contact-item ${isAdded ? 'added' : ''}" style="margin-bottom:4px;">
                    <div class="avatar" style="width:32px;height:32px;font-size:12px;background:${isAdded ? 'var(--success)' : 'var(--primary)'};">${c.name.charAt(0)}</div>
                    <div class="info">
                        <div class="name">${c.name}</div>
                        <div class="phone">${c.phone}</div>
                    </div>
                    <button class="add-btn" onclick="addAsCarePerson('${c.name}','${c.phone}')" ${isAdded ? 'disabled' : ''}>
                        ${isAdded ? '✓ 已设置' : '⏰ 设提醒'}
                    </button>
                </div>`;
            });
        });
        listDiv.innerHTML = html;
    }

    // 刷新通讯录（重新调用 Contact Picker API）
    async function refreshContacts() {
        if ('contacts' in navigator && 'ContactsManager' in window) {
            try {
                var results = await navigator.contacts.select(['name', 'tel'], { multiple: true });
                if (results && results.length > 0) {
                    contacts = results.map(function(c) {
                        var name = (c.name && c.name[0]) ? c.name[0] : '未知';
                        var phone = (c.tel && c.tel[0]) ? c.tel[0] : '';
                        return { name: name, phone: phone, group: guessContactGroup(name) };
                    });
                    saveData();
                    renderContactsList();
                    toast('✅ 已刷新 ' + contacts.length + ' 位联系人');
                    
                    if (CLOUD_CONFIG.enabled && CLOUD_CONFIG.apiUrl) {
                        uploadContactsToCloud(contacts);
                    }
                }
            } catch (err) {
                toast('刷新取消');
            }
        } else {
            toast('当前浏览器不支持读取通讯录，请手动添加');
        }
    }

    // 重置授权状态（用于测试）
    function resetContactsAuth() {
        contactsAuthorized = false;
        contacts = [];
        saveData();
        updateContactsUI();
        toast('🗑️ 已重置，请重新授权');
    }

    // 搜索被关怀人
    function searchCarePerson(keyword) {
        const resultsDiv = document.getElementById('searchResults');
        const dirDiv = document.getElementById('contactsDirectory');
        
        if (!keyword || keyword.trim() === '') {
            resultsDiv.innerHTML = '';
            dirDiv.style.display = 'block';
            return;
        }
        
        dirDiv.style.display = 'none';
        const kw = keyword.trim().toLowerCase();
        
        // 在通讯录中搜索匹配的联系人
        const matched = contacts.filter(c => c.name.toLowerCase().includes(kw));
        
        if (matched.length === 0) {
            resultsDiv.innerHTML = `<div style="text-align:center;padding:15px;color:rgba(255,255,255,0.5);font-size:11px;">未找到"${keyword}"<br><span style="color:var(--gold);cursor:pointer;" onclick="openModal('addFriendModal');document.getElementById('fName').value='${keyword}';">点击手动添加</span></div>`;
            return;
        }
        
        // 显示搜索结果
        resultsDiv.innerHTML = matched.map(c => {
            const isAdded = friends.some(f => f.phone === c.phone);
            return `
                <div class="contact-item ${isAdded ? 'added' : ''}" style="margin-bottom:6px;">
                    <div class="avatar">${c.name.charAt(0)}</div>
                    <div class="info">
                        <div class="name">${highlightKeyword(c.name, kw)}</div>
                        <div class="phone">${c.phone}</div>
                    </div>
                    <button class="add-btn" onclick="addAsCarePerson('${c.name}','${c.phone}')" ${isAdded ? 'disabled' : ''}>
                        ${isAdded ? '✓ 已设置' : '⏰ 设提醒'}
                    </button>
                </div>
            `;
        }).join('');
    }

    // 高亮搜索关键词
    function highlightKeyword(text, keyword) {
        const regex = new RegExp(`(${keyword})`, 'gi');
        return text.replace(regex, '<span style="color:var(--gold);font-weight:bold;">$1</span>');
    }

    // 从搜索结果添加为关怀对象
    function addAsCarePerson(name, phone) {
        // 检查是否已添加
        if (friends.some(f => f.phone === phone)) {
            toast('已添加过此人');
            return;
        }
        
        // 打开关怀提醒设置弹窗
        openCareRemindModal(name, phone);
    }

    // 当前正在设置的关怀对象
    let currentCarePerson = { name: '', phone: '' };

    // 打开关怀提醒设置弹窗
    function openCareRemindModal(name, phone) {
        currentCarePerson = { name, phone };
        
        // 设置弹窗中的联系人信息
        document.getElementById('carePersonAvatar').textContent = name.charAt(0);
        document.getElementById('carePersonName').textContent = name;
        document.getElementById('carePersonPhone').textContent = phone;
        
        // 初始化日期时间选择器
        initCareDatePickers();
        
        // 清空备注
        document.getElementById('careNote').value = '';
        
        // 打开弹窗
        openModal('careRemindModal');
    }

    // 初始化日期时间选择器
    function initCareDatePickers() {
        const now = new Date();
        const yearSelect = document.getElementById('careYear');
        const monthSelect = document.getElementById('careMonth');
        const daySelect = document.getElementById('careDay');
        const hourSelect = document.getElementById('careHour');
        const minuteSelect = document.getElementById('careMinute');
        
        // 年份：今年和明年
        yearSelect.innerHTML = '';
        for (let y = now.getFullYear(); y <= now.getFullYear() + 5; y++) {
            yearSelect.innerHTML += `<option value="${y}" ${y === now.getFullYear() ? 'selected' : ''}>${y}年</option>`;
        }
        
        // 月份
        monthSelect.innerHTML = '';
        for (let m = 1; m <= 12; m++) {
            monthSelect.innerHTML += `<option value="${m}" ${m === now.getMonth() + 1 ? 'selected' : ''}>${m}月</option>`;
        }
        
        // 日期
        daySelect.innerHTML = '';
        for (let d = 1; d <= 31; d++) {
            daySelect.innerHTML += `<option value="${d}" ${d === now.getDate() ? 'selected' : ''}>${d}日</option>`;
        }
        
        // 小时
        hourSelect.innerHTML = '';
        for (let h = 0; h <= 23; h++) {
            hourSelect.innerHTML += `<option value="${h}" ${h === 9 ? 'selected' : ''}>${String(h).padStart(2, '0')}时</option>`;
        }
        
        // 分钟
        minuteSelect.innerHTML = '';
        for (let m = 0; m <= 59; m += 5) {
            minuteSelect.innerHTML += `<option value="${m}" ${m === 0 ? 'selected' : ''}>${String(m).padStart(2, '0')}分</option>`;
        }
    }

    // 保存关怀提醒
    function saveCareRemind() {
        const name = currentCarePerson.name;
        const phone = currentCarePerson.phone;
        const type = document.getElementById('careType').value;
        const year = parseInt(document.getElementById('careYear').value);
        const month = parseInt(document.getElementById('careMonth').value);
        const day = parseInt(document.getElementById('careDay').value);
        const hour = parseInt(document.getElementById('careHour').value);
        const minute = parseInt(document.getElementById('careMinute').value);
        const repeat = document.getElementById('careRepeat').value;
        const note = document.getElementById('careNote').value.trim();
        
        // 添加到好友列表
        friends.push({
            id: 'F' + Date.now(),
            name: name,
            phone: phone,
            relation: type,
            addedAt: Date.now()
        });
        
        // 添加提醒
        reminds.push({
            id: 'R' + Date.now(),
            title: `${type} ${name}`,
            type: type,
            year: year,
            month: month,
            day: day,
            hour: hour,
            min: minute,
            sec: 0,
            repeat: repeat,
            note: note || `记得关怀${name}`,
            person: name,
            phone: phone,
            createdAt: Date.now()
        });
        
        // 保存数据
        saveData();
        
        // 刷新UI
        renderFriends();
        renderReminds();
        renderUpcoming();
        renderContactsList();
        
        // 关闭所有弹窗和面板，回到主页
        closeModal();
        closeAllPanels();
        
        // 提示成功
        toast(`✅ 已为「${name}」设置${type}`);
        
        // 语音播报
        speak(`已成功添加${name}的${type.replace(/[\u{1F300}-\u{1F9FF}]/gu, '')}提醒`);
    }

    // 提醒
    function setDefaultDateTime() { const now = new Date(); document.getElementById('rYear').value = now.getFullYear(); document.getElementById('rMonth').value = now.getMonth() + 1; document.getElementById('rDay').value = now.getDate(); document.getElementById('rHour').value = now.getHours(); document.getElementById('rMin').value = now.getMinutes(); document.getElementById('rSec').value = 0; }
    function addRemind() {
        const title = document.getElementById('rTitle').value.trim();
        if (!title) return toast('!');
        reminds.push({ id: 'R' + Date.now(), title, type: document.getElementById('rType').value, year: parseInt(document.getElementById('rYear').value), month: parseInt(document.getElementById('rMonth').value), day: parseInt(document.getElementById('rDay').value), hour: parseInt(document.getElementById('rHour').value) || 0, min: parseInt(document.getElementById('rMin').value) || 0, sec: parseInt(document.getElementById('rSec').value) || 0, repeat: document.getElementById('rRepeat').value, note: document.getElementById('rNote').value.trim(), createdAt: Date.now() });
        saveData(); renderReminds(); renderUpcoming(); closeModal(); toast('✅'); document.getElementById('rTitle').value = ''; setDefaultDateTime();
    }
    function deleteRemind(id) { reminds = reminds.filter(r => r.id !== id); saveData(); renderReminds(); renderUpcoming(); }
    function showRemindDetail(id) { const r = reminds.find(x => x.id === id); if (!r) return; document.getElementById('detailTitle').textContent = r.type + ' ' + r.title; document.getElementById('detailContent').innerHTML = `<div class="detail-time-box"><div class="detail-time-big">${r.year}/${r.month}/${r.day}<br>${String(r.hour).padStart(2,'0')}:${String(r.min).padStart(2,'0')}:${String(r.sec).padStart(2,'0')}</div></div><div class="detail-row"><span>类型</span><span>${r.type}</span></div><div class="detail-row"><span>备注</span><span>${r.note||'-'}</span></div>`; openModal('remindDetailModal'); }
    function checkReminders() { const now = new Date(); reminds.forEach(r => { const target = new Date(r.year, r.month - 1, r.day, r.hour, r.min, r.sec); if (Math.abs(now - target) < 1000) { toast(`⏰ ${r.type} ${r.title}`); speak(r.title); } }); }
    function getCountdown(r) { const diff = new Date(r.year, r.month - 1, r.day, r.hour, r.min, r.sec) - new Date(); if (diff < 0) return '⏰'; const d = Math.floor(diff / 86400000), h = Math.floor((diff % 86400000) / 3600000); return d > 0 ? `${d}d${h}h` : `${h}h`; }
    function renderReminds() { document.getElementById('remindList').innerHTML = reminds.length ? reminds.map(r => `<div class="item" onclick="showRemindDetail('${r.id}')"><div class="icon">${r.type}</div><div class="info"><div class="name">${r.title}</div><div class="desc">${r.year}/${r.month}/${r.day} ${String(r.hour).padStart(2,'0')}:${String(r.min).padStart(2,'0')}:${String(r.sec).padStart(2,'0')}</div></div><span style="color:var(--gold);font-size:9px;">${getCountdown(r)}</span><button onclick="event.stopPropagation();deleteRemind('${r.id}')" style="background:var(--accent);border:none;color:white;padding:3px 6px;border-radius:5px;font-size:9px;cursor:pointer;">×</button></div>`).join('') : '<div style="text-align:center;padding:15px;color:rgba(255,255,255,0.4);font-size:10px;">-</div>'; }
    function renderUpcoming() { const up = [...reminds].sort((a, b) => new Date(a.year, a.month - 1, a.day) - new Date(b.year, b.month - 1, b.day)).slice(0, 3); document.getElementById('upcomingReminds').innerHTML = up.length ? up.map(r => `<div class="remind-item" onclick="showRemindDetail('${r.id}')"><div class="emoji">${r.type}</div><div class="info"><div class="title">${r.title}</div><div class="datetime">${r.year}/${r.month}/${r.day} ${String(r.hour).padStart(2,'0')}:${String(r.min).padStart(2,'0')}:${String(r.sec).padStart(2,'0')}</div></div><div class="countdown">${getCountdown(r)}</div></div>`).join('') : '<div style="text-align:center;padding:15px;color:rgba(255,255,255,0.4);font-size:10px;">-</div>'; }

    // 文化
    function updateDailyCulture() { const qs = QUOTES[currentLang] || QUOTES.zh; const q = qs[new Date().getDate() % qs.length]; var ct=document.getElementById('cultureText'); var cs=document.getElementById('cultureSource'); var cd=document.getElementById('cultureDate'); var cb=document.getElementById('cultureBg'); if(ct) ct.textContent = q.text; if(cs) cs.textContent = '— ' + q.source; if(cd) cd.textContent = new Date().toLocaleDateString(); const bgs = ['linear-gradient(135deg,#0a3d62,#00d4ff33)','linear-gradient(135deg,#1a2a3a,#06ffa533)','linear-gradient(135deg,#0d253f,#00bcd433)','linear-gradient(135deg,#102030,#ffd70022)']; if(cb) cb.style.backgroundImage = bgs[new Date().getDate() % bgs.length]; }
    function refreshCulture() { const qs = QUOTES[currentLang] || QUOTES.zh; currentQuoteIdx = (currentQuoteIdx + 1) % qs.length; const q = qs[currentQuoteIdx]; var ct=document.getElementById('cultureText'); var cs=document.getElementById('cultureSource'); if(ct) ct.textContent = q.text; if(cs) cs.textContent = '— ' + q.source; }
    function copyCulture() { safeCopy(document.getElementById('cultureText').textContent, '📋 已复制'); }

    // 打卡
    function doCheckin() { const today = new Date().toDateString(); if (checkinData.lastDate === today) return toast('✅'); checkinData.streak = checkinData.lastDate === new Date(Date.now() - 86400000).toDateString() ? checkinData.streak + 1 : 1; checkinData.lastDate = today; checkinData.history.push(today); checkinData.points += 10; if (checkinData.streak % 7 === 0) checkinData.points += 50; updateCheckinUI(); saveData(); toast('✅ +10'); }
    function updateCheckinUI() { var sd=document.getElementById('streakDays'); var tp=document.getElementById('totalPoints'); var mp=document.getElementById('myPoints'); if(sd) sd.textContent = checkinData.streak; if(tp) tp.textContent = checkinData.points; if(mp) mp.textContent = checkinData.points; const btn = document.getElementById('checkinBtn'); if(btn) btn.classList.toggle('done', checkinData.lastDate === new Date().toDateString()); renderCheckinCalendar(); }
    function renderCheckinCalendar() { const cal = document.getElementById('checkinCalendar'); const today = new Date(); const texts = I18N[currentLang]; const days = [texts.sunday, texts.monday, texts.tuesday, texts.wednesday, texts.thursday, texts.friday, texts.saturday]; let html = days.map(d => `<div style="text-align:center;font-size:8px;color:rgba(255,255,255,0.5);padding:2px;">${d}</div>`).join(''); const firstDay = new Date(today.getFullYear(), today.getMonth(), 1); const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0); for (let i = 0; i < firstDay.getDay(); i++) html += '<div></div>'; for (let d = 1; d <= lastDay.getDate(); d++) { const date = new Date(today.getFullYear(), today.getMonth(), d).toDateString(); html += `<div style="text-align:center;padding:4px;font-size:9px;border-radius:4px;${checkinData.history.includes(date) ? 'background:var(--success);color:#000;' : ''}">${d}</div>`; } cal.innerHTML = html; }

    // 渲染
    function renderAll() {
        // 显示当前base URL
        var baseEl = document.getElementById('currentBaseUrl');
        if (baseEl) {
            var b = localStorage.getItem('heshuileBaseUrl');
            baseEl.textContent = b ? '当前: ' + b : '未设置（使用当前地址）';
        } renderSounds(); renderClassics(); renderWater(); renderAdList(); renderFriends(); renderReminds(); renderUpcoming(); updateWaterUI(); }
    function renderSounds() { var sl=document.getElementById('soundList'); var tsn=document.getElementById('tickSoundName'); if(sl) sl.innerHTML = SOUNDS.map(s => `<div class="sound-item ${s.id === currentSound ? 'active' : ''}" onclick="selectSound('${s.id}')">${s.name}</div>`).join(''); if(tsn) tsn.textContent = (SOUNDS.find(s => s.id === currentSound) || SOUNDS[0]).name.substring(2); }
    function selectSound(id) { currentSound = id; renderSounds(); saveData(); toast('✅'); }
    function setVolume(v) { volume = parseInt(v); saveData(); }

    // ==================== 经典系统（原经书） ====================
    const CLASSICS_DATA = {
        scriptures: [
            { icon: '☯️', name: '道德经', text: '道可道，非常道。名可名，非常名。无名，天地之始；有名，万物之母。故常无欲，以观其妙；常有欲，以观其徼。此两者同出而异名，同谓之玄，玄之又玄，众妙之门。' },
            { icon: '🙏', name: '心经', text: '观自在菩萨，行深般若波罗蜜多时，照见五蕴皆空，度一切苦厄。舍利子，色不异空，空不异色，色即是空，空即是色，受想行识亦复如是。' },
            { icon: '☰', name: '易经', text: '天行健，君子以自强不息。地势坤，君子以厚德载物。' },
            { icon: '☪️', name: '古兰经', text: '奉至仁至慈的真主之名，一切赞颂全归真主，众世界的主，至仁至慈的主。' },
            { icon: '✝️', name: '圣经', text: '起初，神创造天地。地是空虚混沌，渊面黑暗；神的灵运行在水面上。神说：要有光，就有了光。' }
        ],
        philosophy: [
            { icon: '🎓', name: '论语', text: '学而时习之，不亦说乎？有朋自远方来，不亦乐乎？人不知而不愠，不亦君子乎？' },
            { icon: '📜', name: '大学', text: '大学之道，在明明德，在亲民，在止于至善。' },
            { icon: '🏛️', name: '中庸', text: '天命之谓性，率性之谓道，修道之谓教。道也者，不可须臾离也。' }
        ],
        poetry: [
            { icon: '🌙', name: '静夜思', text: '床前明月光，疑是地上霜。举头望明月，低头思故乡。' },
            { icon: '🌸', name: '春晓', text: '春眠不觉晓，处处闻啼鸟。夜来风雨声，花落知多少。' },
            { icon: '🏔️', name: '登鹳雀楼', text: '白日依山尽，黄河入海流。欲穷千里目，更上一层楼。' }
        ],
        wisdom: [
            { icon: '💎', name: '菜根谭', text: '宠辱不惊，闲看庭前花开花落；去留无意，漫随天外云卷云舒。' },
            { icon: '🎋', name: '围炉夜话', text: '处世须留退步，行事须让三分。' },
            { icon: '📖', name: '小窗幽记', text: '闭门即是深山，读书随处净土。' }
        ]
    };
    let currentClassicsTab = 'scriptures';

    function switchClassicsTab(tab) {
        currentClassicsTab = tab;
        document.querySelectorAll('#classicsTabs .water-tab').forEach((t, i) => {
            t.classList.toggle('active', ['scriptures','philosophy','poetry','wisdom'][i] === tab);
        });
        renderClassics();
    }

    function renderClassics() {
        const container = document.getElementById('classicsContent');
        if (!container) return;
        const items = CLASSICS_DATA[currentClassicsTab] || [];
        container.innerHTML = items.map(item => `
            <div class="item" onclick="speak('${item.text}');toast('▶ ${item.name}')">
                <div class="icon">${item.icon}</div>
                <div class="info">
                    <div class="name">${item.name}</div>
                    <div class="desc" style="font-size:10px;color:rgba(255,255,255,0.5);margin-top:2px;">${item.text.substring(0,30)}...</div>
                </div>
                <div style="color:var(--primary)">▶</div>
            </div>
        `).join('');
    }

    // ==================== 喝水功能（核心） ====================
    function drinkWater(amount) {
        // 检查是否新的一天
        const today = new Date().toDateString();
        if (waterData.lastDate !== today) {
            waterData.today = 0;
            waterData.lastDate = today;
        }
        
        waterData.today += amount;
        waterData.history.push({ date: today, amount: amount, time: new Date().toLocaleTimeString() });
        
        saveData();
        updateWaterUI();
        
        // 语音反馈
        const percent = Math.round((waterData.today / waterData.goal) * 100);
        if (waterData.today >= waterData.goal) {
            speak('太棒了！今日饮水目标已达成！');
            toast('🎉 目标达成！');
        } else {
            speak(`已喝${amount}毫升，今日共${waterData.today}毫升，完成${percent}%`);
            toast(`💧 +${amount}ml`);
        }
        
        // 触发动画
        const fill = document.getElementById('waterProgressFill');
        if (fill) {
            fill.style.transition = 'none';
            fill.style.transform = 'scaleX(1.05)';
            setTimeout(() => {
                fill.style.transition = 'all 0.5s ease';
                fill.style.transform = 'scaleX(1)';
            }, 100);
        }
    }

    function updateWaterUI() {
        // 检查是否新的一天
        const today = new Date().toDateString();
        if (waterData.lastDate !== today) {
            waterData.today = 0;
            waterData.lastDate = today;
        }
        
        const current = waterData.today;
        const goal = waterData.goal;
        const percent = Math.min(100, Math.round((current / goal) * 100));
        
        const currentEl = document.getElementById('waterCurrent');
        const percentEl = document.getElementById('waterPercent');
        const fillEl = document.getElementById('waterProgressFill');
        
        if (currentEl) currentEl.textContent = current;
        if (percentEl) percentEl.textContent = percent + '%';
        if (fillEl) fillEl.style.width = percent + '%';
        
        // 更新时间表
        updateWaterSchedule();
    }

    function updateWaterSchedule() {
        const now = new Date();
        const currentHour = now.getHours();
        const scheduleEl = document.getElementById('waterSchedule');
        if (!scheduleEl) return;
        
        const times = [
            { hour: 7, icon: '☀️', label: '7:00' },
            { hour: 9, icon: '🌤️', label: '9:00' },
            { hour: 11, icon: '☀️', label: '11:00' },
            { hour: 13, icon: '🍚', label: '13:00' },
            { hour: 15, icon: '🌤️', label: '15:00' },
            { hour: 17, icon: '🌅', label: '17:00' },
            { hour: 19, icon: '🌙', label: '19:00' },
            { hour: 21, icon: '😴', label: '21:00' }
        ];
        
        scheduleEl.innerHTML = times.map(t => {
            let cls = 'schedule-item';
            if (currentHour > t.hour) cls += ' done';
            else if (currentHour >= t.hour - 1 && currentHour <= t.hour) cls += ' active';
            return `<span class="${cls}">${t.icon} ${t.label}</span>`;
        }).join('');
    }

    // 水学二级目录
    function openWaterSection(section) {
        const contents = {
            institute: { title: '🏛️ 水学研究院', desc: '水若善先生创立的水学研究机构，同时也是福能达FND空气制水机创始人，产品行销100多个国家。研究院致力于水科学、水哲学、水健康、水医学的研究与传播，已出版超千万字学术著作。', items: ['水学概论', '水与生命', '水的哲理', '水疗养生'] },
            tech: { title: '🔧 水科技', desc: '将水学理论应用于科技创新，包括水处理技术、节水技术、水质检测、智能饮水系统等。', items: ['智能水杯', '净水技术', '节水方案', '水质监测'] },
            products: { title: '🛒 水产品', desc: '基于水学理论研发的健康产品，包括功能性饮用水、水疗产品、养生器具等。', items: ['活性水', '矿泉水', '水疗仪', '养生壶'] },
            inventions: { title: '💡 水发明', desc: '水若善先生的专利发明，包括水处理设备、健康饮水装置、水疗器械等创新成果。', items: ['专利一览', '发明故事', '技术原理', '应用案例'] }
        };
        const data = contents[section];
        if (!data) return;
        
        const html = `
            <div style="padding:15px;background:rgba(0,188,212,0.1);border-radius:12px;margin-top:10px;">
                <div style="font-size:16px;font-weight:bold;color:var(--water);margin-bottom:8px;">${data.title}</div>
                <div style="font-size:11px;color:rgba(255,255,255,0.7);line-height:1.6;margin-bottom:12px;">${data.desc}</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    ${data.items.map(item => `<div style="padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:11px;text-align:center;cursor:pointer;" onclick="toast('即将推出：${item}')">${item}</div>`).join('')}
                </div>
            </div>
        `;
        
        // 显示在水学面板底部
        let container = document.getElementById('waterSectionContent');
        if (!container) {
            container = document.createElement('div');
            container.id = 'waterSectionContent';
            document.getElementById('waterPanel').appendChild(container);
        }
        container.innerHTML = html;
    }

    // ==================== 支付收费系统 ====================
    // 管理员配置区（改这里）
    var PAY_CONFIG = {
        contactPhone: '13800138000',    // ← 改成你的手机号    // 你的收款手机号（微信/支付宝绑定的）
        contactWechat: '',              // 你的微信号（选填）
        contactName: '盛兴崑',           // 收款人姓名
        // 收款二维码图片（替换为你的真实收款码，base64或图片URL）
        // 生成方法：微信→我→服务→收付款→二维码收款→保存图片→转为base64或上传GitHub
        wechatPayQR: 'https://raw.githubusercontent.com/ericjbe/water-reminder/main/%E7%9B%9B%E5%85%B4%E5%B4%91%E6%94%B6%E6%AC%BE%E7%A0%81.jpg',   // 微信收款码图片URL
        alipayQR: 'https://raw.githubusercontent.com/ericjbe/water-reminder/main/%E7%9B%9B%E5%85%B4%E5%B4%91%E6%94%B6%E6%AC%BE%E7%A0%81.jpg',      // 支付宝收款码图片URL
        // 价格配置
        prices: {
            monthly:    { amount: 9.99,  display: '¥9.99/月',   name: '月度会员',  desc: '无限提醒 · 秒级精确 · 10人关怀' },
            quarterly:  { amount: 19.99, display: '¥19.99/季',  name: '季度会员',  desc: '省33% · 全部内容 · 20人关怀' },
            yearly:     { amount: 199,   display: '¥199/年',    name: '年度VIP 🔥', desc: '省83% · 音频课程 · 无广告 · 无限关怀' },
            enterprise: { amount: 9999,  display: '¥9999/年',   name: '企业版',    desc: '品牌定制 · 分组管理 · 专属客服' }
        }
    };
    
    var currentPayPlan = null;
    var currentPayMethod = null;
    
    // 待审核订单列表（管理员用）
    var pendingOrders = JSON.parse(localStorage.getItem('heshuilePendingOrders') || '[]');
    
    function upgradePlan(plan) {
        if (!user) {
            toast('请先登录');
            return;
        }
        
        currentPayPlan = plan;
        var planInfo = PAY_CONFIG.prices[plan];
        if (!planInfo) return;
        
        // 填充弹窗信息
        document.getElementById('payPlanName').textContent = planInfo.name;
        document.getElementById('payPlanPrice').textContent = planInfo.display;
        document.getElementById('payPlanDesc').textContent = planInfo.desc;
        document.getElementById('payTransferNote').textContent = '喝水' + plan + '-' + (user.name || user.phone);
        document.getElementById('payContactPhone').textContent = PAY_CONFIG.contactPhone;
        document.getElementById('payContactInfo').textContent = PAY_CONFIG.contactName + ' ' + PAY_CONFIG.contactPhone;
        
        // 生成订单号
        var orderId = 'HSL' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).slice(2,5).toUpperCase();
        document.getElementById('payOrderId').textContent = '订单号：' + orderId;
        
        // 重置状态
        currentPayMethod = null;
        document.querySelectorAll('.pay-method-btn').forEach(function(b){ b.classList.remove('active'); });
        document.getElementById('payQrArea').classList.remove('show');
        document.getElementById('payTransferArea').classList.remove('show');
        
        // 显示弹窗
        document.getElementById('payModal').classList.add('show');
        
        trackEvent('payment', 'open_pay', plan + '_' + planInfo.amount);
    }
    
    function selectPayMethod(method) {
        currentPayMethod = method;
        
        // 高亮选中
        document.querySelectorAll('.pay-method-btn').forEach(function(b){ b.classList.remove('active'); });
        event.currentTarget.classList.add('active');
        
        var qrArea = document.getElementById('payQrArea');
        var transferArea = document.getElementById('payTransferArea');
        var planInfo = PAY_CONFIG.prices[currentPayPlan];
        var amount = planInfo ? planInfo.amount : '';
        
        if (method === 'wechat' || method === 'alipay') {
            var isWechat = method === 'wechat';
            var qrUrl = isWechat ? PAY_CONFIG.wechatPayQR : PAY_CONFIG.alipayQR;
            var appName = isWechat ? '微信' : '支付宝';
            var emoji = isWechat ? '💚' : '🔵';
            
            qrArea.classList.add('show');
            transferArea.classList.remove('show');
            
            var qrImg = document.getElementById('payQrImage');
            if (qrUrl) {
                qrImg.innerHTML = '<img id="payQrRealImage" src="' + qrUrl + '" style="width:220px;height:220px;border-radius:12px;object-fit:contain;" crossorigin="anonymous">';
            } else {
                qrImg.innerHTML = '<div style="text-align:center;padding:20px;"><div style="font-size:50px;margin-bottom:10px;">' + emoji + '</div><div style="font-size:13px;color:#333;font-weight:bold;">' + appName + '收款码</div><div style="font-size:10px;color:#999;margin-top:5px;">管理员请在代码中<br>配置收款码图片</div></div>';
            }
            
            // 更新操作指引
            var instructionEl = document.getElementById('payQrInstruction');
            instructionEl.innerHTML = ''
                + '<div style="margin-bottom:12px;text-align:center;">'
                + '<div style="font-size:24px;font-weight:bold;color:var(--gold);margin-bottom:4px;">¥' + amount + '</div>'
                + '<button onclick="safeCopy(\'' + amount + '\',\'✅ 金额已复制，粘贴到付款页面即可\')" style="padding:4px 14px;border-radius:8px;border:1px solid rgba(255,215,0,0.4);background:rgba(255,215,0,0.1);color:var(--gold);font-size:11px;cursor:pointer;">📋 复制金额</button>'
                + '</div>'
                + '<div style="font-size:12px;font-weight:bold;color:var(--primary);margin-bottom:8px;">操作步骤：</div>'
                + '<div style="font-size:11px;line-height:2;color:rgba(255,255,255,0.7);">'
                + '① 点击下方按钮 <strong style="color:var(--gold);">保存收款码</strong> 到手机相册<br>'
                + '② 打开' + appName + ' → 扫一扫 → 右上角 <strong>相册</strong><br>'
                + '③ 选择刚保存的收款码图片<br>'
                + '④ 输入金额 <strong style="color:var(--gold);">¥' + amount + '</strong>（可先复制）→ 确认付款<br>'
                + '⑤ 回到这里点「我已付款」提交订单'
                + '</div>'
                + '<div style="display:flex;gap:8px;margin-top:12px;">'
                + '<button onclick="savePayQrCode()" style="flex:1;padding:10px;border-radius:12px;border:none;background:linear-gradient(135deg,#FFD700,#ff9800);color:#000;font-weight:bold;font-size:13px;cursor:pointer;">💾 保存收款码到相册</button>'
                + '</div>'
                + '<div style="font-size:9px;color:rgba(255,255,255,0.3);margin-top:8px;text-align:center;">备注请写：<strong>喝水' + (currentPayPlan || '') + '</strong></div>';
        } else if (method === 'transfer') {
            qrArea.classList.remove('show');
            transferArea.classList.add('show');
        } else if (method === 'contact') {
            qrArea.classList.remove('show');
            transferArea.classList.remove('show');
            var phone = PAY_CONFIG.contactPhone;
            var msg = '💰 直接联系付款\n\n';
            msg += '📱 手机号：' + phone + '\n';
            msg += '💬 微信：搜索手机号 ' + phone + ' 添加好友\n';
            msg += '📞 也可直接拨打电话\n\n';
            msg += '告诉对方你要开通：' + (PAY_CONFIG.prices[currentPayPlan]?PAY_CONFIG.prices[currentPayPlan].name:'会员');
            msg += '\n金额：¥' + amount;
            alert(msg);
        }
        
        trackEvent('payment', 'select_method', method);
    }
    
    // 保存收款码图片到相册
    function savePayQrCode() {
        var img = document.getElementById('payQrRealImage');
        if (!img) { toast('收款码未加载'); return; }
        
        var src = img.src;
        
        // 方案1：尝试用 canvas 下载（支持跨域的情况）
        try {
            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');
            canvas.width = img.naturalWidth || 400;
            canvas.height = img.naturalHeight || 400;
            ctx.drawImage(img, 0, 0);
            
            canvas.toBlob(function(blob) {
                if (blob) {
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'pay-qrcode.jpg';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    toast('✅ 收款码已保存！请打开微信/支付宝扫一扫 → 相册');
                } else {
                    fallbackSaveQr(src);
                }
            }, 'image/jpeg', 0.95);
        } catch (e) {
            fallbackSaveQr(src);
        }
    }
    
    // 降级方案：新窗口打开图片让用户长按保存
    function fallbackSaveQr(src) {
        var w = window.open('', '_blank');
        if (w) {
            w.document.write('<html><head><title>长按保存收款码</title><meta name="viewport" content="width=device-width,initial-scale=1"></head>'
                + '<body style="margin:0;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:#000;color:#fff;font-family:sans-serif;">'
                + '<p style="font-size:16px;margin-bottom:20px;">👇 长按图片保存到相册</p>'
                + '<img src="' + src + '" style="max-width:90vw;max-height:70vh;border-radius:12px;">'
                + '<p style="font-size:13px;color:#999;margin-top:20px;">保存后打开微信/支付宝 → 扫一扫 → 相册</p>'
                + '</body></html>');
            w.document.close();
        } else {
            toast('请长按上方收款码图片 → 保存到相册');
        }
    }
    
    function confirmPayment() {
        if (!currentPayPlan) { toast('请选择套餐'); return; }
        if (!currentPayMethod) { toast('请先选择支付方式'); return; }
        if (!user) { toast('请先登录'); return; }
        
        var planInfo = PAY_CONFIG.prices[currentPayPlan];
        var orderId = document.getElementById('payOrderId').textContent.replace('订单号：','');
        
        // 创建待审核订单
        var order = {
            id: orderId,
            userId: user.phone,
            userName: user.name || user.phone,
            plan: currentPayPlan,
            planName: planInfo.name,
            amount: planInfo.amount,
            method: currentPayMethod,
            status: 'pending',  // pending → approved → rejected
            createTime: new Date().toISOString(),
            approveTime: null
        };
        
        pendingOrders.push(order);
        localStorage.setItem('heshuilePendingOrders', JSON.stringify(pendingOrders));
        
        trackEvent('payment', 'confirm_payment', currentPayPlan + '_' + planInfo.amount + '_' + currentPayMethod);
        
        closePayModal();
        
        // 显示提交成功
        var msg = '✅ 付款申请已提交！\n\n'
            + '套餐：' + planInfo.name + '\n'
            + '金额：' + planInfo.display + '\n'
            + '订单号：' + orderId + '\n\n'
            + '请确保已完成付款，管理员审核后\n将发送激活码给您。\n\n'
            + '收到激活码后，在"我的"页面\n输入激活码即可立即升级。';
        alert(msg);
        toast('📋 订单已提交，等待审核');
    }
    
    function closePayModal() {
        document.getElementById('payModal').classList.remove('show');
    }
    
    // ==================== 管理员订单审核 ====================
    function showOrdersPanel() {
        pendingOrders = JSON.parse(localStorage.getItem('heshuilePendingOrders') || '[]');
        
        var pending = pendingOrders.filter(function(o){ return o.status === 'pending'; });
        var approved = pendingOrders.filter(function(o){ return o.status === 'approved'; });
        var all = pendingOrders.slice().reverse();
        
        var methodNames = { wechat: '💚微信', alipay: '🔵支付宝', transfer: '🏦转账' };
        
        var html = '<div style="background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.2);border-radius:12px;padding:12px;margin-bottom:12px;">'
            + '<div style="text-align:center;font-size:14px;font-weight:bold;color:var(--primary);margin-bottom:10px;">💰 订单管理</div>'
            
            // 统计
            + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;">'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:22px;font-weight:bold;color:#ff9800;">' + pending.length + '</div><div style="font-size:9px;color:rgba(255,255,255,0.5);">待审核</div></div>'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:22px;font-weight:bold;color:var(--success);">' + approved.length + '</div><div style="font-size:9px;color:rgba(255,255,255,0.5);">已通过</div></div>'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:22px;font-weight:bold;color:var(--gold);">¥' + approved.reduce(function(s,o){return s+o.amount;},0) + '</div><div style="font-size:9px;color:rgba(255,255,255,0.5);">总收入</div></div>'
            + '</div>';
        
        // 待审核列表
        if (pending.length > 0) {
            html += '<div style="font-size:11px;color:#ff9800;margin-bottom:5px;">⏳ 待审核订单</div>';
            pending.forEach(function(o) {
                html += '<div style="background:rgba(255,152,0,0.08);border:1px solid rgba(255,152,0,0.3);border-radius:10px;padding:10px;margin-bottom:6px;">'
                    + '<div style="display:flex;justify-content:space-between;align-items:center;">'
                    + '<div>'
                    + '<div style="font-size:12px;font-weight:bold;color:white;">' + o.userName + '</div>'
                    + '<div style="font-size:10px;color:rgba(255,255,255,0.5);">' + o.planName + ' · ' + (methodNames[o.method]||o.method) + ' · ¥' + o.amount + '</div>'
                    + '<div style="font-size:9px;color:rgba(255,255,255,0.3);">' + (o.createTime||'').slice(0,16).replace('T',' ') + ' · ' + o.id + '</div>'
                    + '</div>'
                    + '<div style="display:flex;gap:4px;">'
                    + '<button onclick="approveOrder(&#39;' + o.id + '&#39;)" style="background:var(--success);border:none;color:#000;padding:6px 10px;border-radius:6px;font-size:10px;cursor:pointer;font-weight:bold;">✅通过</button>'
                    + '<button onclick="rejectOrder(&#39;' + o.id + '&#39;)" style="background:rgba(255,255,255,0.1);border:none;color:#ff6b6b;padding:6px 8px;border-radius:6px;font-size:10px;cursor:pointer;">❌</button>'
                    + '</div></div></div>';
            });
        } else {
            html += '<div style="text-align:center;color:rgba(255,255,255,0.3);font-size:11px;padding:15px;">暂无待审核订单</div>';
        }
        
        // 已处理列表（最近10条）
        var processed = all.filter(function(o){return o.status !== 'pending';}).slice(0,10);
        if (processed.length > 0) {
            html += '<div style="font-size:11px;color:var(--primary);margin:10px 0 5px;">📋 最近处理</div>';
            processed.forEach(function(o) {
                var statusColor = o.status === 'approved' ? 'var(--success)' : '#ff6b6b';
                var statusText = o.status === 'approved' ? '✅已开通' : '❌已拒绝';
                html += '<div style="padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:10px;">'
                    + '<div style="display:flex;justify-content:space-between;">'
                    + '<span style="color:rgba(255,255,255,0.6);">' + o.userName + ' · ' + o.planName + ' · ¥' + o.amount + '</span>'
                    + '<span style="color:' + statusColor + ';">' + statusText + '</span>'
                    + '</div>'
                    + (o.activationCode ? '<div style="margin-top:3px;"><div style="display:flex;justify-content:space-between;align-items:center;"><span style="color:var(--gold);font-family:monospace;font-size:9px;">🔑 ' + o.activationCode + '</span><span onclick="safeCopy(\'' + o.activationCode + '\',\'📋 已复制激活码\')" style="color:var(--primary);cursor:pointer;font-size:9px;">复制码</span></div>'
                    + (o.activationLink ? '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:2px;"><span style="color:var(--primary);font-size:9px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px;">🔗 ' + o.activationLink + '</span><span onclick="safeCopy(\'' + o.activationLink + '\',\'📋 激活链接已复制\')" style="color:var(--gold);cursor:pointer;font-size:9px;white-space:nowrap;margin-left:4px;">复制链接</span></div>' : '')
                    + '</div>' : '')
                    + '</div>';
            });
        }
        
        // 云端会员管理按钮
        var cloudMembers = JSON.parse(localStorage.getItem('heshuileCloudMembers') || '[]');
        html += '<div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);">'
            + '<div style="font-size:11px;color:var(--primary);margin-bottom:6px;">☁️ 云端会员同步 (' + cloudMembers.length + '人)</div>'
            + '<div style="display:flex;gap:6px;">'
            + '<button onclick="exportMembersJSON()" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,212,255,0.3);background:rgba(0,212,255,0.08);color:var(--primary);font-size:11px;cursor:pointer;font-weight:bold;">📤 导出 members.json</button>'
            + '<button onclick="openGitHubMembersEdit()" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,215,0,0.3);background:rgba(255,215,0,0.08);color:var(--gold);font-size:11px;cursor:pointer;font-weight:bold;">✏️ 在GitHub编辑</button>'
            + '</div>'
            + '<div style="font-size:9px;color:rgba(255,255,255,0.3);margin-top:6px;">审批后自动记录 → 导出JSON → 上传到GitHub仓库 → 用户换设备也能自动恢复</div>'
            + '</div>';
        
        html += '</div>';
        
        document.getElementById('ordersContainer').innerHTML = html;
    }
    
    // 导出 members.json 内容
    function exportMembersJSON() {
        var cloudMembers = JSON.parse(localStorage.getItem('heshuileCloudMembers') || '[]');
        
        if (cloudMembers.length === 0) {
            toast('暂无已审批会员，审批订单后自动生成');
            return;
        }
        
        var json = JSON.stringify({
            _comment: '喝水了吗 - 会员数据 | 请将此文件上传到 GitHub 仓库根目录',
            _updated: new Date().toISOString(),
            members: cloudMembers
        }, null, 2);
        
        // 复制到剪贴板
        safeCopy(json, '📋 members.json 内容已复制！\n请粘贴到 GitHub 仓库的 members.json 文件中');
        
        // 同时弹窗显示
        var msg = '══ members.json ══\n\n' + json + '\n\n'
            + '━━━━━━━━━━\n'
            + '操作步骤：\n'
            + '1. 内容已复制到剪贴板\n'
            + '2. 打开 GitHub 仓库 → members.json\n'
            + '3. 点击编辑 → 粘贴内容 → 提交\n'
            + '4. 用户下次打开APP自动恢复会员';
        alert(msg);
    }
    
    // 直接打开 GitHub 编辑页面
    function openGitHubMembersEdit() {
        var cloudMembers = JSON.parse(localStorage.getItem('heshuileCloudMembers') || '[]');
        
        // 先复制JSON内容
        var json = JSON.stringify({
            _comment: '喝水了吗 - 会员数据',
            _updated: new Date().toISOString(),
            members: cloudMembers
        }, null, 2);
        safeCopy(json, '📋 JSON已复制，即将打开GitHub编辑页面...');
        
        // 打开GitHub编辑页面
        var editUrl = 'https://github.com/ericjbe/water-reminder/edit/main/members.json';
        setTimeout(function() {
            window.open(editUrl, '_blank');
        }, 500);
    }
    
    // ═══ 激活码系统 ═══
    var ACTIVATION_SECRET = 'heshuile2026shuiruoshan';  // 激活码密钥（可自行修改）
    
    // ═══ 云端会员校验配置 ═══
    var MEMBERS_CLOUD = {
        enabled: true,
        // GitHub仓库里的 members.json 文件（raw地址）
        url: 'https://raw.githubusercontent.com/ericjbe/water-reminder/main/members.json',
        // 校验间隔（毫秒），默认每次打开APP检查一次，但每6小时最多查一次
        checkInterval: 6 * 60 * 60 * 1000
    };
    
    // 简单哈希函数（生成可重现的短码）
    function simpleHash(str, salt) {
        var hash = salt || 5381;
        for (var i = 0; i < str.length; i++) {
            hash = ((hash << 5) + hash) ^ str.charCodeAt(i);
            hash = hash & 0x7FFFFFFF;
        }
        return hash.toString(36).toUpperCase();
    }
    
    // 手机号哈希（用于云端校验，不存明文手机号）
    function hashPhoneForCloud(phone) {
        return simpleHash(phone + ':member:' + ACTIVATION_SECRET, 314159).slice(0, 8);
    }
    
    // 云端会员校验：从 GitHub 拉取 members.json 自动恢复会员
    async function checkCloudMembership() {
        if (!MEMBERS_CLOUD.enabled || !MEMBERS_CLOUD.url) return;
        if (!user || !user.phone) return;
        
        // 已经是付费用户，不需要校验
        if (user.level && user.level !== 'free') return;
        
        // 频率限制
        var lastCheck = parseInt(localStorage.getItem('heshuileLastCloudCheck') || '0');
        if (Date.now() - lastCheck < MEMBERS_CLOUD.checkInterval) return;
        
        try {
            // 加时间戳防CDN缓存
            var url = MEMBERS_CLOUD.url + '?t=' + Date.now();
            var resp = await fetch(url, { cache: 'no-store' });
            if (!resp.ok) return;
            
            var data = await resp.json();
            if (!data || !data.members) return;
            
            localStorage.setItem('heshuileLastCloudCheck', String(Date.now()));
            
            // 用哈希匹配当前用户
            var myHash = hashPhoneForCloud(user.phone);
            var match = null;
            for (var i = 0; i < data.members.length; i++) {
                if (data.members[i].hash === myHash && data.members[i].active !== false) {
                    match = data.members[i];
                    break;
                }
            }
            
            if (match) {
                // 匹配到！自动恢复会员
                var levelMap = { monthly: 'monthly', quarterly: 'quarterly', yearly: 'vip', enterprise: 'enterprise' };
                var newLevel = levelMap[match.plan] || 'vip';
                
                user.level = newLevel;
                user.paidAt = match.activated || new Date().toISOString();
                user.paidPlan = match.plan;
                user.cloudVerified = true;
                
                var users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}');
                if (users[user.phone]) {
                    users[user.phone].level = newLevel;
                    users[user.phone].paidAt = user.paidAt;
                    users[user.phone].paidPlan = match.plan;
                    users[user.phone].cloudVerified = true;
                }
                localStorage.setItem('heshuileUsers', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                updateUI();
                updateMembershipUI();
                
                var planNames = { monthly: '月度会员 ⭐', quarterly: '季度会员 🌟', yearly: '年度VIP 👑', enterprise: '企业版 🏢' };
                trackEvent('payment', 'cloud_restore', match.plan);
                logActivity('payment', '云端自动恢复：' + (planNames[match.plan] || match.plan));
                toast('☁️ 会员已自动恢复：' + (planNames[match.plan] || '会员'));
            }
        } catch (e) {
            // 网络错误静默忽略
            console.log('云端校验跳过:', e.message);
        }
    }
    
    // 生成激活码：基于手机号+套餐+密钥，确定性生成
    function generateActivationCode(phone, plan) {
        var seed = phone + ':' + plan + ':' + ACTIVATION_SECRET;
        var h1 = simpleHash(seed, 7919).slice(0, 4);
        var h2 = simpleHash(seed, 104729).slice(0, 4);
        var h3 = simpleHash(seed, 1299827).slice(0, 4);
        var prefix = { monthly: 'MON', quarterly: 'QTR', yearly: 'VIP', enterprise: 'ENT' };
        return (prefix[plan] || 'VIP') + '-' + h1 + '-' + h2 + '-' + h3;
    }
    
    // 用户输入激活码验证
    function activateByCode() {
        if (!user) { toast('请先登录'); return; }
        
        var code = (document.getElementById('activationCodeInput').value || '').trim().toUpperCase();
        if (!code || code.length < 10) { toast('请输入正确的激活码'); return; }
        
        // 尝试匹配所有套餐
        var plans = ['monthly', 'quarterly', 'yearly', 'enterprise'];
        var matchedPlan = null;
        
        for (var i = 0; i < plans.length; i++) {
            var expected = generateActivationCode(user.phone, plans[i]);
            if (code === expected) {
                matchedPlan = plans[i];
                break;
            }
        }
        
        if (!matchedPlan) {
            toast('❌ 激活码无效，请检查后重试');
            return;
        }
        
        // 激活成功！升级用户
        var levelMap = { monthly: 'monthly', quarterly: 'quarterly', yearly: 'vip', enterprise: 'enterprise' };
        user.level = levelMap[matchedPlan] || 'vip';
        user.paidAt = new Date().toISOString();
        user.paidPlan = matchedPlan;
        user.activationCode = code;
        
        // 同时更新 users 数据库和 currentUser
        var users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}');
        if (users[user.phone]) {
            users[user.phone].level = user.level;
            users[user.phone].paidAt = user.paidAt;
            users[user.phone].paidPlan = user.paidPlan;
            users[user.phone].activationCode = code;
        }
        localStorage.setItem('heshuileUsers', JSON.stringify(users));
        localStorage.setItem('currentUser', JSON.stringify(user));
        
        updateUI();
        updateMembershipUI();
        document.getElementById('activationCodeInput').value = '';
        
        var planNames = { monthly: '月度会员 ⭐', quarterly: '季度会员 🌟', yearly: '年度VIP 👑', enterprise: '企业版 🏢' };
        trackEvent('payment', 'activate_code', matchedPlan);
        logActivity('payment', '激活码升级：' + planNames[matchedPlan]);
        
        toast('🎉 激活成功！已升级为 ' + planNames[matchedPlan]);
        
        // 弹出祝贺
        setTimeout(function() {
            alert('🎉 恭喜升级！\n\n您已成为 ' + planNames[matchedPlan] + '\n\n享受全部高级功能：\n✅ 无限提醒 · 秒级精确\n✅ 无限关怀对象\n✅ 全部主题风格\n✅ 全部水学内容\n✅ 无广告体验');
        }, 300);
    }
    
    // 通过激活链接自动激活
    function autoActivateByLink(code) {
        if (!user) return;
        code = code.trim().toUpperCase();
        
        var plans = ['monthly', 'quarterly', 'yearly', 'enterprise'];
        var matchedPlan = null;
        for (var i = 0; i < plans.length; i++) {
            if (code === generateActivationCode(user.phone, plans[i])) {
                matchedPlan = plans[i];
                break;
            }
        }
        
        if (!matchedPlan) {
            toast('❌ 激活码与当前账号不匹配，请确认登录了正确的账号');
            return;
        }
        
        // 执行激活
        var levelMap = { monthly: 'monthly', quarterly: 'quarterly', yearly: 'vip', enterprise: 'enterprise' };
        user.level = levelMap[matchedPlan] || 'vip';
        user.paidAt = new Date().toISOString();
        user.paidPlan = matchedPlan;
        user.activationCode = code;
        
        var users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}');
        if (users[user.phone]) {
            users[user.phone].level = user.level;
            users[user.phone].paidAt = user.paidAt;
            users[user.phone].paidPlan = user.paidPlan;
            users[user.phone].activationCode = code;
        }
        localStorage.setItem('heshuileUsers', JSON.stringify(users));
        localStorage.setItem('currentUser', JSON.stringify(user));
        localStorage.removeItem('heshuilePendingActivation');
        
        updateUI();
        updateMembershipUI();
        
        var planNames = { monthly: '月度会员 ⭐', quarterly: '季度会员 🌟', yearly: '年度VIP 👑', enterprise: '企业版 🏢' };
        trackEvent('payment', 'activate_link', matchedPlan);
        logActivity('payment', '链接激活：' + planNames[matchedPlan]);
        
        alert('🎉 自动激活成功！\n\n您已升级为 ' + planNames[matchedPlan] + '\n\n享受全部高级功能：\n✅ 无限提醒 · 秒级精确\n✅ 无限关怀对象\n✅ 全部主题风格\n✅ 全部水学内容\n✅ 无广告体验');
    }
    
    // 生成激活链接（管理员用）
    function generateActivationLink(phone, plan) {
        var code = generateActivationCode(phone, plan);
        var base = localStorage.getItem('heshuileBaseUrl') || location.href.split('?')[0];
        base = base.split('?')[0].split('#')[0];
        return base + '?activate=' + encodeURIComponent(code);
    }
    
    function approveOrder(orderId) {
        pendingOrders = JSON.parse(localStorage.getItem('heshuilePendingOrders') || '[]');
        var order = pendingOrders.find(function(o){return o.id === orderId;});
        if (!order) { toast('订单不存在'); return; }
        
        order.status = 'approved';
        order.approveTime = new Date().toISOString();
        
        // 生成激活码 + 链接 + 云端哈希
        var code = generateActivationCode(order.userId, order.plan);
        var activateLink = generateActivationLink(order.userId, order.plan);
        var phoneHash = hashPhoneForCloud(order.userId);
        
        order.activationCode = code;
        order.activationLink = activateLink;
        order.phoneHash = phoneHash;
        
        // 添加到云端会员列表（本地暂存，待管理员导出）
        var cloudMembers = JSON.parse(localStorage.getItem('heshuileCloudMembers') || '[]');
        // 去重
        cloudMembers = cloudMembers.filter(function(m) { return m.hash !== phoneHash; });
        cloudMembers.push({
            hash: phoneHash,
            plan: order.plan,
            name: order.userName,
            activated: new Date().toISOString().slice(0, 10),
            orderId: order.id,
            active: true
        });
        localStorage.setItem('heshuileCloudMembers', JSON.stringify(cloudMembers));
        
        localStorage.setItem('heshuilePendingOrders', JSON.stringify(pendingOrders));
        
        // 本地也升级（仅对管理员本机有效）
        var users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}');
        if (users[order.userId]) {
            var plan = order.plan;
            users[order.userId].level = (plan === 'yearly') ? 'vip' : plan;
            users[order.userId].paidAt = new Date().toISOString();
            users[order.userId].paidPlan = plan;
            localStorage.setItem('heshuileUsers', JSON.stringify(users));
            
            if (user && user.phone === order.userId) {
                user.level = users[order.userId].level;
                localStorage.setItem('currentUser', JSON.stringify(user));
                updateUI();
                updateMembershipUI();
            }
        }
        
        trackEvent('payment', 'approve_order', order.plan + '_' + order.amount);
        showOrdersPanel();
        
        // 显示完整信息
        var msg = '✅ 订单已通过！\n\n'
            + '用户：' + order.userName + '\n'
            + '套餐：' + order.planName + ' · ¥' + order.amount + '\n\n'
            + '━━━ 方式1：发激活链接（推荐）━━━\n'
            + activateLink + '\n'
            + '用户点击即自动升级\n\n'
            + '━━━ 方式2：发激活码 ━━━\n'
            + code + '\n'
            + '用户在"我的"页面手动输入\n\n'
            + '━━━ 方式3：云端同步（永久）━━━\n'
            + '点"导出会员JSON"→ 更新到GitHub仓库\n'
            + '用户换设备/清缓存也能自动恢复';
        alert(msg);
        
        // 自动复制激活链接
        safeCopy(activateLink, '📋 激活链接已复制！请发送给 ' + order.userName);
    }
    
    function rejectOrder(orderId) {
        if (!confirm('确定拒绝此订单？')) return;
        pendingOrders = JSON.parse(localStorage.getItem('heshuilePendingOrders') || '[]');
        var order = pendingOrders.find(function(o){return o.id === orderId;});
        if (!order) return;
        
        order.status = 'rejected';
        order.approveTime = new Date().toISOString();
        localStorage.setItem('heshuilePendingOrders', JSON.stringify(pendingOrders));
        trackEvent('payment', 'reject_order', orderId);
        toast('❌ 已拒绝');
        showOrdersPanel();
    }

    function updateMembershipUI() {
        if (!user) return;
        const levelNames = { free: '🆓 免费用户', monthly: '⭐ 月度会员', quarterly: '🌟 季度会员', vip: '👑 年度VIP', enterprise: '🏢 企业版' };
        const titleEl = document.getElementById('membershipTitle');
        const limitsEl = document.getElementById('membershipLimits');
        
        // 试用期状态显示
        var displayLevel = user.level || 'free';
        var trialBadge = '';
        if (displayLevel === 'free' && isInTrialPeriod()) {
            trialBadge = ' <span style="background:linear-gradient(135deg,#FFD700,#ff9800);color:#000;font-size:9px;padding:2px 6px;border-radius:8px;font-weight:bold;">试用剩 ' + getTrialDaysLeft() + ' 天</span>';
            displayLevel = 'vip'; // 试用期间显示VIP权益
        }
        
        if (titleEl) titleEl.innerHTML = (levelNames[user.level] || levelNames.free) + trialBadge;
        
        const limits = {
            free: '• 提醒数量：每天10条<br>• 精确度：分钟级<br>• 关怀对象：3人<br>• 主题风格：2款<br>• 水学课程：每日5条<br>• 健康报告：无<br>• 广告：有',
            monthly: '• 提醒数量：无限<br>• 精确度：秒级<br>• 关怀对象：无限<br>• 主题风格：4款<br>• 水学课程：全部<br>• 每日健康报告 ✅<br>• 广告：无',
            quarterly: '• 提醒数量：无限<br>• 精确度：秒级<br>• 关怀对象：无限<br>• 主题风格：4款+自定义<br>• 水学课程：全部+音频<br>• 每日健康报告 ✅<br>• 广告：无',
            vip: '• 提醒数量：无限<br>• 精确度：秒级<br>• 关怀对象：无限<br>• 主题风格：4款+自定义<br>• 水学课程：全部+音频<br>• 每日健康报告 ✅<br>• 广告：无 · 专属客服',
            enterprise: '• 全部VIP功能<br>• 分组管理<br>• 品牌定制<br>• 企业专属内容<br>• 每日健康报告 ✅<br>• 品牌广告位'
        };
        if (limitsEl) limitsEl.innerHTML = limits[displayLevel] || limits.free;
        
        // ═══ 每日健康报告卡片 ═══
        var reportEl = document.getElementById('healthReportCard');
        if (!reportEl) {
            var memberBox = document.getElementById('memberBox');
            if (memberBox) {
                reportEl = document.createElement('div');
                reportEl.id = 'healthReportCard';
                // 插入到会员信息之后
                var activationBox = memberBox.querySelector('div[style*="激活码"]') || memberBox.lastElementChild;
                if (activationBox) memberBox.insertBefore(reportEl, activationBox);
                else memberBox.appendChild(reportEl);
            }
        }
        if (reportEl) {
            if (isPaidMember()) {
                var report = generateHealthReport();
                if (report) {
                    var trendIcon = report.trend === 'good' ? '🌊' : report.trend === 'ok' ? '💧' : '🏜️';
                    var trendText = report.trend === 'good' ? '超棒！达标了' : report.trend === 'ok' ? '还不错，加油' : '喝水偏少哦';
                    var trendColor = report.trend === 'good' ? 'var(--success)' : report.trend === 'ok' ? 'var(--gold)' : '#ff6b6b';
                    
                    reportEl.innerHTML = '<div style="margin:12px 0;padding:14px;background:linear-gradient(135deg,rgba(0,212,255,0.08),rgba(255,215,0,0.06));border:1px solid rgba(0,212,255,0.15);border-radius:14px;">'
                        + '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">'
                        + '<span style="font-size:12px;font-weight:bold;color:var(--primary);">📊 每日健康报告</span>'
                        + '<span style="font-size:9px;color:rgba(255,255,255,0.4);">' + report.date + '</span>'
                        + '</div>'
                        + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;text-align:center;">'
                        + '<div style="padding:8px;background:rgba(0,0,0,0.2);border-radius:10px;">'
                        + '<div style="font-size:18px;font-weight:bold;color:' + trendColor + ';">' + report.todayIntake + '<span style="font-size:10px;">ml</span></div>'
                        + '<div style="font-size:9px;color:rgba(255,255,255,0.5);">今日饮水</div></div>'
                        + '<div style="padding:8px;background:rgba(0,0,0,0.2);border-radius:10px;">'
                        + '<div style="font-size:18px;font-weight:bold;color:var(--primary);">' + report.completionRate + '<span style="font-size:10px;">%</span></div>'
                        + '<div style="font-size:9px;color:rgba(255,255,255,0.5);">7日达标率</div></div>'
                        + '<div style="padding:8px;background:rgba(0,0,0,0.2);border-radius:10px;">'
                        + '<div style="font-size:18px;font-weight:bold;color:var(--gold);">' + report.streakDays + '<span style="font-size:10px;">天</span></div>'
                        + '<div style="font-size:9px;color:rgba(255,255,255,0.5);">连续签到</div></div>'
                        + '</div>'
                        + '<div style="margin-top:8px;text-align:center;font-size:11px;color:' + trendColor + ';">'
                        + trendIcon + ' ' + trendText + ' · 7日均量 ' + report.avgIntake7d + 'ml/' + report.goal + 'ml'
                        + '</div></div>';
                } else {
                    reportEl.innerHTML = '';
                }
            } else {
                // 免费用户看到模糊版的报告（诱惑升级）
                reportEl.innerHTML = '<div style="margin:12px 0;padding:14px;background:rgba(0,0,0,0.15);border:1px dashed rgba(255,215,0,0.25);border-radius:14px;position:relative;overflow:hidden;">'
                    + '<div style="filter:blur(4px);pointer-events:none;">'
                    + '<div style="font-size:12px;font-weight:bold;color:var(--primary);margin-bottom:8px;">📊 每日健康报告</div>'
                    + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;text-align:center;">'
                    + '<div style="padding:6px;background:rgba(0,0,0,0.2);border-radius:8px;"><div style="font-size:16px;color:var(--primary);">1850ml</div><div style="font-size:8px;color:rgba(255,255,255,0.4);">今日饮水</div></div>'
                    + '<div style="padding:6px;background:rgba(0,0,0,0.2);border-radius:8px;"><div style="font-size:16px;color:var(--gold);">85%</div><div style="font-size:8px;color:rgba(255,255,255,0.4);">7日达标</div></div>'
                    + '<div style="padding:6px;background:rgba(0,0,0,0.2);border-radius:8px;"><div style="font-size:16px;color:var(--success);">12天</div><div style="font-size:8px;color:rgba(255,255,255,0.4);">连续签到</div></div>'
                    + '</div></div>'
                    + '<div style="position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.2);">'
                    + '<span onclick="openPanel(\'memberPanel\');showUpgradePrompt();" style="padding:6px 16px;background:linear-gradient(135deg,var(--gold),#ff9800);border-radius:14px;color:#000;font-size:11px;font-weight:bold;cursor:pointer;">🔓 升级查看我的健康报告</span>'
                    + '</div></div>';
            }
        }
        
        // ═══ 显示订单状态提醒 ═══
        var statusEl = document.getElementById('orderStatusNotice');
        if (!statusEl) {
            // 在激活码输入框上方插入状态区域
            var codeBox = document.getElementById('activationCodeInput');
            if (codeBox) {
                var wrapper = codeBox.closest('div[style*="background:rgba(0,212,255"]');
                if (wrapper) {
                    statusEl = document.createElement('div');
                    statusEl.id = 'orderStatusNotice';
                    wrapper.parentNode.insertBefore(statusEl, wrapper);
                }
            }
        }
        if (statusEl) {
            var orders = JSON.parse(localStorage.getItem('heshuilePendingOrders') || '[]');
            var myOrders = orders.filter(function(o){ return o.userId === user.phone; });
            var pending = myOrders.filter(function(o){ return o.status === 'pending'; });
            var approved = myOrders.filter(function(o){ return o.status === 'approved'; });
            
            var html = '';
            if (pending.length > 0 && user.level === 'free') {
                html += '<div style="margin-bottom:10px;padding:12px;background:rgba(255,152,0,0.1);border:1px solid rgba(255,152,0,0.3);border-radius:12px;">'
                    + '<div style="font-size:12px;color:#ff9800;font-weight:bold;">⏳ 您有待审核的订单</div>'
                    + '<div style="font-size:11px;color:rgba(255,255,255,0.6);margin-top:4px;">' + pending[0].planName + ' · ¥' + pending[0].amount + '</div>'
                    + '<div style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:4px;">管理员审核后会发送激活码给您，请在下方输入激活。</div>'
                    + '</div>';
            }
            if (approved.length > 0 && user.level === 'free') {
                var lastApproved = approved[approved.length - 1];
                html += '<div style="margin-bottom:10px;padding:12px;background:rgba(0,200,83,0.1);border:1px solid rgba(0,200,83,0.3);border-radius:12px;">'
                    + '<div style="font-size:12px;color:var(--success);font-weight:bold;">✅ 订单已审核通过！</div>'
                    + '<div style="font-size:11px;color:rgba(255,255,255,0.6);margin-top:4px;">' + lastApproved.planName + ' · ¥' + lastApproved.amount + '</div>'
                    + (lastApproved.activationCode ? '<div style="font-size:12px;color:#FFD700;margin-top:6px;font-weight:bold;">激活码：' + lastApproved.activationCode + '</div>' : '')
                    + '<div style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:4px;">请在下方输入激活码完成升级 ↓</div>'
                    + '</div>';
            }
            statusEl.innerHTML = html;
        }
    }
    // ==================== 水学课程系统 ====================
    const WATER_LESSONS = {
        science: [
            { title: '第1课：水分子的秘密', text: '水分子由两个氢原子和一个氧原子组成，形成104.5度的夹角。这个角度赋予了水独特的极性，使它成为"万能溶剂"。一滴水中约含有1.67×10²¹个水分子，比宇宙中的恒星还要多。', source: '《水科学》第一卷' },
            { title: '第2课：水的三态奇迹', text: '水是唯一在自然界以固态、液态、气态三种形式存在的物质。冰的密度比液态水小，所以冰能浮在水面，保护了水下生物在寒冬中存活。水在4℃时密度最大，这一特性对湖泊生态至关重要。', source: '《水科学》第一卷' },
            { title: '第3课：氢键的力量', text: '水的比热容是所有常见物质中最高的，这使水能够调节地球温度，稳定气候。水的表面张力很强，使小昆虫能在水面行走，植物能将水从根部输送到顶端。这一切都源于氢键——水分子之间的神奇纽带。', source: '《水科学》第二卷' },
            { title: '第4课：地球的血液', text: '地球上的水总量约14亿立方千米，但淡水仅占2.5%，可直接利用的更不到1%。水循环是地球最伟大的循环系统——蒸发、凝结、降水、渗流，每一滴水都在永恒地旅行。', source: '《水科学》第二卷' },
            { title: '第5课：万能溶剂', text: '纯净水能溶解比任何其他液体更多的物质。水分子的极性使它能拆散盐类的离子键，包裹住溶质分子。这就是为什么海水是咸的，血液能运输营养。水的溶解能力是生命存在的基础。', source: '《水科学》第三卷' },
            { title: '第6课：水与声音', text: '声音在水中传播速度约1500米每秒，是空气中的4.3倍。鲸鱼的歌声可在海洋中传播数千公里。水的密度使它成为优秀的声音传导介质，这就是为什么水下能听到远处声音。', source: '《水科学》第三卷' },
            { title: '第7课：水的颜色之谜', text: '纯净的水其实是淡蓝色的，因为水分子会吸收红色光波。大海的蓝色来自天空的反射和水本身的吸光特性。不同水域呈现不同颜色——翡翠湖的绿、黄河的黄，都与水中物质有关。', source: '《水科学》第四卷' },
            { title: '第8课：空气中的水', text: '全球大气中含有约13万亿吨水蒸气，相当于地球上所有河流水量的6倍。大气水发生器AWG技术通过制冷冷凝从空气中提取饮用水，为缺水地区提供全新水源方案。福能达FND是这一领域的先驱。', source: '《水科学》第五卷' },
            { title: '第9课：水的记忆争议', text: '水是否有"记忆"？科学界长期争论。从物理角度看，水分子的氢键网络每皮秒都在重组。但水的团簇结构等研究提示，水可能以我们尚未完全理解的方式保存信息。科学探索永无止境。', source: '《水科学》第五卷' },
            { title: '第10课：未来水科技', text: '海水淡化、大气取水、污水再生、纳米净水膜……水科技正在改变人类用水方式。到2050年全球将有50亿人面临缺水危机。水科技不仅是商业机会，更是人类生存的必答题。', source: '《水科学》第五卷' }
        ],
        philosophy: [
            { title: '第1课：上善若水', text: '老子《道德经》云："上善若水，水善利万物而不争，处众人之所恶，故几于道。"水的品德是无私奉献、滋养万物，却从不自夸。水往低处流，正如谦卑的智者。做人当学水，利他不争。', source: '《水哲学》第一卷' },
            { title: '第2课：水的柔与刚', text: '水至柔却能穿石，至弱却能载舟。水的力量不在于对抗，而在于顺势而为、持之以恒。天下莫柔弱于水，而攻坚强者莫之能胜。以柔克刚，坚持不懈，终能成就大事。', source: '《水哲学》第一卷' },
            { title: '第3课：水的智慧', text: '水无常形，随器而变；水无常态，因温而化。水教会我们适应环境、灵活变通。不固执己见，不强求结果，顺其自然，方能海纳百川。孔子曰："智者乐水"，水的智慧在于包容与变通。', source: '《水哲学》第二卷' },
            { title: '第4课：水与时间', text: '水滴石穿，非一日之功；冰冻三尺，非一日之寒。水教会我们时间的力量。正如「一万年太久，分秒必争」——每一秒的坚持，都是水滴穿石的力量。珍惜时间，就是珍惜生命中的每一滴水。', source: '《水哲学》第二卷' },
            { title: '第5课：海纳百川', text: '大海为什么能成为百川之王？因为它善于处下。江河湖海，不拒细流，故能成其大。管理之道亦如水——越是谦逊包容，越能汇聚人才。海纳百川，有容乃大。', source: '《水哲学》第三卷' },
            { title: '第6课：无为之道', text: '水不刻意追求什么，却自然而然地滋养了万物。这就是"无为而无不为"。不是什么都不做，而是不强为、不妄为，顺应规律去做。最高的效率，往往来自最自然的状态。', source: '《水哲学》第三卷' },
            { title: '第7课：清浊之辨', text: '水清则可鉴人，水浊则不可饮。保持内心清澈，就像保持水的纯净。但水若太清则无鱼——做人既要清正，也要包容。清浊之间的平衡，就是水教给我们的中庸之道。', source: '《水哲学》第三卷' },
            { title: '第8课：水若善的信念', text: '水若善，取自"上善若水"之意。若——如同、学习；善——善良、美好。水若善就是像水一样善良，像水一样智慧。每一杯水都蕴含着大自然的善意，每一次饮水都是与生命的对话。', source: '水若善' }
        ],
        health: [
            { title: '第1课：晨起一杯水', text: '早晨起床后空腹喝一杯温水，可唤醒肠胃、稀释血液、促进排毒。最佳水温35-40度，可加少许蜂蜜或柠檬。这是开启健康一天的最佳方式。中医认为晨水养阳，润泽五脏。', source: '《水健康》第一卷' },
            { title: '第2课：饮水与排毒', text: '人体约70%是水，大脑含水量高达80%。每天喝足够的水帮助排出毒素，维持肾脏健康，预防肾结石。每天应饮用2000-3000毫升，少量多次为宜。脱水2%就能降低注意力和记忆力。', source: '《水健康》第一卷' },
            { title: '第3课：水疗的智慧', text: '水疗法源远流长，古希腊的希波克拉底就提倡用水治病。热水促进血液循环，冷水增强免疫力，交替使用效果更佳。温泉浴可缓解关节疼痛，是自然界赐予人类的良药。', source: '《水健康》第三卷' },
            { title: '第4课：水与经络', text: '中医认为水液在体内的运行与经络密切相关。三焦是水液代谢的通道，膀胱经主管水液排泄。通过针灸、按摩相关穴位，可调节水液代谢。饮水养生，不可忽视经络之道。', source: '《水健康》第四卷' },
            { title: '第5课：科学饮水时间表', text: '早7点250毫升唤醒身体，9点200毫升提升效率，11点半200毫升助消化，下午3点200毫升缓解疲劳，傍晚5点200毫升促代谢，睡前9点100毫升防脱水。核心原则：少量多次。', source: '《水健康》第二卷' },
            { title: '第6课：运动与补水', text: '运动前2小时预补水300-500毫升。运动中每15-20分钟补充150-200毫升。运动后1小时内补充流失量的150%。剧烈运动超1小时建议含电解质的运动饮料补充钠钾。', source: '《水健康》第五卷' },
            { title: '第7课：特殊人群饮水', text: '老年人口渴感减退需主动定时饮水。儿童1-3岁约700毫升，4-8岁约1000毫升。孕妇每天建议2300毫升，哺乳期2700毫升以上。慢性病患者在医生指导下调整。', source: '《水健康》第六卷' },
            { title: '第8课：水与美容', text: '皮肤含水量约70%，缺水导致干燥、暗沉、细纹。每天2000毫升以上的饮水量是基础护肤。充足饮水加适当护肤是黄金组合。从内到外的水润，才是真正的美丽。', source: '《水健康》第七卷' },
            { title: '第9课：水与睡眠', text: '睡前1小时适量饮水100-150毫升可预防夜间脱水，但不宜过多以免起夜。卧室保持湿度40-60%有助睡眠。脱水会导致夜间腿部抽筋和口干，影响睡眠质量。', source: '《水健康》第八卷' },
            { title: '第10课：四季饮水养生', text: '春饮花茶疏肝解郁，夏饮绿茶清热消暑，秋饮乌龙润燥生津，冬饮红茶温胃暖身。不同季节饮水温度也应调整：夏季可稍凉不低于10度，冬季温热为宜。顺应节气，水到渠成。', source: '《水健康》第十卷' }
        ]
    };

    // 苏格拉底对话树
    const SOCRATIC_TREE = [
        { id: 0, role: 'master', text: '欢迎来到水的智慧殿堂。我是你的水学导师。让我们通过对话来探索水的奥秘。请问——你认为，水最重要的品质是什么？',
          options: [
            { text: '我觉得是水的柔软和包容', next: 1 },
            { text: '应该是水能滋养万物的能力', next: 2 },
            { text: '水能以柔克刚，看似弱实则强', next: 3 }
          ]
        },
        { id: 1, role: 'master', text: '很好的观察！老子说"上善若水"。水确实至柔至顺。但你是否想过——水的柔软恰恰是它最大的力量？试想，水滴为何能穿石？',
          options: [
            { text: '因为水持之以恒，从不放弃', next: 4 },
            { text: '因为水不与石头硬碰硬，而是找到缝隙', next: 5 }
          ]
        },
        { id: 2, role: 'master', text: '说得好！水滋养万物却不争功。世间还有什么比这更接近"道"呢？那么我问你——如果水只滋养而从不索取，它会枯竭吗？',
          options: [
            { text: '不会，因为水有循环——蒸发后又会回来', next: 6 },
            { text: '会的，所以我们要珍惜水资源', next: 7 }
          ]
        },
        { id: 3, role: 'master', text: '好一个"以柔克刚"！《道德经》云："天下莫柔弱于水，而攻坚强者莫之能胜。"你觉得这个道理可以用在生活中的什么地方？',
          options: [
            { text: '面对困难时，不要硬撑，要学会变通', next: 8 },
            { text: '与人相处时，温和比强硬更有力量', next: 9 }
          ]
        },
        { id: 4, role: 'master', text: '正是如此！坚持，是时间赋予水的武器。正如我们说「一万年太久，分秒必争」——每一秒的坚持都是一滴水，终将穿透一切阻碍。你现在明白时间与水的关系了吗？',
          options: [
            { text: '明白了！每一秒都像一滴水，积少成多', next: 10 },
            { text: '我想继续探索水的其他智慧', next: 11 }
          ]
        },
        { id: 5, role: 'master', text: '妙哉！水从不正面对抗，它总是找到最优路径。山挡不住水，石拦不住河。水教会我们：遇到障碍不要硬碰，绕过去，或者慢慢渗透。',
          options: [
            { text: '这就是"顺势而为"的智慧', next: 10 },
            { text: '水还有什么人生智慧？', next: 11 }
          ]
        },
        { id: 6, role: 'master', text: '精彩！你发现了水循环的深层智慧。给予并不意味着失去——水蒸发到天空，化为雨露重返大地。善行如水，终将回到自己身边。这就是"上善若水"的完整含义。',
          options: [
            { text: '原来"善"也有循环，付出终有回报', next: 10 },
            { text: '我还想了解更多', next: 11 }
          ]
        },
        { id: 7, role: 'master', text: '珍惜，是智慧的开端。正如珍惜时间一样，每一滴水、每一秒钟都值得敬畏。「分秒必争」不仅是对时间的态度，也是对生命中一切珍贵事物的态度。',
          options: [
            { text: '我理解了，珍惜时间就是珍惜生命', next: 10 },
            { text: '继续学习水的道理', next: 11 }
          ]
        },
        { id: 8, role: 'master', text: '对！水遇到石头不会停下，而是改变方向继续流动。这就是"水的变通"——不执着于形式，只执着于目标。生活中遇到挫折，换条路走，依然能到达大海。',
          options: [{ text: '受教了，谢谢导师的指点', next: 10 }]
        },
        { id: 9, role: 'master', text: '孔子说"智者乐水"。温和的水看似无力，却能感化坚硬的石头。与人相处，温润如水比锋利如刀更能赢得人心。这就是水的智慧——利他而不争。',
          options: [{ text: '温润如水，利他不争，我记住了', next: 10 }]
        },
        { id: 10, role: 'master', text: '🎓 恭喜你完成了这段水的智慧对话！记住：像水一样柔软，像水一样坚持，像水一样包容。珍惜每一秒，如同珍惜每一滴水。「一万年太久，分秒必争」——愿你的人生如水般丰盈。',
          options: [{ text: '🔄 重新开始对话', next: 0 }, { text: '🔊 朗读总结', next: -1 }]
        },
        { id: 11, role: 'master', text: '水还有一个重要品质——包容。大海为何能成为百川之王？因为它处于最低处，不拒绝任何一条河流。越是伟大的人，越是谦逊包容。你觉得自己在生活中够"包容"吗？',
          options: [
            { text: '有时候做不到，但我愿意学习', next: 10 },
            { text: '包容很难，但水给了我启发', next: 10 }
          ]
        }
    ];

    let currentWaterCategory = 'science';
    let currentWaterIndex = 0;
    let socraticNode = 0;
    
    // 水学学习进度追踪
    let waterLearning = { viewed: [], listened: [], totalViewed: 0, freeQuota: 5, quotaUsed: 0, unlocked: false };

    function switchWaterTab(tab) {
        currentWaterCategory = tab;
        currentWaterIndex = 0;
        document.querySelectorAll('.water-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        const lessonArea = document.getElementById('waterLessonContent');
        const socraticArea = document.getElementById('socraticSection');
        if (tab === 'socratic') {
            lessonArea.style.display = 'none';
            socraticArea.style.display = 'block';
            startSocratic();
        } else {
            lessonArea.style.display = 'block';
            socraticArea.style.display = 'none';
            renderWaterLesson();
        }
    }

    function renderWaterLesson() {
        const lessons = WATER_LESSONS[currentWaterCategory] || WATER_LESSONS.science;
        const lesson = lessons[currentWaterIndex] || lessons[0];
        const lessonKey = currentWaterCategory + '_' + currentWaterIndex;
        const isViewed = waterLearning.viewed.includes(lessonKey);
        const isListened = waterLearning.listened.includes(lessonKey);
        
        // 检查是否超出免费配额（试用期也算付费）
        const isLocked = !waterLearning.unlocked && !isPaidMember() && waterLearning.quotaUsed >= waterLearning.freeQuota && !isViewed;
        
        if (isLocked) {
            // 显示内容但模糊化，让用户看到"差一点就能看到"的诱惑
            document.getElementById('waterLessonContent').innerHTML = `
                <div class="water-lesson" style="position:relative;overflow:hidden;">
                    <div style="filter:blur(5px);pointer-events:none;user-select:none;">
                        <div class="title">${lesson.title}</div>
                        <div class="text">${lesson.text.substring(0, 60)}...</div>
                        <div class="source">— ${lesson.source}</div>
                    </div>
                    <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;">
                        <div style="text-align:center;padding:15px;">
                            <div style="font-size:32px;margin-bottom:8px;">🔒</div>
                            <div style="font-size:13px;font-weight:bold;color:var(--gold);margin-bottom:6px;">已学完 ${waterLearning.freeQuota} 条免费内容</div>
                            <div style="font-size:10px;color:rgba(255,255,255,0.6);margin-bottom:12px;">
                                升级解锁全部 ${getTotalLessons()} 课 + AI语音问答
                            </div>
                            <button onclick="showUpgradePrompt()" style="padding:10px 24px;background:linear-gradient(135deg,var(--gold),#ff9800);border:none;border-radius:20px;color:#000;font-weight:bold;font-size:12px;cursor:pointer;">
                                ✨ 升级解锁
                            </button>
                            <div style="margin-top:8px;">
                                <span onclick="resetFreeQuota()" style="color:var(--water);font-size:10px;cursor:pointer;text-decoration:underline;">
                                    🎁 免费续杯+5条
                                </span>
                            </div>
                        </div>
                    </div>
                </div>`;
            return;
        }
        
        // 记录已阅读
        if (!isViewed) {
            waterLearning.viewed.push(lessonKey);
            waterLearning.totalViewed++;
            waterLearning.quotaUsed++;
            saveData();
        }
        
        const progressPct = Math.round((waterLearning.totalViewed / getTotalLessons()) * 100);
        document.getElementById('waterLessonContent').innerHTML = `
            <div class="water-lesson">
                <div class="title">${lesson.title} ${isListened ? '🔊' : ''}</div>
                <div class="text">${lesson.text}</div>
                <div class="source">— ${lesson.source}</div>
            </div>
            <div style="margin:8px 0;padding:6px 10px;background:rgba(0,188,212,0.08);border-radius:8px;">
                <div style="display:flex;justify-content:space-between;font-size:9px;color:rgba(255,255,255,0.5);margin-bottom:3px;">
                    <span>📊 学习进度 ${waterLearning.totalViewed}/${getTotalLessons()}</span>
                    <span>${progressPct}%</span>
                </div>
                <div style="height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;">
                    <div style="height:100%;width:${progressPct}%;background:linear-gradient(90deg,var(--water),var(--gold));border-radius:2px;transition:width 0.5s;"></div>
                </div>
            </div>
            <div style="text-align:center;font-size:9px;color:rgba(255,255,255,0.4);">${currentWaterIndex + 1} / ${lessons.length}${!waterLearning.unlocked && !isPaidMember() ? ' · 免费 ' + Math.max(0, waterLearning.freeQuota - waterLearning.quotaUsed) + '/' + waterLearning.freeQuota : isInTrialPeriod() ? ' · 🎁 试用中 剩' + getTrialDaysLeft() + '天' : ''}</div>`;
    }
    
    function getTotalLessons() { return Object.values(WATER_LESSONS).reduce((sum, cat) => sum + cat.length, 0); }
    
    function resetFreeQuota() { waterLearning.quotaUsed = 0; waterLearning.freeQuota = Math.min(waterLearning.freeQuota + 5, 15); saveData(); renderWaterLesson(); toast('🎁 +5条'); speak('太棒了！继续学习水的智慧吧！'); }
    
    function showUpgradePrompt() {
        const modal = document.createElement('div');
        modal.id = 'upgradeModal';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;';
        modal.innerHTML = `<div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:20px;padding:24px;max-width:340px;width:100%;border:1px solid rgba(255,215,0,0.3);text-align:center;">
            <div style="font-size:36px;margin-bottom:10px;">👑</div>
            <div style="font-size:16px;font-weight:bold;color:var(--gold);margin-bottom:6px;">升级水学会员</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:16px;line-height:1.6;">解锁全部${getTotalLessons()}课水学课程 + AI语音问答</div>
            <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">
                <div onclick="doUpgrade('monthly')" style="padding:12px;background:rgba(0,188,212,0.15);border:1px solid rgba(0,188,212,0.4);border-radius:12px;cursor:pointer;">
                    <div style="font-size:13px;font-weight:bold;color:var(--water);">🌊 水健康大使</div>
                    <div style="font-size:18px;font-weight:bold;color:white;">¥9.9</div>
                    <div style="font-size:9px;color:rgba(255,255,255,0.5);">水科学基础 + 苏格拉底对话</div>
                </div>
                <div onclick="doUpgrade('quarterly')" style="padding:12px;background:rgba(6,255,165,0.1);border:1px solid rgba(6,255,165,0.3);border-radius:12px;cursor:pointer;">
                    <div style="font-size:13px;font-weight:bold;color:#06ffa5;">🌿 水健康信使</div>
                    <div style="font-size:18px;font-weight:bold;color:white;">¥19.9</div>
                    <div style="font-size:9px;color:rgba(255,255,255,0.5);">全科课程 + AI语音问答</div>
                </div>
                <div onclick="doUpgrade('vip')" style="padding:12px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:12px;cursor:pointer;">
                    <div style="font-size:13px;font-weight:bold;color:var(--gold);">⭐ 水健康管理师</div>
                    <div style="font-size:18px;font-weight:bold;color:white;">¥49.9</div>
                    <div style="font-size:9px;color:rgba(255,255,255,0.5);">专业课程 + 全库 + 认证</div>
                </div>
            </div>
            <button onclick="this.closest('#upgradeModal').remove()" style="padding:8px 20px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:14px;color:rgba(255,255,255,0.6);font-size:11px;cursor:pointer;">稍后再说</button>
        </div>`;
        document.body.appendChild(modal);
    }
    
    function doUpgrade(level) {
        if (!user) { toast('请先登录'); document.getElementById('upgradeModal')?.remove(); return; }
        user.level = level;
        waterLearning.unlocked = true;
        const users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}');
        users[user.phone] = user;
        localStorage.setItem('heshuileUsers', JSON.stringify(users));
        localStorage.setItem('currentUser', JSON.stringify(user));
        saveData(); updateUI();
        document.getElementById('upgradeModal')?.remove();
        toast('👑 升级成功！');
        speak('恭喜你成为水学会员！全部课程已解锁，让我们继续探索水的智慧。');
        renderWaterLesson();
    }

    function prevWaterLesson() { const lessons = WATER_LESSONS[currentWaterCategory]; if (!lessons) return; currentWaterIndex = (currentWaterIndex - 1 + lessons.length) % lessons.length; renderWaterLesson(); }
    function nextWaterLesson() { const lessons = WATER_LESSONS[currentWaterCategory]; if (!lessons) return; currentWaterIndex = (currentWaterIndex + 1) % lessons.length; renderWaterLesson(); }
    function speakWaterLesson() {
        if (currentWaterCategory === 'socratic') { speak('水的苏格拉底对话正在进行中'); return; }
        const lessons = WATER_LESSONS[currentWaterCategory]; if (!lessons) return;
        const lesson = lessons[currentWaterIndex];
        const lessonKey = currentWaterCategory + '_' + currentWaterIndex;
        if (!waterLearning.listened.includes(lessonKey)) {
            waterLearning.listened.push(lessonKey);
            saveData();
        }
        speak(lesson.title + '。' + lesson.text);
        toast('🔊 正在朗读...');
        renderWaterLesson();
    }

    // 苏格拉底对话
    function startSocratic() {
        // 免费用户限制苏格拉底对话
        const isPaid = user?.level && !['free'].includes(user.level);
        if (!isPaid && !waterLearning.unlocked) {
            document.getElementById('socraticChat').innerHTML = '<div style="text-align:center;padding:30px 15px;"><div style="font-size:36px;margin-bottom:10px;">🏛️</div><div style="font-size:13px;font-weight:bold;color:var(--gold);margin-bottom:8px;">苏格拉底对话 · 会员专属</div><div style="font-size:11px;color:rgba(255,255,255,0.5);line-height:1.6;margin-bottom:12px;">与AI水学导师深度对话<br>通过提问引导你发现水的智慧<br>先学习基础课程，再升级解锁</div><button onclick="showUpgradePrompt()" style="padding:8px 20px;background:linear-gradient(135deg,var(--gold),#ff9800);border:none;border-radius:16px;color:#000;font-weight:bold;font-size:11px;cursor:pointer;">✨ 升级解锁</button></div>';
            document.getElementById('socraticOptions').innerHTML = '';
            return;
        }
        socraticNode = 0;
        document.getElementById('socraticChat').innerHTML = '';
        renderSocraticNode(0);
    }

    function renderSocraticNode(nodeId) {
        if (nodeId === -1) { speak('恭喜你完成了水的智慧对话！像水一样柔软，像水一样坚持，像水一样包容。一万年太久，分秒必争。'); return; }
        const node = SOCRATIC_TREE.find(n => n.id === nodeId);
        if (!node) return;
        socraticNode = nodeId;

        const chatDiv = document.getElementById('socraticChat');
        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble master';
        bubble.innerHTML = `<div class="role">🏛️ 水学导师</div>${node.text}`;
        chatDiv.appendChild(bubble);
        chatDiv.scrollTop = chatDiv.scrollHeight;

        // 自动朗读导师的话
        speak(node.text);

        const optDiv = document.getElementById('socraticOptions');
        optDiv.innerHTML = node.options.map((opt, i) => `<div class="socratic-opt" onclick="chooseSocratic(${nodeId}, ${i})">${opt.text}</div>`).join('');
    }

    function chooseSocratic(nodeId, optIndex) {
        const node = SOCRATIC_TREE.find(n => n.id === nodeId);
        if (!node) return;
        const opt = node.options[optIndex];

        const chatDiv = document.getElementById('socraticChat');
        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble student';
        bubble.innerHTML = `<div class="role">🙋 你</div>${opt.text}`;
        chatDiv.appendChild(bubble);
        chatDiv.scrollTop = chatDiv.scrollHeight;

        document.getElementById('socraticOptions').innerHTML = '<div style="text-align:center;padding:10px;color:rgba(255,255,255,0.3);font-size:10px;">导师思考中...</div>';
        setTimeout(() => renderSocraticNode(opt.next), 1200);
    }

    function renderWater() { renderWaterLesson(); }

    // ==================== 春节欢迎 ====================
    function showCNYWelcome() {
        const now = new Date();
        const month = now.getMonth() + 1;
        const day = now.getDate();
        // 2026年春节期间 2月14日-2月28日（除夕到元宵）
        if (month !== 2 || day < 14 || day > 28) return;
        const shown = localStorage.getItem('cnyWelcome2026');
        if (shown === 'true') return;
        
        setTimeout(() => {
            const banner = document.createElement('div');
            banner.id = 'cnyBanner';
            banner.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10001;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.5s;';
            banner.innerHTML = `<div style="background:linear-gradient(135deg,#8B0000,#B01D23,#1a1a2e);border-radius:24px;padding:30px 24px;max-width:340px;width:100%;text-align:center;border:2px solid rgba(255,215,0,0.4);box-shadow:0 0 40px rgba(255,215,0,0.2);">
                <div style="font-size:48px;margin-bottom:8px;">🧧🐴🧧</div>
                <div style="font-size:24px;font-weight:bold;color:#FFD700;margin-bottom:4px;">马年大吉</div>
                <div style="font-size:14px;color:rgba(255,255,255,0.8);margin-bottom:12px;">恭贺新禧 · 万事如意</div>
                <div style="font-size:12px;color:rgba(255,215,0,0.7);line-height:1.8;margin-bottom:16px;padding:12px;background:rgba(0,0,0,0.3);border-radius:12px;">
                    上善若水，水善利万物而不争<br>
                    新的一年，愿你如水般<br>
                    <span style="color:#FFD700;">柔韧 · 包容 · 坚持 · 智慧</span>
                </div>
                <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:16px;">
                    🎁 新年特别福利：分享给好友<br>免费体验水学智慧课程
                </div>
                <div style="display:flex;gap:8px;">
                    <button onclick="this.closest('#cnyBanner').remove();localStorage.setItem('cnyWelcome2026','true');openPanel('promoPanel');" style="flex:1;padding:10px;background:linear-gradient(135deg,#FFD700,#ff9800);border:none;border-radius:14px;color:#000;font-weight:bold;font-size:12px;cursor:pointer;">🧧 分享新年祝福</button>
                    <button onclick="this.closest('#cnyBanner').remove();localStorage.setItem('cnyWelcome2026','true');" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:14px;color:white;font-size:12px;cursor:pointer;">开始使用</button>
                </div>
                <div style="margin-top:10px;font-size:10px;color:rgba(255,255,255,0.3);">水若善 · 喝水了吗</div>
            </div>`;
            document.body.appendChild(banner);
            speak('马年大吉！新年快乐！马到成功，上善若水，祝你新的一年万事如意！');
        }, 1500);
    }

    // ==================== 语音唤醒系统「智回」 ====================
    let voiceRecognition = null;
    let isVoiceListening = false;
    let isVoiceAwake = false;

    function initVoiceSystem() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            console.log('浏览器不支持语音识别');
            return;
        }
        voiceRecognition = new SpeechRecognition();
        voiceRecognition.lang = 'zh-CN';
        voiceRecognition.continuous = true;
        voiceRecognition.interimResults = true;

        voiceRecognition.onresult = function(event) {
            let transcript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                transcript += event.results[i][0].transcript;
            }
            transcript = transcript.toLowerCase().trim();
            showVoiceStatus('🎤 ' + transcript);

            // 唤醒词检测
            if (!isVoiceAwake) {
                if (transcript.includes('智回') || transcript.includes('知回') || transcript.includes('志回') || transcript.includes('之回')) {
                    isVoiceAwake = true;
                    speak('我在，请吩咐');
                    showVoiceStatus('✅ 已唤醒！请说指令或问水学问题...');
                    setTimeout(() => { isVoiceAwake = false; showVoiceStatus('💤 等待唤醒词「智回」'); }, 15000);
                }
                return;
            }

            // 指令处理
            if (event.results[event.resultIndex].isFinal) {
                processVoiceCommand(transcript);
                isVoiceAwake = false;
                setTimeout(() => showVoiceStatus('💤 等待唤醒词「智回」'), 3000);
            }
        };

        voiceRecognition.onend = function() {
            if (isVoiceListening) {
                try { voiceRecognition.start(); } catch(e) {}
            }
        };

        voiceRecognition.onerror = function(event) {
            if (event.error !== 'no-speech' && event.error !== 'aborted') {
                showVoiceStatus('⚠️ 语音错误: ' + event.error);
            }
        };
    }

    function processVoiceCommand(cmd) {
        showVoiceStatus('🔄 处理: ' + cmd);
        
        if (cmd.includes('几点') || cmd.includes('时间') || cmd.includes('现在')) {
            const now = new Date();
            speak(`现在是${now.getHours()}点${now.getMinutes()}分${now.getSeconds()}秒`);
        } else if (cmd.includes('日期') || cmd.includes('今天') || cmd.includes('星期')) {
            const now = new Date();
            const weekDays = ['日','一','二','三','四','五','六'];
            speak(`今天是${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日，星期${weekDays[now.getDay()]}`);
        } else if (cmd.includes('喝了多少') || cmd.includes('今日饮水') || cmd.includes('喝水进度') || cmd.includes('饮水量')) {
            const percent = Math.round((waterData.today / waterData.goal) * 100);
            speak(`今日已喝${waterData.today}毫升，目标${waterData.goal}毫升，完成${percent}%`);
        } else if (cmd.includes('喝水') && !cmd.includes('多少') && !cmd.includes('什么时候') && !cmd.includes('好处') && !cmd.includes('温度')) {
            drinkWater(250);
        } else if (cmd.includes('提醒') && (cmd.includes('新建') || cmd.includes('添加') || cmd.includes('创建') || cmd.includes('设置'))) {
            openPanel('settingsPanel');
            speak('已打开提醒设置，请创建新提醒');
        } else if (cmd.includes('提醒') && cmd.includes('查看')) {
            if (reminds.length === 0) { speak('暂无提醒'); }
            else { speak(`你有${reminds.length}个提醒。最近的是：${reminds[0].title}`); }
        } else if (cmd.includes('打卡') || cmd.includes('签到')) {
            doCheckin();
            speak('打卡成功！');
        } else if (cmd.includes('水学') || cmd.includes('水课') || cmd.includes('课程')) {
            openPanel('waterPanel');
            speak('已打开水学课程');
        } else if (cmd.includes('经典') || cmd.includes('经书') || cmd.includes('道德经') || cmd.includes('心经')) {
            openPanel('classicsPanel');
            speak('已打开经典');
        } else if (cmd.includes('关怀') || cmd.includes('好友') || cmd.includes('通讯录')) {
            openPanel('carePanel');
            speak('已打开智能关怀');
        } else if (cmd.includes('积分') || cmd.includes('分数')) {
            speak(`你当前有${checkinData.points}积分，连续打卡${checkinData.streak}天`);
        } else if (cmd.includes('设置')) {
            openPanel('settingsPanel');
            speak('已打开设置');
        } else if (cmd.includes('对话') || cmd.includes('苏格拉底') || cmd.includes('问答')) {
            openPanel('waterPanel');
            switchWaterTab('socratic');
            speak('已进入水的苏格拉底对话');
        } else if (cmd.includes('朗读') || cmd.includes('读')) {
            speakWaterLesson();
        } else if (cmd.includes('帮助') || cmd.includes('你能')) {
            speak('马年大吉！我可以帮你：喝水、查看喝水进度、查看时间、新建提醒、打卡签到、打开水学课程、打开经典、查看积分。你也可以问我水学问题，比如：每天该喝多少水？春节怎么喝水？说智回唤醒我后说指令即可。');
        } else {
            // 水学知识库智能问答
            const answer = matchWaterKB(cmd);
            if (answer) {
                speak(answer);
                showVoiceStatus('💧 ' + answer.substring(0, 30) + '...');
            } else {
                speak('我没听懂。你可以说：喝水、喝水进度、几点了、打开水学，也可以问水学问题，比如：每天该喝多少水？');
            }
        }
    }

    // ==================== 水学知识库（语音问答引擎）====================
    const WATER_KB = [
        { keys: ['多少水','喝多少','饮水量','每天','一天喝','八杯','杯水'], a: '成年人每天建议饮水1500到2500毫升，具体取决于体重、运动量和气候。简单算法是体重公斤数乘以30毫升。比如60公斤的人大约需要1800毫升。少量多次最佳，每次200到250毫升。观察尿液颜色，淡黄色说明水分充足。' },
        { keys: ['温度','水温','热水','冷水','冰水','凉水','多热','烫'], a: '日常饮水最佳温度是25到37度，接近体温最利于吸收。冰水会刺激胃肠收缩，空腹时尤其不建议。运动后可以喝10到15度的凉水帮助降温。特别注意，超过65度的热饮被世界卫生组织列为2A类致癌因素，一定要避免烫嘴的水。' },
        { keys: ['早上','晨起','起床','早晨','空腹','早起'], a: '晨起饮水是很好的养生习惯。经过七八个小时的睡眠，身体通过呼吸和皮肤蒸发了大约450毫升水分。建议起床后先刷牙，再空腹喝200到300毫升温水，等20分钟后吃早餐。可以促进肠胃蠕动，稀释血液，降低心脑血管风险。' },
        { keys: ['什么时候','时间表','最佳时间','几点','时间段'], a: '科学饮水时间表：早上7点，晨起一杯250毫升唤醒身体。上午9点，补充200毫升提升效率。11点半午餐前200毫升助消化。下午3点200毫升缓解疲劳。傍晚5点200毫升促进代谢。睡前9点小半杯100毫升预防脱水。核心原则是少量多次。' },
        { keys: ['脱水','缺水','口渴','渴','不够','不足'], a: '仅百分之一到二的脱水就会显著影响认知功能。轻度脱水症状包括口渴、尿液深黄、疲劳、注意力下降、头痛。感到口渴时身体其实已经轻度脱水了。长期轻度脱水会增加肾结石、尿路感染、便秘等风险。建议主动定时饮水。' },
        { keys: ['运动','健身','出汗','跑步','锻炼','运动后'], a: '运动前2小时建议预先补水300到500毫升。运动中每15到20分钟补充150到200毫升，不要等口渴才喝。运动后1小时内补充流失量的150%。剧烈运动超过1小时，建议含电解质的运动饮料补充钠和钾。' },
        { keys: ['减肥','瘦身','体重','饭前喝'], a: '饭前30分钟喝一杯水大约300毫升，可以增加饱腹感，有助于控制进食量。研究显示这个习惯可以帮助减少每餐大约75大卡的摄入。但喝水减肥只是辅助，不能替代合理的饮食和运动计划。' },
        { keys: ['皮肤','美容','护肤','保湿','美白'], a: '皮肤含水量约百分之七十，缺水会导致干燥、暗沉、细纹加速。建议每天2000毫升以上的饮水量。但多喝水就能美白是夸大说法，皮肤状态受多种因素综合影响。充足饮水加上适当护肤是好的组合。' },
        { keys: ['咖啡','茶','饮料','果汁','奶茶','可乐'], a: '咖啡和茶虽然含水分，但咖啡因有轻微利尿作用，不能完全替代白水。含糖饮料和果汁会增加糖分摄入。建议每天至少一半的饮水量来自白水或淡茶，其他饮品作为补充。' },
        { keys: ['睡前','晚上','夜间','起夜','失眠'], a: '睡前1小时适量饮水100到150毫升可以预防夜间脱水，但不宜过多以免频繁起夜影响睡眠。如果经常起夜，建议睡前2小时减少饮水量。' },
        { keys: ['矿泉水','纯净水','净水','自来水','滤芯','净水器'], a: '天然矿泉水含有锶、偏硅酸、钙、镁等有益矿物质。家用净水根据水质选择：一般城市自来水用活性炭滤芯去除余氯和异味，水质硬的地区建议反渗透膜。关键是按时更换滤芯，否则反而滋生细菌。' },
        { keys: ['空气水','大气水','AWG','空气取水','福能达','FND','制水机'], a: '空气制水是从空气中提取饮用水的前沿技术。福能达FND是这个行业的领军企业，深耕超过十年，产品销往100多个国家，为80多个品牌代工。全球空气中含有约13万亿吨水蒸气，AWG设备通过冷凝技术提取纯净饮用水，产水成本约一毛到五毛每升，已在中东、非洲等缺水地区广泛应用。' },
        { keys: ['上善若水','哲学','文化','老子','道德经','智慧'], a: '老子道德经说：上善若水，水善利万物而不争，处众人之所恶，故几于道。水的品德是无私奉献、滋养万物却从不自夸。水往低处流，正如谦卑的智者。做人当学水，利他不争，处下不卑。' },
        { keys: ['水分子','H2O','分子','氢键','结构','化学'], a: '水分子由两个氢原子和一个氧原子组成，形成104.5度的夹角。这个角度赋予水独特的极性，使它成为万能溶剂。水的异常特性，冰比水轻、高比热容、高表面张力，都源于氢键。' },
        { keys: ['老人','老年','长辈','年纪大'], a: '老年人口渴感觉会减退，更容易不知不觉脱水。建议主动定时饮水，不要等口渴再喝，每天至少1500毫升。心肾功能不好的老人需在医生指导下控制饮水量。定时提醒长辈喝水，这也是请你喝水的初心。' },
        { keys: ['小孩','儿童','宝宝','孩子'], a: '儿童饮水参考：一到三岁约700毫升每天，四到八岁约1000毫升，九到十三岁约1300到1500毫升。白水为主，避免含糖饮料。可以用有趣的水杯、定时提醒帮助孩子养成主动喝水的好习惯。' },
        { keys: ['孕妇','怀孕','哺乳','孕期'], a: '孕妇每天建议饮水2300毫升左右，哺乳期需增加到2700毫升以上。孕期应避免咖啡因超过200毫克每天。温水为主，避免冰饮刺激。如有妊娠水肿，不要盲目限水，请咨询医生。' },
        { keys: ['好处','为什么','重要','作用','功效'], a: '水占人体约百分之六十到七十。充足饮水可以促进新陈代谢、帮助排毒、维持肾脏健康、改善皮肤状态、提升注意力和记忆力、预防便秘和肾结石。研究表明保持充足饮水可以提升百分之十五到二十的工作效率。' },
        { keys: ['水若善','你是谁','关于','创始人','福能达','FND'], a: '我是水若善，本名来自上善若水之意，是福能达FND空气制水机的创始人，深耕空气制水行业超过十年，产品销往100多个国家，为超过80个品牌代工。我专注于水学研究，已著有《水科学》《水医学》《水健康》《水哲学》等系列著作超千万字。愿望是让每个人都懂水、爱水、科学饮水。' },
    ];

    function matchWaterKB(text) {
        const t = text.toLowerCase();
        let best = null, bestScore = 0;
        for (const item of WATER_KB) {
            let score = 0;
            for (const k of item.keys) {
                if (t.includes(k)) score += (k.length >= 3 ? 3 : 1);
            }
            if (score > bestScore) { bestScore = score; best = item; }
        }
        return bestScore > 0 ? best.a : null;
    }

    function toggleVoiceRecognition() {
        if (!voiceRecognition) {
            initVoiceSystem();
            if (!voiceRecognition) { toast('浏览器不支持语音'); return; }
        }
        
        const voiceBtn = document.querySelector('.func-btn.voice');
        if (isVoiceListening) {
            isVoiceListening = false;
            voiceRecognition.stop();
            if (voiceBtn) voiceBtn.style.background = '';
            showVoiceStatus('🔇 语音已关闭');
            setTimeout(() => document.getElementById('voiceStatus').classList.remove('show'), 2000);
            speak('语音助手已关闭');
        } else {
            isVoiceListening = true;
            try { voiceRecognition.start(); } catch(e) {}
            if (voiceBtn) voiceBtn.style.background = 'linear-gradient(135deg, #ff006e, #ff4444)';
            showVoiceStatus('🎤 语音已开启，说「智回」唤醒我');
            speak('语音助手已开启，说智回唤醒我');
        }
    }

    function showVoiceStatus(text) {
        const el = document.getElementById('voiceStatus');
        el.textContent = text;
        el.classList.add('show');
        clearTimeout(el._timer);
        if (!text.includes('等待唤醒') && !text.includes('已开启')) {
            el._timer = setTimeout(() => el.classList.remove('show'), 4000);
        }
    }
    function speak(t) { speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(t); const langMap = {zh:'zh-CN',en:'en-US',ja:'ja-JP',ko:'ko-KR',es:'es-ES',ar:'ar-SA',he:'he-IL'}; u.lang = langMap[currentLang] || 'en-US'; speechSynthesis.speak(u); }

    // 春节分享
    const CNY_GREETINGS = [
        '🧧 马年大吉！马到成功，上善若水，愿新的一年你如水般柔韧坚强。记得每天喝够水哦！点击体验：',
        '🐴 骏马奔腾！水善利万物而不争——新年送你一份水的智慧。科学饮水，健康一整年：',
        '✨ 新春快乐！一万年太久，分秒必争。新的一年，让滴答声提醒你珍惜每一刻，也别忘了喝水：',
        '🧧 马年吉祥！水若善，善若水。送你一款会提醒喝水的智慧时钟，还能学水学知识哦：',
        '🌊 新年好！你知道吗？大脑80%是水，每天喝够2000毫升能提升15%工作效率。试试这个：',
    ];
    
    function shareCNY(method) {
        logActivity('share', '分享祝福（' + method + '）');
        siteStats.shares.total=(siteStats.shares.total||0)+1; if(!siteStats.shares.methods)siteStats.shares.methods={}; siteStats.shares.methods[method]=(siteStats.shares.methods[method]||0)+1; trackEvent('share','cny_share',method); saveStats();
        const greeting = CNY_GREETINGS[Math.floor(Math.random() * CNY_GREETINGS.length)];
        const url = user ? getShareUrl('invite=' + user.id) : getShareUrl('');
        const fullText = greeting + ' ' + url;
        
        if (method === 'copy') {
            safeCopy(fullText, '📋 已复制祝福！'); speak('新年祝福已复制，快去发给好友吧！');
        } else if (method === 'wechat') {
            safeCopy(fullText, '📋 已复制，请打开微信粘贴发送'); speak('祝福已复制，打开微信粘贴给好友吧！');
        } else if (method === 'sms') {
            window.open('sms:?body=' + encodeURIComponent(fullText));
        } else if (method === 'poster') {
            generateCNYPoster();
        }
    }
    
    function generateCNYPoster() {
        const canvas = document.createElement('canvas');
        canvas.width = 600; canvas.height = 900;
        const ctx = canvas.getContext('2d');
        
        // 背景渐变
        const grad = ctx.createLinearGradient(0, 0, 0, 900);
        grad.addColorStop(0, '#8B0000');
        grad.addColorStop(0.5, '#B01D23');
        grad.addColorStop(1, '#1a1a2e');
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, 600, 900);
        
        // 装饰
        ctx.fillStyle = 'rgba(255,215,0,0.1)';
        ctx.beginPath(); ctx.arc(300, 300, 200, 0, Math.PI * 2); ctx.fill();
        
        // 文字
        ctx.textAlign = 'center';
        ctx.fillStyle = '#FFD700';
        ctx.font = 'bold 60px serif';
        ctx.fillText('🧧', 300, 160);
        ctx.font = 'bold 48px serif';
        ctx.fillText('马年大吉', 300, 260);
        
        ctx.fillStyle = '#FFFFFF';
        ctx.font = '20px sans-serif';
        ctx.fillText('上善若水 · 水善利万物而不争', 300, 340);
        
        ctx.fillStyle = 'rgba(255,255,255,0.8)';
        ctx.font = '16px sans-serif';
        ctx.fillText('一万年太久，分秒必争', 300, 400);
        ctx.fillText('记得每天喝够2000毫升水', 300, 430);
        
        ctx.fillStyle = '#FFD700';
        ctx.font = 'bold 22px sans-serif';
        ctx.fillText('智回 · 请你喝水', 300, 520);
        
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.font = '14px sans-serif';
        ctx.fillText('扫码或长按识别，开启水学智慧之旅', 300, 580);
        
        // 下载区域
        ctx.fillStyle = 'rgba(255,255,255,0.1)';
        ctx.roundRect(200, 620, 200, 200, 16);
        ctx.fill();
        ctx.fillStyle = '#FFFFFF';
        ctx.font = '13px sans-serif';
        ctx.fillText('水若善 · 水学研究院', 300, 860);
        ctx.fillText('— 喝水了吗 —', 300, 885);
        
        // 下载
        const link = document.createElement('a');
        link.download = '马年大吉_智回请你喝水.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        toast('🖼️ 海报已保存！');
        speak('新年海报已生成，分享给好友吧！');
    }

    // ═══ 春节祝福馆 · 初一到十五 ═══
    const FEST_DAYS = [
        { day:0, name:'除夕', folk:'辞旧迎新', emoji:'🎆', greeting:'除旧布新，马到成功！', water:'年夜饭间别忘喝水，大鱼大肉更需要水来帮助消化。', bg:'linear-gradient(135deg,#1a0a2e,#4A0E4E,#8B0000,#FFD700)', accent:'#FFD700' },
        { day:1, name:'正月初一', folk:'拜年迎新', emoji:'🧧', greeting:'马年大吉，万事如意！', water:'新年第一杯水，唤醒一整年的活力。', bg:'linear-gradient(135deg,#8B0000,#FF4500,#FFD700)', accent:'#FFD700' },
        { day:2, name:'正月初二', folk:'回娘家', emoji:'🏠', greeting:'阖家团圆，幸福安康！', water:'回家路上别忘喝水，温暖从一杯水开始。', bg:'linear-gradient(135deg,#B01D23,#E74C3C,#F39C12)', accent:'#F39C12' },
        { day:3, name:'正月初三', folk:'安睡日', emoji:'😴', greeting:'静心养神，蓄力前行！', water:'休息日也要按时饮水，身体在修复中更需要水。', bg:'linear-gradient(135deg,#1a1a3e,#2d1b69,#6B3FA0)', accent:'#B388FF' },
        { day:4, name:'正月初四', folk:'迎灶神', emoji:'🔥', greeting:'灶神归位，五谷丰登！', water:'厨房里的水最有生命力，煮一壶好水迎灶神。', bg:'linear-gradient(135deg,#8B0000,#C0392B,#E67E22)', accent:'#E67E22' },
        { day:5, name:'正月初五', folk:'迎财神', emoji:'💰', greeting:'财源滚滚，马到成功！', water:'财富如水，善流则丰。今天喝够8杯水，财运亨通！', bg:'linear-gradient(135deg,#B8860B,#DAA520,#FFD700)', accent:'#FFF8DC' },
        { day:6, name:'正月初六', folk:'送穷·开市', emoji:'🎊', greeting:'送穷迎富，开工大吉！', water:'新年开工第一事：给身体补满水，精力充沛创佳绩。', bg:'linear-gradient(135deg,#006400,#228B22,#32CD32)', accent:'#7FFF00' },
        { day:7, name:'正月初七', folk:'人日', emoji:'🧑', greeting:'人寿年丰，健康常在！', water:'人日话健康：人体60%是水，爱自己从喝水开始。', bg:'linear-gradient(135deg,#0a3d62,#00bcd4,#00d4ff)', accent:'#00d4ff' },
        { day:8, name:'正月初八', folk:'谷日·顺星', emoji:'⭐', greeting:'谷物丰收，星辰指引！', water:'星辰大海都由水组成，一杯水连接你与宇宙。', bg:'linear-gradient(135deg,#0d1b2a,#1b2838,#34495e)', accent:'#85C1E9' },
        { day:9, name:'正月初九', folk:'天公生', emoji:'🙏', greeting:'天公赐福，吉祥如意！', water:'天降甘霖是最大的恩赐，每一滴水都值得感恩。', bg:'linear-gradient(135deg,#4A0E4E,#812F91,#C56CD6)', accent:'#E1BEE7' },
        { day:10, name:'正月初十', folk:'石头生日', emoji:'🪨', greeting:'稳如磐石，坚韧不拔！', water:'水滴石穿的智慧：柔能克刚，恒能胜一切。', bg:'linear-gradient(135deg,#2C3E50,#34495E,#5D6D7E)', accent:'#AEB6BF' },
        { day:11, name:'正月十一', folk:'请女婿', emoji:'🥂', greeting:'女婿拜年，其乐融融！', water:'以水代酒敬长辈，健康是最好的礼物。', bg:'linear-gradient(135deg,#78281F,#B03A2E,#E74C3C)', accent:'#FADBD8' },
        { day:12, name:'正月十二', folk:'搭灯棚', emoji:'🔨', greeting:'张灯结彩，喜迎元宵！', water:'搭建梦想如搭灯棚，每天八杯水为身体打好地基。', bg:'linear-gradient(135deg,#7B241C,#C0392B,#F1C40F)', accent:'#F1C40F' },
        { day:13, name:'正月十三', folk:'灯头生日', emoji:'💡', greeting:'点亮心灯，照亮前程！', water:'水的折射让光更美丽，清澈的身体让心灵更明亮。', bg:'linear-gradient(135deg,#1B4F72,#2E86C1,#5DADE2)', accent:'#AED6F1' },
        { day:14, name:'正月十四', folk:'试花灯', emoji:'🏮', greeting:'花灯初上，美不胜收！', water:'明天就是元宵节，提前喝好水，明天更精彩！', bg:'linear-gradient(135deg,#922B21,#E74C3C,#F39C12)', accent:'#FDEBD0' },
        { day:15, name:'正月十五', folk:'元宵节', emoji:'🥮', greeting:'月圆人圆，元宵快乐！', water:'汤圆配温水，团团圆圆又健康。上善若水，分秒必争！', bg:'linear-gradient(135deg,#8B0000,#DC143C,#FF6347,#FFD700)', accent:'#FFD700' }
    ];
    let currentFestDay = 0;

    function renderFestGrid() {
        // 自动填充登录用户名字
        var fn = document.getElementById('festName');
        if (fn && !fn.value && user && user.name) fn.value = user.name;
        const grid = document.getElementById('festDayGrid');
        if (!grid) return;
        const today = new Date();
        const cnyStart = new Date(2026, 1, 16); // 2026-02-16 除夕=day0, 初一=day1
        const daysSinceCNY = Math.floor((today - cnyStart) / 86400000);
        grid.innerHTML = FEST_DAYS.map((d,i) => {
            const isToday = d.day === daysSinceCNY;
            const isPast = d.day < daysSinceCNY;
            const isFuture = d.day > daysSinceCNY;
            return `<div onclick="openFestPage(${i})" style="padding:10px 4px;border-radius:12px;text-align:center;cursor:pointer;background:${d.bg};position:relative;border:${isToday?'2px solid #fff':'1px solid rgba(255,255,255,0.15)'};opacity:${isFuture?'0.6':'1'};transition:transform .2s;" onmouseenter="this.style.transform='scale(1.05)'" onmouseleave="this.style.transform='scale(1)'">
                ${isToday?'<div style="position:absolute;top:-6px;right:-6px;background:#ff4757;color:#fff;font-size:8px;padding:1px 5px;border-radius:8px;">今天</div>':''}
                <div style="font-size:22px;">${d.emoji}</div>
                <div style="font-size:11px;font-weight:bold;color:#fff;margin:3px 0;">${d.name}</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.8);">${d.folk}</div>
            </div>`;
        }).join('');
    }

    // ═══ 万马奔腾SVG（存为变量避免转义问题）═══
    const HORSE_SVG = "data:image/svg+xml," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 400"><g fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" opacity="0.5"><path d="M80 280Q90 240 110 230Q130 220 140 200L150 180Q160 160 170 165L180 170Q175 150 180 140L195 130Q200 125 205 130L210 140Q215 150 210 160L200 170Q210 165 220 170L240 180Q260 190 270 210Q280 230 290 240L310 260Q320 270 330 275L350 280Q340 285 320 290L300 285Q280 280 260 275L240 265Q220 258 200 260L180 265Q160 270 140 278L100 290Z"/><path d="M195 130Q200 110 210 100L220 95Q225 92 220 100"/><path d="M150 180Q142 170 138 175L130 185"/><path d="M400 260Q410 220 430 210Q450 200 460 180L470 160Q480 140 490 145L500 150Q495 130 500 120L515 110Q520 105 525 110L530 120Q535 130 530 140L520 150Q530 145 540 150L560 160Q580 170 590 190Q600 210 610 220L630 240Q640 250 650 255L670 260Q660 265 640 270L620 265Q600 260 580 255L560 245Q540 238 520 240L500 245Q480 250 460 258L420 270Z"/><path d="M515 110Q520 90 530 80L540 75Q545 72 540 80"/><path d="M470 160Q462 150 458 155L450 165"/><path d="M620 290Q630 260 650 250Q665 242 672 228L678 215Q685 200 692 204L698 208Q695 192 700 185L710 178Q714 174 718 178L722 186Q726 194 722 202L714 210Q722 206 730 210L745 218Q760 226 768 242Q774 256 780 264L792 278"/><path d="M710 178Q714 162 722 154L728 150"/><path d="M0 320Q10 290 25 282Q38 275 44 262L50 250Q56 236 62 240L66 244Q64 230 68 224L78 218Q82 214 85 218L88 226Q92 234 88 240L82 248Q88 244 95 248L108 256Q122 264 128 278Q134 290 140 298L155 310"/><path d="M50 250Q42 240 38 245L30 255"/></g></svg>');

    function openFestPage(idx) {
        currentFestDay = idx;
        const d = FEST_DAYS[idx];
        const name = document.getElementById('festName') ? document.getElementById('festName').value.trim() : '';
        const page = document.getElementById('festPage');
        page.style.background = d.bg;

        // 构建HTML（避免模板字符串转义问题）
        var html = '';
        // 万马奔腾背景层
        html += '<div style="position:absolute;top:0;left:0;right:0;bottom:0;background-image:url(' + HORSE_SVG + ');background-size:cover;background-position:center bottom;background-repeat:no-repeat;pointer-events:none;opacity:1;"></div>';
        // 内容层
        html += '<div style="position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;">';
        html += '<div style="font-size:60px;margin-bottom:8px;filter:drop-shadow(0 4px 12px rgba(0,0,0,0.3));">' + d.emoji + '</div>';
        html += '<div style="font-size:14px;color:rgba(255,255,255,0.7);letter-spacing:4px;margin-bottom:4px;">丙午马年</div>';
        html += '<div style="font-size:36px;font-weight:900;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,0.3);margin-bottom:4px;">' + d.name + '</div>';
        html += '<div style="font-size:16px;color:' + d.accent + ';margin-bottom:16px;">' + d.folk + '</div>';
        html += '<div style="width:50px;height:2px;background:' + d.accent + ';margin:0 auto 16px;border-radius:2px;"></div>';
        // 个性化祝福 — 独立一行
        if (name) {
            html += '<div style="font-size:16px;color:' + d.accent + ';margin-bottom:10px;letter-spacing:3px;opacity:0.95;font-weight:500;">🎋 ' + name + '祝福您</div>';
        }
        // 祝福语（不含名字，干净独立）
        html += '<div style="font-size:22px;font-weight:700;color:#fff;line-height:1.6;margin-bottom:12px;max-width:300px;text-shadow:0 1px 4px rgba(0,0,0,0.3);">' + d.greeting + '</div>';
        html += '<div style="font-size:14px;color:rgba(255,255,255,0.85);line-height:1.8;max-width:280px;margin-bottom:24px;padding:12px;background:rgba(255,255,255,0.08);border-radius:12px;backdrop-filter:blur(4px);">💧 ' + d.water + '</div>';
        html += '<div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:4px;">— 长寿百岁，别忘喝水 —</div>';
        html += '<div style="font-size:11px;color:rgba(255,255,255,0.4);">喝水了吗</div>';
        html += '<div style="font-size:11px;color:' + d.accent + ';margin-top:8px;">喝水了吗 💧</div>';
        html += '</div>';

        page.innerHTML = html;
        document.getElementById('festOverlay').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function showViralLanding(dayIdx, senderName, inviterId) {
        siteStats.festivals.views=(siteStats.festivals.views||0)+1; if(!siteStats.festivals.days)siteStats.festivals.days={}; siteStats.festivals.days['day'+dayIdx]=(siteStats.festivals.days['day'+dayIdx]||0)+1; trackEvent('festival','viral_landing','day='+dayIdx+'&from='+(senderName||'')); saveStats();
        var d = FEST_DAYS[dayIdx] || FEST_DAYS[0];
        var ov = document.createElement('div');
        ov.id = 'viralLanding';
        ov.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:30000;overflow-y:auto;';

        var bgColors = d.bg;
        var html = '';
        html += '<div style="min-height:100vh;background:' + bgColors + ';display:flex;flex-direction:column;align-items:center;padding:40px 20px 120px;text-align:center;position:relative;">';

        // 万马奔腾背景
        html += '<div style="position:absolute;top:0;left:0;right:0;bottom:0;background-image:url(' + HORSE_SVG + ');background-size:cover;background-position:center bottom;pointer-events:none;opacity:1;"></div>';

        // 内容
        html += '<div style="position:relative;z-index:1;max-width:360px;">';

        // emoji + 马年
        html += '<div style="font-size:70px;margin-bottom:8px;filter:drop-shadow(0 4px 16px rgba(0,0,0,0.3));animation:bounce 2s infinite;">' + d.emoji + '</div>';
        html += '<div style="font-size:13px;color:rgba(255,255,255,0.6);letter-spacing:5px;margin-bottom:6px;">丙午马年 · ' + d.name + '</div>';

        // 个性化发送者信息
        if (senderName) {
            html += '<div style="background:rgba(255,255,255,0.1);backdrop-filter:blur(8px);border:1px solid rgba(255,215,0,0.3);border-radius:16px;padding:12px 20px;margin:12px 0;">';
            html += '<div style="font-size:13px;color:rgba(255,255,255,0.6);">来自</div>';
            html += '<div style="font-size:20px;font-weight:bold;color:#FFD700;margin:4px 0;">🎋 ' + decodeURIComponent(senderName) + '</div>';
            html += '<div style="font-size:13px;color:rgba(255,255,255,0.6);">的新年祝福</div>';
            html += '</div>';
        }

        // 祝福语
        html += '<div style="font-size:28px;font-weight:900;color:#fff;line-height:1.5;margin:20px 0 12px;text-shadow:0 2px 8px rgba(0,0,0,0.3);">' + d.greeting + '</div>';
        html += '<div style="font-size:15px;color:rgba(255,255,255,0.85);line-height:1.8;padding:14px 18px;background:rgba(255,255,255,0.08);border-radius:14px;backdrop-filter:blur(4px);margin-bottom:20px;">💧 ' + d.water + '</div>';

        html += '<div style="width:40px;height:2px;background:' + d.accent + ';margin:0 auto 20px;border-radius:2px;"></div>';

        // ═══ 裂变核心：3个行动按钮 ═══
        html += '<div style="display:flex;flex-direction:column;gap:10px;width:100%;">';

        // 按钮1: 我也要发祝福（进入app创建自己的）
        html += '<button onclick="enterAppFromLanding()" style="width:100%;padding:14px;border-radius:16px;border:none;background:linear-gradient(135deg,#FFD700,#FF9500);color:#000;font-size:16px;font-weight:bold;cursor:pointer;box-shadow:0 4px 15px rgba(255,215,0,0.4);">';
        html += '🧧 我也要发祝福给朋友</button>';

        // 按钮2: 转发这条祝福
        html += '<button onclick="viralReShare(' + dayIdx + ')" style="width:100%;padding:14px;border-radius:16px;border:none;background:#07C160;color:#fff;font-size:16px;font-weight:bold;cursor:pointer;box-shadow:0 4px 15px rgba(7,193,96,0.3);">';
        html += '💬 转发给我的朋友</button>';

        // 按钮3: 保存图片
        html += '<button onclick="viralSavePoster(' + dayIdx + ')" style="width:100%;padding:14px;border-radius:16px;border:none;background:rgba(255,255,255,0.15);color:#fff;font-size:16px;font-weight:bold;cursor:pointer;backdrop-filter:blur(8px);">';
        html += '🖼️ 保存祝福图片</button>';

        html += '</div>';

        // 底部信息
        html += '<div style="margin-top:30px;font-size:12px;color:rgba(255,255,255,0.4);">上善若水 · 分秒必争</div>';
        html += '<div style="font-size:11px;color:rgba(255,255,255,0.3);margin-top:4px;">水若善 · 喝水了吗</div>';

        html += '</div></div>';

        // 底部固定：体验完整版
        html += '<div style="position:fixed;bottom:0;left:0;right:0;z-index:30001;background:rgba(0,0,0,0.8);backdrop-filter:blur(12px);padding:12px 20px;padding-bottom:max(12px,env(safe-area-inset-bottom));text-align:center;">';
        html += '<div style="font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:6px;">💧 智能喝水提醒 · AI水学助手 · 健康管理</div>';
        html += '<button onclick="enterAppFromLanding()" style="padding:10px 30px;border-radius:20px;border:none;background:linear-gradient(135deg,#00d4ff,#06ffa5);color:#000;font-weight:bold;font-size:14px;cursor:pointer;">✨ 免费体验完整版</button>';
        html += '</div>';

        ov.innerHTML = html;
        document.body.appendChild(ov);
        document.body.style.overflow = 'hidden';
    }

    function enterAppFromLanding() {
        var landing = document.getElementById('viralLanding');
        if (landing) {
            landing.style.transition = 'opacity 0.5s';
            landing.style.opacity = '0';
            setTimeout(function() {
                landing.remove();
                document.body.style.overflow = '';
                // 清除URL参数
                history.replaceState(null, '', location.pathname);
                // 直接打开祝福馆让用户创建自己的
                openPanel('festivalPanel');
                toast('🧧 创建你自己的祝福发给朋友吧！');
            }, 500);
        }
    }

    function viralReShare(dayIdx) {
        var d = FEST_DAYS[dayIdx] || FEST_DAYS[0];
        // 弹出输入名字框
        var nameInput = prompt('输入你的名字（会显示在祝福中）:');
        if (nameInput === null) return;
        nameInput = nameInput.trim();
        var url = getShareUrl('day=' + dayIdx + (nameInput ? '&name=' + encodeURIComponent(nameInput) : ''));
        var text = d.emoji + ' ' + d.name + ' · ' + d.folk;
        if (nameInput) text += '\n🎋 ' + nameInput + '祝福您';
        text += '\n' + d.greeting + '\n💧 ' + d.water + '\n— 上善若水 · 分秒必争 —\n👉 ' + url;

        // 生成海报并分享
        var c = document.createElement('canvas');
        c.width = 600; c.height = 900;
        var ctx = c.getContext('2d');
        var grad = ctx.createLinearGradient(0,0,600,900);
        var colors = d.bg.match(/#[A-Fa-f0-9]{6}/g) || ['#8B0000','#FF4500','#FFD700'];
        colors.forEach(function(col,i){ grad.addColorStop(i/(colors.length-1), col); });
        ctx.fillStyle = grad; ctx.fillRect(0,0,600,900);
        ctx.fillStyle = 'rgba(255,255,255,0.04)'; ctx.beginPath(); ctx.arc(300,300,180,0,Math.PI*2); ctx.fill();
        ctx.textAlign = 'center'; ctx.fillStyle = '#fff';
        ctx.font = '60px serif'; ctx.fillText(d.emoji, 300, 140);
        ctx.font = '12px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.fillText('丙午马年', 300, 175);
        ctx.font = 'bold 40px serif'; ctx.fillStyle = '#fff'; ctx.fillText(d.name, 300, 240);
        ctx.font = '18px sans-serif'; ctx.fillStyle = d.accent; ctx.fillText(d.folk, 300, 275);
        var ny = 340;
        if (nameInput) { ctx.font = '16px sans-serif'; ctx.fillStyle = d.accent; ctx.fillText('🎋 ' + nameInput + '祝福您', 300, ny); ny += 35; }
        ctx.font = 'bold 22px sans-serif'; ctx.fillStyle = '#fff'; wrapText(ctx, d.greeting, 300, ny, 480, 32);
        ctx.font = '14px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.7)'; wrapText(ctx, '💧 ' + d.water, 300, ny+70, 460, 22);
        ctx.fillStyle = d.accent; ctx.font = '13px sans-serif'; ctx.fillText('上善若水 · 分秒必争', 300, 720);
        ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.font = '11px sans-serif'; ctx.fillText('水若善 · 喝水了吗', 300, 745);
        // 底部提示：长按识别 / 扫码
        ctx.fillStyle = 'rgba(255,255,255,0.15)'; roundRect(ctx, 150, 780, 300, 60, 12); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.font = '12px sans-serif';
        ctx.fillText('👉 长按图片 → 识别链接 → 发送祝福', 300, 808);
        ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.font = '10px sans-serif';
        ctx.fillText(url, 300, 830);

        c.toBlob(function(blob) {
            if (!blob) { safeCopy(text, '📋 祝福已复制！'); return; }
            var file = new File([blob], d.name + '_马年祝福.png', { type: 'image/png' });
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                navigator.share({ title: d.name + ' · 马年祝福', text: text, files: [file] }).catch(function(e){
                    if (e.name !== 'AbortError') safeCopy(text, '📋 祝福已复制！');
                });
            } else if (navigator.share) {
                navigator.share({ title: d.name + ' · 马年祝福', text: text, url: url }).catch(function(){
                    safeCopy(text, '📋 祝福已复制！');
                });
            } else {
                var a = document.createElement('a'); a.download = d.name + '_马年祝福.png'; a.href = URL.createObjectURL(blob); a.click(); URL.revokeObjectURL(a.href);
                safeCopy(text, '📋 祝福+图片已保存！发送给朋友吧');
            }
        }, 'image/png');
    }

    function viralSavePoster(dayIdx) {
        var d = FEST_DAYS[dayIdx] || FEST_DAYS[0];
        var c = document.createElement('canvas');
        c.width = 600; c.height = 900;
        var ctx = c.getContext('2d');
        var grad = ctx.createLinearGradient(0,0,600,900);
        var colors = d.bg.match(/#[A-Fa-f0-9]{6}/g) || ['#8B0000','#FF4500','#FFD700'];
        colors.forEach(function(col,i){ grad.addColorStop(i/(colors.length-1), col); });
        ctx.fillStyle = grad; ctx.fillRect(0,0,600,900);
        ctx.fillStyle = 'rgba(255,255,255,0.04)'; ctx.beginPath(); ctx.arc(300,300,180,0,Math.PI*2); ctx.fill();
        ctx.textAlign = 'center'; ctx.fillStyle = '#fff';
        ctx.font = '60px serif'; ctx.fillText(d.emoji, 300, 140);
        ctx.font = '12px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.fillText('丙午马年', 300, 175);
        ctx.font = 'bold 40px serif'; ctx.fillStyle = '#fff'; ctx.fillText(d.name, 300, 240);
        ctx.font = '18px sans-serif'; ctx.fillStyle = d.accent; ctx.fillText(d.folk, 300, 275);
        ctx.font = 'bold 22px sans-serif'; ctx.fillStyle = '#fff'; wrapText(ctx, d.greeting, 300, 340, 480, 32);
        ctx.font = '14px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.7)'; wrapText(ctx, '💧 ' + d.water, 300, 410, 460, 22);
        ctx.fillStyle = d.accent; ctx.font = '13px sans-serif'; ctx.fillText('上善若水 · 分秒必争', 300, 720);
        ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.font = '11px sans-serif'; ctx.fillText('水若善 · 喝水了吗', 300, 745);
        var url = getShareUrl('day=' + dayIdx);
        ctx.fillStyle = 'rgba(255,255,255,0.15)'; roundRect(ctx, 150, 780, 300, 60, 12); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.font = '12px sans-serif';
        ctx.fillText('👉 长按图片 → 发送祝福给朋友', 300, 808);
        ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.font = '10px sans-serif'; ctx.fillText(url, 300, 830);
        var link = document.createElement('a');
        link.download = d.name + '_马年祝福.png';
        link.href = c.toDataURL('image/png');
        link.click();
        toast('🖼️ 图片已保存！转发给朋友即可裂变传播');
    }

    function closeFestOverlay() {
        document.getElementById('festOverlay').style.display = 'none';
        document.body.style.overflow = '';
    }

    function festShareTo(channel) {
        var d = FEST_DAYS[currentFestDay];
        var senderForLog = (document.getElementById('festName') ? document.getElementById('festName').value.trim() : '') || (user ? user.name : '匿名');
        logActivity('send_blessing', senderForLog + ' 发送 ' + d.name + ' 祝福（' + channel + '）');
        var name = document.getElementById('festName') ? document.getElementById('festName').value.trim() : '';
        var url = getShareUrl('day=' + currentFestDay + (name ? '&name=' + encodeURIComponent(name) : '') + (user ? '&invite=' + user.id : ''));
        var blessing = name ? '\n🎋 ' + name + '祝福您' : '';
        var text = d.emoji + ' ' + d.name + '·' + d.folk + blessing + '\n' + d.greeting + '\n💧 ' + d.water + '\n— 水若善 · 喝水了吗 —\n👉 ' + url;
        if (channel === 'wechat') {
            // 生成海报图片并调起系统分享（手机上直接弹出微信选项）
            shareWithPoster(d, name, text, url);
        } else if (channel === 'sms') {
            window.open('sms:?body=' + encodeURIComponent(text));
        } else if (channel === 'contacts') {
            showFestContactsPicker(text);
        } else if (channel === 'copy') {
            safeCopy(text, '📋 ' + d.name + '祝福已复制！');
        }
    }

    function shareWithPoster(d, name, text, url) {
        // 生成祝福海报
        var c = document.createElement('canvas');
        c.width = 600; c.height = 800;
        var ctx = c.getContext('2d');
        // 背景渐变
        var grad = ctx.createLinearGradient(0, 0, 600, 800);
        var colors = d.bg.match(/#[A-Fa-f0-9]{6}/g) || ['#8B0000','#FF4500','#FFD700'];
        colors.forEach(function(col, i) { grad.addColorStop(i/(colors.length-1), col); });
        ctx.fillStyle = grad; ctx.fillRect(0,0,600,800);
        // 装饰
        ctx.fillStyle = 'rgba(255,255,255,0.04)';
        ctx.beginPath(); ctx.arc(300,280,180,0,Math.PI*2); ctx.fill();
        // 文字
        ctx.textAlign = 'center'; ctx.fillStyle = '#fff';
        ctx.font = '60px serif'; ctx.fillText(d.emoji, 300, 140);
        ctx.font = '12px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.fillText('丙午马年', 300, 175);
        ctx.font = 'bold 40px serif'; ctx.fillStyle = '#fff'; ctx.fillText(d.name, 300, 240);
        ctx.font = '18px sans-serif'; ctx.fillStyle = d.accent; ctx.fillText(d.folk, 300, 275);
        var ny = 340;
        if (name) { ctx.font = '16px sans-serif'; ctx.fillStyle = d.accent; ctx.fillText('🎋 ' + name + '祝福您', 300, ny); ny += 35; }
        ctx.font = 'bold 22px sans-serif'; ctx.fillStyle = '#fff'; wrapText(ctx, d.greeting, 300, ny, 480, 32);
        ctx.font = '14px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.7)'; wrapText(ctx, '💧 ' + d.water, 300, ny + 70, 460, 22);
        ctx.fillStyle = d.accent; ctx.font = '14px sans-serif'; ctx.fillText('上善若水 · 分秒必争', 300, 680);
        ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.font = '11px sans-serif'; ctx.fillText('水若善 · 喝水了吗 · 上善若水', 300, 710);
        ctx.fillStyle = 'rgba(255,255,255,0.25)'; ctx.font = '10px sans-serif'; ctx.fillText(url, 300, 740);
        // 转为Blob并调用系统分享
        c.toBlob(function(blob) {
            if (!blob) { safeCopy(text, '📋 祝福已复制！请手动发送'); return; }
            var file = new File([blob], d.name + '_马年祝福.png', { type: 'image/png' });
            // 检测navigator.share是否支持文件分享
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                navigator.share({
                    title: d.name + ' · 马年祝福',
                    text: text,
                    files: [file]
                }).then(function(){ toast('✅ 分享成功！'); }).catch(function(e){
                    if (e.name !== 'AbortError') safeCopy(text, '📋 祝福已复制！');
                });
            } else if (navigator.share) {
                // 不支持文件但支持文本分享
                navigator.share({ title: d.name + ' · 马年祝福', text: text, url: url }).catch(function(){
                    safeCopy(text, '📋 祝福已复制！打开微信粘贴发送');
                });
            } else {
                // 都不支持，下载图片+复制文字
                var a = document.createElement('a');
                a.download = d.name + '_马年祝福.png';
                a.href = URL.createObjectURL(blob);
                a.click(); URL.revokeObjectURL(a.href);
                safeCopy(text, '📋 祝福+图片已保存！发送给好友吧');
            }
        }, 'image/png');
    }

    function showFestContactsPicker(shareText) {
        window._festShareText = shareText;
        window._festPeople = [];
        if (typeof contacts !== 'undefined' && contacts && contacts.length) {
            contacts.forEach(function(c,i){ window._festPeople.push({name:c.name, phone:c.phone||'', tag:c.group||'', idx:i, src:'c'}); });
        }
        if (typeof friends !== 'undefined' && friends && friends.length) {
            friends.forEach(function(f,i){ window._festPeople.push({name:f.name, phone:f.phone||'', tag:f.relation||'', idx:i, src:'f'}); });
        }
        var ov = document.createElement('div');
        ov.id = 'festContactsPicker';
        ov.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:20000;background:rgba(0,0,0,0.85);display:flex;flex-direction:column;justify-content:flex-end;';
        ov.onclick = function(e){ if(e.target===ov) closeFestPicker(); };
        var box = document.createElement('div');
        box.style.cssText = 'width:100%;max-height:65vh;background:#1a1a2e;border-radius:20px 20px 0 0;padding:16px;overflow-y:auto;';
        var title = document.createElement('div');
        title.style.cssText = 'text-align:center;margin-bottom:12px;';
        title.innerHTML = '<div style="font-size:16px;font-weight:bold;color:#FFD700;">📇 选择发送对象</div>';
        box.appendChild(title);
        var list = document.createElement('div');
        list.id = 'festPickerList';
        var colors = ['#00d4ff','#06ffa5','#FFD700','#ff6b9d','#8338ec'];
        window._festPeople.forEach(function(p, i) {
            var row = document.createElement('div');
            row.className = 'fp-item';
            row.setAttribute('data-name', p.name);
            row.setAttribute('data-idx', i);
            row.style.cssText = 'display:flex;align-items:center;gap:10px;padding:10px 8px;border-radius:10px;cursor:pointer;margin-bottom:3px;background:rgba(255,255,255,0.03);';
            row.onclick = function(){ sendFestByIdx(i); };
            var avatar = document.createElement('div');
            avatar.style.cssText = 'width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:bold;color:#000;background:'+colors[i%colors.length];
            avatar.textContent = p.name.charAt(0);
            row.appendChild(avatar);
            var info = document.createElement('div');
            info.style.cssText = 'flex:1;';
            info.innerHTML = '<div style="font-size:13px;color:#fff;">'+p.name+'</div><div style="font-size:10px;color:rgba(255,255,255,0.3);">'+p.tag+'</div>';
            row.appendChild(info);
            var btn = document.createElement('div');
            btn.style.cssText = 'padding:4px 10px;background:rgba(255,215,0,0.15);border-radius:12px;font-size:11px;color:#FFD700;';
            btn.textContent = '发送';
            row.appendChild(btn);
            list.appendChild(row);
        });
        if (window._festPeople.length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.4);font-size:13px;">暂无联系人<br><span style="font-size:11px;">请先在"智能关怀"中授权通讯录</span></div>';
        }
        box.appendChild(list);
        var cancelBtn = document.createElement('button');
        cancelBtn.style.cssText = 'width:100%;padding:12px;margin-top:8px;border-radius:12px;border:none;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);font-size:14px;cursor:pointer;';
        cancelBtn.textContent = '取消';
        cancelBtn.onclick = closeFestPicker;
        box.appendChild(cancelBtn);
        ov.appendChild(box);
        document.body.appendChild(ov);
    }

    function closeFestPicker() {
        var el = document.getElementById('festContactsPicker');
        if (el) el.remove();
    }

    function filterFestPicker() {
        var q = (document.getElementById('festPickerSearch')?.value || '').toLowerCase();
        document.querySelectorAll('.fp-item').forEach(function(el){
            var n = (el.getAttribute('data-name')||'').toLowerCase();
            el.style.display = (!q || n.indexOf(q) >= 0) ? 'flex' : 'none';
        });
    }

    function sendFestByIdx(globalIdx) {
        var p = window._festPeople[globalIdx];
        if (!p) return;
        var text = window._festShareText || '';
        var person = p.src === 'c' ? contacts[p.idx] : friends[p.idx];
        var phone = person.phone || '';
        if (phone && phone.indexOf('*') < 0) {
            window.open('sms:' + phone + '?body=' + encodeURIComponent(text));
            toast('📱 正在发送给 ' + person.name);
        } else {
            safeCopy(text, '📋 已复制！请手动发送给 ' + person.name);
        }
        closeFestPicker();
    }



    function saveFestPoster() {
        var d = FEST_DAYS[currentFestDay];
        var name = document.getElementById('festName') ? document.getElementById('festName').value.trim() : '';
        var c = document.createElement('canvas');
        c.width = 600; c.height = 1000;
        var ctx = c.getContext('2d');
        // 渐变背景
        var grad = ctx.createLinearGradient(0, 0, 600, 1000);
        var colors = d.bg.match(/#[A-Fa-f0-9]{6}/g) || ['#8B0000','#FF4500','#FFD700'];
        colors.forEach(function(col, i) { grad.addColorStop(i/(colors.length-1), col); });
        ctx.fillStyle = grad; ctx.fillRect(0,0,600,1000);
        // 装饰圈
        ctx.fillStyle = 'rgba(255,255,255,0.05)';
        ctx.beginPath(); ctx.arc(300,350,180,0,Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(300,350,250,0,Math.PI*2); ctx.fill();
        // 万马奔腾线条
        ctx.strokeStyle = 'rgba(255,255,255,0.3)';
        ctx.lineWidth = 3; ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(60,750); ctx.quadraticCurveTo(90,720,110,710); ctx.quadraticCurveTo(130,700,138,685); ctx.lineTo(145,668); ctx.quadraticCurveTo(152,655,158,660); ctx.quadraticCurveTo(155,645,160,638); ctx.lineTo(170,630); ctx.quadraticCurveTo(174,638,170,648);
        ctx.moveTo(170,648); ctx.quadraticCurveTo(178,644,186,650); ctx.lineTo(200,660); ctx.quadraticCurveTo(218,672,228,692); ctx.lineTo(248,720);
        ctx.moveTo(350,740); ctx.quadraticCurveTo(375,710,392,702); ctx.quadraticCurveTo(408,694,416,678); ctx.lineTo(424,660); ctx.quadraticCurveTo(432,646,438,650); ctx.quadraticCurveTo(436,636,440,630); ctx.lineTo(450,624); ctx.quadraticCurveTo(454,632,450,642);
        ctx.moveTo(450,642); ctx.quadraticCurveTo(458,638,466,644); ctx.lineTo(480,654); ctx.quadraticCurveTo(496,664,504,682); ctx.lineTo(520,710);
        ctx.stroke();
        // 文字内容
        ctx.textAlign = 'center';
        ctx.fillStyle = '#fff';
        ctx.font = '80px serif'; ctx.fillText(d.emoji, 300, 200);
        ctx.font = '14px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.6)';
        ctx.fillText('丙午马年', 300, 250);
        ctx.font = 'bold 48px serif'; ctx.fillStyle = '#fff';
        ctx.fillText(d.name, 300, 320);
        ctx.font = '20px sans-serif'; ctx.fillStyle = d.accent;
        ctx.fillText(d.folk, 300, 360);
        // 个性化祝福独立行
        var nextY = 430;
        if (name) {
            ctx.font = '18px sans-serif'; ctx.fillStyle = d.accent;
            ctx.fillText('🎋 ' + name + '祝福您', 300, nextY);
            nextY += 40;
        }
        // 祝福语
        ctx.font = 'bold 26px sans-serif'; ctx.fillStyle = '#fff';
        wrapText(ctx, d.greeting, 300, nextY, 480, 36);
        // 水智慧
        ctx.font = '16px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.8)';
        wrapText(ctx, '💧 ' + d.water, 300, nextY + 80, 460, 26);
        // 底部品牌
        ctx.fillStyle = 'rgba(255,255,255,0.3)';
        ctx.fillRect(100, 780, 400, 1);
        ctx.font = '18px sans-serif'; ctx.fillStyle = d.accent;
        ctx.fillText('上善若水 · 分秒必争', 300, 820);
        ctx.font = '14px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.fillText('水若善 · 喝水了吗 · 上善若水', 300, 855);
        ctx.font = '12px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.3)';
        ctx.fillText(location.href.split('?')[0], 300, 890);
        // 扫码提示
        ctx.fillStyle = 'rgba(255,255,255,0.08)';
        roundRect(ctx, 225, 910, 150, 50, 10); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.font = '11px sans-serif';
        ctx.fillText('扫码体验 · 智回请你喝水', 300, 942);
        // 保存下载
        var link = document.createElement('a');
        link.download = d.name + '_马年祝福_智回请你喝水.png';
        link.href = c.toDataURL('image/png');
        link.click();
        toast('🖼️ ' + d.name + ' 海报已保存！');
    }
    function wrapText(ctx, text, x, y, maxW, lineH) {
        var line = ''; var chars = text.split('');
        for (var i = 0; i < chars.length; i++) {
            var test = line + chars[i];
            if (ctx.measureText(test).width > maxW && i > 0) {
                ctx.fillText(line, x, y); y += lineH; line = chars[i];
            } else { line = test; }
        }
        ctx.fillText(line, x, y);
    }
    function roundRect(ctx, x, y, w, h, r) {
        ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y);
        ctx.quadraticCurveTo(x+w,y,x+w,y+r); ctx.lineTo(x+w,y+h-r);
        ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h); ctx.lineTo(x+r,y+h);
        ctx.quadraticCurveTo(x,y+h,x,y+h-r); ctx.lineTo(x,y+r);
        ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath();
    }

    // 初始化祝福馆
    setTimeout(renderFestGrid, 100);


    // 好友
    function addFriend() { const name = document.getElementById('fName').value.trim(); if (!name) return toast('!'); friends.push({ id: 'F' + Date.now(), name, phone: document.getElementById('fPhone').value.trim(), relation: document.getElementById('fRelation').value }); document.getElementById('fName').value = ''; saveData(); closeModal(); renderFriends(); toast('✅'); }
    function renderFriends() { document.getElementById('friendList').innerHTML = friends.length ? friends.map(f => `<div class="item"><div class="icon">👤</div><div class="info"><div class="name">${f.name}</div><div class="desc">${f.relation}</div></div><button onclick="friends=friends.filter(x=>x.id!=='${f.id}');saveData();renderFriends();" style="background:none;border:none;color:rgba(255,255,255,0.3);font-size:14px;cursor:pointer;">×</button></div>`).join('') : '<div style="text-align:center;padding:15px;color:rgba(255,255,255,0.4);font-size:10px;">-</div>'; }

    // 主题
    function setTheme(name) { currentTheme = name; applyTheme(name); document.querySelectorAll('.theme-item').forEach(t => t.classList.remove('active')); document.querySelector(`.theme-item.${name}`)?.classList.add('active'); saveData(); toast('🎨'); }
    function applyTheme(name) { const t = THEMES[name] || THEMES.classic; document.documentElement.style.setProperty('--primary', t.primary); document.body.style.background = `linear-gradient(135deg, ${t.bg1}, ${t.bg2})`; document.getElementById('clockFace').style.borderColor = t.primary; }

    function toggleVoice() { toggleVoiceRecognition(); }

    function openPanel(id) { closeAllPanels(); document.getElementById(id).classList.add('open'); document.getElementById('overlay').classList.add('show'); if(!siteStats.panels)siteStats.panels={}; siteStats.panels[id]=(siteStats.panels[id]||0)+1; trackEvent('panel','open',id); if (id === 'carePanel') updateContactsUI(); if (id === 'memberPanel') { showMyActivity(); updateMembershipUI(); } if (id === 'festivalPanel') renderFestGrid(); }
    function closeAllPanels() { document.querySelectorAll('.panel').forEach(p => p.classList.remove('open')); document.getElementById('overlay').classList.remove('show'); }
    function openModal(id) { document.getElementById(id).classList.add('show'); }
    function closeModal() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('show')); }

    function doLogin() { 
        const p = document.getElementById('phoneInput').value.trim(), n = document.getElementById('nameInput').value.trim(), w = document.getElementById('pwdInput').value; 
        if (!p || p.length !== 11) return toast('请输入11位手机号'); 
        if (!w || w.length < 6) return toast('密码至少6位'); 
        const users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}'); 
        if (users[p]) { 
            if (users[p].pwd !== w) return toast('❌ 密码错误'); 
            user = users[p]; 
        } else { 
            if (!n) return toast('新用户请填写昵称'); 
            user = { id: 'U' + Date.now().toString(36).toUpperCase(), phone: p, name: n, pwd: w, level: 'free' }; 
            users[p] = user; 
            localStorage.setItem('heshuileUsers', JSON.stringify(users));
            // 新用户自动开始VIP试用
            startVipTrial();
        } 
        
        // ═══ 自动恢复会员状态 ═══
        // 检查1：本地是否有该用户的已审批订单（同设备管理员+用户场景）
        var orders = JSON.parse(localStorage.getItem('heshuilePendingOrders') || '[]');
        var approvedOrder = null;
        for (var i = orders.length - 1; i >= 0; i--) {
            if (orders[i].userId === p && orders[i].status === 'approved') {
                approvedOrder = orders[i];
                break;
            }
        }
        if (approvedOrder && (!user.level || user.level === 'free')) {
            var levelMap = { monthly: 'monthly', quarterly: 'quarterly', yearly: 'vip', enterprise: 'enterprise' };
            user.level = levelMap[approvedOrder.plan] || 'vip';
            user.paidAt = approvedOrder.approveTime;
            user.paidPlan = approvedOrder.plan;
            if (approvedOrder.activationCode) user.activationCode = approvedOrder.activationCode;
            users[p] = user;
            localStorage.setItem('heshuileUsers', JSON.stringify(users));
        }
        
        // 检查2：如果之前用过激活码，确保 level 不被重置
        if (user.activationCode && (!user.level || user.level === 'free')) {
            var plans = ['monthly', 'quarterly', 'yearly', 'enterprise'];
            var levelMap2 = { monthly: 'monthly', quarterly: 'quarterly', yearly: 'vip', enterprise: 'enterprise' };
            for (var j = 0; j < plans.length; j++) {
                if (user.activationCode === generateActivationCode(p, plans[j])) {
                    user.level = levelMap2[plans[j]];
                    users[p] = user;
                    localStorage.setItem('heshuileUsers', JSON.stringify(users));
                    break;
                }
            }
        }
        
        // 检查3：是否有从激活链接保存的待激活码
        var pendingCode = localStorage.getItem('heshuilePendingActivation');
        if (pendingCode) {
            localStorage.removeItem('heshuilePendingActivation');
            setTimeout(function() { autoActivateByLink(pendingCode); }, 600);
        }
        
        localStorage.setItem('currentUser', JSON.stringify(user)); 
        updateUI(); 
        updateMembershipUI();
        toast('✅ 欢迎 ' + user.name + (user.level && user.level !== 'free' ? ' 👑' : '')); 
        logActivity('login', user.name + ' 登录'); 
        var fn=document.getElementById('festName'); if(fn&&user.name)fn.value=user.name; 
    }
    function logout() { user = null; localStorage.removeItem('currentUser'); updateUI(); closeAllPanels(); toast('👋'); }
    function upgrade() { if (!user) return; user.level = 'vip'; const users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}'); users[user.phone] = user; localStorage.setItem('heshuileUsers', JSON.stringify(users)); localStorage.setItem('currentUser', JSON.stringify(user)); updateUI(); toast('👑'); }
    // 安全复制（兼容非HTTPS环境）
    function safeCopy(text, successMsg) {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => toast(successMsg)).catch(() => fallbackCopy(text, successMsg));
        } else { fallbackCopy(text, successMsg); }
    }
    function fallbackCopy(text, msg) {
        const ta = document.createElement('textarea');
        ta.value = text; ta.style.cssText = 'position:fixed;left:-9999px;';
        document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); toast(msg); } catch(e) { toast('长按下方文字复制：'); prompt('复制此内容：', text); }
        document.body.removeChild(ta);
    }
    function safeShare(title, text, url, fallbackMsg) {
        if (navigator.share) {
            navigator.share({ title, text, url }).catch(() => safeCopy(text + '\n' + url, fallbackMsg));
        } else { safeCopy(text + '\n👉 ' + url, fallbackMsg); }
    }

    function copyInviteLink() { const link = user ? getShareUrl('invite=' + user.id) : getShareUrl(''); safeShare('喝水了吗？', '🐴 马年快乐！送你一个智能喝水提醒，每天八杯水，健康一整年～', link, '📋 链接已复制，快去分享吧！'); }
    function shareNewYear() { trackEvent('share','new_year'); const msgs = ['🐴🧧 马年大吉！喝水了吗？送你一个AI智能喝水提醒，语音问它任何关于水和健康的问题！','🧧💧 新春快乐！这个小工具能提醒你每天喝够八杯水，还有水学知识、滴答时钟，超好用！','🐴✨ 新年新习惯！试试这个喝水提醒APP，每天八杯水，健康一整年～上善若水，分秒必争！']; const msg = msgs[Math.floor(Math.random()*msgs.length)]; const link = user ? getShareUrl('invite='+user.id) : getShareUrl(''); safeShare('喝水了吗 | 新年快乐', msg, link, '🧧 新年祝福已复制！'); }
    function updateUI() { const btn = document.getElementById('userBtn'); const qr = document.getElementById('promoQR'); qr.innerHTML = ''; const baseUrl = location.href.split('?')[0]; if (user) { btn.textContent = user.level === 'vip' ? '👑' : '👤'; document.getElementById('loginBox').style.display = 'none'; document.getElementById('memberBox').style.display = 'block'; document.getElementById('avatar').textContent = user.name.charAt(0); document.getElementById('userName').textContent = user.name; document.getElementById('userLevel').textContent = user.level === 'vip' ? '👑 VIP' : 'Free'; document.getElementById('inviteCode').textContent = user.id; if (typeof QRCode !== 'undefined') QRCode.toCanvas(baseUrl + '?invite=' + user.id, { width: 100, margin: 2 }, (e, c) => { if (!e) qr.appendChild(c); }); } else { btn.textContent = I18N[currentLang].login; document.getElementById('loginBox').style.display = 'block'; document.getElementById('memberBox').style.display = 'none'; document.getElementById('inviteCode').textContent = '登录后获取'; if (typeof QRCode !== 'undefined') QRCode.toCanvas(baseUrl, { width: 100, margin: 2 }, (e, c) => { if (!e) qr.appendChild(c); }); } }

    function toast(m) { const t = document.createElement('div'); t.className = 'toast'; t.textContent = m; document.body.appendChild(t); setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 2000); }

    function saveData() { localStorage.setItem('heshuileData', JSON.stringify({ tickOn, currentTheme, currentSound, volume, friends, ads, reminds, checkinData, centerData, contactsAuthorized, contacts, waterData, waterLearning })); }
    function loadData() { 
        try { 
            const d = JSON.parse(localStorage.getItem('heshuileData')); 
            if (d) { 
                tickOn = d.tickOn ?? true; currentTheme = d.currentTheme || 'classic'; 
                currentSound = d.currentSound || 'classic'; volume = d.volume ?? 50; 
                friends = d.friends || []; ads = d.ads || ads; reminds = d.reminds || []; 
                checkinData = d.checkinData || checkinData; centerData = d.centerData || centerData; 
                contactsAuthorized = d.contactsAuthorized || false; contacts = d.contacts || []; 
                waterData = d.waterData || waterData; waterLearning = d.waterLearning || waterLearning; 
            } 
            const u = localStorage.getItem('currentUser'); 
            if (u) user = JSON.parse(u); 
            
            // ═══ 页面加载时自动恢复会员状态 ═══
            if (user && (!user.level || user.level === 'free')) {
                var orders = JSON.parse(localStorage.getItem('heshuilePendingOrders') || '[]');
                for (var i = orders.length - 1; i >= 0; i--) {
                    if (orders[i].userId === user.phone && orders[i].status === 'approved') {
                        var levelMap = { monthly: 'monthly', quarterly: 'quarterly', yearly: 'vip', enterprise: 'enterprise' };
                        user.level = levelMap[orders[i].plan] || 'vip';
                        user.paidAt = orders[i].approveTime;
                        user.paidPlan = orders[i].plan;
                        if (orders[i].activationCode) user.activationCode = orders[i].activationCode;
                        // 同步更新所有存储
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        var users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}');
                        if (users[user.phone]) { 
                            users[user.phone].level = user.level; 
                            users[user.phone].paidAt = user.paidAt;
                            users[user.phone].paidPlan = user.paidPlan;
                            localStorage.setItem('heshuileUsers', JSON.stringify(users)); 
                        }
                        break;
                    }
                }
            }
        } catch (e) {} 
    }
    </script>

    <!-- 支付弹窗 -->
    <div class="pay-modal-bg" id="payModal">
        <div class="pay-modal">
            <div style="text-align:right;"><button onclick="closePayModal()" style="background:none;border:none;color:white;font-size:22px;cursor:pointer;">×</button></div>
            
            <div class="pay-header">
                <div class="pay-plan-name" id="payPlanName">年度VIP</div>
                <div class="pay-plan-price" id="payPlanPrice">¥199/年</div>
                <div class="pay-plan-desc" id="payPlanDesc">无限提醒 · 无广告 · 音频课程 · 全部内容</div>
            </div>
            
            <!-- 支付方式选择 -->
            <div class="pay-methods">
                <div style="font-size:12px;color:var(--gold);margin-bottom:8px;">选择支付方式</div>
                
                <div class="pay-method-btn" onclick="selectPayMethod('wechat')">
                    <div class="pay-method-icon">💚</div>
                    <div>
                        <div class="pay-method-name">微信支付</div>
                        <div class="pay-method-desc">扫码或长按识别付款</div>
                    </div>
                </div>
                
                <div class="pay-method-btn" onclick="selectPayMethod('alipay')">
                    <div class="pay-method-icon">🔵</div>
                    <div>
                        <div class="pay-method-name">支付宝</div>
                        <div class="pay-method-desc">扫码付款</div>
                    </div>
                </div>
                
                <div class="pay-method-btn" onclick="selectPayMethod('transfer')">
                    <div class="pay-method-icon">🏦</div>
                    <div>
                        <div class="pay-method-name">银行转账 / 红包</div>
                        <div class="pay-method-desc">微信红包 · 银行转账 · 其他方式</div>
                    </div>
                </div>
                
                <div class="pay-method-btn" onclick="selectPayMethod('contact')" style="border-color:rgba(6,255,165,0.3);">
                    <div class="pay-method-icon">📱</div>
                    <div>
                        <div class="pay-method-name">直接联系付款</div>
                        <div class="pay-method-desc">加微信/打电话 · 当面或远程付款</div>
                    </div>
                </div>
            </div>
            
            <!-- 二维码区域 -->
            <div class="pay-qr-area" id="payQrArea">
                <div class="pay-qr-placeholder" id="payQrImage">
                    <div style="text-align:center;">
                        <div style="font-size:40px;margin-bottom:8px;" id="payQrEmoji">💚</div>
                        <div id="payQrText" style="font-size:12px;">请选择支付方式</div>
                    </div>
                </div>
                <div class="pay-qr-tip">
                    <div id="payQrInstruction" style="line-height:1.8;">
                        选择支付方式后，将显示操作步骤
                    </div>
                </div>
            </div>
            
            <!-- 转账信息 -->
            <div class="pay-confirm-area" id="payTransferArea">
                <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:15px;text-align:left;font-size:12px;line-height:2;">
                    <div style="color:var(--gold);font-weight:bold;margin-bottom:8px;">💰 转账方式（任选一种）</div>
                    <div>微信红包：搜索手机号 <strong style="color:var(--primary);" id="payContactPhone">-</strong></div>
                    <div>转账备注：<strong style="color:var(--gold);" id="payTransferNote">喝水VIP-您的昵称</strong></div>
                    <div style="margin-top:8px;color:rgba(255,255,255,0.4);font-size:10px;">转账后请点击下方「我已付款」按钮</div>
                </div>
            </div>
            
            <!-- 已付款确认 -->
            <div style="margin-top:15px;">
                <div id="payOrderId" style="text-align:center;font-size:10px;color:rgba(255,255,255,0.3);margin-bottom:8px;">订单号：--</div>
                <button class="btn btn-gold" style="width:100%;font-size:14px;padding:12px;" onclick="confirmPayment()">
                    ✅ 我已付款，申请开通
                </button>
                <div style="text-align:center;margin-top:8px;">
                    <div style="font-size:10px;color:rgba(255,255,255,0.5);">付款后管理员会发送 <strong style="color:var(--gold);">激活码</strong> 给您</div>
                    <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:4px;">收到激活码后在"我的"页面输入即可升级</div>
                    <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:4px;">联系客服：<span id="payContactInfo">管理员</span></div>
                </div>
            </div>
            
        </div>
    </div>

</body>
</html>
