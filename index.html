<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- Google Analytics 4 æ•°æ®ç»Ÿè®¡ -->
    <!-- æ­¥éª¤ï¼š1.æ‰“å¼€ https://analytics.google.com æ³¨å†Œ 2.åˆ›å»ºåª’ä½“èµ„æº 3.æŠŠG-8BF63PNVGDæ›¿æ¢ä¸ºä½ çš„æµ‹é‡ID -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8BF63PNVGD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-8BF63PNVGD');
    </script>
    <!-- åˆ†äº«å¡ç‰‡ Open Graph -->
    <meta property="og:title" content="ç››å…´å´‘ç»™ä½ æ‹œå¹´ï¼šè¿‡èŠ‚åˆ«å¿˜è®°å–æ°´">
    <meta property="og:description" content="ğŸ´ æ–°æ˜¥é¥®æ°´ï¼Œç¦å¯¿ç»µé•¿ã€‚ç‚¹å¼€é¢†å–é©¬å¹´ç¥ç¦ï¼Œè¿˜èƒ½ä¸€é”®è½¬å‘ç»™æœ‹å‹æ‹œå¹´ğŸ’§">
    <meta property="og:image" content="https://ericjbe.github.io/water-reminder/share-card.png">
    <meta property="og:url" content="https://ericjbe.github.io/water-reminder/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="å–æ°´äº†å— Â· é©¬å¹´ç¥ç¦">
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ç››å…´å´‘ç»™ä½ æ‹œå¹´ï¼šè¿‡èŠ‚åˆ«å¿˜è®°å–æ°´">
    <meta name="twitter:description" content="ğŸ´ æ–°æ˜¥é¥®æ°´ï¼Œç¦å¯¿ç»µé•¿ã€‚ç‚¹å¼€é¢†å–é©¬å¹´ç¥ç¦ï¼Œè½¬å‘ç»™æœ‹å‹æ‹œå¹´ğŸ’§">
    <meta name="twitter:image" content="https://ericjbe.github.io/water-reminder/share-card.png">
    <!-- å¾®ä¿¡åˆ†äº« -->
    <meta itemprop="name" content="ç››å…´å´‘ç»™ä½ æ‹œå¹´ï¼šè¿‡èŠ‚åˆ«å¿˜è®°å–æ°´">
    <meta itemprop="description" content="ç‚¹å¼€æ”¶ä¸“å±ç¥ç¦ï¼Œè¿˜èƒ½ä¸€é”®è½¬å‘ç»™æœ‹å‹">
    <meta itemprop="image" content="https://ericjbe.github.io/water-reminder/share-card.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="pageTitle">å–æ°´äº†å— | é•¿å¯¿ç™¾å²ï¼Œåˆ«å¿˜å–æ°´</title>
    
    <!-- PWA é…ç½® -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å–æ°´äº†å—">
    <meta name="application-name" content="å–æ°´äº†å—">
    <meta name="theme-color" content="#0a192f">
    <meta name="description" content="å–æ°´äº†å—ï¼Ÿæ™ºèƒ½å–æ°´æé†’ï¼Œæ¯å¤©å…«æ¯æ°´ï¼Œå¥åº·ä¸€æ•´å¹´ã€‚æ°´å­¦çŸ¥è¯†+æ»´ç­”æ—¶é’Ÿ+è¯­éŸ³åŠ©æ‰‹ï¼Œæ°´è‹¥å–„å‡ºå“ã€‚">
    <meta property="og:description" content="ä¸Šå–„è‹¥æ°´ï¼Œåˆ†ç§’å¿…äº‰ã€‚æ¯å¤©å…«æ¯æ°´ï¼Œåšè‡ªå·±çš„å¥åº·ç®¡ç†å¸ˆã€‚è¯­éŸ³é—®æ°´å­¦ï¼ŒAIæ¥å›ç­”ã€‚">
    <meta property="og:type" content="website">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230a192f' width='100' height='100' rx='20'/><text x='50' y='68' font-size='55' text-anchor='middle'>ğŸ’§</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2300d4ff' width='100' height='100' rx='20'/><text x='50' y='68' font-size='55' text-anchor='middle'>ğŸ’§</text></svg>">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi5Zad5rC05LqG5ZCXIiwic2hvcnRfbmFtZSI6IuWWneawtOS6huWQlyIsImRlc2NyaXB0aW9uIjoi5pm66IO95Zad5rC05o+Q6YaSIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBhMTkyZiIsInRoZW1lX2NvbG9yIjoiIzAwZDRmZiIsInN0YXJ0X3VybCI6Ii4iLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLDxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCc+PHJlY3QgZmlsbD0nJTIzMDBkNGZmJyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCcgcng9JzIwJy8+PHRleHQgeD0nNTAnIHk9JzY4JyBmb250LXNpemU9JzU1JyB0ZXh0LWFuY2hvcj0nbWlkZGxlJz7wn5KnPC90ZXh0Pjwvc3ZnPiIsInNpemVzIjoiYW55IiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJwdXJwb3NlIjoiYW55IG1hc2thYmxlIn1dfQ==">
    
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        :root { --primary: #00d4ff; --accent: #ff006e; --gold: #ffd700; --success: #06ffa5; --bg1: #0a192f; --bg2: #112240; --water: #00bcd4; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, 'Noto Sans SC', sans-serif; color: #fff; min-height: 100vh; background: linear-gradient(135deg, var(--bg1), var(--bg2)); }

        .top-bar { position: fixed; top: 0; left: 0; right: 0; background: rgba(10,25,47,0.95); padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo { font-size: 18px; font-weight: bold; }
        .logo span { background: linear-gradient(90deg, var(--primary), var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .top-right { display: flex; gap: 6px; align-items: center; }
        .top-btn { background: rgba(255,255,255,0.1); border: none; padding: 5px 10px; border-radius: 15px; color: white; font-size: 11px; cursor: pointer; }
        .lang-select { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; color: white; font-size: 10px; cursor: pointer; }

        .ad-bar { position: fixed; top: 42px; left: 0; right: 0; height: 52px; overflow: hidden; z-index: 99; }
        .ad-bar::before { content:''; position:absolute; top:0; left:0; right:0; bottom:0; background: linear-gradient(90deg, #006994, #0077b6, #00b4d8, #48cae4, #0096c7, #023e8a); background-size: 300% 100%; animation: waterColorShift 12s ease infinite; z-index:0; }
        .ad-bar::after { content:''; position:absolute; bottom:0; left:-100%; width:300%; height:100%; background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 60'%3E%3Cpath d='M0 30 Q150 10 300 30 T600 30 T900 30 T1200 30 V60 H0 Z' fill='rgba(255,255,255,0.06)'/%3E%3Cpath d='M0 35 Q150 20 300 35 T600 35 T900 35 T1200 35 V60 H0 Z' fill='rgba(255,255,255,0.04)'/%3E%3C/svg%3E") repeat-x; background-size: 600px 100%; animation: waterWave 4s linear infinite; z-index:1; pointer-events:none; }
        @keyframes waterColorShift { 0%{background-position:0% 50%} 33%{background-position:50% 50%} 66%{background-position:100% 50%} 100%{background-position:0% 50%} }
        @keyframes waterWave { 0%{transform:translateX(0)} 100%{transform:translateX(600px)} }
        .ad-container { position:relative; z-index:2; height:100%; }
        .ad-slide { position:absolute; top:0; left:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; gap:8px; padding:3px 12px; opacity:0; transform:translateX(100%); }
        .ad-slide.active { opacity:1; animation: adRiver 3s linear forwards; }
        .ad-slide.exit { animation: adRiverOut 3s linear forwards; }
        @keyframes adRiver {
            0%   { opacity:0; transform:translateX(80%); }
            10%  { opacity:0.6; transform:translateX(60%); }
            33%  { opacity:1; transform:translateX(30%); }
            66%  { opacity:1; transform:translateX(0%); }
            100% { opacity:1; transform:translateX(0%); }
        }
        @keyframes adRiverOut {
            0%   { opacity:1; transform:translateX(0%); }
            33%  { opacity:0.7; transform:translateX(-30%); }
            66%  { opacity:0.3; transform:translateX(-60%); }
            100% { opacity:0; transform:translateX(-100%); }
        }
        .ad-slide .ad-text { font-size:13px; color:#fff; text-shadow:0 1px 3px rgba(0,0,0,0.3); font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:70vw; }
        .ad-slide .ad-img { max-height:42px; max-width:35vw; object-fit:contain; border-radius:4px; flex-shrink:0; }
        .ad-slide .ad-vid { max-height:42px; max-width:35vw; object-fit:contain; border-radius:4px; flex-shrink:0; }
        .ad-slide .ad-mixed { display:flex; align-items:center; gap:8px; max-width:95vw; overflow:hidden; }
        .ad-dots { position:absolute; bottom:2px; left:50%; transform:translateX(-50%); display:flex; gap:3px; z-index:3; }
        .ad-dot { width:4px; height:4px; border-radius:50%; background:rgba(255,255,255,0.3); transition:all .3s; }
        .ad-dot.active { width:12px; border-radius:2px; background:rgba(255,255,255,0.8); }

        .main { padding: 102px 12px 70px; }

        .culture-card { position: relative; border-radius: 14px; padding: 16px; overflow: hidden; margin-bottom: 12px; }
        .culture-bg { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-size: cover; background-position: center; filter: brightness(0.35); }
        .culture-content { position: relative; z-index: 1; }
        .culture-label { font-size: 10px; color: var(--gold); margin-bottom: 6px; }
        .culture-text { font-size: 14px; line-height: 1.8; }
        .culture-source { font-size: 10px; color: rgba(255,255,255,0.5); text-align: right; margin-top: 6px; }
        .culture-actions { display: flex; gap: 6px; margin-top: 10px; }
        .culture-btn { flex: 1; padding: 6px; background: rgba(255,255,255,0.15); border: none; border-radius: 15px; color: white; font-size: 10px; cursor: pointer; }

        .checkin-bar { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: linear-gradient(90deg, rgba(255,215,0,0.08), rgba(6,255,165,0.08)); border-radius: 10px; margin-bottom: 15px; }
        .checkin-info { display: flex; align-items: center; gap: 12px; }
        .checkin-streak { font-size: 11px; }
        .checkin-streak strong { color: var(--gold); font-size: 16px; }
        .checkin-points { font-size: 10px; color: var(--success); }
        .checkin-btn { padding: 6px 14px; background: linear-gradient(135deg, var(--gold), #ff8c00); border: none; border-radius: 15px; color: #000; font-size: 11px; font-weight: bold; cursor: pointer; }
        .checkin-btn.done { background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.5); }

        .clock-unit { background: rgba(0,0,0,0.25); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); padding: 20px 15px; }
        .clock-area { display: flex; flex-direction: column; align-items: center; }

        .clock-face { position: relative; width: 240px; height: 240px; border-radius: 50%; border: 5px solid var(--primary); box-shadow: 0 0 40px rgba(0,212,255,0.3), inset 0 0 30px rgba(0,0,0,0.5); background: radial-gradient(circle, rgba(10,25,47,0.8), rgba(0,0,0,0.9)); margin-bottom: 15px; }
        .tick { position: absolute; left: 50%; top: 8px; width: 2px; height: 10px; background: rgba(255,255,255,0.4); transform-origin: 0 112px; }
        .tick.major { width: 3px; height: 15px; background: var(--gold); transform-origin: 0 109px; }
        .clock-num { position: absolute; font-size: 15px; font-weight: bold; color: var(--gold); }
        .clock-num.n12 { top: 18px; left: 50%; transform: translateX(-50%); }
        .clock-num.n3 { right: 16px; top: 50%; transform: translateY(-50%); }
        .clock-num.n6 { bottom: 18px; left: 50%; transform: translateX(-50%); }
        .clock-num.n9 { left: 16px; top: 50%; transform: translateY(-50%); }

        .clock-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 110px; height: 110px; border-radius: 50%; background: rgba(0,20,40,0.9); border: 2px solid rgba(255,255,255,0.15); overflow: hidden; cursor: pointer; z-index: 5; display: flex; align-items: center; justify-content: center; }
        .center-content { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; }
        .center-content img, .center-content video { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .center-text { font-size: 10px; line-height: 1.4; padding: 8px; color: rgba(255,255,255,0.85); }
        .center-placeholder { font-size: 9px; color: rgba(255,255,255,0.4); }

        .hand { position: absolute; left: 50%; bottom: 50%; transform-origin: 50% 100%; border-radius: 4px; z-index: 10; }
        .hand-hour { width: 5px; height: 45px; margin-left: -2.5px; background: linear-gradient(to top, var(--primary), #fff); box-shadow: 0 0 10px var(--primary); }
        .hand-minute { width: 4px; height: 65px; margin-left: -2px; background: linear-gradient(to top, #8338ec, #fff); box-shadow: 0 0 8px #8338ec; }
        .hand-second { width: 2px; height: 85px; margin-left: -1px; background: var(--accent); box-shadow: 0 0 15px var(--accent); }
        .hand-dot { position: absolute; width: 12px; height: 12px; background: var(--gold); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 20px var(--gold); z-index: 15; }

        .digital-box { text-align: center; margin-bottom: 12px; }
        .digital-time { font-size: 38px; font-weight: bold; font-family: 'Courier New', monospace; color: var(--primary); text-shadow: 0 0 25px rgba(0,212,255,0.6); letter-spacing: 2px; }
        .digital-time .colon { animation: blink 1s infinite; }
        @keyframes blink { 0%,100%{opacity:1}50%{opacity:0.3} }
        .digital-date { font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 5px; }
        .slogan { font-size: 10px; color: rgba(255,255,255,0.4); margin-top: 4px; font-style: italic; }

        .tick-bar { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 6px 14px; background: rgba(255,255,255,0.05); border-radius: 18px; cursor: pointer; margin-bottom: 15px; }
        .tick-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); animation: pulse 1s infinite; }
        .tick-dot.off { background: #555; animation: none; }
        @keyframes pulse { 0%,100%{opacity:1}50%{opacity:.3} }

        .func-row { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .func-btn { display: flex; flex-direction: column; align-items: center; padding: 10px 14px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; color: white; cursor: pointer; min-width: 55px; }
        .func-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.15); }
        .func-btn .icon { font-size: 22px; }
        .func-btn .label { font-size: 9px; margin-top: 3px; color: rgba(255,255,255,0.7); }
        .func-btn.voice { background: linear-gradient(135deg, var(--primary), #8338ec); border: none; }

        .remind-section { margin-top: 5px; }
        .remind-title { font-size: 12px; color: var(--gold); margin-bottom: 8px; }
        .remind-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,107,157,0.1); border: 1px solid rgba(255,107,157,0.2); border-radius: 10px; margin-bottom: 6px; cursor: pointer; }
        .remind-item .emoji { font-size: 20px; }
        .remind-item .info { flex: 1; }
        .remind-item .title { font-size: 12px; font-weight: 500; }
        .remind-item .datetime { font-size: 10px; color: var(--gold); margin-top: 2px; font-family: monospace; }
        .remind-item .countdown { font-size: 10px; color: var(--success); font-weight: bold; }

        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10,25,47,0.98); border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; padding: 6px 0 10px; z-index: 100; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; padding: 4px 8px; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn .icon { font-size: 18px; }
        .nav-btn .label { font-size: 8px; margin-top: 2px; }

        .panel-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 199; display: none; }
        .panel-overlay.show { display: block; }
        .panel { position: fixed; top: 0; right: -100%; width: 92%; max-width: 380px; height: 100%; background: linear-gradient(180deg, rgba(10,25,47,0.98), rgba(17,34,64,0.98)); z-index: 200; transition: right 0.3s; overflow-y: auto; padding: 50px 15px 30px; }
        .panel.open { right: 0; }
        .panel-close { position: absolute; top: 12px; right: 15px; background: none; border: none; color: white; font-size: 26px; cursor: pointer; }
        .panel-title { font-size: 16px; color: var(--gold); margin-bottom: 15px; }

        .item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 6px; cursor: pointer; }
        .item:active { background: rgba(255,255,255,0.1); }
        .item .icon { font-size: 18px; }
        .item .info { flex: 1; }
        .item .name { font-size: 12px; }
        .item .desc { font-size: 9px; color: rgba(255,255,255,0.5); margin-top: 2px; }
        .section-title { font-size: 12px; color: var(--gold); margin: 15px 0 8px; }
        .divider { height: 1px; background: rgba(255,255,255,0.1); margin: 12px 0; }
        .form-group { margin-bottom: 8px; }
        .form-group label { display: block; font-size: 10px; color: rgba(255,255,255,0.6); margin-bottom: 3px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px 10px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-size: 12px; }
        .btn { padding: 10px 16px; border: none; border-radius: 10px; font-size: 12px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #8338ec); color: white; }
        .btn-gold { background: linear-gradient(135deg, var(--gold), #ff8c00); color: #000; }
        .btn-outline { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-danger { background: var(--accent); color: white; }

        .datetime-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 8px; }
        .datetime-input { text-align: center; }
        .datetime-input label { font-size: 9px; display: block; margin-bottom: 2px; }
        .datetime-input input { text-align: center; padding: 6px 4px; font-size: 14px; font-weight: bold; }

        .detail-time-box { background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); border-radius: 10px; padding: 12px; text-align: center; margin-bottom: 12px; }
        .detail-time-big { font-size: 20px; font-weight: bold; color: var(--gold); font-family: monospace; line-height: 1.5; }
        .detail-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 11px; }

        .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .theme-item { aspect-ratio: 1; border-radius: 8px; cursor: pointer; border: 2px solid transparent; }
        .theme-item.active { border-color: white; }
        .theme-item.classic { background: linear-gradient(135deg, #00d4ff, #8338ec); }
        .theme-item.luxury { background: linear-gradient(135deg, #ffd700, #ff8c00); }
        .theme-item.nature { background: linear-gradient(135deg, #06ffa5, #00d4ff); }
        .theme-item.romantic { background: linear-gradient(135deg, #ff6b9d, #8338ec); }

        .sound-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 5px; cursor: pointer; font-size: 11px; }
        .sound-item.active { border-color: var(--gold); background: rgba(255,215,0,0.1); }

        .ad-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 10px; margin-bottom: 8px; }
        .ad-card .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .ad-card .type-badge { font-size: 9px; padding: 2px 6px; border-radius: 8px; }
        .ad-card .type-badge.text { background: #667eea; }
        .ad-card .type-badge.image { background: #06ffa5; color: #000; }
        .ad-card .type-badge.video { background: #ff006e; }
        .ad-card .type-badge.link { background: #ffd700; color: #000; }
        .ad-card .preview { font-size: 11px; color: rgba(255,255,255,0.7); word-break: break-all; }
        .ad-card .preview img { max-width: 100%; max-height: 60px; border-radius: 6px; margin-top: 4px; }

        .contact-auth-box { background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(131,56,236,0.1)); border: 1px solid rgba(0,212,255,0.3); border-radius: 14px; padding: 18px; text-align: center; margin-bottom: 12px; }
        .contact-auth-box .icon { font-size: 36px; margin-bottom: 8px; }
        .contact-auth-box .title { font-size: 13px; font-weight: bold; margin-bottom: 6px; }
        .contact-auth-box .desc { font-size: 10px; color: rgba(255,255,255,0.6); margin-bottom: 12px; line-height: 1.5; }

        .contact-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 6px; }
        .contact-item .avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }
        .contact-item .info { flex: 1; }
        .contact-item .name { font-size: 12px; font-weight: 500; }
        .contact-item .phone { font-size: 9px; color: rgba(255,255,255,0.5); }
        .contact-item .add-btn { padding: 5px 10px; background: var(--gold); border: none; border-radius: 12px; color: #000; font-size: 9px; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .contact-item .add-btn:disabled { background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.5); cursor: default; }
        .contact-item.added .add-btn { background: rgba(6,255,165,0.3); color: var(--success); }

        /* ç®¡ç†å‘˜ç™»å½•æ¡† */
        .admin-login-box { background: rgba(255,0,0,0.1); border: 1px solid rgba(255,0,0,0.3); border-radius: 12px; padding: 15px; margin-bottom: 12px; }
        .admin-login-box .title { font-size: 12px; color: var(--accent); margin-bottom: 10px; text-align: center; }
        .admin-locked { text-align: center; padding: 20px; color: rgba(255,255,255,0.5); font-size: 11px; }

        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.92); z-index: 300; justify-content: center; align-items: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-box { background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid var(--primary); border-radius: 16px; padding: 20px; max-width: 340px; width: 100%; max-height: 85vh; overflow-y: auto; }
        .modal-title { font-size: 14px; color: var(--gold); margin-bottom: 12px; text-align: center; }
        .toast { position: fixed; top: 90px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.95); border: 1px solid var(--primary); padding: 10px 20px; border-radius: 20px; z-index: 1000; font-size: 12px; }

        /* æ°´å­¦é¢æ¿æ ·å¼ */
        .water-tabs { display: flex; gap: 6px; margin-bottom: 12px; overflow-x: auto; padding-bottom: 4px; }
        .water-tab { padding: 6px 12px; background: rgba(0,0,0,0.2); border: 1px solid transparent; border-radius: 20px; font-size: 11px; color: rgba(255,255,255,0.7); cursor: pointer; white-space: nowrap; }
        .water-tab.active { background: rgba(0,188,212,0.3); border-color: var(--water); color: var(--water); }
        .water-lesson { background: rgba(0,188,212,0.08); border: 1px solid rgba(0,188,212,0.2); border-radius: 12px; padding: 14px; margin-bottom: 10px; }
        .water-lesson .title { font-size: 13px; color: var(--gold); margin-bottom: 6px; font-weight: bold; }
        .water-lesson .text { font-size: 12px; line-height: 1.8; color: rgba(255,255,255,0.85); }
        .water-lesson .source { font-size: 9px; color: rgba(255,255,255,0.4); text-align: right; margin-top: 6px; }
        .water-controls { display: flex; gap: 6px; margin-bottom: 14px; }
        .water-controls button { flex: 1; padding: 8px; background: rgba(0,188,212,0.15); border: 1px solid rgba(0,188,212,0.3); border-radius: 8px; color: var(--water); font-size: 11px; cursor: pointer; }

        /* è‹æ ¼æ‹‰åº•å¯¹è¯ */
        .socratic-box { background: linear-gradient(135deg, rgba(255,215,0,0.08), rgba(0,188,212,0.08)); border: 2px solid rgba(255,215,0,0.3); border-radius: 14px; padding: 15px; margin-top: 10px; }
        .socratic-title { font-size: 13px; color: var(--gold); font-weight: bold; margin-bottom: 10px; }
        .socratic-chat { max-height: 300px; overflow-y: auto; margin-bottom: 10px; }
        .chat-bubble { padding: 10px 12px; border-radius: 12px; margin-bottom: 8px; font-size: 12px; line-height: 1.7; animation: fadeIn 0.3s; }
        .chat-bubble.master { background: rgba(0,188,212,0.15); border-left: 3px solid var(--water); margin-right: 30px; }
        .chat-bubble.student { background: rgba(255,215,0,0.1); border-right: 3px solid var(--gold); margin-left: 30px; text-align: right; }
        .chat-bubble .role { font-size: 9px; color: var(--gold); margin-bottom: 4px; font-weight: bold; }
        .socratic-options { display: flex; flex-direction: column; gap: 6px; }
        .socratic-opt { padding: 10px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; color: white; font-size: 11px; cursor: pointer; text-align: left; transition: all 0.2s; }
        .socratic-opt:hover { background: rgba(0,188,212,0.2); border-color: var(--water); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* è¯­éŸ³æµ®çƒ - éšè—ï¼Œå…¥å£æ”¹ä¸ºåŠŸèƒ½åŒºæŒ‰é’® */
        .voice-fab { display: none !important; }
        .voice-status { position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); border: 1px solid var(--primary); border-radius: 20px; padding: 8px 16px; font-size: 11px; max-width: 280px; z-index: 200; display: none; text-align: center; }
        .voice-status.show { display: block; }

        /* ğŸ’§ å–æ°´æé†’æ ¸å¿ƒåŠŸèƒ½ */
        .water-remind-box { background: linear-gradient(135deg, rgba(0,188,212,0.15), rgba(0,150,200,0.1)); border: 2px solid rgba(0,188,212,0.4); border-radius: 16px; padding: 15px; margin: 12px 0; }
        .water-remind-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .water-title { font-size: 14px; font-weight: bold; color: var(--water); }
        .water-goal { font-size: 11px; color: rgba(255,255,255,0.6); }
        .water-progress-bar { height: 12px; background: rgba(0,0,0,0.3); border-radius: 6px; overflow: hidden; margin-bottom: 8px; }
        .water-progress-fill { height: 100%; background: linear-gradient(90deg, #00bcd4, #00e5ff, #4dd0e1); border-radius: 6px; transition: width 0.5s ease; box-shadow: 0 0 10px rgba(0,188,212,0.5); }
        .water-stats { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .water-current { font-size: 24px; font-weight: bold; color: white; }
        .water-current span { color: var(--water); }
        .water-percent { font-size: 16px; color: var(--gold); font-weight: bold; }
        .water-buttons { display: flex; gap: 8px; margin-bottom: 12px; }
        .water-btn { border: none; border-radius: 20px; padding: 8px 12px; font-size: 11px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .water-btn.small { background: rgba(255,255,255,0.1); color: white; flex: 1; }
        .water-btn.small:active { background: rgba(0,188,212,0.3); }
        .water-btn.primary { background: linear-gradient(135deg, #00bcd4, #0097a7); color: white; flex: 2; }
        .water-btn.primary:active { transform: scale(0.95); }
        .water-schedule { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        .schedule-item { font-size: 9px; padding: 4px 8px; background: rgba(255,255,255,0.08); border-radius: 12px; color: rgba(255,255,255,0.5); }
        .schedule-item.done { background: rgba(6,255,165,0.2); color: var(--success); }
        .schedule-item.active { background: rgba(0,188,212,0.3); color: var(--water); animation: pulse 1.5s infinite; border: 1px solid var(--water); }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* ä¼šå‘˜ä½“ç³»æ ·å¼ */
        .membership-box { background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,140,0,0.1)); border: 2px solid rgba(255,215,0,0.3); border-radius: 16px; padding: 15px; margin: 10px 0; }
        .membership-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .membership-level { font-size: 14px; font-weight: bold; }
        .membership-level.free { color: rgba(255,255,255,0.6); }
        .membership-level.vip { color: var(--gold); }
        .membership-level.enterprise { color: #ff6b6b; }
        .membership-limits { font-size: 10px; color: rgba(255,255,255,0.5); margin-bottom: 12px; line-height: 1.6; }
        .membership-plans { display: flex; flex-direction: column; gap: 8px; }
        .plan-btn { padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .plan-btn:hover { background: rgba(255,215,0,0.1); border-color: var(--gold); }
        .plan-btn .plan-name { font-size: 12px; font-weight: bold; }
        .plan-btn .plan-price { font-size: 14px; color: var(--gold); font-weight: bold; }

        /* æ”¯ä»˜å¼¹çª— */
        .pay-modal-bg { position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px; }
        .pay-modal-bg.show { display:flex; }
        .pay-modal { background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:20px;padding:20px;max-width:360px;width:100%;max-height:90vh;overflow-y:auto;border:1px solid rgba(255,215,0,0.3);box-shadow:0 20px 60px rgba(0,0,0,0.5); }
        .pay-header { text-align:center;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:15px; }
        .pay-plan-name { font-size:18px;font-weight:bold;color:var(--gold);margin-bottom:4px; }
        .pay-plan-price { font-size:28px;font-weight:bold;color:#ff6b6b;margin-bottom:4px; }
        .pay-plan-desc { font-size:11px;color:rgba(255,255,255,0.5); }
        .pay-methods { margin-bottom:15px; }
        .pay-method-btn { display:flex;align-items:center;gap:12px;padding:14px;border:2px solid rgba(255,255,255,0.1);border-radius:12px;margin-bottom:8px;cursor:pointer;transition:all 0.3s; }
        .pay-method-btn:hover,.pay-method-btn.active { border-color:var(--gold);background:rgba(255,215,0,0.08); }
        .pay-method-icon { font-size:28px; }
        .pay-method-name { font-size:14px;font-weight:bold;color:white; }
        .pay-method-desc { font-size:10px;color:rgba(255,255,255,0.4); }
        .pay-qr-area { text-align:center;padding:15px;background:rgba(255,255,255,0.05);border-radius:12px;margin-bottom:15px;display:none; }
        .pay-qr-area.show { display:block; }
        .pay-qr-placeholder { width:200px;height:200px;background:white;border-radius:12px;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:14px;color:#333; }
        .pay-qr-tip { font-size:11px;color:rgba(255,255,255,0.6);line-height:1.6; }
        .pay-confirm-area { display:none;text-align:center; }
        .pay-confirm-area.show { display:block; }
        .pay-order-id { font-size:10px;color:rgba(255,255,255,0.4);margin-top:10px; }

        .plan-btn.recommended { background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,140,0,0.15)); border-color: var(--gold); }
        .plan-btn.recommended::after { content: 'æ¨è'; font-size: 9px; background: var(--gold); color: #000; padding: 2px 6px; border-radius: 8px; margin-left: 8px; }

        /* PWA å®‰è£…æç¤ºæ ·å¼ */
        .pwa-banner { display: none; position: fixed; bottom: 55px; left: 8px; right: 8px; background: linear-gradient(135deg, var(--primary), #8338ec); padding: 12px; border-radius: 12px; z-index: 150; box-shadow: 0 4px 20px rgba(0,212,255,0.4); animation: pwaSlide 0.4s ease; }
        .pwa-banner.show { display: block; }
        @keyframes pwaSlide { from { transform: translateY(80px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .pwa-banner-inner { display: flex; align-items: center; gap: 10px; }
        .pwa-banner-icon { font-size: 28px; }
        .pwa-banner-text { flex: 1; }
        .pwa-banner-title { font-size: 12px; font-weight: bold; }
        .pwa-banner-desc { font-size: 10px; opacity: 0.85; margin-top: 2px; }
        .pwa-banner-btn { background: white; color: #8338ec; border: none; padding: 8px 14px; border-radius: 16px; font-size: 11px; font-weight: bold; cursor: pointer; }
        .pwa-banner-close { position: absolute; top: 4px; right: 8px; background: none; border: none; color: white; font-size: 16px; cursor: pointer; opacity: 0.7; }
        .pwa-guide { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 400; justify-content: center; align-items: center; padding: 15px; }
        .pwa-guide.show { display: flex; }
        .pwa-guide-box { background: linear-gradient(135deg, var(--bg1), var(--bg2)); border: 2px solid var(--primary); border-radius: 16px; padding: 20px; max-width: 320px; width: 100%; }
        .pwa-guide-header { text-align: center; margin-bottom: 15px; }
        .pwa-guide-header .icon { font-size: 40px; }
        .pwa-guide-header .title { font-size: 16px; font-weight: bold; color: var(--gold); margin-top: 8px; }
        .pwa-guide-header .desc { font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; }
        .pwa-guide-steps { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 12px; margin-bottom: 15px; }
        .pwa-guide-step { display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 11px; line-height: 1.5; }
        .pwa-guide-step:last-child { border-bottom: none; }
        .pwa-step-num { background: var(--primary); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; flex-shrink: 0; }
        .pwa-guide-btn { width: 100%; padding: 10px; background: linear-gradient(135deg, var(--primary), #8338ec); border: none; border-radius: 20px; color: white; font-size: 13px; font-weight: bold; cursor: pointer; }
        .pwa-wechat-tip { background: rgba(255,215,0,0.15); border: 1px solid rgba(255,215,0,0.4); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 10px; color: var(--gold); line-height: 1.5; display: none; }
    </style>
</head>
<body>
    <!-- PWA å®‰è£…æç¤º -->
    <div class="pwa-banner" id="pwaBanner">
        <button class="pwa-banner-close" onclick="closePwaBanner()">Ã—</button>
        <div class="pwa-banner-inner">
            <div class="pwa-banner-icon">ğŸ’§</div>
            <div class="pwa-banner-text">
                <div class="pwa-banner-title">æ·»åŠ åˆ°æ¡Œé¢</div>
                <div class="pwa-banner-desc">åƒAPPä¸€æ ·ä½¿ç”¨ï¼Œä¸€é”®æ‰“å¼€</div>
            </div>
            <button class="pwa-banner-btn" onclick="handlePwaInstall()">æ·»åŠ </button>
        </div>
    </div>
    <div class="pwa-guide" id="pwaGuide">
        <div class="pwa-guide-box">
            <div class="pwa-guide-header">
                <div class="icon">ğŸ“±</div>
                <div class="title">æ·»åŠ åˆ°ä¸»å±å¹•</div>
                <div class="desc">3æ­¥å®Œæˆï¼ŒåƒAPPä¸€æ ·ä½¿ç”¨</div>
            </div>
            <div class="pwa-wechat-tip" id="pwaWechatTip">âš ï¸ å½“å‰åœ¨å¾®ä¿¡å†…ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’ Â·Â·Â· é€‰æ‹©ã€Œåœ¨æµè§ˆå™¨æ‰“å¼€ã€</div>
            <div class="pwa-guide-steps" id="pwaSteps"></div>
            <button class="pwa-guide-btn" onclick="closePwaGuide()">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <div class="top-bar">
        <div class="logo">ğŸ’§ <span data-i18n="appName">å–æ°´äº†å—</span></div>
        <div class="top-right">
            <select class="lang-select" id="langSelect" onchange="changeLang(this.value)">
                <option value="zh">ä¸­æ–‡</option>
                <option value="en">English</option>
                <option value="es">EspaÃ±ol</option>
                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                <option value="he">×¢×‘×¨×™×ª</option>
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="ko">í•œêµ­ì–´</option>
            </select>
            <button class="top-btn" onclick="openPanel('promoPanel')" data-i18n="promo">å…±äº«</button>
            <button class="top-btn" id="userBtn" onclick="openPanel('memberPanel')" data-i18n="login">ç™»å½•</button>
        </div>
    </div>

    <div class="ad-bar"><div class="ad-container" id="adContainer"></div><div class="ad-dots" id="adDots"></div></div>

    <div class="main">
        <div class="culture-card">
            <div class="culture-bg" id="cultureBg"></div>
            <div class="culture-content">
                <div class="culture-label">ğŸ’§ <span data-i18n="dailyWisdom">æ¯æ—¥æ°´è¯­</span> Â· <span id="cultureDate"></span></div>
                <div class="culture-text" id="cultureText"></div>
                <div class="culture-source" id="cultureSource"></div>
                <div class="culture-actions">
                    <button class="culture-btn" onclick="copyCulture()" data-i18n="copy">å¤åˆ¶</button>
                    <button class="culture-btn" onclick="refreshCulture()" data-i18n="refresh">æ¢ä¸€æ¡</button>
                </div>
            </div>
        </div>

        <div class="checkin-bar">
            <div class="checkin-info">
                <div class="checkin-streak"><span data-i18n="streak">è¿ç»­</span> <strong id="streakDays">0</strong> <span data-i18n="days">å¤©</span></div>
                <div class="checkin-points"><span data-i18n="points">ç§¯åˆ†</span>: <span id="totalPoints">0</span></div>
            </div>
            <button class="checkin-btn" id="checkinBtn" onclick="doCheckin()">âœ… <span data-i18n="checkin">æ‰“å¡</span>+10</button>
        </div>

        <div class="clock-unit">
            <div class="clock-area">
                <div class="clock-face" id="clockFace">
                    <div id="ticks"></div>
                    <div class="clock-num n12">12</div>
                    <div class="clock-num n3">3</div>
                    <div class="clock-num n6">6</div>
                    <div class="clock-num n9">9</div>
                    <div class="clock-center" onclick="openPanel('centerPanel')">
                        <div class="center-content" id="centerContent">
                            <div class="center-placeholder" data-i18n="clickToAdd">ç‚¹å‡»æ·»åŠ <br>å›¾ç‰‡/è§†é¢‘/æ–‡å­—</div>
                        </div>
                    </div>
                    <div class="hand hand-hour" id="hHour"></div>
                    <div class="hand hand-minute" id="hMin"></div>
                    <div class="hand hand-second" id="hSec"></div>
                    <div class="hand-dot"></div>
                </div>

                <div class="digital-box">
                    <div class="digital-time">
                        <span id="dH">00</span><span class="colon">:</span><span id="dM">00</span><span class="colon">:</span><span id="dS">00</span>
                    </div>
                    <div class="digital-date" id="digitalDate"></div>
                    <div class="slogan" data-i18n="slogan">ã€Œä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰ã€</div>
                </div>

                <div class="tick-bar" onclick="openPanel('settingsPanel')">
                    <div class="tick-dot" id="tickDot"></div>
                    <span style="font-size:11px;" data-i18n="tickSound">æ»´ç­”å£°</span>
                    <span style="font-size:10px;color:var(--gold);" id="tickSoundName">ç»å…¸é’Ÿå£°</span>
                </div>

                <!-- ğŸ’§ å–æ°´æé†’æ ¸å¿ƒåŠŸèƒ½åŒº -->
                <div class="water-remind-box">
                    <div class="water-remind-header">
                        <span class="water-title">ğŸ’§ ä»Šæ—¥é¥®æ°´</span>
                        <span class="water-goal" id="waterGoalText">ç›®æ ‡ 2000ml</span>
                    </div>
                    <div class="water-progress-bar">
                        <div class="water-progress-fill" id="waterProgressFill" style="width:0%"></div>
                    </div>
                    <div class="water-stats">
                        <span class="water-current"><span id="waterCurrent">0</span> ml</span>
                        <span class="water-percent" id="waterPercent">0%</span>
                    </div>
                    <div class="water-buttons">
                        <button class="water-btn small" onclick="drinkWater(100)">+100ml</button>
                        <button class="water-btn small" onclick="drinkWater(200)">+200ml</button>
                        <button class="water-btn primary" onclick="drinkWater(250)">ğŸ¥¤ å–ä¸€æ¯ 250ml</button>
                    </div>
                    <div class="water-schedule" id="waterSchedule">
                        <span class="schedule-item done">â˜€ï¸ 7:00</span>
                        <span class="schedule-item done">ğŸŒ¤ï¸ 9:00</span>
                        <span class="schedule-item active">â˜€ï¸ 11:00</span>
                        <span class="schedule-item">ğŸš 13:00</span>
                        <span class="schedule-item">ğŸŒ¤ï¸ 15:00</span>
                        <span class="schedule-item">ğŸŒ… 17:00</span>
                        <span class="schedule-item">ğŸŒ™ 19:00</span>
                        <span class="schedule-item">ğŸ˜´ 21:00</span>
                    </div>
                </div>

                <div class="func-row">
                    <div class="func-btn" onclick="openPanel('classicsPanel')"><div class="icon">ğŸ“–</div><div class="label" data-i18n="classics">ç»å…¸</div></div>
                    <div class="func-btn" onclick="openPanel('waterPanel')"><div class="icon">ğŸ’§</div><div class="label" data-i18n="waterStudy">æ°´å­¦</div></div>
                    <div class="func-btn voice" onclick="toggleVoice()"><div class="icon">ğŸ¤</div><div class="label" data-i18n="voice">è¯­éŸ³</div></div>
                    <div class="func-btn" onclick="openPanel('carePanel')"><div class="icon">ğŸ’</div><div class="label" data-i18n="care">å…³æ€€</div></div>
                    <div class="func-btn" onclick="openPanel('settingsPanel')"><div class="icon">âš™ï¸</div><div class="label" data-i18n="settings">è®¾ç½®</div></div>
                </div>
            </div>

            <div class="remind-section">
                <div class="remind-title">ğŸ”” <span data-i18n="upcomingReminders">å³å°†åˆ°æ¥çš„æé†’</span></div>
                <div id="upcomingReminds"></div>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <button class="nav-btn active"><span class="icon">ğŸ </span><span class="label" data-i18n="home">é¦–é¡µ</span></button>
        <button class="nav-btn" onclick="openPanel('promoPanel')"><span class="icon">ğŸ“£</span><span class="label" data-i18n="promo">å…±äº«</span></button>
        <button class="nav-btn" onclick="openPanel('settingsPanel')"><span class="icon">â°</span><span class="label" data-i18n="remind">æé†’</span></button>
        <button class="nav-btn" onclick="openPanel('pointsPanel')"><span class="icon">ğŸ</span><span class="label" data-i18n="points">ç§¯åˆ†</span></button>
        <button class="nav-btn" onclick="openPanel('memberPanel')"><span class="icon">ğŸ‘¤</span><span class="label" data-i18n="me">æˆ‘çš„</span></button>
    </div>

    <!-- è¯­éŸ³æµ®çƒã€Œæ™ºå›ã€ -->
    <div class="voice-fab" id="voiceFab" onclick="toggleVoiceRecognition()">
        ğŸ¤
        <div class="voice-label">è¯´ã€Œæ™ºå›ã€</div>
    </div>
    <div class="voice-status" id="voiceStatus">ğŸ¤ ç­‰å¾…å”¤é†’è¯ã€Œæ™ºå›ã€...</div>

    <div class="panel-overlay" id="overlay" onclick="closeAllPanels()"></div>

    <!-- è®¾ç½®é¢æ¿ -->
    <div class="panel" id="settingsPanel">
        <button class="panel-close" onclick="closeAllPanels()">Ã—</button>
        <div class="panel-title">âš™ï¸ <span data-i18n="settings">è®¾ç½®</span></div>

        <div class="section-title">â° <span data-i18n="reminderManagement">æé†’ç®¡ç†</span></div>
        <button class="btn btn-gold" style="margin-bottom:10px;" onclick="openModal('addRemindModal')">â• <span data-i18n="newReminder">æ–°å»ºæé†’</span></button>
        <div id="remindList"></div>

        <div class="divider"></div>

        <div class="section-title">ğŸ”Š <span data-i18n="soundSettings">æ»´ç­”å£°è®¾ç½®</span></div>
        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px;background:rgba(255,255,255,0.05);border-radius:10px;margin-bottom:10px;">
            <span style="font-size:12px;" data-i18n="tickSwitch">æ»´ç­”å£°å¼€å…³</span>
            <div style="width:44px;height:24px;background:rgba(255,255,255,0.2);border-radius:12px;position:relative;cursor:pointer;" id="tickSwitch" onclick="toggleTick()">
                <div style="width:20px;height:20px;background:white;border-radius:50%;position:absolute;top:2px;transition:0.3s;" id="tickKnob"></div>
            </div>
        </div>
        <div id="soundList"></div>
        <div class="section-title">ğŸ”ˆ <span data-i18n="volume">éŸ³é‡</span></div>
        <input type="range" id="volumeSlider" min="0" max="100" value="50" style="width:100%;" onchange="setVolume(this.value)">

        <div class="divider"></div>

        <div class="section-title">ğŸ¨ <span data-i18n="theme">ä¸»é¢˜é£æ ¼</span></div>
        <div class="theme-grid">
            <div class="theme-item classic active" onclick="setTheme('classic')"></div>
            <div class="theme-item luxury" onclick="setTheme('luxury')"></div>
            <div class="theme-item nature" onclick="setTheme('nature')"></div>
            <div class="theme-item romantic" onclick="setTheme('romantic')"></div>
        </div>

        <div class="divider"></div>

        <!-- ç®¡ç†å‘˜å¹¿å‘Šè®¾ç½® -->
        <div class="section-title">ğŸ“¢ <span data-i18n="adManagement">å¹¿å‘Šç®¡ç†</span> <span style="font-size:9px;color:var(--accent);">(ç®¡ç†å‘˜)</span></div>
        
        <div id="adminAdSection">
            <div class="admin-login-box" id="adminLoginBox">
                <div class="title">ğŸ” <span data-i18n="adminLogin">ç®¡ç†å‘˜ç™»å½•</span></div>
                <div class="form-group">
                    <input type="password" id="adminPwd" placeholder="è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
                </div>
                <button class="btn btn-danger" onclick="adminLogin()" data-i18n="verify">éªŒè¯</button>
            </div>
            
            <div id="adminAdContent" style="display:none;">
                <div id="ordersContainer"></div>
                <button class="btn btn-gold" style="width:100%;margin-bottom:10px;font-size:13px;" onclick="showOrdersPanel()">ğŸ’° åˆ·æ–°è®¢å•ç®¡ç†</button>
                <div class="divider"></div>
                <div id="autoSendContainer"></div>
                <button class="btn btn-outline" style="width:100%;margin-bottom:10px;font-size:13px;border-color:rgba(255,152,0,0.4);color:#ff9800;" onclick="showAutoSendPanel()">ğŸ¤– è‡ªåŠ¨ç¥ç¦ç³»ç»Ÿ</button>
                <div class="divider"></div>
                <div id="activityLogContainer"></div>
                <button class="btn btn-outline" style="width:100%;margin-bottom:10px;font-size:13px;" onclick="showActivityLog()">ğŸ“‹ æ´»åŠ¨æ—¥å¿—</button>
                <div class="divider"></div>
                <div id="statsContainer"></div>
                <button class="btn btn-primary" style="width:100%;margin-bottom:10px;font-size:13px;" onclick="showStatsPanel()">ğŸ“Š åˆ·æ–°æ•°æ®çœ‹æ¿</button>
                <script>setTimeout(function(){if(document.getElementById("adminAdContent").style.display!=="none")showStatsPanel();},100);</script>
                <div class="divider"></div>
                <div id="adList"></div>
                <button class="btn btn-outline" style="margin-bottom:8px;" onclick="openModal('addAdModal')">â• <span data-i18n="addAd">æ·»åŠ æ–°å¹¿å‘Š</span></button>
                <button class="btn btn-outline" onclick="adminLogout()" style="font-size:10px;" data-i18n="adminLogout">é€€å‡ºç®¡ç†</button>
            </div>
        </div>
    </div>

    <!-- é’Ÿè¡¨ä¸­å¿ƒé¢æ¿ -->
    <div class="panel" id="centerPanel">
        <button class="panel-close" onclick="closeAllPanels()">Ã—</button>
        <div class="panel-title">ğŸ¨ <span data-i18n="customizeCenter">è‡ªå®šä¹‰é’Ÿè¡¨ä¸­å¿ƒ</span></div>
        
        <div class="section-title">ğŸ“· <span data-i18n="uploadImage">ä¸Šä¼ å›¾ç‰‡</span></div>
        <div style="border:2px dashed rgba(255,255,255,0.2);border-radius:10px;padding:20px;text-align:center;cursor:pointer;margin-bottom:12px;" onclick="document.getElementById('imgUpload').click()">
            <div style="font-size:28px;">ğŸ–¼ï¸</div>
            <div style="font-size:10px;color:rgba(255,255,255,0.5);" data-i18n="clickUpload">ç‚¹å‡»ä¸Šä¼ </div>
        </div>
        <input type="file" id="imgUpload" accept="image/*" style="display:none" onchange="uploadImage(this)">

        <div class="section-title">ğŸ¬ <span data-i18n="uploadVideo">ä¸Šä¼ è§†é¢‘</span></div>
        <div style="border:2px dashed rgba(255,255,255,0.2);border-radius:10px;padding:20px;text-align:center;cursor:pointer;margin-bottom:12px;" onclick="document.getElementById('vidUpload').click()">
            <div style="font-size:28px;">ğŸ¬</div>
            <div style="font-size:10px;color:rgba(255,255,255,0.5);" data-i18n="clickUpload">ç‚¹å‡»ä¸Šä¼ </div>
        </div>
        <input type="file" id="vidUpload" accept="video/*" style="display:none" onchange="uploadVideo(this)">

        <div class="section-title">âœï¸ <span data-i18n="customText">è‡ªå®šä¹‰æ–‡å­—</span></div>
        <div class="form-group"><textarea id="centerText" rows="3" placeholder="è¾“å…¥æ–‡å­—..."></textarea></div>
        <button class="btn btn-primary" onclick="setCenterText()" data-i18n="apply">åº”ç”¨</button>
        <div class="divider"></div>
        <button class="btn btn-outline" onclick="resetCenter()" data-i18n="resetDefault">æ¢å¤é»˜è®¤</button>
    </div>

    <!-- å…³æ€€é¢æ¿ -->
    <div class="panel" id="carePanel">
        <button class="panel-close" onclick="closeAllPanels()">Ã—</button>
        <div class="panel-title">ğŸ’ <span data-i18n="smartCare">æ™ºèƒ½å…³æ€€</span></div>

        <!-- æœªæˆæƒæ—¶æ˜¾ç¤º -->
        <div class="contact-auth-box" id="contactAuthBox">
            <div class="icon">ğŸ“±</div>
            <div class="title" data-i18n="readContacts">è¯»å–é€šè®¯å½•</div>
            <div class="desc" data-i18n="contactsDesc">æˆæƒåå¯ä»æ‰‹æœºé€šè®¯å½•ä¸­é€‰æ‹©è”ç³»äººï¼Œè®¾ç½®ç”Ÿæ—¥ã€çºªå¿µæ—¥ç­‰å…³æ€€æé†’ã€‚ä»…Android Chromeæ”¯æŒç›´æ¥è¯»å–ï¼Œå…¶ä»–æµè§ˆå™¨å¯æ‰‹åŠ¨æ·»åŠ ã€‚</div>
            <button class="btn btn-gold" onclick="requestContactsPermission()">ğŸ“‡ <span data-i18n="authorizeContacts">æˆæƒè¯»å–é€šè®¯å½•</span></button>
            <div style="margin-top:8px;">
                <button class="btn btn-outline" style="font-size:11px;" onclick="showManualContactEntry()">âœï¸ è·³è¿‡ï¼Œæ‰‹åŠ¨æ·»åŠ </button>
            </div>
        </div>

        <!-- å·²æˆæƒåæ˜¾ç¤ºæœç´¢æ¡†+é€šè®¯å½•åˆ—è¡¨ -->
        <div id="contactSearchBox" style="display:none;">
            <div class="section-title">ğŸ” <span data-i18n="findCarePerson">æŸ¥æ‰¾è¢«å…³æ€€äºº</span></div>
            <div style="position:relative;margin-bottom:12px;">
                <input type="text" id="careSearchInput" placeholder="è¾“å…¥å§“åæŸ¥æ‰¾..." oninput="searchCarePerson(this.value)" style="width:100%;padding:12px 15px;padding-left:40px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:12px;color:white;font-size:14px;">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:18px;">ğŸ”</span>
            </div>
            <!-- æœç´¢ç»“æœ -->
            <div id="searchResults" style="max-height:200px;overflow-y:auto;"></div>

            <!-- é€šè®¯å½•å®Œæ•´åˆ—è¡¨ -->
            <div id="contactsDirectory">
                <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 0 8px;">
                    <span style="font-size:12px;color:var(--water);font-weight:bold;">ğŸ“‡ é€šè®¯å½• (<span id="contactCount">0</span>äºº)</span>
                    <div>
                        <button onclick="refreshContacts()" style="background:none;border:1px solid rgba(255,255,255,0.2);border-radius:8px;padding:3px 8px;font-size:9px;color:rgba(255,255,255,0.6);cursor:pointer;margin-right:4px;">ğŸ”„ åˆ·æ–°</button>
                        <button onclick="resetContactsAuth()" style="background:none;border:1px solid rgba(255,100,100,0.3);border-radius:8px;padding:3px 8px;font-size:9px;color:rgba(255,100,100,0.6);cursor:pointer;">ğŸ—‘ï¸ é‡ç½®</button>
                    </div>
                </div>
                <div id="contactsList" style="max-height:320px;overflow-y:auto;"></div>
            </div>
        </div>

        <div class="divider"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <span class="section-title" style="margin:0">ğŸ‘¥ <span data-i18n="addedFriends">å·²æ·»åŠ çš„å…³æ€€å¯¹è±¡</span></span>
            <button class="btn btn-primary" style="width:auto;padding:5px 10px;font-size:10px;" onclick="openModal('addFriendModal')">+ <span data-i18n="manualAdd">æ‰‹åŠ¨æ·»åŠ </span></button>
        </div>
        <div id="friendList"></div>
    </div>

    <!-- ç»å…¸é¢æ¿ï¼ˆåŸç»ä¹¦ï¼Œå¸¦äºŒçº§ç›®å½•ï¼‰ -->
    <div class="panel" id="classicsPanel">
        <button class="panel-close" onclick="closeAllPanels()">Ã—</button>
        <div class="panel-title">ğŸ“– <span data-i18n="classics">ç»å…¸</span></div>

        <div class="water-tabs" id="classicsTabs">
            <div class="water-tab active" onclick="switchClassicsTab('scriptures')">ğŸ“œ äº”ç»</div>
            <div class="water-tab" onclick="switchClassicsTab('philosophy')">ğŸ“ å“²å­¦</div>
            <div class="water-tab" onclick="switchClassicsTab('poetry')">ğŸ“ è¯—è¯</div>
            <div class="water-tab" onclick="switchClassicsTab('wisdom')">ğŸ’¡ æ™ºæ…§</div>
        </div>

        <div id="classicsContent"></div>
    </div>

    <div class="panel" id="waterPanel">
        <button class="panel-close" onclick="closeAllPanels()">Ã—</button>
        <div class="panel-title">ğŸ’§ <span data-i18n="waterCourse">æ°´å­¦è¯¾ç¨‹</span></div>

        <div class="water-tabs" id="waterTabs">
            <div class="water-tab active" onclick="switchWaterTab('science')">ğŸ”¬ æ°´ç§‘å­¦</div>
            <div class="water-tab" onclick="switchWaterTab('philosophy')">â˜¯ï¸ æ°´å“²å­¦</div>
            <div class="water-tab" onclick="switchWaterTab('health')">ğŸ’Š æ°´å¥åº·</div>
            <div class="water-tab" onclick="switchWaterTab('socratic')">ğŸ›ï¸ æ°´é—®ç­”</div>
        </div>

        <!-- æ°´å­¦äºŒçº§ç›®å½• -->
        <div class="water-submenu" style="display:flex;flex-wrap:wrap;gap:6px;margin:10px 0;padding:10px;background:rgba(0,188,212,0.08);border-radius:12px;">
            <div class="submenu-item" onclick="openWaterSection('institute')" style="flex:1;min-width:45%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(0,188,212,0.3);border-radius:10px;text-align:center;cursor:pointer;">
                <div style="font-size:20px;margin-bottom:4px;">ğŸ›ï¸</div>
                <div style="font-size:11px;font-weight:bold;color:var(--water);">æ°´å­¦ç ”ç©¶é™¢</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.5);">å­¦æœ¯ç ”ç©¶</div>
            </div>
            <div class="submenu-item" onclick="openWaterSection('tech')" style="flex:1;min-width:45%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(0,188,212,0.3);border-radius:10px;text-align:center;cursor:pointer;">
                <div style="font-size:20px;margin-bottom:4px;">ğŸ”§</div>
                <div style="font-size:11px;font-weight:bold;color:var(--water);">æ°´ç§‘æŠ€</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.5);">ç§‘æŠ€åˆ›æ–°</div>
            </div>
            <div class="submenu-item" onclick="openWaterSection('products')" style="flex:1;min-width:45%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(0,188,212,0.3);border-radius:10px;text-align:center;cursor:pointer;">
                <div style="font-size:20px;margin-bottom:4px;">ğŸ›’</div>
                <div style="font-size:11px;font-weight:bold;color:var(--water);">æ°´äº§å“</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.5);">å¥åº·å¥½ç‰©</div>
            </div>
            <div class="submenu-item" onclick="openWaterSection('inventions')" style="flex:1;min-width:45%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(0,188,212,0.3);border-radius:10px;text-align:center;cursor:pointer;">
                <div style="font-size:20px;margin-bottom:4px;">ğŸ’¡</div>
                <div style="font-size:11px;font-weight:bold;color:var(--water);">æ°´å‘æ˜</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.5);">ä¸“åˆ©æŠ€æœ¯</div>
            </div>
        </div>
            <div class="water-tab" onclick="switchWaterTab('health')">ğŸ’Š æ°´å¥åº·</div>
            <div class="water-tab" onclick="switchWaterTab('socratic')">ğŸ›ï¸ æ°´é—®ç­”</div>
        </div>

        <div id="waterLessonContent"></div>

        <div class="water-controls">
            <button onclick="prevWaterLesson()">â¬… ä¸Šä¸€è¯¾</button>
            <button onclick="speakWaterLesson()">ğŸ”Š æœ—è¯»</button>
            <button onclick="nextWaterLesson()">ä¸‹ä¸€è¯¾ â¡</button>
        </div>

        <div id="socraticSection" style="display:none;">
            <div class="socratic-box">
                <div class="socratic-title">ğŸ›ï¸ æ°´çš„è‹æ ¼æ‹‰åº•å¯¹è¯</div>
                <div class="socratic-chat" id="socraticChat"></div>
                <div class="socratic-options" id="socraticOptions"></div>
            </div>
        </div>

        <div id="waterList" style="display:none;"></div>
    </div>

    <div class="panel" id="promoPanel">
        <button class="panel-close" onclick="closeAllPanels()">Ã—</button>
        <div class="panel-title">ğŸ“£ <span data-i18n="promoCenter">å…±äº«ä¸­å¿ƒ</span></div>
        <div style="text-align:center;padding:16px;background:linear-gradient(135deg,rgba(255,215,0,0.12),rgba(255,0,110,0.08));border-radius:14px;margin-bottom:12px;">
            <div style="font-size:28px;">ğŸ´ğŸ§§</div>
            <div style="font-size:16px;font-weight:bold;color:var(--gold);margin:6px 0;">æ–°æ˜¥å¿«ä¹ Â· å–æ°´äº†å—ï¼Ÿ</div>
            <div style="font-size:12px;color:rgba(255,255,255,0.7);">æŠŠå¥åº·çš„ç¥ç¦åˆ†äº«ç»™æœ‹å‹</div>
        </div>
        <button class="btn btn-gold" style="width:100%;margin-bottom:8px;font-size:14px;" onclick="openPanel('festivalPanel')">ğŸ® æ˜¥èŠ‚ç¥ç¦é¦† Â· åˆä¸€åˆ°åäº”</button>
        <button class="btn" style="width:100%;margin-bottom:8px;font-size:14px;" onclick="shareNewYear()">ğŸ§§ åˆ†äº«æ–°å¹´å–æ°´ç¥ç¦</button>
        <button class="btn" style="width:100%;margin-bottom:12px;" onclick="copyInviteLink()" data-i18n="copyInviteLink">ğŸ“‹ å¤åˆ¶é‚€è¯·é“¾æ¥</button>
        <div style="text-align:center;padding:16px;background:rgba(255,215,0,0.06);border-radius:14px;">
            <div style="font-size:12px;" data-i18n="myInviteCode">æˆ‘çš„é‚€è¯·ç </div>
            <div style="font-size:20px;font-weight:bold;color:var(--gold);margin:10px 0;" id="inviteCode">--</div>
            <div id="promoQR" style="background:white;padding:10px;border-radius:10px;display:inline-block;margin:10px 0;"></div>
        </div>
    </div>

    <!-- â•â•â• æ˜¥èŠ‚ç¥ç¦é¦† Â· åˆä¸€åˆ°åäº” â•â•â• -->
    <div class="panel" id="festivalPanel" style="max-height:90vh;overflow-y:auto;">
        <button class="panel-close" onclick="closeAllPanels()">Ã—</button>
        <div class="panel-title">ğŸ® æ˜¥èŠ‚ç¥ç¦é¦†</div>
        <div style="text-align:center;margin-bottom:10px;">
            <div style="font-size:12px;color:rgba(255,255,255,0.6);">é€‰æ‹©æ—¥æœŸ Â· ä¸ªæ€§åŒ–å®šåˆ¶ Â· ä¸€é”®åˆ†äº«</div>
            <div style="margin:8px 0;">
                <input type="text" id="festName" placeholder="è¾“å…¥ä½ çš„åå­—/æ˜µç§°ï¼ˆä¸ªæ€§åŒ–ç¥ç¦ï¼‰" style="width:85%;padding:8px 12px;border-radius:20px;border:1px solid rgba(255,215,0,0.3);background:rgba(255,255,255,0.06);color:#fff;font-size:12px;text-align:center;">
            </div>
        </div>
        <div id="festDayGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;"></div>
    </div>

    <!-- â•â•â• è´ºé¡µå…¨å±æµ®å±‚ â•â•â• -->
    <div id="festOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:10000;overflow-y:auto;">
        <div id="festPage" style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px 20px 90px;text-align:center;position:relative;"></div>
        <div style="position:fixed;bottom:0;left:0;right:0;z-index:10001;background:rgba(0,0,0,0.7);backdrop-filter:blur(12px);padding:12px 16px;padding-bottom:max(12px,env(safe-area-inset-bottom));">
            <div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap;">
                <button onclick="festShareTo('wechat')" style="padding:8px 14px;border-radius:16px;border:none;background:#07C160;color:#fff;font-weight:bold;font-size:12px;cursor:pointer;">ğŸ’¬ å¾®ä¿¡</button>
                <button onclick="festShareTo('sms')" style="padding:8px 14px;border-radius:16px;border:none;background:#4A90D9;color:#fff;font-weight:bold;font-size:12px;cursor:pointer;">ğŸ“± çŸ­ä¿¡</button>
                <button onclick="festShareTo('contacts')" style="padding:8px 14px;border-radius:16px;border:none;background:#FF9500;color:#fff;font-weight:bold;font-size:12px;cursor:pointer;">ğŸ“‡ é€šè®¯å½•</button>
                <button onclick="festShareTo('copy')" style="padding:8px 14px;border-radius:16px;border:none;background:rgba(255,215,0,0.9);color:#000;font-weight:bold;font-size:12px;cursor:pointer;">ğŸ“‹ å¤åˆ¶</button>
                <button onclick="saveFestPoster()" style="padding:8px 14px;border-radius:16px;border:none;background:rgba(255,255,255,0.2);color:#fff;font-weight:bold;font-size:12px;cursor:pointer;">ğŸ–¼ ä¿å­˜</button>
                <button onclick="closeFestOverlay()" style="padding:8px 14px;border-radius:16px;border:none;background:rgba(255,255,255,0.1);color:#fff;font-size:12px;cursor:pointer;">âœ•</button>
            </div>
        </div>
    </div>

    <div class="panel" id="pointsPanel">
        <button class="panel-close" onclick="closeAllPanels()">Ã—</button>
        <div class="panel-title">ğŸ <span data-i18n="pointsCenter">ç§¯åˆ†ä¸­å¿ƒ</span></div>
        <div style="text-align:center;padding:20px;background:rgba(255,215,0,0.08);border-radius:14px;margin-bottom:12px;">
            <div style="font-size:10px;color:rgba(255,255,255,0.6);" data-i18n="myPoints">æˆ‘çš„ç§¯åˆ†</div>
            <div style="font-size:32px;font-weight:bold;color:var(--gold);" id="myPoints">0</div>
        </div>
        <div style="background:linear-gradient(135deg,rgba(255,215,0,0.08),rgba(0,212,255,0.06));border:1px solid rgba(255,215,0,0.2);border-radius:14px;padding:14px;margin-bottom:12px;">
            <div style="font-size:13px;font-weight:bold;color:var(--gold);margin-bottom:8px;">ğŸ† ç§¯åˆ†è§„åˆ™</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.8);line-height:1.8;">
                ğŸ“… æ¯æ—¥ç­¾åˆ°ï¼š<span style="color:var(--gold);">+10åˆ†</span><br>
                ğŸ”¥ è¿ç»­7å¤©ç­¾åˆ°ï¼š<span style="color:var(--gold);">é¢å¤–+50åˆ†</span><br>
                ğŸ’§ æ¯æ¬¡å–æ°´æ‰“å¡ï¼š<span style="color:var(--gold);">+5åˆ†</span><br>
                ğŸ“¤ åˆ†äº«ç»™å¥½å‹ï¼ˆå¯¹æ–¹æ‰“å¼€ï¼‰ï¼š<span style="color:var(--gold);">+20åˆ†</span><br>
                ğŸ‘¤ å¥½å‹é€šè¿‡ä½ çš„é“¾æ¥æ³¨å†Œï¼š<span style="color:var(--gold);">+100åˆ†</span><br>
                ğŸ“š å®Œæˆæ°´å­¦è¯¾ç¨‹1èŠ‚ï¼š<span style="color:var(--gold);">+30åˆ†</span><br>
                ğŸ“ å®Œæˆè‹æ ¼æ‹‰åº•å¯¹è¯ï¼š<span style="color:var(--gold);">+50åˆ†</span>
            </div>
        </div>
        <div style="background:rgba(0,212,255,0.06);border:1px solid rgba(0,212,255,0.2);border-radius:14px;padding:14px;margin-bottom:12px;">
            <div style="font-size:13px;font-weight:bold;color:var(--primary);margin-bottom:8px;">ğŸ ç§¯åˆ†å…‘æ¢</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.8);line-height:1.8;">
                500åˆ† â†’ è§£é”æ›´å¤šæ°´å­¦è¯¾ç¨‹<br>
                1000åˆ† â†’ è§£é”å…¨éƒ¨ä¸»é¢˜é£æ ¼<br>
                2000åˆ† â†’ æœˆåº¦VIPä½“éªŒï¼ˆ7å¤©ï¼‰<br>
                5000åˆ† â†’ å­£åº¦VIP<br>
                10000åˆ† â†’ å¹´åº¦VIP + æ°´å¥åº·å¤§ä½¿è®¤è¯
            </div>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
            <div style="flex:1;text-align:center;padding:10px;background:rgba(255,215,0,0.06);border-radius:10px;">
                <div style="font-size:18px;font-weight:bold;color:var(--gold);" id="inviteCount">0</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.5);">é‚€è¯·äººæ•°</div>
            </div>
            <div style="flex:1;text-align:center;padding:10px;background:rgba(6,255,165,0.06);border-radius:10px;">
                <div style="font-size:18px;font-weight:bold;color:var(--success);" id="promoPoints">0</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.5);">å…±äº«ç§¯åˆ†</div>
            </div>
        </div>
        <div class="section-title">ğŸ“… <span data-i18n="monthlyCheckin">æœ¬æœˆæ‰“å¡</span></div>
        <div id="checkinCalendar" style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;"></div>
    </div>

    <div class="panel" id="memberPanel">
        <button class="panel-close" onclick="closeAllPanels()">Ã—</button>
        <div id="loginBox">
            <div class="panel-title">ğŸ” <span data-i18n="loginRegister">ç™»å½• / æ³¨å†Œ</span></div>
            <div class="form-group"><label data-i18n="phone">æ‰‹æœºå·</label><input type="tel" id="phoneInput" placeholder="11ä½æ‰‹æœºå·"></div>
            <div class="form-group"><label data-i18n="nickname">æ˜µç§°</label><input type="text" id="nameInput" placeholder="æ‚¨çš„æ˜µç§°"></div>
            <div class="form-group"><label data-i18n="password">å¯†ç </label><input type="password" id="pwdInput" placeholder="6ä½ä»¥ä¸Šå¯†ç "></div>
            <button class="btn btn-gold" onclick="doLogin()" data-i18n="loginRegister">ç™»å½• / æ³¨å†Œ</button>
        </div>
        <div id="memberBox" style="display:none;">
            <div style="text-align:center;padding:20px;background:rgba(255,215,0,0.08);border-radius:14px;margin-bottom:15px;">
                <div style="font-size:36px;" id="avatar">ğŸ‘¤</div>
                <div style="font-size:16px;font-weight:bold;margin-top:8px;" id="userName">ç”¨æˆ·</div>
                <div style="font-size:11px;color:var(--gold);margin-top:4px;" id="userLevel">å…è´¹ç”¨æˆ·</div>
            </div>

            <!-- ä¼šå‘˜æƒç›Šå¯¹æ¯” -->
            <div class="membership-box">
                <div class="membership-header">
                    <span class="membership-level" id="membershipTitle">ğŸ†“ å…è´¹ç”¨æˆ·</span>
                    <span style="font-size:10px;color:rgba(255,255,255,0.5);">å½“å‰ç­‰çº§</span>
                </div>
                <div class="membership-limits" id="membershipLimits">
                    â€¢ æé†’æ•°é‡ï¼šæ¯å¤©10æ¡<br>
                    â€¢ ç²¾ç¡®åº¦ï¼šåˆ†é’Ÿçº§<br>
                    â€¢ å…³æ€€å¯¹è±¡ï¼š3äºº<br>
                    â€¢ ä¸»é¢˜é£æ ¼ï¼š2æ¬¾<br>
                    â€¢ ç»å…¸/æ°´å­¦ï¼šæ¯æ—¥1ç¯‡<br>
                    â€¢ å¹¿å‘Šï¼šæœ‰å¹¿å‘Š
                </div>
            </div>

            <!-- å‡çº§é€‰é¡¹ -->
            <div style="font-size:12px;font-weight:bold;color:var(--gold);margin:15px 0 10px;">ğŸ‘‘ å‡çº§ä¼šå‘˜</div>
            <div class="membership-plans">
                <div class="plan-btn" onclick="upgradePlan('monthly')">
                    <div>
                        <div class="plan-name">æœˆåº¦ä¼šå‘˜</div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.5);">æ— é™æé†’ Â· ç§’çº§ç²¾ç¡®</div>
                    </div>
                    <div class="plan-price">Â¥9.99/æœˆ</div>
                </div>
                <div class="plan-btn" onclick="upgradePlan('quarterly')">
                    <div>
                        <div class="plan-name">å­£åº¦ä¼šå‘˜</div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.5);">çœ33% Â· å…¨éƒ¨å†…å®¹</div>
                    </div>
                    <div class="plan-price">Â¥19.99/å­£</div>
                </div>
                <div class="plan-btn recommended" onclick="upgradePlan('yearly')">
                    <div>
                        <div class="plan-name">å¹´åº¦VIP ğŸ”¥</div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.5);">çœ83% Â· éŸ³é¢‘è¯¾ç¨‹ Â· æ— å¹¿å‘Š</div>
                    </div>
                    <div class="plan-price">Â¥199/å¹´</div>
                </div>
                <div class="plan-btn" onclick="upgradePlan('enterprise')" style="border-color:rgba(255,107,107,0.5);">
                    <div>
                        <div class="plan-name" style="color:#ff6b6b;">ğŸ¢ ä¼ä¸šç‰ˆ</div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.5);">å“ç‰Œå®šåˆ¶ Â· åˆ†ç»„ç®¡ç† Â· ä¸“å±å†…å®¹</div>
                    </div>
                    <div class="plan-price" style="color:#ff6b6b;">Â¥9999/å¹´</div>
                </div>
            </div>

            <!-- æ¿€æ´»ç è¾“å…¥ -->
            <div style="margin-top:12px;padding:12px;background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.2);border-radius:12px;">
                <div style="font-size:12px;font-weight:bold;color:var(--primary);margin-bottom:8px;">ğŸ”‘ æœ‰æ¿€æ´»ç ï¼Ÿ</div>
                <div style="display:flex;gap:6px;">
                    <input type="text" id="activationCodeInput" placeholder="è¾“å…¥æ¿€æ´»ç ï¼Œå¦‚ VIP-XXXX-XXXX" style="flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.06);color:#fff;font-size:13px;letter-spacing:1px;text-transform:uppercase;">
                    <button onclick="activateByCode()" style="padding:10px 16px;border-radius:10px;border:none;background:linear-gradient(135deg,#FFD700,#ff9800);color:#000;font-weight:bold;font-size:12px;cursor:pointer;white-space:nowrap;">æ¿€æ´»</button>
                </div>
                <div style="font-size:9px;color:rgba(255,255,255,0.3);margin-top:6px;">ä»˜æ¬¾åç®¡ç†å‘˜ä¼šå‘é€æ¿€æ´»ç ç»™ä½ ï¼Œè¾“å…¥åç«‹å³å‡çº§</div>
            </div>

            <!-- æˆ‘çš„æ´»åŠ¨è®°å½• -->
            <div style="margin-top:15px;">
                <div style="font-size:12px;font-weight:bold;color:var(--primary);margin-bottom:8px;">ğŸ“‹ æˆ‘çš„æ´»åŠ¨è®°å½•</div>
                <div id="myActivityList" style="background:rgba(255,255,255,0.03);border-radius:10px;padding:10px;max-height:150px;overflow-y:auto;"></div>
            </div>
            
            <button class="btn btn-outline" style="margin-top:15px;" onclick="logout()" data-i18n="logout">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <!-- å¼¹çª— -->
    <div class="modal" id="addRemindModal">
        <div class="modal-box">
            <div class="modal-title">â° <span data-i18n="newReminder">æ–°å»ºæé†’</span></div>
            <div class="form-group"><label data-i18n="title">æ ‡é¢˜</label><input type="text" id="rTitle" placeholder="å¦‚ï¼šå–æ°´ã€å¼€ä¼šã€ç”Ÿæ—¥"></div>
            <div class="form-group"><label data-i18n="type">ç±»å‹</label>
                <select id="rType">
                    <option value="ğŸ’§">ğŸ’§ å–æ°´</option>
                    <option value="ğŸ¥">ğŸ¥ å°±åŒ»</option>
                    <option value="ğŸ“…">ğŸ“… å¼€ä¼š</option>
                    <option value="ğŸ‚">ğŸ‚ ç”Ÿæ—¥</option>
                    <option value="ğŸ“">ğŸ“ ç”µè¯</option>
                    <option value="ğŸ””">ğŸ”” å…¶ä»–</option>
                </select>
            </div>
            <div class="section-title">ğŸ“… <span data-i18n="date">æ—¥æœŸ</span></div>
            <div class="datetime-row">
                <div class="datetime-input"><label data-i18n="year">å¹´</label><input type="number" id="rYear"></div>
                <div class="datetime-input"><label data-i18n="month">æœˆ</label><input type="number" id="rMonth" min="1" max="12"></div>
                <div class="datetime-input"><label data-i18n="day">æ—¥</label><input type="number" id="rDay" min="1" max="31"></div>
            </div>
            <div class="section-title">â° <span data-i18n="time">æ—¶é—´</span></div>
            <div class="datetime-row">
                <div class="datetime-input"><label data-i18n="hour">æ—¶</label><input type="number" id="rHour" min="0" max="23"></div>
                <div class="datetime-input"><label data-i18n="minute">åˆ†</label><input type="number" id="rMin" min="0" max="59"></div>
                <div class="datetime-input"><label data-i18n="second">ç§’</label><input type="number" id="rSec" min="0" max="59"></div>
            </div>
            <div class="form-group"><label data-i18n="repeat">é‡å¤</label>
                <select id="rRepeat"><option value="once">ä¸é‡å¤</option><option value="daily">æ¯å¤©</option><option value="weekly">æ¯å‘¨</option><option value="monthly">æ¯æœˆ</option><option value="yearly">æ¯å¹´</option></select>
            </div>
            <div class="form-group"><label data-i18n="note">å¤‡æ³¨</label><textarea id="rNote" rows="2"></textarea></div>
            <button class="btn btn-gold" onclick="addRemind()" data-i18n="save">ä¿å­˜</button>
            <button class="btn btn-outline" style="margin-top:8px;" onclick="closeModal()" data-i18n="cancel">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="modal" id="remindDetailModal">
        <div class="modal-box">
            <div class="modal-title" id="detailTitle">â° æé†’è¯¦æƒ…</div>
            <div id="detailContent"></div>
            <button class="btn btn-primary" onclick="closeModal()" data-i18n="close">å…³é—­</button>
        </div>
    </div>

    <div class="modal" id="addAdModal">
        <div class="modal-box">
            <div class="modal-title">ğŸ“¢ <span data-i18n="addAd">æ·»åŠ å¹¿å‘Š</span></div>
            <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:10px;text-align:center;">å¯åŒæ—¶æ·»åŠ æ–‡å­—+å›¾ç‰‡+è§†é¢‘ï¼Œç³»ç»Ÿè‡ªåŠ¨é€‚é…å°ºå¯¸</div>
            <div class="form-group"><label>ğŸ“ æ–‡å­—å†…å®¹</label><textarea id="adText" rows="2" placeholder="å¹¿å‘Šæ–‡æ¡ˆï¼ˆå¯é€‰ï¼‰"></textarea></div>
            <div class="form-group"><label>ğŸ–¼ï¸ å›¾ç‰‡</label><input type="text" id="adImageUrl" placeholder="å›¾ç‰‡URLï¼ˆå¯é€‰ï¼‰">
                <div style="margin-top:4px;"><input type="file" id="adImageFile" accept="image/*" onchange="handleAdImage(this)" style="font-size:10px;color:rgba(255,255,255,0.5);"></div>
                <div id="adImagePreview" style="margin-top:4px;"></div>
            </div>
            <div class="form-group"><label>ğŸ¬ è§†é¢‘</label><input type="text" id="adVideoUrl" placeholder="è§†é¢‘URLï¼ˆå¯é€‰ï¼‰"></div>
            <div class="form-group"><label>ğŸ”— ç‚¹å‡»é“¾æ¥</label><input type="text" id="adLinkUrl" placeholder="ç‚¹å‡»è·³è½¬URLï¼ˆå¯é€‰ï¼‰"></div>
            <button class="btn btn-gold" onclick="addAd()" data-i18n="add">æ·»åŠ </button>
        </div>
    </div>

    <!-- å…³æ€€æé†’è®¾ç½®å¼¹çª— -->
    <div class="modal" id="careRemindModal">
        <div class="modal-box">
            <div class="modal-title">ğŸ’ è®¾ç½®å…³æ€€æé†’</div>
            
            <div style="text-align:center;padding:15px;background:rgba(0,212,255,0.1);border-radius:12px;margin-bottom:15px;">
                <div style="width:60px;height:60px;border-radius:50%;background:var(--primary);margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;" id="carePersonAvatar">å¼ </div>
                <div style="font-size:16px;font-weight:bold;" id="carePersonName">å¼ ä¸‰</div>
                <div style="font-size:11px;color:rgba(255,255,255,0.5);" id="carePersonPhone">138****1234</div>
            </div>

            <div class="form-group">
                <label>æé†’ç±»å‹</label>
                <select id="careType" style="width:100%;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;">
                    <option value="ğŸ‚ ç”Ÿæ—¥">ğŸ‚ ç”Ÿæ—¥æé†’</option>
                    <option value="ğŸ’‘ çºªå¿µæ—¥">ğŸ’‘ çºªå¿µæ—¥æé†’</option>
                    <option value="ğŸ’§ å–æ°´">ğŸ’§ å–æ°´æé†’</option>
                    <option value="ğŸ¥ ä½“æ£€">ğŸ¥ ä½“æ£€æé†’</option>
                    <option value="ğŸ“ ç”µè¯">ğŸ“ å®šæœŸç”µè¯</option>
                    <option value="ğŸ  æ¢æœ›">ğŸ  æ¢æœ›æé†’</option>
                    <option value="ğŸ’ å…³æ€€">ğŸ’ å…¶ä»–å…³æ€€</option>
                </select>
            </div>

            <div class="form-group">
                <label>æé†’æ—¥æœŸ</label>
                <div style="display:flex;gap:8px;">
                    <select id="careYear" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;"></select>
                    <select id="careMonth" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;"></select>
                    <select id="careDay" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;"></select>
                </div>
            </div>

            <div class="form-group">
                <label>æé†’æ—¶é—´</label>
                <div style="display:flex;gap:8px;">
                    <select id="careHour" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;"></select>
                    <select id="careMinute" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;"></select>
                </div>
            </div>

            <div class="form-group">
                <label>é‡å¤</label>
                <select id="careRepeat" style="width:100%;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;">
                    <option value="none">ä¸é‡å¤</option>
                    <option value="yearly" selected>æ¯å¹´é‡å¤</option>
                    <option value="monthly">æ¯æœˆé‡å¤</option>
                    <option value="weekly">æ¯å‘¨é‡å¤</option>
                    <option value="daily">æ¯å¤©é‡å¤</option>
                </select>
            </div>

            <div class="form-group">
                <label>å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</label>
                <input type="text" id="careNote" placeholder="å¦‚ï¼šè®°å¾—ä¹°è›‹ç³•" style="width:100%;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;font-size:13px;">
            </div>

            <div style="display:flex;gap:10px;margin-top:15px;">
                <button class="btn btn-outline" onclick="closeModal()" style="flex:1;">å–æ¶ˆ</button>
                <button class="btn btn-gold" onclick="saveCareRemind()" style="flex:1;">âœ… ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <div class="modal" id="addFriendModal">
        <div class="modal-box">
            <div class="modal-title">ğŸ‘¤ <span data-i18n="addFriend">æ·»åŠ å¥½å‹</span></div>
            <div class="form-group"><label data-i18n="name">å§“å</label><input type="text" id="fName"></div>
            <div class="form-group"><label data-i18n="phone">æ‰‹æœºå·</label><input type="tel" id="fPhone"></div>
            <div class="form-group"><label data-i18n="relation">å…³ç³»</label><select id="fRelation"><option>å®¶äºº</option><option>æœ‹å‹</option><option>åŒäº‹</option></select></div>
            <button class="btn btn-primary" onclick="addFriend()" data-i18n="save">ä¿å­˜</button>
            <button class="btn btn-outline" style="margin-top:8px;" onclick="closeModal()" data-i18n="cancel">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
    // ==================== ç‰ˆæœ¬æ§åˆ¶ä¸è‡ªåŠ¨æ›´æ–° ====================
    var APP_VERSION = '4.8.0';
    var APP_BUILD_TIME = '2026-02-19T00:00:00Z';
    var VERSION_CHECK_URL = 'https://raw.githubusercontent.com/ericjbe/water-reminder/main/version.json';
    
    // æ£€æŸ¥æ–°ç‰ˆæœ¬ï¼ˆæ¯æ¬¡æ‰“å¼€æ£€æŸ¥ï¼Œä½†æ¯4å°æ—¶æœ€å¤šä¸€æ¬¡å¼¹çª—æé†’ï¼‰
    async function checkForUpdates(silent) {
        try {
            var lastCheck = parseInt(localStorage.getItem('heshuileLastVersionCheck') || '0');
            if (!silent && Date.now() - lastCheck < 4 * 60 * 60 * 1000) return;
            
            var resp = await fetch(VERSION_CHECK_URL + '?t=' + Date.now(), { cache: 'no-store' });
            if (!resp.ok) return;
            var data = await resp.json();
            
            localStorage.setItem('heshuileLastVersionCheck', String(Date.now()));
            
            if (data.version && data.version !== APP_VERSION && compareVersions(data.version, APP_VERSION) > 0) {
                // æœ‰æ–°ç‰ˆæœ¬
                if (data.force) {
                    // å¼ºåˆ¶æ›´æ–°ï¼šç›´æ¥åˆ·æ–°
                    showUpdateBanner(data.version, data.changelog || 'ä¿®å¤bugï¼Œæå‡ä½“éªŒ', true);
                } else {
                    // å¯é€‰æ›´æ–°ï¼šæ˜¾ç¤ºæé†’
                    showUpdateBanner(data.version, data.changelog || 'æ–°åŠŸèƒ½å·²å°±ç»ª', false);
                }
            }
        } catch(e) {
            // ç½‘ç»œé”™è¯¯é™é»˜å¿½ç•¥
        }
    }
    
    function compareVersions(a, b) {
        var pa = a.split('.').map(Number), pb = b.split('.').map(Number);
        for (var i = 0; i < 3; i++) {
            if ((pa[i]||0) > (pb[i]||0)) return 1;
            if ((pa[i]||0) < (pb[i]||0)) return -1;
        }
        return 0;
    }
    
    function showUpdateBanner(newVer, changelog, force) {
        var existing = document.getElementById('updateBanner');
        if (existing) existing.remove();
        
        var div = document.createElement('div');
        div.id = 'updateBanner';
        div.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:99999;background:linear-gradient(135deg,#FFD700,#ff9800);color:#000;padding:12px 16px;font-size:13px;text-align:center;box-shadow:0 2px 12px rgba(0,0,0,0.3);';
        div.innerHTML = '<div style="font-weight:bold;">ğŸ†• æ–°ç‰ˆæœ¬ v' + newVer + ' å·²å‘å¸ƒ</div>'
            + '<div style="font-size:11px;margin:4px 0;opacity:0.8;">' + changelog + '</div>'
            + '<div style="display:flex;justify-content:center;gap:8px;margin-top:8px;">'
            + '<button onclick="doAppUpdate()" style="padding:6px 20px;border-radius:8px;border:none;background:#000;color:#FFD700;font-weight:bold;font-size:12px;cursor:pointer;">ç«‹å³æ›´æ–°</button>'
            + (force ? '' : '<button onclick="this.parentElement.parentElement.remove()" style="padding:6px 14px;border-radius:8px;border:1px solid rgba(0,0,0,0.3);background:transparent;color:#000;font-size:12px;cursor:pointer;">ç¨å</button>')
            + '</div>';
        document.body.prepend(div);
    }
    
    function doAppUpdate() {
        // æ¸…é™¤Service Workerç¼“å­˜
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(regs) {
                regs.forEach(function(r) { r.unregister(); });
            });
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    names.forEach(function(n) { caches.delete(n); });
                });
            }
        }
        // å¼ºåˆ¶é‡æ–°åŠ è½½
        setTimeout(function() {
            location.reload(true);
        }, 500);
    }
    
    // é¡µé¢åŠ è½½åå»¶è¿Ÿæ£€æŸ¥
    setTimeout(function() { checkForUpdates(false); }, 3000);

    // ==================== PWA å®‰è£…é€»è¾‘ ====================
    let pwaPrompt = null;
    const pwaInfo = {
        isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
        isAndroid: /Android/.test(navigator.userAgent),
        isWechat: /MicroMessenger/.test(navigator.userAgent),
        isStandalone: window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone
    };

    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); pwaPrompt = e; if (!pwaInfo.isStandalone && !localStorage.getItem('pwaDismissed')) setTimeout(showPwaBanner, 5000); });
    window.addEventListener('appinstalled', () => { closePwaBanner(); toast('ğŸ‰ å·²æ·»åŠ åˆ°æ¡Œé¢ï¼'); });

    function showPwaBanner() { if (pwaInfo.isStandalone) return; document.getElementById('pwaBanner').classList.add('show'); }
    function closePwaBanner() { document.getElementById('pwaBanner').classList.remove('show'); localStorage.setItem('pwaDismissed', '1'); }
    function handlePwaInstall() {
        if (pwaInfo.isWechat) { showPwaGuide('wechat'); }
        else if (pwaInfo.isIOS) { showPwaGuide('ios'); }
        else if (pwaPrompt) { pwaPrompt.prompt(); pwaPrompt.userChoice.then(() => { pwaPrompt = null; closePwaBanner(); }); }
        else { showPwaGuide('android'); }
    }
    function showPwaGuide(type) {
        const steps = document.getElementById('pwaSteps');
        const tip = document.getElementById('pwaWechatTip');
        tip.style.display = type === 'wechat' ? 'block' : 'none';
        if (type === 'wechat') steps.innerHTML = '<div class="pwa-guide-step"><div class="pwa-step-num">1</div><div>ç‚¹å‡»å³ä¸Šè§’ <b>Â·Â·Â·</b></div></div><div class="pwa-guide-step"><div class="pwa-step-num">2</div><div>é€‰æ‹©ã€Œåœ¨æµè§ˆå™¨æ‰“å¼€ã€</div></div><div class="pwa-guide-step"><div class="pwa-step-num">3</div><div>å†æ¬¡ç‚¹å‡»ã€Œæ·»åŠ åˆ°æ¡Œé¢ã€</div></div>';
        else if (type === 'ios') steps.innerHTML = '<div class="pwa-guide-step"><div class="pwa-step-num">1</div><div>ç‚¹å‡»åº•éƒ¨ <b>åˆ†äº«æŒ‰é’®</b> â¬†ï¸</div></div><div class="pwa-guide-step"><div class="pwa-step-num">2</div><div>å‘ä¸Šæ»‘åŠ¨ï¼Œæ‰¾åˆ°ã€Œæ·»åŠ åˆ°ä¸»å±å¹•ã€</div></div><div class="pwa-guide-step"><div class="pwa-step-num">3</div><div>ç‚¹å‡»å³ä¸Šè§’ã€Œæ·»åŠ ã€</div></div>';
        else steps.innerHTML = '<div class="pwa-guide-step"><div class="pwa-step-num">1</div><div>ç‚¹å‡»æµè§ˆå™¨ <b>èœå•</b>ï¼ˆâ‹® æˆ– Â·Â·Â·ï¼‰</div></div><div class="pwa-guide-step"><div class="pwa-step-num">2</div><div>æ‰¾åˆ°ã€Œæ·»åŠ åˆ°ä¸»å±å¹•ã€æˆ–ã€Œå®‰è£…ã€</div></div><div class="pwa-guide-step"><div class="pwa-step-num">3</div><div>ç‚¹å‡»ã€Œæ·»åŠ ã€ç¡®è®¤</div></div>';
        document.getElementById('pwaGuide').classList.add('show'); closePwaBanner();
    }
    function closePwaGuide() { document.getElementById('pwaGuide').classList.remove('show'); }
    window.addEventListener('load', () => { if (!pwaInfo.isStandalone && !localStorage.getItem('pwaDismissed')) { if (pwaInfo.isIOS || pwaInfo.isWechat) setTimeout(showPwaBanner, 5000); } });

    // ==================== å¤šè¯­è¨€ç³»ç»Ÿ ====================
    const I18N = {
        zh: {
            appName: 'å–æ°´äº†å—', slogan: 'ã€Œä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰ã€', login: 'ç™»å½•', promo: 'å…±äº«',
            dailyWisdom: 'æ¯æ—¥æ°´è¯­', copy: 'å¤åˆ¶', refresh: 'æ¢ä¸€æ¡', streak: 'è¿ç»­', days: 'å¤©', points: 'ç§¯åˆ†', checkin: 'æ‰“å¡',
            clickToAdd: 'ç‚¹å‡»æ·»åŠ <br>å›¾ç‰‡/è§†é¢‘/æ–‡å­—', tickSound: 'æ»´ç­”å£°', classics: 'ç»å…¸', waterStudy: 'æ°´å­¦', voice: 'è¯­éŸ³', care: 'å…³æ€€', settings: 'è®¾ç½®',
            drinkWater: 'å–æ°´æé†’', drinkNow: 'ç«‹å³å–æ°´', todayWater: 'ä»Šæ—¥é¥®æ°´', waterGoal: 'ç›®æ ‡2000ml',
            upcomingReminders: 'å³å°†åˆ°æ¥çš„æé†’', home: 'é¦–é¡µ', remind: 'æé†’', me: 'æˆ‘çš„',
            reminderManagement: 'æé†’ç®¡ç†', newReminder: 'æ–°å»ºæé†’', soundSettings: 'æ»´ç­”å£°è®¾ç½®', tickSwitch: 'æ»´ç­”å£°å¼€å…³', volume: 'éŸ³é‡', theme: 'ä¸»é¢˜é£æ ¼',
            adManagement: 'å¹¿å‘Šç®¡ç†', adminLogin: 'ç®¡ç†å‘˜ç™»å½•', verify: 'éªŒè¯', adminLogout: 'é€€å‡ºç®¡ç†', addAd: 'æ·»åŠ æ–°å¹¿å‘Š',
            customizeCenter: 'è‡ªå®šä¹‰é’Ÿè¡¨ä¸­å¿ƒ', uploadImage: 'ä¸Šä¼ å›¾ç‰‡', uploadVideo: 'ä¸Šä¼ è§†é¢‘', customText: 'è‡ªå®šä¹‰æ–‡å­—', clickUpload: 'ç‚¹å‡»ä¸Šä¼ ', apply: 'åº”ç”¨', resetDefault: 'æ¢å¤é»˜è®¤',
            smartCare: 'æ™ºèƒ½å…³æ€€', readContacts: 'è¯»å–é€šè®¯å½•', contactsDesc: 'æˆæƒåå¯å¿«é€ŸæŸ¥æ‰¾å¹¶æ·»åŠ è¢«å…³æ€€äººï¼Œè®¾ç½®ç”Ÿæ—¥ã€çºªå¿µæ—¥ç­‰å…³æ€€æé†’ã€‚', authorizeContacts: 'æˆæƒè¯»å–é€šè®¯å½•',
            findCarePerson: 'æŸ¥æ‰¾è¢«å…³æ€€äºº', addedFriends: 'å·²æ·»åŠ çš„å…³æ€€å¯¹è±¡', manualAdd: 'æ‰‹åŠ¨æ·»åŠ ',
            classics: 'ç»å…¸', fiveScriptures: 'äº”ç»', waterCourse: 'æ°´å­¦è¯¾ç¨‹', socraticDialog: 'è‹æ ¼æ‹‰åº•å¼æ°´å­¦å¯¹è¯', promoCenter: 'å…±äº«ä¸­å¿ƒ', myInviteCode: 'æˆ‘çš„é‚€è¯·ç ', copyInviteLink: 'å¤åˆ¶é‚€è¯·é“¾æ¥',
            pointsCenter: 'ç§¯åˆ†ä¸­å¿ƒ', myPoints: 'æˆ‘çš„ç§¯åˆ†', monthlyCheckin: 'æœ¬æœˆæ‰“å¡',
            loginRegister: 'ç™»å½• / æ³¨å†Œ', phone: 'æ‰‹æœºå·', nickname: 'æ˜µç§°', password: 'å¯†ç ', upgradeVip: 'å‡çº§VIP', logout: 'é€€å‡ºç™»å½•',
            title: 'æ ‡é¢˜', type: 'ç±»å‹', date: 'æ—¥æœŸ', time: 'æ—¶é—´', year: 'å¹´', month: 'æœˆ', day: 'æ—¥', hour: 'æ—¶', minute: 'åˆ†', second: 'ç§’',
            repeat: 'é‡å¤', note: 'å¤‡æ³¨', save: 'ä¿å­˜', cancel: 'å–æ¶ˆ', close: 'å…³é—­', add: 'æ·»åŠ ', name: 'å§“å', relation: 'å…³ç³»', adType: 'å¹¿å‘Šç±»å‹',
            sunday: 'æ—¥', monday: 'ä¸€', tuesday: 'äºŒ', wednesday: 'ä¸‰', thursday: 'å››', friday: 'äº”', saturday: 'å…­'
        },
        en: {
            appName: 'DrinkWater', slogan: '"Seize every second"', login: 'Login', promo: 'Promo',
            dailyWisdom: 'Daily Wisdom', copy: 'Copy', refresh: 'Refresh', streak: 'Streak', days: 'days', points: 'Points', checkin: 'Check-in',
            clickToAdd: 'Click to add<br>Image/Video/Text', tickSound: 'Tick Sound', classics: 'Classics', waterStudy: 'Water Study', voice: 'Voice', care: 'Care', settings: 'Settings',
            upcomingReminders: 'Upcoming Reminders', home: 'Home', remind: 'Remind', me: 'Me',
            reminderManagement: 'Reminder Management', newReminder: 'New Reminder', soundSettings: 'Sound Settings', tickSwitch: 'Tick Switch', volume: 'Volume', theme: 'Theme',
            adManagement: 'Ad Management', adminLogin: 'Admin Login', verify: 'Verify', adminLogout: 'Logout Admin', addAd: 'Add New Ad',
            customizeCenter: 'Customize Clock Center', uploadImage: 'Upload Image', uploadVideo: 'Upload Video', customText: 'Custom Text', clickUpload: 'Click to upload', apply: 'Apply', resetDefault: 'Reset',
            smartCare: 'Smart Care', readContacts: 'Read Contacts', contactsDesc: 'After authorization, you can quickly find and add care recipients for birthday and anniversary reminders.', authorizeContacts: 'Authorize Contacts',
            findCarePerson: 'Find Care Recipient', addedFriends: 'Added Care Recipients', manualAdd: 'Manual Add',
            classics: 'Classics', fiveScriptures: 'Five Scriptures', waterCourse: 'Water Course', socraticDialog: 'Socratic Water Dialogue', promoCenter: 'Promo Center', myInviteCode: 'My Invite Code', copyInviteLink: 'Copy Invite Link',
            pointsCenter: 'Points Center', myPoints: 'My Points', monthlyCheckin: 'Monthly Check-in',
            loginRegister: 'Login / Register', phone: 'Phone', nickname: 'Nickname', password: 'Password', upgradeVip: 'Upgrade VIP', logout: 'Logout',
            title: 'Title', type: 'Type', date: 'Date', time: 'Time', year: 'Year', month: 'Month', day: 'Day', hour: 'Hour', minute: 'Min', second: 'Sec',
            repeat: 'Repeat', note: 'Note', save: 'Save', cancel: 'Cancel', close: 'Close', add: 'Add', name: 'Name', relation: 'Relation', adType: 'Ad Type',
            sunday: 'Sun', monday: 'Mon', tuesday: 'Tue', wednesday: 'Wed', thursday: 'Thu', friday: 'Fri', saturday: 'Sat'
        },
        ja: {
            appName: 'æ°´é£²ã‚“ã ï¼Ÿ', slogan: 'ã€Œä¸€ç§’ã‚‚ç„¡é§„ã«ã—ãªã„ã€', login: 'ãƒ­ã‚°ã‚¤ãƒ³', promo: 'ãƒ—ãƒ­ãƒ¢',
            dailyWisdom: 'ä»Šæ—¥ã®è¨€è‘‰', copy: 'ã‚³ãƒ”ãƒ¼', refresh: 'æ›´æ–°', streak: 'é€£ç¶š', days: 'æ—¥', points: 'ãƒã‚¤ãƒ³ãƒˆ', checkin: 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³',
            clickToAdd: 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¿½åŠ <br>ç”»åƒ/å‹•ç”»/ãƒ†ã‚­ã‚¹ãƒˆ', tickSound: 'ãƒã‚¯ã‚¿ã‚¯éŸ³', classics: 'çµŒå…¸', waterStudy: 'æ°´å­¦', voice: 'éŸ³å£°', care: 'ã‚±ã‚¢', settings: 'è¨­å®š',
            upcomingReminders: 'äºˆå®šã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼', home: 'ãƒ›ãƒ¼ãƒ ', remind: 'ãƒªãƒã‚¤ãƒ³ãƒ‰', me: 'ãƒã‚¤ãƒšãƒ¼ã‚¸',
            reminderManagement: 'ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ç®¡ç†', newReminder: 'æ–°è¦ä½œæˆ', soundSettings: 'ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š', tickSwitch: 'ãƒã‚¯ã‚¿ã‚¯éŸ³', volume: 'éŸ³é‡', theme: 'ãƒ†ãƒ¼ãƒ',
            adManagement: 'åºƒå‘Šç®¡ç†', adminLogin: 'ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³', verify: 'ç¢ºèª', adminLogout: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ', addAd: 'åºƒå‘Šè¿½åŠ ',
            customizeCenter: 'æ™‚è¨ˆä¸­å¤®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º', uploadImage: 'ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰', uploadVideo: 'å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰', customText: 'ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚­ã‚¹ãƒˆ', clickUpload: 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰', apply: 'é©ç”¨', resetDefault: 'ãƒªã‚»ãƒƒãƒˆ',
            smartCare: 'ã‚¹ãƒãƒ¼ãƒˆã‚±ã‚¢', readContacts: 'é€£çµ¡å…ˆã‚’èª­ã¿è¾¼ã‚€', contactsDesc: 'è¨±å¯å¾Œã€ã‚±ã‚¢å¯¾è±¡è€…ã‚’ç´ æ—©ãæ¤œç´¢ãƒ»è¿½åŠ ã§ãã¾ã™ã€‚', authorizeContacts: 'é€£çµ¡å…ˆã‚’è¨±å¯',
            findCarePerson: 'ã‚±ã‚¢å¯¾è±¡è€…ã‚’æ¤œç´¢', addedFriends: 'è¿½åŠ æ¸ˆã¿ã®ã‚±ã‚¢å¯¾è±¡è€…', manualAdd: 'æ‰‹å‹•è¿½åŠ ',
            classics: 'çµŒå…¸', fiveScriptures: 'äº”ã¤ã®çµŒå…¸', waterCourse: 'æ°´å­¦ã‚³ãƒ¼ã‚¹', socraticDialog: 'ã‚½ã‚¯ãƒ©ãƒ†ã‚¹å¼æ°´å­¦å¯¾è©±', promoCenter: 'ãƒ—ãƒ­ãƒ¢ã‚»ãƒ³ã‚¿ãƒ¼', myInviteCode: 'æ‹›å¾…ã‚³ãƒ¼ãƒ‰', copyInviteLink: 'æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼',
            pointsCenter: 'ãƒã‚¤ãƒ³ãƒˆã‚»ãƒ³ã‚¿ãƒ¼', myPoints: 'ãƒã‚¤ãƒã‚¤ãƒ³ãƒˆ', monthlyCheckin: 'ä»Šæœˆã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³',
            loginRegister: 'ãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²', phone: 'é›»è©±ç•ªå·', nickname: 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ', password: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰', upgradeVip: 'VIPã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰', logout: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
            title: 'ã‚¿ã‚¤ãƒˆãƒ«', type: 'ã‚¿ã‚¤ãƒ—', date: 'æ—¥ä»˜', time: 'æ™‚é–“', year: 'å¹´', month: 'æœˆ', day: 'æ—¥', hour: 'æ™‚', minute: 'åˆ†', second: 'ç§’',
            repeat: 'ç¹°ã‚Šè¿”ã—', note: 'ãƒ¡ãƒ¢', save: 'ä¿å­˜', cancel: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', close: 'é–‰ã˜ã‚‹', add: 'è¿½åŠ ', name: 'åå‰', relation: 'é–¢ä¿‚', adType: 'åºƒå‘Šã‚¿ã‚¤ãƒ—',
            sunday: 'æ—¥', monday: 'æœˆ', tuesday: 'ç«', wednesday: 'æ°´', thursday: 'æœ¨', friday: 'é‡‘', saturday: 'åœŸ'
        },
        ko: {
            appName: 'ë¬¼ ë§ˆì…¨ì–´?', slogan: 'ã€Œ1ì´ˆë„ ì•„ê¹ë‹¤ã€', login: 'ë¡œê·¸ì¸', promo: 'í”„ë¡œëª¨ì…˜',
            dailyWisdom: 'ì˜¤ëŠ˜ì˜ ëª…ì–¸', copy: 'ë³µì‚¬', refresh: 'ìƒˆë¡œê³ ì¹¨', streak: 'ì—°ì†', days: 'ì¼', points: 'í¬ì¸íŠ¸', checkin: 'ì²´í¬ì¸',
            clickToAdd: 'í´ë¦­í•˜ì—¬ ì¶”ê°€<br>ì´ë¯¸ì§€/ë¹„ë””ì˜¤/í…ìŠ¤íŠ¸', tickSound: 'í‹±í†¡ ì†Œë¦¬', classics: 'ê³ ì „', scriptures: 'ê²½ì „', waterStudy: 'ë¬¼ í•™ìŠµ', voice: 'ìŒì„±', care: 'ì¼€ì–´', settings: 'ì„¤ì •',
            upcomingReminders: 'ì˜ˆì •ëœ ì•Œë¦¼', home: 'í™ˆ', remind: 'ì•Œë¦¼', me: 'ë‚´ ì •ë³´',
            reminderManagement: 'ì•Œë¦¼ ê´€ë¦¬', newReminder: 'ìƒˆ ì•Œë¦¼', soundSettings: 'ì†Œë¦¬ ì„¤ì •', tickSwitch: 'í‹±í†¡ ì†Œë¦¬', volume: 'ë³¼ë¥¨', theme: 'í…Œë§ˆ',
            adManagement: 'ê´‘ê³  ê´€ë¦¬', adminLogin: 'ê´€ë¦¬ì ë¡œê·¸ì¸', verify: 'í™•ì¸', adminLogout: 'ë¡œê·¸ì•„ì›ƒ', addAd: 'ê´‘ê³  ì¶”ê°€',
            customizeCenter: 'ì‹œê³„ ì¤‘ì•™ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ', uploadImage: 'ì´ë¯¸ì§€ ì—…ë¡œë“œ', uploadVideo: 'ë¹„ë””ì˜¤ ì—…ë¡œë“œ', customText: 'ì»¤ìŠ¤í…€ í…ìŠ¤íŠ¸', clickUpload: 'í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ', apply: 'ì ìš©', resetDefault: 'ì´ˆê¸°í™”',
            smartCare: 'ìŠ¤ë§ˆíŠ¸ ì¼€ì–´', readContacts: 'ì—°ë½ì²˜ ì½ê¸°', contactsDesc: 'í—ˆìš© í›„ ì¼€ì–´ ëŒ€ìƒìë¥¼ ë¹ ë¥´ê²Œ ê²€ìƒ‰í•˜ê³  ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', authorizeContacts: 'ì—°ë½ì²˜ í—ˆìš©',
            findCarePerson: 'ì¼€ì–´ ëŒ€ìƒì ì°¾ê¸°', addedFriends: 'ì¶”ê°€ëœ ì¼€ì–´ ëŒ€ìƒì', manualAdd: 'ìˆ˜ë™ ì¶”ê°€',
            classics: 'ê³ ì „', fiveScriptures: 'ë‹¤ì„¯ ê²½ì „', waterCourse: 'ë¬¼ ì½”ìŠ¤', socraticDialog: 'ì†Œí¬ë¼í…ŒìŠ¤ì‹ ë¬¼ ëŒ€í™”', promoCenter: 'í”„ë¡œëª¨ì…˜ ì„¼í„°', myInviteCode: 'ì´ˆëŒ€ ì½”ë“œ', copyInviteLink: 'ì´ˆëŒ€ ë§í¬ ë³µì‚¬',
            pointsCenter: 'í¬ì¸íŠ¸ ì„¼í„°', myPoints: 'ë‚´ í¬ì¸íŠ¸', monthlyCheckin: 'ì´ë²ˆ ë‹¬ ì²´í¬ì¸',
            loginRegister: 'ë¡œê·¸ì¸/ê°€ì…', phone: 'ì „í™”ë²ˆí˜¸', nickname: 'ë‹‰ë„¤ì„', password: 'ë¹„ë°€ë²ˆí˜¸', upgradeVip: 'VIP ì—…ê·¸ë ˆì´ë“œ', logout: 'ë¡œê·¸ì•„ì›ƒ',
            title: 'ì œëª©', type: 'ìœ í˜•', date: 'ë‚ ì§œ', time: 'ì‹œê°„', year: 'ë…„', month: 'ì›”', day: 'ì¼', hour: 'ì‹œ', minute: 'ë¶„', second: 'ì´ˆ',
            repeat: 'ë°˜ë³µ', note: 'ë©”ëª¨', save: 'ì €ì¥', cancel: 'ì·¨ì†Œ', close: 'ë‹«ê¸°', add: 'ì¶”ê°€', name: 'ì´ë¦„', relation: 'ê´€ê³„', adType: 'ê´‘ê³  ìœ í˜•',
            sunday: 'ì¼', monday: 'ì›”', tuesday: 'í™”', wednesday: 'ìˆ˜', thursday: 'ëª©', friday: 'ê¸ˆ', saturday: 'í† '
        },
        es: {
            appName: 'Hidratado', slogan: 'ã€ŒCada segundo cuentaã€', login: 'Entrar', promo: 'Compartir',
            dailyWisdom: 'SabidurÃ­a diaria', copy: 'Copiar', refresh: 'Actualizar', streak: 'Racha', days: 'dÃ­as', points: 'Puntos', checkin: 'Registro',
            clickToAdd: 'Toca para agregar<br>imagen/video/texto', tickSound: 'Tic-tac', classics: 'ClÃ¡sicos', waterStudy: 'Ciencia del agua', voice: 'Voz', care: 'Cuidado', settings: 'Ajustes',
            drinkWater: 'Recordatorio', drinkNow: 'Beber ahora', todayWater: 'Hoy', waterGoal: 'Meta 2000ml',
            upcomingReminders: 'PrÃ³ximos recordatorios', home: 'Inicio', remind: 'Recordar', me: 'Mi perfil',
            reminderManagement: 'GestiÃ³n', newReminder: 'Nuevo recordatorio', soundSettings: 'Sonido Tic-tac', tickSwitch: 'Activar tic-tac', volume: 'Volumen', theme: 'Tema',
            adManagement: 'GestiÃ³n de anuncios', adminLogin: 'Admin', verify: 'Verificar', adminLogout: 'Cerrar admin', addAd: 'Agregar anuncio',
            customizeCenter: 'Personalizar reloj', uploadImage: 'Subir imagen', uploadVideo: 'Subir video', customText: 'Texto', clickUpload: 'Subir', apply: 'Aplicar', resetDefault: 'Restablecer',
            smartCare: 'Cuidado inteligente', readContacts: 'Leer contactos', contactsDesc: 'Autorizar contactos para recordatorios de cumpleaÃ±os y salud.', authorizeContacts: 'Autorizar contactos',
            findCarePerson: 'Buscar persona', addedFriends: 'Personas agregadas', manualAdd: 'Agregar manual',
            fiveScriptures: 'Cinco Escrituras', waterCourse: 'Curso de Agua', socraticDialog: 'DiÃ¡logo SocrÃ¡tico', promoCenter: 'Centro de PromociÃ³n', myInviteCode: 'Mi cÃ³digo', copyInviteLink: 'Copiar enlace',
            pointsCenter: 'Centro de Puntos', myPoints: 'Mis Puntos', monthlyCheckin: 'Registro mensual',
            loginRegister: 'Entrar / Registrar', phone: 'TelÃ©fono', nickname: 'Apodo', password: 'ContraseÃ±a', upgradeVip: 'Mejorar VIP', logout: 'Salir',
            title: 'TÃ­tulo', type: 'Tipo', date: 'Fecha', time: 'Hora', year: 'AÃ±o', month: 'Mes', day: 'DÃ­a', hour: 'Hora', minute: 'Min', second: 'Seg',
            repeat: 'Repetir', note: 'Nota', save: 'Guardar', cancel: 'Cancelar', close: 'Cerrar', add: 'Agregar', name: 'Nombre', relation: 'RelaciÃ³n', adType: 'Tipo de anuncio',
            sunday: 'Do', monday: 'Lu', tuesday: 'Ma', wednesday: 'Mi', thursday: 'Ju', friday: 'Vi', saturday: 'SÃ¡'
        },
        ar: {
            appName: 'Ù‡Ù„ Ø´Ø±Ø¨Øª Ø§Ù„Ù…Ø§Ø¡', slogan: 'ã€ŒÙƒÙ„ Ø«Ø§Ù†ÙŠØ© ØªÙ‡Ù…ã€', login: 'Ø¯Ø®ÙˆÙ„', promo: 'Ù…Ø´Ø§Ø±ÙƒØ©',
            dailyWisdom: 'Ø­ÙƒÙ…Ø© Ø§Ù„ÙŠÙˆÙ…', copy: 'Ù†Ø³Ø®', refresh: 'ØªØ­Ø¯ÙŠØ«', streak: 'Ù…ØªØªØ§Ù„ÙŠ', days: 'Ø£ÙŠØ§Ù…', points: 'Ù†Ù‚Ø§Ø·', checkin: 'ØªØ³Ø¬ÙŠÙ„',
            clickToAdd: 'Ø§Ø¶ØºØ· Ù„Ø¥Ø¶Ø§ÙØ©<br>ØµÙˆØ±Ø©/ÙÙŠØ¯ÙŠÙˆ/Ù†Øµ', tickSound: 'ØµÙˆØª Ø§Ù„Ø³Ø§Ø¹Ø©', classics: 'ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ§Øª', waterStudy: 'Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¡', voice: 'ØµÙˆØª', care: 'Ø±Ø¹Ø§ÙŠØ©', settings: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
            drinkWater: 'ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ù…Ø§Ø¡', drinkNow: 'Ø§Ø´Ø±Ø¨ Ø§Ù„Ø¢Ù†', todayWater: 'Ø§Ù„ÙŠÙˆÙ…', waterGoal: 'Ø§Ù„Ù‡Ø¯Ù 2000Ù…Ù„',
            upcomingReminders: 'Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©', home: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', remind: 'ØªØ°ÙƒÙŠØ±', me: 'Ø­Ø³Ø§Ø¨ÙŠ',
            reminderManagement: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª', newReminder: 'ØªØ°ÙƒÙŠØ± Ø¬Ø¯ÙŠØ¯', soundSettings: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª', tickSwitch: 'ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª', volume: 'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª', theme: 'Ø§Ù„Ù…Ø¸Ù‡Ø±',
            adManagement: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª', adminLogin: 'Ù…Ø¯ÙŠØ±', verify: 'ØªØ­Ù‚Ù‚', adminLogout: 'Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø¯ÙŠØ±', addAd: 'Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù†',
            customizeCenter: 'ØªØ®ØµÙŠØµ Ø§Ù„Ø³Ø§Ø¹Ø©', uploadImage: 'Ø±ÙØ¹ ØµÙˆØ±Ø©', uploadVideo: 'Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ', customText: 'Ù†Øµ Ù…Ø®ØµØµ', clickUpload: 'Ø±ÙØ¹', apply: 'ØªØ·Ø¨ÙŠÙ‚', resetDefault: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
            smartCare: 'Ø±Ø¹Ø§ÙŠØ© Ø°ÙƒÙŠØ©', readContacts: 'Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„', contactsDesc: 'Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø£Ø¹ÙŠØ§Ø¯ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ ÙˆØ§Ù„ØµØ­Ø©.', authorizeContacts: 'Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„',
            findCarePerson: 'Ø¨Ø­Ø«', addedFriends: 'Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ù…Ø¶Ø§ÙÙˆÙ†', manualAdd: 'Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ©',
            fiveScriptures: 'Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ø®Ù…Ø³Ø©', waterCourse: 'Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø§Ø¡', socraticDialog: 'Ø­ÙˆØ§Ø± Ø³Ù‚Ø±Ø§Ø·ÙŠ', promoCenter: 'Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©', myInviteCode: 'Ø±Ù…Ø² Ø§Ù„Ø¯Ø¹ÙˆØ©', copyInviteLink: 'Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·',
            pointsCenter: 'Ù…Ø±ÙƒØ² Ø§Ù„Ù†Ù‚Ø§Ø·', myPoints: 'Ù†Ù‚Ø§Ø·ÙŠ', monthlyCheckin: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø±',
            loginRegister: 'Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„', phone: 'Ù‡Ø§ØªÙ', nickname: 'Ø§Ø³Ù…', password: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', upgradeVip: 'ØªØ±Ù‚ÙŠØ© VIP', logout: 'Ø®Ø±ÙˆØ¬',
            title: 'Ø¹Ù†ÙˆØ§Ù†', type: 'Ù†ÙˆØ¹', date: 'ØªØ§Ø±ÙŠØ®', time: 'ÙˆÙ‚Øª', year: 'Ø³Ù†Ø©', month: 'Ø´Ù‡Ø±', day: 'ÙŠÙˆÙ…', hour: 'Ø³Ø§Ø¹Ø©', minute: 'Ø¯Ù‚ÙŠÙ‚Ø©', second: 'Ø«Ø§Ù†ÙŠØ©',
            repeat: 'ØªÙƒØ±Ø§Ø±', note: 'Ù…Ù„Ø§Ø­Ø¸Ø©', save: 'Ø­ÙØ¸', cancel: 'Ø¥Ù„ØºØ§Ø¡', close: 'Ø¥ØºÙ„Ø§Ù‚', add: 'Ø¥Ø¶Ø§ÙØ©', name: 'Ø§Ø³Ù…', relation: 'Ø¹Ù„Ø§Ù‚Ø©', adType: 'Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†',
            sunday: 'Ø£Ø­Ø¯', monday: 'Ø§Ø«Ù†ÙŠÙ†', tuesday: 'Ø«Ù„Ø§Ø«Ø§Ø¡', wednesday: 'Ø£Ø±Ø¨Ø¹Ø§Ø¡', thursday: 'Ø®Ù…ÙŠØ³', friday: 'Ø¬Ù…Ø¹Ø©', saturday: 'Ø³Ø¨Øª'
        },
        he: {
            appName: '×©×ª×™×ª ××™×', slogan: 'ã€Œ×›×œ ×©× ×™×™×” ×—×©×•×‘×”ã€', login: '×›× ×™×¡×”', promo: '×©×™×ª×•×£',
            dailyWisdom: '×—×•×›××ª ×”×™×•×', copy: '×”×¢×ª×§', refresh: '×¨×¢× ×Ÿ', streak: '×¨×¦×£', days: '×™××™×', points: '× ×§×•×“×•×ª', checkin: '×¦×§-××™×Ÿ',
            clickToAdd: '×œ×—×¥ ×œ×”×•×¡×¤×ª<br>×ª××•× ×”/×•×™×“××•/×˜×§×¡×˜', tickSound: '×¦×œ×™×œ ×©×¢×•×Ÿ', classics: '×§×œ××¡×™×§×”', waterStudy: '××“×¢ ×”××™×', voice: '×§×•×œ', care: '×˜×™×¤×•×œ', settings: '×”×’×“×¨×•×ª',
            drinkWater: '×ª×–×›×•×¨×ª ×©×ª×™×™×”', drinkNow: '×©×ª×” ×¢×›×©×™×•', todayWater: '×”×™×•×', waterGoal: '×™×¢×“ 2000××œ',
            upcomingReminders: '×ª×–×›×•×¨×•×ª ×§×¨×•×‘×•×ª', home: '×‘×™×ª', remind: '×ª×–×›×•×¨×ª', me: '×©×œ×™',
            reminderManagement: '× ×™×”×•×œ ×ª×–×›×•×¨×•×ª', newReminder: '×ª×–×›×•×¨×ª ×—×“×©×”', soundSettings: '×”×’×“×¨×•×ª ×¦×œ×™×œ', tickSwitch: '×”×¤×¢×œ ×¦×œ×™×œ', volume: '×¢×•×¦××”', theme: '×¢×¨×›×ª × ×•×©×',
            adManagement: '× ×™×”×•×œ ×¤×¨×¡×•×', adminLogin: '×× ×”×œ', verify: '××™××•×ª', adminLogout: '×™×¦×™××ª ×× ×”×œ', addAd: '×”×•×¡×£ ×¤×¨×¡×•×',
            customizeCenter: '×”×ª×× ×©×¢×•×Ÿ', uploadImage: '×”×¢×œ×” ×ª××•× ×”', uploadVideo: '×”×¢×œ×” ×•×™×“××•', customText: '×˜×§×¡×˜', clickUpload: '×”×¢×œ×”', apply: '×”×—×œ', resetDefault: '××™×¤×•×¡',
            smartCare: '×˜×™×¤×•×œ ×—×›×', readContacts: '×§×¨× ×× ×©×™ ×§×©×¨', contactsDesc: '××©×¨ ×’×™×©×” ×œ×ª×–×›×•×¨×•×ª ×™×•× ×”×•×œ×“×ª ×•×‘×¨×™××•×ª.', authorizeContacts: '××©×¨ ×’×™×©×”',
            findCarePerson: '×—×¤×©', addedFriends: '×× ×©×™× ×©× ×•×¡×¤×•', manualAdd: '×”×•×¡×¤×” ×™×“× ×™×ª',
            fiveScriptures: '×—××©×ª ×”×›×ª×‘×™×', waterCourse: '×§×•×¨×¡ ××™×', socraticDialog: '×“×™××œ×•×’ ×¡×•×§×¨×˜×™', promoCenter: '××¨×›×– ×©×™×ª×•×£', myInviteCode: '×§×•×“ ×”×–×× ×”', copyInviteLink: '×”×¢×ª×§ ×§×™×©×•×¨',
            pointsCenter: '××¨×›×– × ×§×•×“×•×ª', myPoints: '×”× ×§×•×“×•×ª ×©×œ×™', monthlyCheckin: '×¦×§-××™×Ÿ ×—×•×“×©×™',
            loginRegister: '×›× ×™×¡×” / ×”×¨×©××”', phone: '×˜×œ×¤×•×Ÿ', nickname: '×›×™× ×•×™', password: '×¡×™×¡××”', upgradeVip: '×©×“×¨×•×’ VIP', logout: '×™×¦×™××”',
            title: '×›×•×ª×¨×ª', type: '×¡×•×’', date: '×ª××¨×™×š', time: '×©×¢×”', year: '×©× ×”', month: '×—×•×“×©', day: '×™×•×', hour: '×©×¢×”', minute: '×“×§×”', second: '×©× ×™×™×”',
            repeat: '×—×–×¨×”', note: '×”×¢×¨×”', save: '×©××•×¨', cancel: '×‘×™×˜×•×œ', close: '×¡×’×•×¨', add: '×”×•×¡×£', name: '×©×', relation: '×§×©×¨', adType: '×¡×•×’ ×¤×¨×¡×•×',
            sunday: '××³', monday: '×‘×³', tuesday: '×’×³', wednesday: '×“×³', thursday: '×”×³', friday: '×•×³', saturday: '×©×³'
        }
    };

    let currentLang = 'zh';

    function changeLang(lang) {
        document.body.dir = (lang === 'ar' || lang === 'he') ? 'rtl' : 'ltr';
        currentLang = lang;
        localStorage.setItem('heshuileLang', lang);
        applyI18n();
        updateClock();
        renderAll();
    }

    function applyI18n() {
        const t = I18N[currentLang] || I18N.zh;
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (t[key]) el.innerHTML = t[key];
        });
        // åŠ¨æ€æ–‡æœ¬å…¨è¦†ç›–
        const sloganMap = {zh:'ã€Œä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰ã€',en:'"Seize every moment"',ja:'ã€Œä¸€ç§’ã‚‚ç„¡é§„ã«ã—ãªã„ã€',ko:'ã€Œë§¤ ìˆœê°„ì„ ì¡ì•„ë¼ã€',es:'"Cada segundo cuenta"',ar:'ã€ŒÙƒÙ„ Ø«Ø§Ù†ÙŠØ© ØªÙ‡Ù…ã€',he:'ã€Œ×›×œ ×©× ×™×™×” ×—×©×•×‘×”ã€'};
        const slogan = document.querySelector('.slogan,[data-i18n="slogan"]');
        if (slogan) slogan.textContent = sloganMap[currentLang] || sloganMap.zh;
        // åº•éƒ¨å¯¼èˆª
        const navLabels = {zh:['é¦–é¡µ','æé†’','æˆ‘çš„'],en:['Home','Remind','Me'],ja:['ãƒ›ãƒ¼ãƒ ','é€šçŸ¥','ãƒã‚¤'],ko:['í™ˆ','ì•Œë¦¼','ë‚´ì •ë³´'],es:['Inicio','Recordar','Perfil'],ar:['Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©','ØªØ°ÙƒÙŠØ±','Ø­Ø³Ø§Ø¨ÙŠ'],he:['×‘×™×ª','×ª×–×›×•×¨×ª','×©×œ×™']};
        const navEls = document.querySelectorAll('.nav-bar .nav-item span:last-child');
        const nl = navLabels[currentLang] || navLabels.zh;
        navEls.forEach((el,i) => { if(nl[i]) el.textContent = nl[i]; });
        // é¢æ¿æ ‡é¢˜
        const panelTitles = {
            zh:{remind:'â° æé†’ç®¡ç†',sound:'ğŸ”Š æ»´ç­”å£°è®¾ç½®',theme:'ğŸ¨ ä¸»é¢˜é£æ ¼',ad:'ğŸ“¢ å¹¿å‘Šç®¡ç†',custom:'ğŸ¯ è‡ªå®šä¹‰é’Ÿè¡¨ä¸­å¿ƒ',care:'ğŸ’ æ™ºèƒ½å…³æ€€',classics:'ğŸ“œ ç»å…¸ / äº”ç»',water:'ğŸŒŠ æ°´å­¦ç ”ç©¶é™¢',promo:'ğŸ§§ å…±äº«ä¸­å¿ƒ',points:'ğŸ† ç§¯åˆ†ä¸­å¿ƒ',user:'ğŸ‘¤ ç”¨æˆ·ä¸­å¿ƒ',fest:'ğŸ® æ˜¥èŠ‚ç¥ç¦é¦†'},
            en:{remind:'â° Reminders',sound:'ğŸ”Š Tick Sound',theme:'ğŸ¨ Theme',ad:'ğŸ“¢ Ad Manager',custom:'ğŸ¯ Clock Center',care:'ğŸ’ Smart Care',classics:'ğŸ“œ Classics',water:'ğŸŒŠ Water Academy',promo:'ğŸ§§ Promotion',points:'ğŸ† Points',user:'ğŸ‘¤ Profile',fest:'ğŸ® Festival Greetings'},
            ja:{remind:'â° é€šçŸ¥ç®¡ç†',sound:'ğŸ”Š ãƒã‚¯ã‚¿ã‚¯è¨­å®š',theme:'ğŸ¨ ãƒ†ãƒ¼ãƒ',ad:'ğŸ“¢ åºƒå‘Šç®¡ç†',custom:'ğŸ¯ æ™‚è¨ˆã‚«ã‚¹ã‚¿ãƒ ',care:'ğŸ’ ã‚¹ãƒãƒ¼ãƒˆã‚±ã‚¢',classics:'ğŸ“œ çµŒå…¸',water:'ğŸŒŠ æ°´å­¦é™¢',promo:'ğŸ§§ ãƒ—ãƒ­ãƒ¢',points:'ğŸ† ãƒã‚¤ãƒ³ãƒˆ',user:'ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼',fest:'ğŸ® ãŠæ­£æœˆ'},
            ko:{remind:'â° ì•Œë¦¼ ê´€ë¦¬',sound:'ğŸ”Š í‹±í†¡ ì„¤ì •',theme:'ğŸ¨ í…Œë§ˆ',ad:'ğŸ“¢ ê´‘ê³  ê´€ë¦¬',custom:'ğŸ¯ ì‹œê³„ ì»¤ìŠ¤í…€',care:'ğŸ’ ìŠ¤ë§ˆíŠ¸ ì¼€ì–´',classics:'ğŸ“œ ê³ ì „',water:'ğŸŒŠ ë¬¼ í•™ì›',promo:'ğŸ§§ í”„ë¡œëª¨ì…˜',points:'ğŸ† í¬ì¸íŠ¸',user:'ğŸ‘¤ í”„ë¡œí•„',fest:'ğŸ® ìƒˆí•´ ì¶•í•˜'},
            es:{remind:'â° Recordatorios',sound:'ğŸ”Š Tic-tac',theme:'ğŸ¨ Tema',ad:'ğŸ“¢ Anuncios',custom:'ğŸ¯ Personalizar',care:'ğŸ’ Cuidado',classics:'ğŸ“œ ClÃ¡sicos',water:'ğŸŒŠ Academia',promo:'ğŸ§§ PromociÃ³n',points:'ğŸ† Puntos',user:'ğŸ‘¤ Perfil',fest:'ğŸ® Festivales'},
            ar:{remind:'â° Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª',sound:'ğŸ”Š ØµÙˆØª Ø§Ù„Ø³Ø§Ø¹Ø©',theme:'ğŸ¨ Ø§Ù„Ù…Ø¸Ù‡Ø±',ad:'ğŸ“¢ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª',custom:'ğŸ¯ ØªØ®ØµÙŠØµ',care:'ğŸ’ Ø±Ø¹Ø§ÙŠØ©',classics:'ğŸ“œ ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ§Øª',water:'ğŸŒŠ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©',promo:'ğŸ§§ Ù…Ø´Ø§Ø±ÙƒØ©',points:'ğŸ† Ù†Ù‚Ø§Ø·',user:'ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ',fest:'ğŸ® ØªÙ‡Ù†Ø¦Ø§Øª'},
            he:{remind:'â° ×ª×–×›×•×¨×•×ª',sound:'ğŸ”Š ×¦×œ×™×œ ×©×¢×•×Ÿ',theme:'ğŸ¨ ×¢×¨×›×ª × ×•×©×',ad:'ğŸ“¢ ×¤×¨×¡×•×',custom:'ğŸ¯ ×”×ª×××”',care:'ğŸ’ ×˜×™×¤×•×œ',classics:'ğŸ“œ ×§×œ××¡×™×§×”',water:'ğŸŒŠ ××§×“××™×”',promo:'ğŸ§§ ×©×™×ª×•×£',points:'ğŸ† × ×§×•×“×•×ª',user:'ğŸ‘¤ ×¤×¨×•×¤×™×œ',fest:'ğŸ® ×‘×¨×›×•×ª'}
        };
        const pt = panelTitles[currentLang] || panelTitles.zh;
        var ptMap = {'remindPanel':'remind','soundPanel':'sound','themePanel':'theme','adPanel':'ad','customPanel':'custom','carePanel':'care','classicsPanel':'classics','waterPanel':'water','promoPanel':'promo','pointsPanel':'points','userPanel':'user','festivalPanel':'fest'};
        Object.keys(ptMap).forEach(function(panelId){
            var panel = document.getElementById(panelId);
            if (panel) {
                var titleEl = panel.querySelector('.panel-title');
                if (titleEl && pt[ptMap[panelId]]) titleEl.textContent = pt[ptMap[panelId]];
            }
        });
        // æŒ‰é’®æ–‡æœ¬
        var drinkBtn = document.querySelector('[onclick*="drinkWater"],.drink-btn');
        if (drinkBtn) drinkBtn.textContent = t.drinkNow || 'ç«‹å³å–æ°´';
        // é¡µé¢æ ‡é¢˜
        var titleSuffix = {zh:'åˆ†ç§’å¿…äº‰',en:'Seize every second',ja:'ä¸€ç§’ã‚‚ç„¡é§„ã«ã—ãªã„',ko:'ë§¤ ìˆœê°„ì„ ì¡ì•„ë¼',es:'Cada segundo cuenta',ar:'ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© ØªÙ‡Ù…',he:'×›×œ ×©× ×™×™×” ×—×©×•×‘×”'};
        document.title = t.appName + ' | ' + (titleSuffix[currentLang] || titleSuffix.zh);
    }

    // ==================== ç®¡ç†å‘˜ç³»ç»Ÿ ====================
    const ADMIN_PASSWORD = 'Fndlogo8888';
    let isAdminLoggedIn = false;

    function adminLogin() {
        const pwd = document.getElementById('adminPwd').value;
        if (pwd === ADMIN_PASSWORD) {
            isAdminLoggedIn = true;
            document.getElementById('adminLoginBox').style.display = 'none';
            document.getElementById('adminAdContent').style.display = 'block';
            renderAdList();
            toast('âœ… ç®¡ç†å‘˜éªŒè¯æˆåŠŸ');
            setTimeout(function(){showOrdersPanel();showAutoSendPanel();showActivityLog();showStatsPanel();},200);
        } else {
            toast('âŒ å¯†ç é”™è¯¯');
        }
    }

    function adminLogout() {
        isAdminLoggedIn = false;
        document.getElementById('adminLoginBox').style.display = 'block';
        document.getElementById('adminAdContent').style.display = 'none';
        document.getElementById('adminPwd').value = '';
        toast('å·²é€€å‡ºç®¡ç†');
    }

    // ==================== æ•°æ®å’ŒçŠ¶æ€ ====================
    const SOUNDS = [
        { id: 'classic', name: 'ğŸ• ç»å…¸é’Ÿå£°', freq: 1000 },
        { id: 'soft', name: 'ğŸ’§ è½»æŸ”æ°´æ»´', freq: 800 },
        { id: 'wood', name: 'ğŸªµ æœ¨é±¼æ•²å‡»', freq: 400 },
        { id: 'bell', name: 'ğŸ”” é£é“ƒæ‘‡æ›³', freq: 1200 }
    ];

    const THEMES = {
        classic: { primary: '#00d4ff', bg1: '#0a192f', bg2: '#112240' },
        luxury: { primary: '#ffd700', bg1: '#1a1a0a', bg2: '#2d2a10' },
        nature: { primary: '#06ffa5', bg1: '#0a1f1a', bg2: '#102f25' },
        romantic: { primary: '#ff6b9d', bg1: '#1f0a1a', bg2: '#2f1025' }
    };

    const QUOTES = {
        zh: [{ text: 'åˆ«å°çœ‹å¹³æ·¡ï¼Œå¹³æ·¡æ‰æ˜¯å¤§å¤šæ•°ç”Ÿå‘½çš„çœŸç›¸ã€‚', source: 'æ°´è‹¥å–„' }, { text: 'ä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰ã€‚', source: 'æé†’' }, { text: 'ä¸Šå–„è‹¥æ°´ï¼Œæ°´å–„åˆ©ä¸‡ç‰©è€Œä¸äº‰ã€‚', source: 'é“å¾·ç»Â·ç¬¬å…«ç« ' }, { text: 'æ°´èƒ½è½½èˆŸï¼Œäº¦èƒ½è¦†èˆŸã€‚', source: 'è€å­Â·ç‹åˆ¶' }, { text: 'é©¬å¹´å¤§å‰ï¼é©¬åˆ°æˆåŠŸï¼Œæ„¿ä½ å¦‚æ°´èˆ¬æŸ”éŸ§ï¼Œæ–°çš„ä¸€å¹´å¥åº·å¸¸åœ¨ã€‚', source: 'æ°´è‹¥å–„Â·æ–°å¹´å¯„è¯­' }, { text: 'é¥®æ°´æ€æºï¼Œä¸€æ¯å¥½æ°´èƒœè‰¯è¯ã€‚æ¯å¤©å…«æ¯ï¼Œä»ç°åœ¨å¼€å§‹ã€‚', source: 'æ°´å¥åº·' }, { text: 'æ°´æ˜¯ç”Ÿå‘½ä¹‹æºï¼Œçæƒœæ¯ä¸€æ»´æ°´ï¼Œå¦‚åŒçæƒœæ¯ä¸€ç§’é’Ÿã€‚', source: 'æ°´ç§‘å­¦' }],
        en: [{ text: "Don't underestimate simplicity, it's the truth of most lives.", source: 'Shui Ruoshan' }, { text: 'Seize every second.', source: 'Reminder' }, { text: 'The highest good is like water.', source: 'Tao Te Ching' }, { text: 'Water is the driving force of all nature.', source: 'Leonardo da Vinci' }, { text: 'Year of the Horse! Stay hydrated, stay healthy.', source: 'New Year Wishes' }, { text: 'Eight glasses a day keeps the doctor away.', source: 'Water Health' }, { text: 'Water is life. Cherish every drop, cherish every second.', source: 'Water Science' }],
        ja: [{ text: 'å¹³å‡¡ã‚’è»½ã‚“ã˜ã‚‹ãªã€ãã‚ŒãŒäººç”Ÿã®çœŸå®Ÿã€‚', source: 'æ°´è‹¥å–„' }, { text: 'ä¸€ç§’ã‚‚ç„¡é§„ã«ã—ãªã„ã€‚', source: 'ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼' }, { text: 'ä¸Šå–„ã¯æ°´ã®å¦‚ã—ã€‚', source: 'é“å¾³çµŒ' }, { text: 'æ°´ã¯ä¸‡ç‰©ã‚’åˆ©ã—ã¦äº‰ã‚ãšã€‚', source: 'è€å­' }, { text: 'åˆå¹´ãŠã‚ã§ã¨ã†ï¼æ°´ã®ã‚ˆã†ã«æŸ”è»Ÿãªä¸€å¹´ã‚’ã€‚', source: 'æ–°å¹´ã®æŒ¨æ‹¶' }, { text: 'ä¸€æ—¥å…«æ¯ã®æ°´ã§å¥åº·ã‚’å®ˆã‚ã†ã€‚', source: 'æ°´ã®å¥åº·' }, { text: 'æ°´ã¯å‘½ã®æºã€ä¸€æ»´ã‚’å¤§åˆ‡ã«ã€‚', source: 'æ°´ç§‘å­¦' }],
        ko: [{ text: 'í‰ë²”í•¨ì„ ì–•ë³´ì§€ ë§ˆë¼, ê·¸ê²ƒì´ ì‚¶ì˜ ì§„ì‹¤ì´ë‹¤.', source: 'ìˆ˜ì•½ì„ ' }, { text: '1ì´ˆë„ ì•„ê¹ë‹¤.', source: 'ì•Œë¦¼' }, { text: 'ìµœìƒì˜ ì„ ì€ ë¬¼ê³¼ ê°™ë‹¤.', source: 'ë„ë•ê²½' }, { text: 'ë¬¼ì€ ë§Œë¬¼ì„ ì´ë¡­ê²Œ í•˜ë˜ ë‹¤íˆ¬ì§€ ì•ŠëŠ”ë‹¤.', source: 'ë…¸ì' }, { text: 'ë§ë  í•´ ë³µ ë§ì´ ë°›ìœ¼ì„¸ìš”! ë¬¼ì²˜ëŸ¼ ìœ ì—°í•œ í•œ í•´ë¥¼.', source: 'ìƒˆí•´ ì¸ì‚¬' }, { text: 'í•˜ë£¨ ì—¬ëŸ ì”ìœ¼ë¡œ ê±´ê°•ì„ ì§€í‚¤ì„¸ìš”.', source: 'ë¬¼ ê±´ê°•' }, { text: 'ë¬¼ì€ ìƒëª…ì˜ ê·¼ì›, í•œ ë°©ìš¸ì„ ì†Œì¤‘íˆ.', source: 'ë¬¼ ê³¼í•™' }],
        es: [{ text: 'No subestimes lo simple, es la verdad de la vida.', source: 'Shui Ruoshan' }, { text: 'Cada segundo cuenta.', source: 'Recordatorio' }, { text: 'El agua beneficia a todos sin competir.', source: 'Tao Te Ching' }, { text: 'Â¡Feliz AÃ±o del Caballo! Salud como el agua.', source: 'AÃ±o Nuevo' }, { text: 'Ocho vasos al dÃ­a mantienen al mÃ©dico lejos.', source: 'Salud del Agua' }],
        ar: [{ text: 'Ù„Ø§ ØªØ³ØªÙ‡Ù† Ø¨Ø§Ù„Ø¨Ø³Ø§Ø·Ø©ØŒ ÙÙ‡ÙŠ Ø­Ù‚ÙŠÙ‚Ø© Ø§Ù„Ø­ÙŠØ§Ø©.', source: 'Ø´ÙˆÙŠ Ø±ÙˆØ´Ø§Ù†' }, { text: 'ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© ØªÙ‡Ù….', source: 'ØªØ°ÙƒÙŠØ±' }, { text: 'Ø§Ù„Ù…Ø§Ø¡ ÙŠÙ†ÙØ¹ ÙƒÙ„ Ø´ÙŠØ¡ ÙˆÙ„Ø§ ÙŠÙ†Ø§ÙØ³.', source: 'Ø·Ø§Ùˆ ØªÙŠ ØªØ´ÙŠÙ†Øº' }, { text: 'Ø¹Ø§Ù… Ø§Ù„Ø­ØµØ§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ! Ø§Ù„ØµØ­Ø© ÙƒØ§Ù„Ù…Ø§Ø¡.', source: 'Ø¹Ø§Ù… Ø¬Ø¯ÙŠØ¯' }, { text: 'Ø«Ù…Ø§Ù†ÙŠØ© Ø£ÙƒÙˆØ§Ø¨ ÙŠÙˆÙ…ÙŠØ§Ù‹ Ù„Ù„ØµØ­Ø©.', source: 'ØµØ­Ø© Ø§Ù„Ù…Ø§Ø¡' }],
        he: [{ text: '××œ ×ª×–×œ×–×œ ×‘×¤×©×˜×•×ª, ×”×™× ×××ª ×”×—×™×™×.', source: '×©×•×™ ×¨×•×©××Ÿ' }, { text: '×›×œ ×©× ×™×™×” ×—×©×•×‘×”.', source: '×ª×–×›×•×¨×ª' }, { text: '×”××™× ××•×¢×™×œ×™× ×œ×›×œ ×•××™× × ××ª×—×¨×™×.', source: '×˜××• ×˜×” ×¦×³×™× ×’' }, { text: '×©× ×ª ×”×¡×•×¡! ×‘×¨×™××•×ª ×›××• ××™×.', source: '×©× ×” ×—×“×©×”' }, { text: '×©××•× ×” ×›×•×¡×•×ª ×‘×™×•× ×œ×‘×¨×™××•×ª.', source: '×‘×¨×™××•×ª ×”××™×' }]
    };

    const books = [
        { name: { zh: 'é“å¾·ç»', en: 'Tao Te Ching', ja: 'é“å¾³çµŒ', ko: 'ë„ë•ê²½' }, icon: 'â˜¯ï¸', text: { zh: 'é“å¯é“ï¼Œéå¸¸é“ã€‚', en: 'The Tao that can be told is not the eternal Tao.', ja: 'é“ã®é“ã¨ã™ã¹ãã¯å¸¸ã®é“ã«éãšã€‚', ko: 'ë„ê°€ë„ë¹„ìƒë„' }},
        { name: { zh: 'å¿ƒç»', en: 'Heart Sutra', ja: 'èˆ¬è‹¥å¿ƒçµŒ', ko: 'ë°˜ì•¼ì‹¬ê²½' }, icon: 'ğŸ™', text: { zh: 'è§‚è‡ªåœ¨è©è¨', en: 'Avalokitesvara Bodhisattva', ja: 'è¦³è‡ªåœ¨è©è–©', ko: 'ê´€ìì¬ë³´ì‚´' }},
        { name: { zh: 'æ˜“ç»', en: 'I Ching', ja: 'æ˜“çµŒ', ko: 'ì£¼ì—­' }, icon: 'â˜°', text: { zh: 'å¤©è¡Œå¥ï¼Œå›å­ä»¥è‡ªå¼ºä¸æ¯ã€‚', en: 'Heaven moves with vigor.', ja: 'å¤©è¡Œå¥ãªã‚Šã€‚', ko: 'ì²œí–‰ê±´' }},
        { name: { zh: 'å¤å…°ç»', en: 'Quran', ja: 'ã‚³ãƒ¼ãƒ©ãƒ³', ko: 'ì½”ë€' }, icon: 'â˜ªï¸', text: { zh: 'å¥‰è‡³ä»è‡³æ…ˆçš„çœŸä¸»ä¹‹åã€‚', en: 'In the name of Allah.', ja: 'ã‚¢ãƒƒãƒ©ãƒ¼ã®å¾¡åã«ãŠã„ã¦ã€‚', ko: 'ì•Œë¼ì˜ ì´ë¦„ìœ¼ë¡œ' }},
        { name: { zh: 'åœ£ç»', en: 'Bible', ja: 'è–æ›¸', ko: 'ì„±ê²½' }, icon: 'âœï¸', text: { zh: 'èµ·åˆï¼Œç¥åˆ›é€ å¤©åœ°ã€‚', en: 'In the beginning God created the heavens and the earth.', ja: 'åˆã‚ã«ç¥ã¯å¤©ã¨åœ°ã‚’å‰µé€ ã•ã‚ŒãŸã€‚', ko: 'íƒœì´ˆì— í•˜ë‚˜ë‹˜ì´ ì²œì§€ë¥¼ ì°½ì¡°í•˜ì‹œë‹ˆë¼' }}
    ];

    let tickOn = true, user = null, audioCtx = null;
    let currentTheme = 'classic', currentSound = 'classic', volume = 50;
    let friends = [], ads = [{ type: 'text', content: 'ğŸ´ é©¬å¹´å¤§å‰ï¼å–æ°´äº†å—ï¼Ÿæ–°å¹´æ–°ä¹ æƒ¯ï¼Œæ¯å¤©å…«æ¯æ°´ï¼Œå¥åº·ä¸€æ•´å¹´' },{ type: 'text', content: 'ğŸ’§ ä¸Šå–„è‹¥æ°´ Â· åˆ†ç§’å¿…äº‰ â€” æ°´è‹¥å–„é‚€æ‚¨å¼€å¯æ™ºæ…§é¥®æ°´ä¹‹æ—…' },{ type: 'text', content: 'ğŸ“ æ°´å­¦è¯¾ç¨‹ä¸Šçº¿ï¼ä»æ°´ç§‘å­¦åˆ°æ°´å“²å­¦ï¼Œåšè‡ªå·±çš„å¥åº·ç®¡ç†å¸ˆ' }];
    let reminds = [], contacts = [];
    let checkinData = { streak: 0, lastDate: '', history: [], points: 0 };
    let waterData = { today: 0, goal: 2000, history: [], schedule: ['7:00','9:00','11:00','13:00','15:00','17:00','19:00','21:00'] };
    let centerData = { type: 'default', content: '' };
    let contactsAuthorized = false;
    let currentQuoteIdx = 0;

    // ==================== VIP è¯•ç”¨ä¸ä¼šå‘˜æƒç›Š ====================
    var VIP_TRIAL_DAYS = 3;  // è¯•ç”¨å¤©æ•°
    
    // åˆ¤æ–­æ˜¯å¦ä»˜è´¹ä¼šå‘˜ï¼ˆå«è¯•ç”¨æœŸï¼‰
    function isPaidMember() {
        if (!user) return false;
        if (user.level && user.level !== 'free') return true;
        // æ£€æŸ¥è¯•ç”¨æœŸ
        return isInTrialPeriod();
    }
    
    // æ£€æŸ¥è¯•ç”¨æœŸ
    function isInTrialPeriod() {
        if (!user) return false;
        var trialStart = localStorage.getItem('heshuileTrialStart_' + user.phone);
        if (!trialStart) return false;
        var elapsed = Date.now() - parseInt(trialStart);
        var trialMs = VIP_TRIAL_DAYS * 24 * 60 * 60 * 1000;
        return elapsed < trialMs;
    }
    
    // è·å–è¯•ç”¨å‰©ä½™å¤©æ•°
    function getTrialDaysLeft() {
        if (!user) return 0;
        var trialStart = localStorage.getItem('heshuileTrialStart_' + user.phone);
        if (!trialStart) return 0;
        var elapsed = Date.now() - parseInt(trialStart);
        var trialMs = VIP_TRIAL_DAYS * 24 * 60 * 60 * 1000;
        var left = trialMs - elapsed;
        return left > 0 ? Math.ceil(left / (24 * 60 * 60 * 1000)) : 0;
    }
    
    // å¼€å§‹è¯•ç”¨ï¼ˆæ–°ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨è§¦å‘ï¼‰
    function startVipTrial() {
        if (!user) return;
        var key = 'heshuileTrialStart_' + user.phone;
        if (localStorage.getItem(key)) return; // å·²ç»è¯•ç”¨è¿‡
        localStorage.setItem(key, String(Date.now()));
        logActivity('trial', 'VIPè¯•ç”¨å¼€å§‹ (' + VIP_TRIAL_DAYS + 'å¤©)');
    }
    
    // è¯•ç”¨åˆ°æœŸæ£€æŸ¥ï¼ˆæ¯æ¬¡æ‰“å¼€APPæ—¶è°ƒç”¨ï¼‰
    function checkTrialExpiry() {
        if (!user || !user.phone) return;
        if (user.level && user.level !== 'free') return; // å·²ä»˜è´¹
        
        var trialStart = localStorage.getItem('heshuileTrialStart_' + user.phone);
        if (!trialStart) return;
        
        var elapsed = Date.now() - parseInt(trialStart);
        var trialMs = VIP_TRIAL_DAYS * 24 * 60 * 60 * 1000;
        
        if (elapsed >= trialMs) {
            // è¯•ç”¨å·²åˆ°æœŸ
            var trialExpired = localStorage.getItem('heshuileTrialExpiredShown_' + user.phone);
            if (!trialExpired) {
                localStorage.setItem('heshuileTrialExpiredShown_' + user.phone, '1');
                setTimeout(function() {
                    showTrialExpiredModal();
                }, 2000);
            }
        } else {
            // è¯•ç”¨ä¸­ï¼Œæ˜¾ç¤ºå‰©ä½™å¤©æ•°
            var daysLeft = Math.ceil((trialMs - elapsed) / (24 * 60 * 60 * 1000));
            if (daysLeft <= 1) {
                setTimeout(function() {
                    toast('â³ VIPè¯•ç”¨ä»Šå¤©åˆ°æœŸï¼Œå‡çº§ç»§ç»­äº«å—å…¨éƒ¨åŠŸèƒ½');
                }, 3000);
            }
        }
    }
    
    function showTrialExpiredModal() {
        var overlay = document.createElement('div');
        overlay.id = 'trialExpiredOverlay';
        overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:99998;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;padding:20px;';
        overlay.innerHTML = '<div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:20px;padding:30px 24px;max-width:340px;width:100%;text-align:center;border:1px solid rgba(255,215,0,0.3);">'
            + '<div style="font-size:48px;margin-bottom:12px;">â°</div>'
            + '<div style="font-size:18px;font-weight:bold;color:var(--gold);margin-bottom:8px;">VIP è¯•ç”¨å·²åˆ°æœŸ</div>'
            + '<div style="font-size:13px;color:rgba(255,255,255,0.7);margin-bottom:16px;line-height:1.6;">'
            + 'è¿‡å»' + VIP_TRIAL_DAYS + 'å¤©é‡Œä½ ä½“éªŒäº†å…¨éƒ¨VIPåŠŸèƒ½ï¼š<br>'
            + 'âœ… æ— é™æé†’ Â· âœ… ç§’çº§ç²¾ç¡®<br>âœ… å…¨éƒ¨æ°´å­¦è¯¾ç¨‹ Â· âœ… æ— å¹¿å‘Š<br><br>'
            + 'å‡çº§å <strong style="color:var(--gold);">æ°¸ä¹…ä¿ç•™</strong> æ‰€æœ‰åŠŸèƒ½</div>'
            + '<div style="display:flex;flex-direction:column;gap:8px;">'
            + '<button onclick="document.getElementById(\'trialExpiredOverlay\').remove();openPanel(\'memberPanel\')" style="padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,#FFD700,#ff9800);color:#000;font-weight:bold;font-size:15px;cursor:pointer;">ğŸ‘‘ ç«‹å³å‡çº§ Â· ä½è‡³Â¥9.99/æœˆ</button>'
            + '<button onclick="document.getElementById(\'trialExpiredOverlay\').remove()" style="padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:rgba(255,255,255,0.5);font-size:12px;cursor:pointer;">ç»§ç»­ä½¿ç”¨å…è´¹ç‰ˆ</button>'
            + '</div></div>';
        document.body.appendChild(overlay);
    }
    
    // æ¯æ—¥å¥åº·æŠ¥å‘Šæ•°æ®ï¼ˆVIPä¸“å±ï¼‰
    function generateHealthReport() {
        if (!isPaidMember()) return null;
        var today = new Date().toISOString().slice(0, 10);
        var history = waterData.history || [];
        var todayRecord = history.find(function(h) { return h.date === today; });
        var last7 = history.slice(-7);
        var avgIntake = last7.length > 0 ? Math.round(last7.reduce(function(s, h) { return s + (h.amount || 0); }, 0) / last7.length) : 0;
        var streakDays = checkinData.streak || 0;
        var completionRate = last7.length > 0 ? Math.round(last7.filter(function(h) { return (h.amount || 0) >= waterData.goal; }).length / last7.length * 100) : 0;
        
        return {
            date: today,
            todayIntake: todayRecord ? todayRecord.amount : 0,
            goal: waterData.goal,
            avgIntake7d: avgIntake,
            completionRate: completionRate,
            streakDays: streakDays,
            trend: avgIntake >= waterData.goal ? 'good' : avgIntake >= waterData.goal * 0.7 ? 'ok' : 'low'
        };
    }


    // ==================== æ•°æ®ç»Ÿè®¡ç³»ç»Ÿ ====================
    // æœ¬åœ°ç»Ÿè®¡ + GA4äº‹ä»¶è¿½è¸ª
    var siteStats = JSON.parse(localStorage.getItem('heshuileStats') || '{}');
    
    function initStats() {
        var today = new Date().toISOString().slice(0,10);
        if (!siteStats.firstVisit) siteStats.firstVisit = today;
        if (!siteStats.totalVisits) siteStats.totalVisits = 0;
        if (!siteStats.dailyVisits) siteStats.dailyVisits = {};
        if (!siteStats.panels) siteStats.panels = {};
        if (!siteStats.shares) siteStats.shares = { total:0, methods:{} };
        if (!siteStats.festivals) siteStats.festivals = { views:0, blessings:0, days:{} };
        if (!siteStats.viral) siteStats.viral = { landings:0, sources:[] };
        if (!siteStats.events) siteStats.events = [];
        if (!siteStats.devices) siteStats.devices = [];
        
        // è®°å½•æœ¬æ¬¡è®¿é—®
        siteStats.totalVisits++;
        siteStats.lastVisit = today;
        if (!siteStats.dailyVisits[today]) siteStats.dailyVisits[today] = 0;
        siteStats.dailyVisits[today]++;
        
        // è®°å½•è®¾å¤‡ä¿¡æ¯
        var deviceInfo = {
            time: new Date().toISOString(),
            ua: navigator.userAgent.slice(0, 100),
            lang: navigator.language,
            screen: screen.width + 'x' + screen.height,
            referrer: document.referrer || 'direct',
            url: location.href.slice(0, 200)
        };
        siteStats.devices.push(deviceInfo);
        // åªä¿ç•™æœ€è¿‘200æ¡è®¾å¤‡è®°å½•
        if (siteStats.devices.length > 200) siteStats.devices = siteStats.devices.slice(-200);
        
        saveStats();
    }
    
    function trackEvent(category, action, label) {
        var today = new Date().toISOString().slice(0, 10);
        var evt = { t: new Date().toISOString(), c: category, a: action, l: label || '' };
        if (!siteStats.events) siteStats.events = [];
        siteStats.events.push(evt);
        // åªä¿ç•™æœ€è¿‘500æ¡äº‹ä»¶
        if (siteStats.events.length > 500) siteStats.events = siteStats.events.slice(-500);
        saveStats();
        
        // åŒæ—¶å‘é€GA4äº‹ä»¶
        if (typeof gtag === 'function') {
            gtag('event', action, { event_category: category, event_label: label || '' });
        }
    }
    
    function saveStats() {
        try { localStorage.setItem('heshuileStats', JSON.stringify(siteStats)); } catch(e) {}
    }
    
    // è¿½è¸ªURLå‚æ•°ï¼ˆè£‚å˜æ¥æºï¼‰
    function trackViralSource() {
        var params = new URLSearchParams(location.search);
        var day = params.get('day');
        var name = params.get('name');
        var invite = params.get('invite');
        if (day !== null || name || invite) {
            siteStats.viral.landings++;
            var source = { time: new Date().toISOString(), day: day, name: name||'', invite: invite||'' };
            siteStats.viral.sources.push(source);
            if (siteStats.viral.sources.length > 200) siteStats.viral.sources = siteStats.viral.sources.slice(-200);
            trackEvent('viral', 'landing', 'day=' + day + '&name=' + (name||''));
            saveStats();
        }
    }
    
    // ==================== ç®¡ç†å‘˜æ•°æ®çœ‹æ¿ ====================
    function showStatsPanel() {
        var today = new Date().toISOString().slice(0,10);
        var todayVisits = siteStats.dailyVisits[today] || 0;
        
        // ç»Ÿè®¡æœ€è¿‘7å¤©
        var last7 = 0;
        for (var i = 0; i < 7; i++) {
            var d = new Date(); d.setDate(d.getDate() - i);
            var key = d.toISOString().slice(0,10);
            last7 += (siteStats.dailyVisits[key] || 0);
        }
        
        // â•â•â• å…¨å±€ç”¨æˆ·æ•°æ®æ±‡æ€»ï¼ˆä»localStorageè¯»å–ï¼‰ â•â•â•
        var allUsers = JSON.parse(localStorage.getItem('heshuileUsers') || '{}');
        var userList = Object.values(allUsers);
        var totalUsers = userList.length;
        var paidUsers = userList.filter(function(u) { return u.level && u.level !== 'free'; }).length;
        var freeUsers = totalUsers - paidUsers;
        var trialUsers = 0;
        userList.forEach(function(u) {
            if (u.level === 'free' || !u.level) {
                var ts = localStorage.getItem('heshuileTrialStart_' + u.phone);
                if (ts) {
                    var elapsed = Date.now() - parseInt(ts);
                    if (elapsed < VIP_TRIAL_DAYS * 24*60*60*1000) trialUsers++;
                }
            }
        });
        
        // è®¢å•æ•°æ®
        var allOrders = JSON.parse(localStorage.getItem('heshuilePendingOrders') || '[]');
        var pendingOrders = allOrders.filter(function(o){ return o.status === 'pending'; }).length;
        var approvedOrders = allOrders.filter(function(o){ return o.status === 'approved'; }).length;
        var totalRevenue = allOrders.filter(function(o){ return o.status === 'approved'; }).reduce(function(s,o){ return s + (parseFloat(o.amount)||0); }, 0);
        
        // äº‘ç«¯ä¼šå‘˜
        var cloudMembers = JSON.parse(localStorage.getItem('heshuileCloudMembers') || '[]');
        
        // é¢æ¿ä½¿ç”¨æ’è¡Œ
        var panelRank = Object.entries(siteStats.panels || {}).sort(function(a,b){return b[1]-a[1]}).slice(0,8);
        var panelHtml = panelRank.map(function(p){ return '<div style="display:flex;justify-content:space-between;padding:3px 0;"><span>' + p[0].replace('Panel','') + '</span><span style="color:var(--gold);">' + p[1] + 'æ¬¡</span></div>'; }).join('');
        
        // åˆ†äº«ç»Ÿè®¡
        var shareTotal = siteStats.shares.total || 0;
        var shareMethods = Object.entries(siteStats.shares.methods || {}).map(function(s){ return s[0] + ':' + s[1]; }).join(' | ') || 'æš‚æ— ';
        
        // è£‚å˜æ¥æº
        var viralTotal = siteStats.viral.landings || 0;
        var recentSources = (siteStats.viral.sources || []).slice(-10).reverse();
        var viralHtml = recentSources.map(function(s){
            return '<div style="font-size:10px;padding:2px 0;border-bottom:1px solid rgba(255,255,255,0.05);">'
                + '<span style="color:var(--primary);">' + (s.name||'åŒ¿å') + '</span> '
                + 'ç¬¬' + (s.day||'?') + 'å¤© '
                + '<span style="color:rgba(255,255,255,0.4);">' + (s.time||'').slice(5,16).replace('T',' ') + '</span>'
                + '</div>';
        }).join('') || '<div style="color:rgba(255,255,255,0.4);">æš‚æ— è£‚å˜æ•°æ®</div>';
        
        // æœ€è¿‘æ³¨å†Œç”¨æˆ·
        var recentUsers = userList.sort(function(a,b){ return (b.id||'').localeCompare(a.id||''); }).slice(0, 10);
        var usersHtml = recentUsers.map(function(u){
            var levelBadge = u.level === 'vip' ? 'ğŸ‘‘' : u.level === 'monthly' ? 'â­' : u.level === 'quarterly' ? 'ğŸŒŸ' : u.level === 'enterprise' ? 'ğŸ¢' : 'ğŸ†“';
            var phone = u.phone ? u.phone.substring(0,3) + '****' + u.phone.substring(7) : 'æœªçŸ¥';
            return '<div style="font-size:10px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-between;">'
                + '<span>' + levelBadge + ' ' + (u.name||'åŒ¿å') + '</span>'
                + '<span style="color:rgba(255,255,255,0.4);">' + phone + '</span>'
                + '</div>';
        }).join('') || 'æš‚æ— ç”¨æˆ·';
        
        // æ¯æ—¥è®¿é—®è¶‹åŠ¿ï¼ˆæœ€è¿‘7å¤©ï¼‰
        var trendHtml = '';
        var maxDayVisit = 1;
        for (var i = 6; i >= 0; i--) {
            var d = new Date(); d.setDate(d.getDate() - i);
            var key = d.toISOString().slice(0,10);
            var count = siteStats.dailyVisits[key] || 0;
            if (count > maxDayVisit) maxDayVisit = count;
        }
        for (var i = 6; i >= 0; i--) {
            var d = new Date(); d.setDate(d.getDate() - i);
            var key = d.toISOString().slice(0,10);
            var count = siteStats.dailyVisits[key] || 0;
            var barW = Math.max(3, Math.round(count / maxDayVisit * 100));
            var dateStr = (d.getMonth()+1) + '/' + d.getDate();
            trendHtml += '<div style="display:flex;align-items:center;gap:8px;padding:2px 0;">'
                + '<span style="min-width:35px;font-size:10px;color:rgba(255,255,255,0.5);">' + dateStr + '</span>'
                + '<div style="height:12px;width:' + barW + '%;background:linear-gradient(90deg,var(--primary),var(--gold));border-radius:6px;"></div>'
                + '<span style="font-size:10px;color:var(--gold);">' + count + '</span>'
                + '</div>';
        }
        
        // æœ€è¿‘äº‹ä»¶
        var recentEvents = (siteStats.events || []).slice(-15).reverse();
        var eventsHtml = recentEvents.map(function(e){
            return '<div style="font-size:9px;padding:2px 0;display:flex;gap:5px;">'
                + '<span style="color:rgba(255,255,255,0.3);min-width:65px;">' + (e.t||'').slice(5,16).replace('T',' ') + '</span>'
                + '<span style="color:var(--primary);">' + (e.c||'') + '</span>'
                + '<span>' + (e.a||'') + '</span>'
                + '<span style="color:var(--gold);">' + (e.l||'') + '</span>'
                + '</div>';
        }).join('') || 'æš‚æ— äº‹ä»¶';
        
        var html = ''
            + '<div style="background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.2);border-radius:12px;padding:12px;margin-bottom:12px;">'
            + '<div style="text-align:center;font-size:14px;font-weight:bold;color:var(--primary);margin-bottom:10px;">ğŸ“Š ç®¡ç†å‘˜æ•°æ®çœ‹æ¿</div>'
            
            // â•â•â• ç”¨æˆ·æ¦‚è§ˆï¼ˆæ ¸å¿ƒæŒ‡æ ‡ï¼‰â•â•â•
            + '<div style="font-size:11px;color:var(--gold);margin-bottom:6px;font-weight:bold;">ğŸ‘¥ ç”¨æˆ·æ¦‚è§ˆ</div>'
            + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin-bottom:12px;">'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:20px;font-weight:bold;color:var(--primary);">' + totalUsers + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">æ€»æ³¨å†Œ</div></div>'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:20px;font-weight:bold;color:var(--gold);">' + paidUsers + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">ä»˜è´¹ä¼šå‘˜</div></div>'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:20px;font-weight:bold;color:#ff9800;">' + trialUsers + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">è¯•ç”¨ä¸­</div></div>'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:20px;font-weight:bold;color:rgba(255,255,255,0.5);">' + freeUsers + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">å…è´¹</div></div>'
            + '</div>'
            
            // â•â•â• æ”¶å…¥æ¦‚è§ˆ â•â•â•
            + '<div style="font-size:11px;color:var(--gold);margin-bottom:6px;font-weight:bold;">ğŸ’° æ”¶å…¥æ¦‚è§ˆ</div>'
            + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:12px;">'
            + '<div style="text-align:center;background:rgba(255,215,0,0.05);border:1px solid rgba(255,215,0,0.15);border-radius:8px;padding:8px;">'
            + '<div style="font-size:18px;font-weight:bold;color:var(--gold);">Â¥' + totalRevenue.toFixed(0) + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">æ€»æ”¶å…¥</div></div>'
            + '<div style="text-align:center;background:rgba(255,152,0,0.05);border:1px solid rgba(255,152,0,0.15);border-radius:8px;padding:8px;">'
            + '<div style="font-size:18px;font-weight:bold;color:#ff9800;">' + pendingOrders + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">å¾…å®¡æ ¸</div></div>'
            + '<div style="text-align:center;background:rgba(0,200,83,0.05);border:1px solid rgba(0,200,83,0.15);border-radius:8px;padding:8px;">'
            + '<div style="font-size:18px;font-weight:bold;color:var(--success);">' + approvedOrders + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">å·²é€šè¿‡</div></div>'
            + '</div>'
            
            // â•â•â• è½¬åŒ–æ¼æ–— â•â•â•
            + '<div style="font-size:11px;color:var(--gold);margin-bottom:6px;font-weight:bold;">ğŸ”„ è½¬åŒ–æ¼æ–—</div>'
            + '<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:10px;margin-bottom:12px;">'
            + buildFunnelBar('è®¿é—®', siteStats.totalVisits||0, siteStats.totalVisits||1)
            + buildFunnelBar('æ³¨å†Œ', totalUsers, siteStats.totalVisits||1)
            + buildFunnelBar('è¯•ç”¨', trialUsers + paidUsers, siteStats.totalVisits||1)
            + buildFunnelBar('ä»˜è´¹', paidUsers, siteStats.totalVisits||1)
            + '</div>'
            
            // â•â•â• æµé‡æ•°æ® â•â•â•
            + '<div style="font-size:11px;color:var(--gold);margin-bottom:6px;font-weight:bold;">ğŸ“ˆ æµé‡æ•°æ®</div>'
            + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:12px;">'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:18px;font-weight:bold;color:var(--primary);">' + (siteStats.totalVisits||0) + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">æ€»è®¿é—®</div></div>'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:18px;font-weight:bold;color:var(--success);">' + todayVisits + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">ä»Šæ—¥</div></div>'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:18px;font-weight:bold;color:#ff9800;">' + last7 + '</div><div style="font-size:8px;color:rgba(255,255,255,0.5);">7æ—¥</div></div>'
            + '</div>'
            
            // 7æ—¥è¶‹åŠ¿
            + '<div style="font-size:10px;color:var(--primary);margin-bottom:4px;">ğŸ“Š 7æ—¥è¶‹åŠ¿</div>'
            + '<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:8px;margin-bottom:10px;">' + trendHtml + '</div>'
            
            // è£‚å˜ + åˆ†äº«
            + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px;">'
            + '<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:8px;">'
            + '<div style="font-size:10px;color:var(--primary);margin-bottom:4px;">ğŸ”— è£‚å˜ ' + viralTotal + 'æ¬¡</div>' + viralHtml + '</div>'
            + '<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:8px;">'
            + '<div style="font-size:10px;color:var(--primary);margin-bottom:4px;">ğŸ“¤ åˆ†äº« ' + shareTotal + 'æ¬¡</div>'
            + '<div style="font-size:10px;color:rgba(255,255,255,0.6);">' + shareMethods + '</div></div>'
            + '</div>'
            
            // æœ€è¿‘æ³¨å†Œç”¨æˆ·
            + '<div style="font-size:10px;color:var(--primary);margin-bottom:4px;">ğŸ‘¤ æœ€è¿‘æ³¨å†Œï¼ˆ' + totalUsers + 'äººï¼‰</div>'
            + '<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:8px;margin-bottom:10px;max-height:120px;overflow-y:auto;">' + usersHtml + '</div>'
            
            // åŠŸèƒ½ä½¿ç”¨ + äº‹ä»¶
            + '<div style="font-size:10px;color:var(--primary);margin-bottom:4px;">ğŸ† åŠŸèƒ½æ’è¡Œ</div>'
            + '<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:8px;margin-bottom:10px;font-size:11px;">' + (panelHtml || 'æš‚æ— ') + '</div>'
            
            + '<div style="font-size:10px;color:var(--primary);margin-bottom:4px;">ğŸ“‹ æœ€è¿‘äº‹ä»¶</div>'
            + '<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:8px;margin-bottom:10px;max-height:120px;overflow-y:auto;">' + eventsHtml + '</div>'
            
            // æ“ä½œæŒ‰é’®
            + '<div style="display:flex;gap:6px;margin-bottom:10px;">'
            + '<button class="btn btn-outline" style="flex:1;font-size:10px;" onclick="exportStats()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>'
            + '<button class="btn btn-outline" style="flex:1;font-size:10px;" onclick="exportAllUserData()">ğŸ“¥ å¯¼å‡ºç”¨æˆ·è¡¨</button>'
            + '<button class="btn btn-outline" style="flex:1;font-size:10px;" onclick="clearAllStats()">ğŸ—‘ï¸ æ¸…é™¤</button>'
            + '</div>'
            
            // GA4 é…ç½®æé†’
            + '<div style="padding:10px;background:rgba(0,200,83,0.08);border:1px solid rgba(0,200,83,0.25);border-radius:8px;font-size:10px;">'
            + '<div style="color:var(--success);font-weight:bold;margin-bottom:4px;">âœ… Google Analytics å·²é…ç½®ï¼ˆG-8BF63PNVGDï¼‰</div>'
            + '<div style="color:rgba(255,255,255,0.6);line-height:1.5;">æ‰€æœ‰ç”¨æˆ·çš„è®¿é—®ã€ç‚¹å‡»ã€ä»˜è´¹äº‹ä»¶æ­£åœ¨è‡ªåŠ¨ä¸ŠæŠ¥ã€‚<br>'
            + 'æŸ¥çœ‹å…¨é‡æ•°æ® â†’ <a href="https://analytics.google.com" target="_blank" style="color:var(--gold);">æ‰“å¼€ Google Analytics</a><br>'
            + '<span style="color:rgba(255,255,255,0.4);">æ³¨ï¼šä¸Šæ–¹ç”¨æˆ·/è®¢å•æ•°æ®ä»…é™æœ¬è®¾å¤‡ï¼ŒGA4å¯çœ‹å…¨éƒ¨è®¾å¤‡</span></div>'
            + '</div>'
            
            + '</div>';
        
        document.getElementById('statsContainer').innerHTML = html;
    }
    
    // è½¬åŒ–æ¼æ–—æ¡å½¢å›¾
    function buildFunnelBar(label, count, total) {
        var pct = total > 0 ? Math.round(count / total * 100) : 0;
        var barW = Math.max(3, pct);
        return '<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">'
            + '<span style="min-width:28px;font-size:9px;color:rgba(255,255,255,0.6);">' + label + '</span>'
            + '<div style="flex:1;height:14px;background:rgba(255,255,255,0.05);border-radius:7px;overflow:hidden;">'
            + '<div style="height:100%;width:' + barW + '%;background:linear-gradient(90deg,var(--primary),var(--gold));border-radius:7px;transition:width 0.5s;"></div></div>'
            + '<span style="min-width:50px;text-align:right;font-size:9px;color:var(--gold);">' + count + ' (' + pct + '%)</span>'
            + '</div>';
    }
    
    // å¯¼å‡ºç”¨æˆ·æ•°æ®ä¸ºCSV
    function exportAllUserData() {
        var allUsers = JSON.parse(localStorage.getItem('heshuileUsers') || '{}');
        var rows = [['æ‰‹æœºå·', 'æ˜µç§°', 'ç­‰çº§', 'ä»˜è´¹å¥—é¤', 'ä»˜è´¹æ—¶é—´', 'æ¿€æ´»ç ', 'ç”¨æˆ·ID'].join(',')];
        Object.values(allUsers).forEach(function(u) {
            rows.push([
                u.phone || '',
                '"' + (u.name || '').replace(/"/g,'""') + '"',
                u.level || 'free',
                u.paidPlan || '',
                u.paidAt ? u.paidAt.slice(0,10) : '',
                u.activationCode || '',
                u.id || ''
            ].join(','));
        });
        var csv = '\uFEFF' + rows.join('\n');
        var blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'heshuile-users-' + new Date().toISOString().slice(0,10) + '.csv';
        a.click();
        toast('ğŸ“¥ ç”¨æˆ·æ•°æ®å·²å¯¼å‡º');
    }
    
    function clearAllStats() {
        if (confirm('ç¡®å®šæ¸…é™¤æ‰€æœ‰ç»Ÿè®¡æ•°æ®ï¼Ÿ')) {
            siteStats = {};
            saveStats();
            showStatsPanel();
            toast('å·²æ¸…é™¤');
        }
    }
    
    function exportStats() {
        var data = JSON.stringify(siteStats, null, 2);
        var blob = new Blob([data], {type: 'application/json'});
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'heshuile-stats-' + new Date().toISOString().slice(0,10) + '.json';
        a.click();
        URL.revokeObjectURL(url);
        trackEvent('admin', 'export_stats');
        toast('ğŸ“¥ æ•°æ®å·²å¯¼å‡º');
    }



    // ==================== æ´»åŠ¨æ—¥å¿—ç³»ç»Ÿ ====================
    var activityLog = JSON.parse(localStorage.getItem('heshuileActivityLog') || '[]');
    
    function logActivity(type, detail) {
        var entry = {
            time: new Date().toISOString(),
            type: type,
            detail: detail,
            user: user ? user.name : 'æœªç™»å½•'
        };
        activityLog.push(entry);
        if (activityLog.length > 500) activityLog = activityLog.slice(-500);
        localStorage.setItem('heshuileActivityLog', JSON.stringify(activityLog));
    }
    
    // æ˜¾ç¤ºæ´»åŠ¨æ—¥å¿—ï¼ˆç®¡ç†å‘˜çœ‹æ¿ï¼‰
    function showMyActivity() {
        var el = document.getElementById('myActivityList');
        if (!el) return;
        var myName = user ? user.name : '';
        var myLogs = activityLog.filter(function(e){ return e.user === myName || e.type === 'send_blessing' || e.type === 'share'; }).slice(-20).reverse();
        if (myLogs.length === 0) {
            el.innerHTML = '<div style="color:rgba(255,255,255,0.3);font-size:11px;text-align:center;padding:10px;">æš‚æ— æ´»åŠ¨è®°å½•</div>';
            return;
        }
        var typeNames = { 'send_blessing':'ğŸ§§å‘é€ç¥ç¦','auto_send':'ğŸ¤–è‡ªåŠ¨å‘é€','share':'ğŸ“¤åˆ†äº«','login':'ğŸ‘¤ç™»å½•','visit':'ğŸŒè®¿é—®','open_fest':'ğŸ®æ‰“å¼€ç¥ç¦é¦†','payment':'ğŸ’°æ”¯ä»˜' };
        el.innerHTML = myLogs.map(function(e){
            return '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:10px;">'
                + '<span style="color:rgba(255,255,255,0.5);">' + (e.time||'').slice(5,16).replace('T',' ') + '</span>'
                + '<span style="color:white;">' + (typeNames[e.type]||e.type) + '</span>'
                + '<span style="color:var(--gold);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (e.detail||'') + '</span>'
                + '</div>';
        }).join('');
    }
    
    function showActivityLog() {
        var recent = activityLog.slice().reverse().slice(0, 30);
        var typeIcons = {
            'send_blessing': 'ğŸ§§', 'auto_send': 'ğŸ¤–', 'open_fest': 'ğŸ®',
            'share': 'ğŸ“¤', 'login': 'ğŸ‘¤', 'payment': 'ğŸ’°', 'visit': 'ğŸŒ'
        };
        var html = '<div style="font-size:11px;color:var(--primary);margin-bottom:5px;">ğŸ“‹ æ´»åŠ¨æ—¥å¿—ï¼ˆæœ€è¿‘30æ¡ï¼‰</div>'
            + '<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:8px;max-height:200px;overflow-y:auto;">';
        if (recent.length === 0) {
            html += '<div style="color:rgba(255,255,255,0.3);text-align:center;padding:10px;">æš‚æ— æ´»åŠ¨</div>';
        } else {
            recent.forEach(function(e) {
                var icon = typeIcons[e.type] || 'ğŸ“Œ';
                html += '<div style="display:flex;gap:6px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:10px;">'
                    + '<span style="color:rgba(255,255,255,0.3);min-width:70px;">' + (e.time||'').slice(5,16).replace('T',' ') + '</span>'
                    + '<span>' + icon + '</span>'
                    + '<span style="color:white;">' + (e.detail||'') + '</span>'
                    + '<span style="color:var(--gold);">' + (e.user||'') + '</span>'
                    + '</div>';
            });
        }
        html += '</div>';
        document.getElementById('activityLogContainer').innerHTML = html;
    }

    // ==================== è‡ªåŠ¨å‘é€ç³»ç»Ÿ ====================
    var autoSendConfig = JSON.parse(localStorage.getItem('heshuileAutoSend') || '{}');
    // autoSendConfigç»“æ„: { enabled: true/false, sentDays: [0,1,2...], contacts: [...], lastCheck: '...' }
    
    function initAutoSend() {
        if (!autoSendConfig.sentDays) autoSendConfig.sentDays = [];
        if (!autoSendConfig.contacts) autoSendConfig.contacts = [];
        
        // æ£€æŸ¥æ˜¯å¦åœ¨æ˜¥èŠ‚æœŸé—´ï¼ˆé™¤å¤•åˆ°åäº”ï¼š2æœˆ16æ—¥-3æœˆ2æ—¥ï¼‰
        var now = new Date();
        var cnyStart = new Date(2026, 1, 16); // 2æœˆ16æ—¥é™¤å¤•
        var cnyEnd = new Date(2026, 2, 3);    // 3æœˆ3æ—¥ï¼ˆåäº”åä¸€å¤©ï¼‰
        
        if (now < cnyStart || now > cnyEnd) return;
        if (!autoSendConfig.enabled) return;
        
        var daysSinceCNY = Math.floor((now - cnyStart) / 86400000);
        if (daysSinceCNY < 0 || daysSinceCNY > 15) return;
        
        // ä»Šå¤©æ˜¯å¦å·²å‘è¿‡
        if (autoSendConfig.sentDays.indexOf(daysSinceCNY) >= 0) return;
        
        // è‡ªåŠ¨ç”Ÿæˆä»Šå¤©çš„ç¥ç¦å¹¶å‡†å¤‡å‘é€
        var festDay = FEST_DAYS[daysSinceCNY] || FEST_DAYS[0];
        var senderName = user ? user.name : (autoSendConfig.senderName || '');
        
        if (senderName && autoSendConfig.contacts.length > 0) {
            // è®°å½•è‡ªåŠ¨å‘é€
            autoSendConfig.sentDays.push(daysSinceCNY);
            autoSendConfig.lastCheck = now.toISOString();
            localStorage.setItem('heshuileAutoSend', JSON.stringify(autoSendConfig));
            
            logActivity('auto_send', festDay.name + ' è‡ªåŠ¨ç¥ç¦' + autoSendConfig.contacts.length + 'äºº');
            
            // ç”Ÿæˆåˆ†äº«å†…å®¹ä¾›ç”¨æˆ·ç¡®è®¤
            setTimeout(function() {
                var url = getShareUrl('day=' + daysSinceCNY + '&name=' + encodeURIComponent(senderName));
                var text = festDay.emoji + ' ' + festDay.name + '\nğŸ‹ ' + senderName + 'ç¥ç¦æ‚¨\n' + festDay.greeting + '\nğŸ’§ ' + festDay.water + '\nğŸ‘‰ ' + url;
                
                if (confirm('ğŸ¤– ä»Šæ—¥è‡ªåŠ¨ç¥ç¦å‡†å¤‡å¥½äº†ï¼\n\n' + festDay.name + ' Â· ' + festDay.folk + '\n\nå°†ä¸ºæ‚¨çš„' + autoSendConfig.contacts.length + 'ä½å¥½å‹å‘é€ç¥ç¦ã€‚\n\nç¡®è®¤å‘é€ï¼Ÿ')) {
                    safeCopy(text, 'âœ… ' + festDay.name + 'ç¥ç¦å·²å¤åˆ¶ï¼è¯·ç²˜è´´å‘é€ç»™å¥½å‹');
                    toast('ğŸ§§ è‡ªåŠ¨ç¥ç¦ï¼š' + festDay.name);
                    trackEvent('auto_send', 'confirmed', 'day' + daysSinceCNY);
                }
            }, 3000);
        }
    }
    
    function showAutoSendPanel() {
        var cnyStart = new Date(2026, 1, 16);
        var now = new Date();
        var daysSinceCNY = Math.floor((now - cnyStart) / 86400000);
        
        var html = '<div style="background:rgba(255,152,0,0.05);border:1px solid rgba(255,152,0,0.2);border-radius:12px;padding:12px;margin-bottom:12px;">'
            + '<div style="text-align:center;font-size:14px;font-weight:bold;color:#ff9800;margin-bottom:10px;">ğŸ¤– è‡ªåŠ¨ç¥ç¦ç³»ç»Ÿ</div>';
        
        // å¼€å…³
        var isEnabled = autoSendConfig.enabled || false;
        html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:10px;">'
            + '<span style="font-size:12px;">è‡ªåŠ¨å‘é€ç¥ç¦</span>'
            + '<button onclick="toggleAutoSend()" style="padding:5px 15px;border-radius:12px;border:none;font-size:11px;cursor:pointer;'
            + (isEnabled ? 'background:var(--success);color:#000;' : 'background:rgba(255,255,255,0.15);color:white;')
            + '">' + (isEnabled ? 'âœ… å·²å¼€å¯' : 'âŒ å·²å…³é—­') + '</button>'
            + '</div>';
        
        // å‘é€è¿›åº¦
        html += '<div style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:8px;">å‘é€è¿›åº¦ï¼ˆé™¤å¤•åˆ°åäº”ï¼‰</div>';
        var sentDays = autoSendConfig.sentDays || [];
        for (var i = 0; i <= 15; i++) {
            var fd = FEST_DAYS[i] || { name: 'ç¬¬' + i + 'å¤©', emoji: 'ğŸ“…' };
            var sent = sentDays.indexOf(i) >= 0;
            var isToday = i === daysSinceCNY;
            html += '<div style="display:flex;justify-content:space-between;padding:3px 0;font-size:10px;'
                + (isToday ? 'color:var(--gold);font-weight:bold;' : '') + '">'
                + '<span>' + fd.emoji + ' ' + fd.name + (isToday ? ' â† ä»Šå¤©' : '') + '</span>'
                + '<span style="color:' + (sent ? 'var(--success)' : 'rgba(255,255,255,0.2)') + ';">' + (sent ? 'âœ…å·²å‘' : 'â³å¾…å‘') + '</span>'
                + '</div>';
        }
        
        // è”ç³»äººç®¡ç†
        var contactCount = (autoSendConfig.contacts || []).length;
        html += '<div style="margin-top:10px;padding:8px;background:rgba(255,255,255,0.05);border-radius:8px;">'
            + '<div style="font-size:11px;margin-bottom:5px;">å·²è®¾ç½® <span style="color:var(--gold);">' + contactCount + '</span> ä½è‡ªåŠ¨å‘é€è”ç³»äºº</div>'
            + '<button onclick="setupAutoSendContacts()" class="btn btn-outline" style="font-size:10px;">ğŸ“‡ ç®¡ç†è”ç³»äºº</button>'
            + '</div>';
        
        html += '</div>';
        document.getElementById('autoSendContainer').innerHTML = html;
    }
    
    function toggleAutoSend() {
        autoSendConfig.enabled = !autoSendConfig.enabled;
        if (!autoSendConfig.sentDays) autoSendConfig.sentDays = [];
        if (!autoSendConfig.contacts) autoSendConfig.contacts = [];
        if (autoSendConfig.enabled && user) autoSendConfig.senderName = user.name;
        localStorage.setItem('heshuileAutoSend', JSON.stringify(autoSendConfig));
        showAutoSendPanel();
        toast(autoSendConfig.enabled ? 'âœ… è‡ªåŠ¨ç¥ç¦å·²å¼€å¯' : 'âŒ è‡ªåŠ¨ç¥ç¦å·²å…³é—­');
    }
    
    function setupAutoSendContacts() {
        // æ”¶é›†æ‰€æœ‰è”ç³»äºº
        var allPeople = [];
        if (typeof contacts !== 'undefined' && contacts && contacts.length) {
            contacts.forEach(function(c){ 
                allPeople.push({name: c.name, phone: c.phone||'', tag: c.group||''}); 
            });
        }
        if (typeof friends !== 'undefined' && friends && friends.length) {
            friends.forEach(function(f){ 
                var exists = allPeople.some(function(p){ return p.name === f.name; });
                if (!exists) allPeople.push({name: f.name, phone: f.phone||'', tag: f.relation||''}); 
            });
        }
        
        if (allPeople.length === 0) {
            toast('è¯·å…ˆåœ¨"æ™ºèƒ½å…³æ€€"ä¸­æˆæƒé€šè®¯å½•æˆ–æ·»åŠ è”ç³»äºº');
            return;
        }
        
        var selectedNames = autoSendConfig.contacts || [];
        
        // åˆ›å»ºæµ®å±‚
        var ov = document.createElement('div');
        ov.id = 'autoSendPicker';
        ov.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:20000;background:rgba(0,0,0,0.85);display:flex;flex-direction:column;justify-content:flex-end;';
        ov.onclick = function(e){ if(e.target===ov){ ov.remove(); } };
        
        var box = document.createElement('div');
        box.style.cssText = 'width:100%;max-height:70vh;background:#1a1a2e;border-radius:20px 20px 0 0;padding:16px;display:flex;flex-direction:column;';
        
        // æ ‡é¢˜
        box.innerHTML = '<div style="text-align:center;margin-bottom:10px;">'
            + '<div style="font-size:16px;font-weight:bold;color:#FFD700;">ğŸ“‡ é€‰æ‹©è‡ªåŠ¨å‘é€è”ç³»äºº</div>'
            + '<div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:4px;">å‹¾é€‰åï¼Œæ˜¥èŠ‚æœŸé—´å°†è‡ªåŠ¨ä¸ºä»–ä»¬å‡†å¤‡ç¥ç¦</div>'
            + '</div>';
        
        // æœç´¢æ 
        box.innerHTML += '<div style="margin-bottom:10px;">'
            + '<input id="autoSendSearch" type="text" placeholder="ğŸ” æœç´¢è”ç³»äºº..." '
            + 'oninput="filterAutoSendPicker()" '
            + 'style="width:100%;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#fff;font-size:13px;outline:none;box-sizing:border-box;">'
            + '</div>';
        
        // å…¨é€‰æŒ‰é’®
        box.innerHTML += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding:0 4px;">'
            + '<span id="autoSendCount" style="font-size:11px;color:rgba(255,255,255,0.5);">å·²é€‰ ' + selectedNames.length + ' äºº</span>'
            + '<div style="display:flex;gap:8px;">'
            + '<span onclick="toggleAllAutoSend(true)" style="font-size:11px;color:var(--gold);cursor:pointer;">å…¨é€‰</span>'
            + '<span onclick="toggleAllAutoSend(false)" style="font-size:11px;color:rgba(255,255,255,0.4);cursor:pointer;">æ¸…ç©º</span>'
            + '</div></div>';
        
        // è”ç³»äººåˆ—è¡¨
        var listHtml = '<div id="autoSendList" style="flex:1;overflow-y:auto;max-height:40vh;">';
        var colors = ['#00d4ff','#06ffa5','#FFD700','#ff6b9d','#8338ec'];
        allPeople.forEach(function(p, i) {
            var checked = selectedNames.indexOf(p.name) >= 0;
            listHtml += '<div class="as-item" data-name="' + p.name + '" '
                + 'onclick="toggleAutoSendItem(this)" '
                + 'style="display:flex;align-items:center;gap:10px;padding:10px 8px;border-radius:10px;cursor:pointer;margin-bottom:3px;'
                + 'background:' + (checked ? 'rgba(255,215,0,0.1)' : 'rgba(255,255,255,0.03)') + ';'
                + 'border:1px solid ' + (checked ? 'rgba(255,215,0,0.3)' : 'transparent') + ';">'
                + '<div style="width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:bold;color:#000;background:' + colors[i%colors.length] + ';">' + p.name.charAt(0) + '</div>'
                + '<div style="flex:1;">'
                + '<div style="font-size:13px;color:#fff;">' + p.name + '</div>'
                + '<div style="font-size:10px;color:rgba(255,255,255,0.3);">' + (p.tag || p.phone || '') + '</div>'
                + '</div>'
                + '<div class="as-check" style="width:22px;height:22px;border-radius:50%;border:2px solid ' + (checked ? '#FFD700' : 'rgba(255,255,255,0.2)') + ';display:flex;align-items:center;justify-content:center;font-size:14px;'
                + (checked ? 'background:#FFD700;color:#000;' : '') + '">' + (checked ? 'âœ“' : '') + '</div>'
                + '</div>';
        });
        listHtml += '</div>';
        box.innerHTML += listHtml;
        
        // åº•éƒ¨æŒ‰é’®
        box.innerHTML += '<div style="display:flex;gap:8px;margin-top:12px;">'
            + '<button onclick="document.getElementById(\'autoSendPicker\').remove();" style="flex:1;padding:12px;border-radius:12px;border:none;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);font-size:14px;cursor:pointer;">å–æ¶ˆ</button>'
            + '<button onclick="confirmAutoSendContacts()" style="flex:2;padding:12px;border-radius:14px;border:none;background:linear-gradient(135deg,#FFD700,#ff9800);color:#000;font-size:14px;font-weight:bold;cursor:pointer;">âœ… ç¡®è®¤é€‰æ‹©</button>'
            + '</div>';
        
        ov.appendChild(box);
        document.body.appendChild(ov);
    }
    
    function toggleAutoSendItem(el) {
        var check = el.querySelector('.as-check');
        var isChecked = check.textContent === 'âœ“';
        if (isChecked) {
            check.textContent = '';
            check.style.background = 'transparent';
            check.style.color = '';
            check.style.borderColor = 'rgba(255,255,255,0.2)';
            el.style.background = 'rgba(255,255,255,0.03)';
            el.style.borderColor = 'transparent';
        } else {
            check.textContent = 'âœ“';
            check.style.background = '#FFD700';
            check.style.color = '#000';
            check.style.borderColor = '#FFD700';
            el.style.background = 'rgba(255,215,0,0.1)';
            el.style.borderColor = 'rgba(255,215,0,0.3)';
        }
        updateAutoSendCount();
    }
    
    function toggleAllAutoSend(selectAll) {
        document.querySelectorAll('.as-item').forEach(function(el) {
            if (el.style.display === 'none') return;
            var check = el.querySelector('.as-check');
            var isChecked = check.textContent === 'âœ“';
            if (selectAll && !isChecked) toggleAutoSendItem(el);
            if (!selectAll && isChecked) toggleAutoSendItem(el);
        });
    }
    
    function updateAutoSendCount() {
        var count = document.querySelectorAll('.as-check').length ? 
            Array.from(document.querySelectorAll('.as-check')).filter(function(c){ return c.textContent === 'âœ“'; }).length : 0;
        var el = document.getElementById('autoSendCount');
        if (el) el.textContent = 'å·²é€‰ ' + count + ' äºº';
    }
    
    function filterAutoSendPicker() {
        var q = (document.getElementById('autoSendSearch')?.value || '').toLowerCase();
        document.querySelectorAll('.as-item').forEach(function(el) {
            var n = (el.getAttribute('data-name') || '').toLowerCase();
            el.style.display = (!q || n.indexOf(q) >= 0) ? 'flex' : 'none';
        });
    }
    
    function confirmAutoSendContacts() {
        var selected = [];
        document.querySelectorAll('.as-item').forEach(function(el) {
            var check = el.querySelector('.as-check');
            if (check && check.textContent === 'âœ“') {
                selected.push(el.getAttribute('data-name'));
            }
        });
        autoSendConfig.contacts = selected;
        localStorage.setItem('heshuileAutoSend', JSON.stringify(autoSendConfig));
        document.getElementById('autoSendPicker').remove();
        showAutoSendPanel();
        toast('âœ… å·²è®¾ç½® ' + selected.length + ' ä½è‡ªåŠ¨å‘é€è”ç³»äºº');
    }

    // ==================== åˆå§‹åŒ– ====================
    // â•â•â• åˆ†äº«åŸºç¡€URL â•â•â•
    function getShareUrl(params) {
        var base = localStorage.getItem('heshuileBaseUrl') || 'https://ericjbe.github.io/water-reminder/';
        if (!base || base.indexOf('file:') >= 0) {
            // æ²¡è®¾ç½®æˆ–æ˜¯æœ¬åœ°fileåè®® â†’ ç”¨å½“å‰åŸŸåï¼ˆé€‚ç”¨äºå·²éƒ¨ç½²çš„æƒ…å†µï¼‰
            base = location.origin + location.pathname;
        }
        // æ¸…ç†å°¾éƒ¨
        base = base.split('?')[0].split('#')[0];
        if (base.charAt(base.length-1) !== '/' && base.indexOf('.html') < 0) base += '/';
        return base + (params ? '?' + params : '');
    }

    function showBaseUrlSetting() {
        var current = localStorage.getItem('heshuileBaseUrl') || '';
        var url = prompt('è®¾ç½®ä½ çš„çº¿ä¸Šç½‘å€ï¼ˆGitHub Pagesåœ°å€ï¼‰\n\nä¾‹å¦‚ï¼šhttps://yourname.github.io/heshuile/\n\nè®¾ç½®ååˆ†äº«é“¾æ¥ä¼šæŒ‡å‘è¿™ä¸ªåœ°å€ï¼Œåˆ«äººæ‰èƒ½æ‰“å¼€ã€‚\nç•™ç©º=ä½¿ç”¨å½“å‰åœ°å€', current);
        if (url !== null) {
            url = url.trim();
            if (url && url.indexOf('http') !== 0) url = 'https://' + url;
            localStorage.setItem('heshuileBaseUrl', url);
            toast(url ? 'âœ… çº¿ä¸Šåœ°å€å·²è®¾ç½®ï¼š' + url : 'âœ… å·²æ¸…é™¤ï¼Œä½¿ç”¨å½“å‰åœ°å€');
        }
    }

    window.onload = function() {
        initStats();
        trackViralSource();
        logActivity('visit', 'æ‰“å¼€ç½‘ç«™');
        // åˆå§‹åŒ–è‡ªåŠ¨å‘é€
        setTimeout(function(){ if(typeof FEST_DAYS !== 'undefined') initAutoSend(); }, 2000);
        // â•â•â• è£‚å˜è½åœ°é¡µæ£€æµ‹ â•â•â•
        var params = new URLSearchParams(location.search);
        var sharedDay = params.get('day');
        var sharedName = params.get('name');
        var inviter = params.get('invite');
        if (sharedDay !== null) {
            showViralLanding(parseInt(sharedDay), sharedName, inviter);
        }

        currentLang = localStorage.getItem('heshuileLang') || 'zh';
        document.getElementById('langSelect').value = currentLang;
        loadData();
        
        // â•â•â• æ¿€æ´»é“¾æ¥æ£€æµ‹ â•â•â•
        var activateCode = params.get('activate');
        if (activateCode) {
            // æ¸…é™¤URLä¸­çš„æ¿€æ´»å‚æ•°ï¼ˆé¿å…åˆ·æ–°é‡å¤è§¦å‘ï¼‰
            var cleanUrl = location.href.split('?')[0];
            history.replaceState(null, '', cleanUrl);
            
            if (user) {
                // å·²ç™»å½•ï¼šç«‹å³å°è¯•æ¿€æ´»
                setTimeout(function() { autoActivateByLink(activateCode); }, 500);
            } else {
                // æœªç™»å½•ï¼šä¿å­˜æ¿€æ´»ç ï¼Œç™»å½•åè‡ªåŠ¨æ¿€æ´»
                localStorage.setItem('heshuilePendingActivation', activateCode);
                setTimeout(function() {
                    toast('ğŸ”‘ æ£€æµ‹åˆ°æ¿€æ´»ç ï¼Œè¯·å…ˆç™»å½•');
                    openPanel('memberPanel');
                }, 800);
            }
        }
        
        // æ˜¥èŠ‚æœŸé—´æ˜¾ç¤ºæ–°å¹´æ¬¢è¿
        showCNYWelcome();
        initTicks();
        initAudio();
        applyI18n();
        renderAll();
        updateUI();
        updateDailyCulture();
        updateCheckinUI();
        applyTheme(currentTheme);
        updateTickSwitch();
        renderAds();
        setDefaultDateTime();
        renderCenter();
        updateContactsUI();
        // â•â•â• äº‘ç«¯ä¼šå‘˜è‡ªåŠ¨æ¢å¤ â•â•â•
        setTimeout(function() { checkCloudMembership(); }, 1500);
        // â•â•â• VIPè¯•ç”¨åˆ°æœŸæ£€æŸ¥ â•â•â•
        setTimeout(function() { checkTrialExpiry(); }, 2500);
        updateClock();
        setInterval(updateClock, 1000);
        setInterval(checkReminders, 1000);
        initVoiceSystem();
        // å¯åŠ¨æ—¶è¯­éŸ³é—®å€™
        setTimeout(() => { speak('æ¬¢è¿ä½¿ç”¨å–æ°´äº†å—ï¼Œè¯´æ™ºå›å”¤é†’è¯­éŸ³åŠ©æ‰‹'); }, 1500);
        // å¦‚æœæ˜¯æœ¬åœ°file://åè®®ä¸”æ²¡è®¾ç½®çº¿ä¸Šåœ°å€ï¼Œæé†’
        if (location.protocol === 'file:' && !localStorage.getItem('heshuileBaseUrl')) {
            setTimeout(function(){
                if (confirm('æ£€æµ‹åˆ°æœ¬åœ°è¿è¡Œã€‚\n\nå¦‚æœè¦åˆ†äº«ç¥ç¦ç»™æœ‹å‹ï¼Œéœ€è¦å…ˆè®¾ç½®çº¿ä¸Šåœ°å€ã€‚\n\næ˜¯å¦ç°åœ¨è®¾ç½®ï¼Ÿï¼ˆéƒ¨ç½²åˆ°GitHub Pagesåå†è®¾ç½®ä¹Ÿè¡Œï¼‰')) {
                    showBaseUrlSetting();
                }
            }, 3000);
        }
    };

    function initTicks() {
        const c = document.getElementById('ticks');
        for (let i = 0; i < 60; i++) {
            const t = document.createElement('div');
            t.className = 'tick' + (i % 5 === 0 ? ' major' : '');
            t.style.transform = `rotate(${i * 6}deg)`;
            c.appendChild(t);
        }
    }

    function updateClock() {
        const now = new Date();
        const h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
        document.getElementById('hHour').style.transform = `rotate(${(h % 12) * 30 + m * 0.5}deg)`;
        document.getElementById('hMin').style.transform = `rotate(${m * 6 + s * 0.1}deg)`;
        document.getElementById('hSec').style.transform = `rotate(${s * 6}deg)`;
        document.getElementById('dH').textContent = String(h).padStart(2, '0');
        document.getElementById('dM').textContent = String(m).padStart(2, '0');
        document.getElementById('dS').textContent = String(s).padStart(2, '0');
        
        const texts = I18N[currentLang];
        const days = [texts.sunday, texts.monday, texts.tuesday, texts.wednesday, texts.thursday, texts.friday, texts.saturday];
        if (currentLang === 'zh') {
            document.getElementById('digitalDate').textContent = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ æ˜ŸæœŸ${days[now.getDay()]}`;
        } else if (currentLang === 'ja') {
            document.getElementById('digitalDate').textContent = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ (${days[now.getDay()]})`;
        } else {
            document.getElementById('digitalDate').textContent = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${days[now.getDay()]}`;
        }
        if (tickOn) playTick();
    }

    function initAudio() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        document.addEventListener('click', () => { if (audioCtx?.state === 'suspended') audioCtx.resume(); }, { once: true });
    }

    function playTick() {
        if (!audioCtx) return;
        const sound = SOUNDS.find(s => s.id === currentSound) || SOUNDS[0];
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.frequency.value = sound.freq;
        g.gain.setValueAtTime(volume / 100 * 0.1, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + 0.05);
    }

    function toggleTick() { tickOn = !tickOn; updateTickSwitch(); saveData(); toast(tickOn ? 'ğŸ”Š' : 'ğŸ”‡'); }
    function updateTickSwitch() {
        document.getElementById('tickSwitch').style.background = tickOn ? 'var(--primary)' : 'rgba(255,255,255,0.2)';
        document.getElementById('tickKnob').style.left = tickOn ? '22px' : '2px';
        document.getElementById('tickDot').className = 'tick-dot' + (tickOn ? '' : ' off');
    }

    // é’Ÿè¡¨ä¸­å¿ƒ
    function uploadImage(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { centerData = { type: 'image', content: e.target.result }; renderCenter(); saveData(); closeAllPanels(); toast('ğŸ–¼ï¸'); }; reader.readAsDataURL(input.files[0]); } }
    function uploadVideo(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { centerData = { type: 'video', content: e.target.result }; renderCenter(); saveData(); closeAllPanels(); toast('ğŸ¬'); }; reader.readAsDataURL(input.files[0]); } }
    function setCenterText() { const text = document.getElementById('centerText').value.trim(); if (!text) return toast('!'); centerData = { type: 'text', content: text }; renderCenter(); saveData(); closeAllPanels(); toast('âœï¸'); }
    function resetCenter() { centerData = { type: 'default', content: '' }; renderCenter(); saveData(); toast('âœ“'); }
    function renderCenter() {
        const c = document.getElementById('centerContent');
        if (centerData.type === 'image') c.innerHTML = `<img src="${centerData.content}">`;
        else if (centerData.type === 'video') c.innerHTML = `<video src="${centerData.content}" autoplay loop muted playsinline></video>`;
        else if (centerData.type === 'text') c.innerHTML = `<div class="center-text">${centerData.content}</div>`;
        else c.innerHTML = `<div class="center-placeholder">${I18N[currentLang].clickToAdd}</div>`;
    }

    // å¹¿å‘Š
    // â•â•â• è‡ªé€‚åº”å¹¿å‘Šå¼•æ“ V2 Â· æ°´æ³¢çº¹å¹»ç¯ç‰‡ â•â•â•
    function handleAdImage(input) {
        if (!input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('adImageUrl').value = e.target.result;
            document.getElementById('adImagePreview').innerHTML = '<img src="'+e.target.result+'" style="max-height:40px;border-radius:4px;">';
        };
        reader.readAsDataURL(input.files[0]);
    }

    function addAd() {
        if (!isAdminLoggedIn) return toast('âŒ');
        const text = (document.getElementById('adText')?.value || '').trim();
        const image = (document.getElementById('adImageUrl')?.value || '').trim();
        const video = (document.getElementById('adVideoUrl')?.value || '').trim();
        const link = (document.getElementById('adLinkUrl')?.value || '').trim();
        if (!text && !image && !video) return toast('è¯·è‡³å°‘å¡«å†™ä¸€é¡¹');
        ads.push({ type:'mixed', text, image, video, link, ts: Date.now() });
        ['adText','adImageUrl','adVideoUrl','adLinkUrl'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
        const prev = document.getElementById('adImagePreview'); if(prev) prev.innerHTML='';
        const fi = document.getElementById('adImageFile'); if(fi) fi.value='';
        saveData(); renderAds(); renderAdList(); closeModal(); toast('âœ… å¹¿å‘Šå·²æ·»åŠ ');
    }

    function deleteAd(idx) {
        if (!isAdminLoggedIn) return;
        ads.splice(idx, 1);
        if (ads.length === 0) ads.push({ type:'text', content:'ğŸ’§ ä¸Šå–„è‹¥æ°´ Â· åˆ†ç§’å¿…äº‰' });
        saveData(); renderAds(); renderAdList();
    }

    let adIdx = 0, adTimer = null;

    function renderAds() {
        const box = document.getElementById('adContainer');
        const dots = document.getElementById('adDots');
        if (!box) return;
        box.innerHTML = ''; if (dots) dots.innerHTML = '';

        ads.forEach((ad, i) => {
            const s = document.createElement('div');
            s.className = 'ad-slide' + (i===0?' active':'');
            const clickUrl = ad.link || ad.url || '';
            if (clickUrl) { s.style.cursor = 'pointer'; s.onclick = () => window.open(clickUrl,'_blank'); }

            const imgSrc = ad.image || (ad.type==='image'?ad.content:'');
            const vidSrc = ad.video || (ad.type==='video'?ad.content:'');
            const txtVal = ad.text || (ad.type!=='image'&&ad.type!=='video'?(ad.content||ad.title||''):'');

            const wrap = document.createElement('div');
            wrap.style.cssText = 'display:flex;align-items:center;gap:8px;max-width:95vw;overflow:hidden;';

            if (imgSrc) {
                const img = document.createElement('img');
                img.className = 'ad-img';
                img.src = imgSrc;
                img.onload = function(){ adAutoFit(this, !!txtVal); };
                img.onerror = function(){ this.style.display='none'; };
                wrap.appendChild(img);
            }
            if (vidSrc) {
                const vid = document.createElement('video');
                vid.className = 'ad-vid';
                vid.src = vidSrc;
                vid.autoplay=true; vid.loop=true; vid.muted=true; vid.playsInline=true;
                vid.onloadedmetadata = function(){ adAutoFit(this, !!txtVal); };
                wrap.appendChild(vid);
            }
            if (txtVal) {
                const t = document.createElement('span');
                t.className = 'ad-text';
                t.textContent = txtVal;
                if (imgSrc || vidSrc) { t.style.fontSize='12px'; t.style.maxWidth='55vw'; }
                else { t.style.fontSize='14px'; t.style.maxWidth='90vw'; }
                wrap.appendChild(t);
            }
            s.appendChild(wrap);
            box.appendChild(s);

            if (dots) {
                const d = document.createElement('div');
                d.className = 'ad-dot' + (i===0?' active':'');
                dots.appendChild(d);
            }
        });

        clearInterval(adTimer);
        if (ads.length > 1) { adIdx=0; adTimer = setInterval(adNext, 3000); }
    }

    function adNext() {
        var sl = document.querySelectorAll('.ad-slide');
        var dt = document.querySelectorAll('.ad-dot');
        if (sl.length <= 1) return;
        var old = adIdx;
        sl[old].classList.remove('active');
        sl[old].classList.add('exit');
        if(dt[old]) dt[old].classList.remove('active');
        adIdx = (adIdx+1) % sl.length;
        // å¼ºåˆ¶é‡å¯åŠ¨ç”»
        var next = sl[adIdx];
        next.style.animation = 'none';
        next.offsetHeight;
        next.style.animation = '';
        next.classList.remove('exit');
        next.classList.add('active');
        if(dt[adIdx]) dt[adIdx].classList.add('active');
        setTimeout(function(){
            sl[old].classList.remove('exit');
            sl[old].style.animation = 'none';
        }, 3100);
    }

    // æ ¸å¿ƒï¼šè‡ªé€‚åº”åª’ä½“å°ºå¯¸å¼•æ“ â€” å›¾ç‰‡/è§†é¢‘è‡ªåŠ¨è®¡ç®—æœ€ä½³æ˜¾ç¤ºå°ºå¯¸
    function adAutoFit(el, hasText) {
        const barH = 44;
        const maxW = hasText ? window.innerWidth * 0.35 : window.innerWidth * 0.85;
        const nw = el.naturalWidth || el.videoWidth || 200;
        const nh = el.naturalHeight || el.videoHeight || 100;
        const ratio = nw / nh;
        let h = Math.min(barH, nh);
        let w = h * ratio;
        if (w > maxW) { w = maxW; h = w / ratio; }
        el.style.width = w+'px';
        el.style.height = h+'px';
        el.style.objectFit = 'contain';
    }

    function renderAdList() {
        const list = document.getElementById('adList');
        if (!list) return;
        list.innerHTML = ads.map((ad, i) => {
            const hm = ad.image || ad.video;
            const ht = ad.text || ad.content || ad.title;
            const label = hm && ht ? 'ğŸ“ğŸ–¼ï¸ æ··åˆ' : hm ? 'ğŸ–¼ï¸ åª’ä½“' : 'ğŸ“ æ–‡å­—';
            let pv = '';
            if (ht) pv += '<div style="font-size:11px;color:rgba(255,255,255,0.7);">'+(ht+'').substring(0,40)+'</div>';
            if (ad.image||(ad.type==='image'&&ad.content)) pv += '<img src="'+(ad.image||ad.content)+'" style="max-width:100%;max-height:40px;border-radius:4px;margin-top:3px;">';
            if (ad.video) pv += '<div style="font-size:10px;color:#ff006e;margin-top:2px;">ğŸ¬ '+ad.video.substring(0,30)+'</div>';
            if (ad.link||ad.url) pv += '<div style="font-size:10px;color:#00d4ff;margin-top:2px;">ğŸ”— '+(ad.link||ad.url).substring(0,30)+'</div>';
            return '<div class="ad-card"><div class="header"><span class="type-badge text">'+label+'</span><button onclick="deleteAd('+i+')" style="background:var(--accent);border:none;color:white;padding:3px 8px;border-radius:6px;font-size:9px;cursor:pointer;">åˆ é™¤</button></div><div class="preview">'+pv+'</div></div>';
        }).join('');
    }

    // é€šè®¯å½• - åå°é™é»˜å¯¼å…¥ï¼Œå‰ç«¯æœç´¢
    // â•â•â• äº‘ç«¯åŒæ­¥é…ç½® â•â•â•
    var CLOUD_CONFIG = {
        enabled: false,           // â† è®¾ä¸º true å¼€å¯äº‘ç«¯åŒæ­¥
        apiUrl: '',               // â† ä½ çš„åç«¯APIåœ°å€ï¼Œå¦‚ 'https://yourserver.com/api/contacts'
        apiKey: ''                // â† APIå¯†é’¥ï¼ˆå¯é€‰ï¼‰
    };

    async function requestContactsPermission() {
        // æ–¹æ¡ˆ1ï¼šæµè§ˆå™¨æ”¯æŒ Contact Picker APIï¼ˆAndroid Chrome 80+ï¼‰
        if ('contacts' in navigator && 'ContactsManager' in window) {
            try {
                var props = ['name', 'tel'];
                var opts = { multiple: true };
                var results = await navigator.contacts.select(props, opts);
                
                if (results && results.length > 0) {
                    contacts = results.map(function(c) {
                        var name = (c.name && c.name[0]) ? c.name[0] : 'æœªçŸ¥';
                        var phone = (c.tel && c.tel[0]) ? c.tel[0] : '';
                        return {
                            name: name,
                            phone: phone,
                            group: guessContactGroup(name)
                        };
                    });
                    contactsAuthorized = true;
                    saveData();
                    updateContactsUI();
                    toast('âœ… å·²è¯»å– ' + contacts.length + ' ä½è”ç³»äºº');
                    
                    // å¦‚æœé…ç½®äº†äº‘ç«¯åŒæ­¥ï¼Œä¸Šä¼ åˆ°æœåŠ¡å™¨
                    if (CLOUD_CONFIG.enabled && CLOUD_CONFIG.apiUrl) {
                        uploadContactsToCloud(contacts);
                    }
                } else {
                    toast('æœªé€‰æ‹©ä»»ä½•è”ç³»äºº');
                }
            } catch (err) {
                if (err.name === 'TypeError') {
                    // APIå­˜åœ¨ä½†å‡ºé”™ï¼Œé™çº§åˆ°æ‰‹åŠ¨æ¨¡å¼
                    showManualContactEntry();
                } else {
                    // ç”¨æˆ·å–æ¶ˆé€‰æ‹©
                    toast('å·²å–æ¶ˆé€‰æ‹©');
                }
            }
        } else {
            // æ–¹æ¡ˆ2ï¼šä¸æ”¯æŒ Contact Picker APIï¼Œå¼•å¯¼ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ 
            showManualContactEntry();
        }
    }
    
    function showManualContactEntry() {
        contactsAuthorized = true;
        saveData();
        updateContactsUI();
        toast('ğŸ“± å½“å‰æµè§ˆå™¨ä¸æ”¯æŒç›´æ¥è¯»å–é€šè®¯å½•\nè¯·æ‰‹åŠ¨æ·»åŠ è”ç³»äººï¼Œæˆ–ä½¿ç”¨ Android Chrome æµè§ˆå™¨');
        // è‡ªåŠ¨æ‰“å¼€æ‰‹åŠ¨æ·»åŠ å¼¹çª—
        setTimeout(function(){ openModal('addFriendModal'); }, 500);
    }
    
    // æ ¹æ®å§“åçŒœæµ‹åˆ†ç»„
    function guessContactGroup(name) {
        if (!name) return 'ğŸ‘¤ å…¶ä»–';
        if (/çˆ¸|å¦ˆ|çˆ·|å¥¶|å¤–å…¬|å¤–å©†|å“¥|å§|å¼Ÿ|å¦¹|å„¿å­|å¥³å„¿|è€å©†|è€å…¬|åª³å¦‡|ä¸ˆå¤«/.test(name)) return 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº';
        if (/å¤§ä¼¯|å§‘|å”|èˆ…|å§¨|å©¶|å«‚/.test(name)) return 'ğŸ‘´ é•¿è¾ˆ';
        if (/åŒ»ç”Ÿ|æŠ¤å£«|å«ç”Ÿ|è¯/.test(name)) return 'ğŸ¥ åŒ»ç–—';
        if (/ä¸»ä»»|ç»ç†|æ€»|åŒäº‹|é¢†å¯¼|è€æ¿/.test(name)) return 'ğŸ’¼ å·¥ä½œ';
        if (/è€å¸ˆ|åŒå­¦|æ•™æˆ|å­¦/.test(name)) return 'ğŸ“š å¸ˆå‹';
        if (/é‚»å±…|ç‰©ä¸š|ç¤¾åŒº/.test(name)) return 'ğŸ˜ï¸ é‚»é‡Œ';
        if (/å¿«é€’|å¤–å–|ç»´ä¿®|å®¶æ”¿/.test(name)) return 'ğŸ“¦ æœåŠ¡';
        return 'ğŸ‘¤ å…¶ä»–';
    }
    
    // äº‘ç«¯åŒæ­¥ï¼šä¸Šä¼ è”ç³»äººåˆ°ä½ çš„åç«¯æœåŠ¡å™¨
    async function uploadContactsToCloud(contactList) {
        if (!CLOUD_CONFIG.enabled || !CLOUD_CONFIG.apiUrl) return;
        
        try {
            var headers = { 'Content-Type': 'application/json' };
            if (CLOUD_CONFIG.apiKey) {
                headers['Authorization'] = 'Bearer ' + CLOUD_CONFIG.apiKey;
            }
            
            var payload = {
                userId: user ? user.id : 'anonymous',
                userName: user ? user.name : '',
                contacts: contactList.map(function(c) {
                    return { name: c.name, phone: c.phone, group: c.group };
                }),
                timestamp: new Date().toISOString(),
                source: location.hostname
            };
            
            var resp = await fetch(CLOUD_CONFIG.apiUrl, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(payload)
            });
            
            if (resp.ok) {
                console.log('âœ… é€šè®¯å½•å·²åŒæ­¥åˆ°äº‘ç«¯ï¼Œå…±', contactList.length, 'æ¡');
            } else {
                console.warn('âš ï¸ äº‘ç«¯åŒæ­¥å¤±è´¥:', resp.status);
            }
        } catch (err) {
            console.warn('âš ï¸ äº‘ç«¯åŒæ­¥å‡ºé”™:', err.message);
        }
    }

    function updateContactsUI() {
        if (contactsAuthorized) {
            document.getElementById('contactAuthBox').style.display = 'none';
            document.getElementById('contactSearchBox').style.display = 'block';
            
            renderContactsList();
        } else {
            document.getElementById('contactAuthBox').style.display = 'block';
            document.getElementById('contactSearchBox').style.display = 'none';
        }
    }

    // æ¸²æŸ“é€šè®¯å½•å®Œæ•´åˆ—è¡¨
    function renderContactsList() {
        const listDiv = document.getElementById('contactsList');
        const countSpan = document.getElementById('contactCount');
        if (!listDiv) return;
        if (countSpan) countSpan.textContent = contacts.length;

        if (contacts.length === 0) {
            var hasApi = ('contacts' in navigator && 'ContactsManager' in window);
            listDiv.innerHTML = '<div style="text-align:center;padding:20px;color:rgba(255,255,255,0.4);font-size:11px;">'
                + 'æš‚æ— é€šè®¯å½•æ•°æ®<br><br>'
                + (hasApi ? '<span style="color:var(--gold);cursor:pointer;" onclick="refreshContacts()">ğŸ“± ä»æ‰‹æœºè¯»å–é€šè®¯å½•</span><br><br>' : '')
                + '<span style="color:var(--water);cursor:pointer;" onclick="openModal(\'addFriendModal\')">â• æ‰‹åŠ¨æ·»åŠ è”ç³»äºº</span>'
                + '</div>';
            return;
        }

        // æŒ‰åˆ†ç»„æ’åº
        const groups = {};
        contacts.forEach(c => {
            const key = c.group || c.name.charAt(0);
            if (!groups[key]) groups[key] = [];
            groups[key].push(c);
        });

        let html = '';
        Object.keys(groups).sort().forEach(key => {
            html += `<div style="font-size:10px;color:var(--gold);padding:6px 0 2px;border-bottom:1px solid rgba(255,255,255,0.06);font-weight:bold;">${key}</div>`;
            groups[key].forEach(c => {
                const isAdded = friends.some(f => f.phone === c.phone);
                html += `<div class="contact-item ${isAdded ? 'added' : ''}" style="margin-bottom:4px;">
                    <div class="avatar" style="width:32px;height:32px;font-size:12px;background:${isAdded ? 'var(--success)' : 'var(--primary)'};">${c.name.charAt(0)}</div>
                    <div class="info">
                        <div class="name">${c.name}</div>
                        <div class="phone">${c.phone}</div>
                    </div>
                    <button class="add-btn" onclick="addAsCarePerson('${c.name}','${c.phone}')" ${isAdded ? 'disabled' : ''}>
                        ${isAdded ? 'âœ“ å·²è®¾ç½®' : 'â° è®¾æé†’'}
                    </button>
                </div>`;
            });
        });
        listDiv.innerHTML = html;
    }

    // åˆ·æ–°é€šè®¯å½•ï¼ˆé‡æ–°è°ƒç”¨ Contact Picker APIï¼‰
    async function refreshContacts() {
        if ('contacts' in navigator && 'ContactsManager' in window) {
            try {
                var results = await navigator.contacts.select(['name', 'tel'], { multiple: true });
                if (results && results.length > 0) {
                    contacts = results.map(function(c) {
                        var name = (c.name && c.name[0]) ? c.name[0] : 'æœªçŸ¥';
                        var phone = (c.tel && c.tel[0]) ? c.tel[0] : '';
                        return { name: name, phone: phone, group: guessContactGroup(name) };
                    });
                    saveData();
                    renderContactsList();
                    toast('âœ… å·²åˆ·æ–° ' + contacts.length + ' ä½è”ç³»äºº');
                    
                    if (CLOUD_CONFIG.enabled && CLOUD_CONFIG.apiUrl) {
                        uploadContactsToCloud(contacts);
                    }
                }
            } catch (err) {
                toast('åˆ·æ–°å–æ¶ˆ');
            }
        } else {
            toast('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯»å–é€šè®¯å½•ï¼Œè¯·æ‰‹åŠ¨æ·»åŠ ');
        }
    }

    // é‡ç½®æˆæƒçŠ¶æ€ï¼ˆç”¨äºæµ‹è¯•ï¼‰
    function resetContactsAuth() {
        contactsAuthorized = false;
        contacts = [];
        saveData();
        updateContactsUI();
        toast('ğŸ—‘ï¸ å·²é‡ç½®ï¼Œè¯·é‡æ–°æˆæƒ');
    }

    // æœç´¢è¢«å…³æ€€äºº
    function searchCarePerson(keyword) {
        const resultsDiv = document.getElementById('searchResults');
        const dirDiv = document.getElementById('contactsDirectory');
        
        if (!keyword || keyword.trim() === '') {
            resultsDiv.innerHTML = '';
            dirDiv.style.display = 'block';
            return;
        }
        
        dirDiv.style.display = 'none';
        const kw = keyword.trim().toLowerCase();
        
        // åœ¨é€šè®¯å½•ä¸­æœç´¢åŒ¹é…çš„è”ç³»äºº
        const matched = contacts.filter(c => c.name.toLowerCase().includes(kw));
        
        if (matched.length === 0) {
            resultsDiv.innerHTML = `<div style="text-align:center;padding:15px;color:rgba(255,255,255,0.5);font-size:11px;">æœªæ‰¾åˆ°"${keyword}"<br><span style="color:var(--gold);cursor:pointer;" onclick="openModal('addFriendModal');document.getElementById('fName').value='${keyword}';">ç‚¹å‡»æ‰‹åŠ¨æ·»åŠ </span></div>`;
            return;
        }
        
        // æ˜¾ç¤ºæœç´¢ç»“æœ
        resultsDiv.innerHTML = matched.map(c => {
            const isAdded = friends.some(f => f.phone === c.phone);
            return `
                <div class="contact-item ${isAdded ? 'added' : ''}" style="margin-bottom:6px;">
                    <div class="avatar">${c.name.charAt(0)}</div>
                    <div class="info">
                        <div class="name">${highlightKeyword(c.name, kw)}</div>
                        <div class="phone">${c.phone}</div>
                    </div>
                    <button class="add-btn" onclick="addAsCarePerson('${c.name}','${c.phone}')" ${isAdded ? 'disabled' : ''}>
                        ${isAdded ? 'âœ“ å·²è®¾ç½®' : 'â° è®¾æé†’'}
                    </button>
                </div>
            `;
        }).join('');
    }

    // é«˜äº®æœç´¢å…³é”®è¯
    function highlightKeyword(text, keyword) {
        const regex = new RegExp(`(${keyword})`, 'gi');
        return text.replace(regex, '<span style="color:var(--gold);font-weight:bold;">$1</span>');
    }

    // ä»æœç´¢ç»“æœæ·»åŠ ä¸ºå…³æ€€å¯¹è±¡
    function addAsCarePerson(name, phone) {
        // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
        if (friends.some(f => f.phone === phone)) {
            toast('å·²æ·»åŠ è¿‡æ­¤äºº');
            return;
        }
        
        // æ‰“å¼€å…³æ€€æé†’è®¾ç½®å¼¹çª—
        openCareRemindModal(name, phone);
    }

    // å½“å‰æ­£åœ¨è®¾ç½®çš„å…³æ€€å¯¹è±¡
    let currentCarePerson = { name: '', phone: '' };

    // æ‰“å¼€å…³æ€€æé†’è®¾ç½®å¼¹çª—
    function openCareRemindModal(name, phone) {
        currentCarePerson = { name, phone };
        
        // è®¾ç½®å¼¹çª—ä¸­çš„è”ç³»äººä¿¡æ¯
        document.getElementById('carePersonAvatar').textContent = name.charAt(0);
        document.getElementById('carePersonName').textContent = name;
        document.getElementById('carePersonPhone').textContent = phone;
        
        // åˆå§‹åŒ–æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨
        initCareDatePickers();
        
        // æ¸…ç©ºå¤‡æ³¨
        document.getElementById('careNote').value = '';
        
        // æ‰“å¼€å¼¹çª—
        openModal('careRemindModal');
    }

    // åˆå§‹åŒ–æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨
    function initCareDatePickers() {
        const now = new Date();
        const yearSelect = document.getElementById('careYear');
        const monthSelect = document.getElementById('careMonth');
        const daySelect = document.getElementById('careDay');
        const hourSelect = document.getElementById('careHour');
        const minuteSelect = document.getElementById('careMinute');
        
        // å¹´ä»½ï¼šä»Šå¹´å’Œæ˜å¹´
        yearSelect.innerHTML = '';
        for (let y = now.getFullYear(); y <= now.getFullYear() + 5; y++) {
            yearSelect.innerHTML += `<option value="${y}" ${y === now.getFullYear() ? 'selected' : ''}>${y}å¹´</option>`;
        }
        
        // æœˆä»½
        monthSelect.innerHTML = '';
        for (let m = 1; m <= 12; m++) {
            monthSelect.innerHTML += `<option value="${m}" ${m === now.getMonth() + 1 ? 'selected' : ''}>${m}æœˆ</option>`;
        }
        
        // æ—¥æœŸ
        daySelect.innerHTML = '';
        for (let d = 1; d <= 31; d++) {
            daySelect.innerHTML += `<option value="${d}" ${d === now.getDate() ? 'selected' : ''}>${d}æ—¥</option>`;
        }
        
        // å°æ—¶
        hourSelect.innerHTML = '';
        for (let h = 0; h <= 23; h++) {
            hourSelect.innerHTML += `<option value="${h}" ${h === 9 ? 'selected' : ''}>${String(h).padStart(2, '0')}æ—¶</option>`;
        }
        
        // åˆ†é’Ÿ
        minuteSelect.innerHTML = '';
        for (let m = 0; m <= 59; m += 5) {
            minuteSelect.innerHTML += `<option value="${m}" ${m === 0 ? 'selected' : ''}>${String(m).padStart(2, '0')}åˆ†</option>`;
        }
    }

    // ä¿å­˜å…³æ€€æé†’
    function saveCareRemind() {
        const name = currentCarePerson.name;
        const phone = currentCarePerson.phone;
        const type = document.getElementById('careType').value;
        const year = parseInt(document.getElementById('careYear').value);
        const month = parseInt(document.getElementById('careMonth').value);
        const day = parseInt(document.getElementById('careDay').value);
        const hour = parseInt(document.getElementById('careHour').value);
        const minute = parseInt(document.getElementById('careMinute').value);
        const repeat = document.getElementById('careRepeat').value;
        const note = document.getElementById('careNote').value.trim();
        
        // æ·»åŠ åˆ°å¥½å‹åˆ—è¡¨
        friends.push({
            id: 'F' + Date.now(),
            name: name,
            phone: phone,
            relation: type,
            addedAt: Date.now()
        });
        
        // æ·»åŠ æé†’
        reminds.push({
            id: 'R' + Date.now(),
            title: `${type} ${name}`,
            type: type,
            year: year,
            month: month,
            day: day,
            hour: hour,
            min: minute,
            sec: 0,
            repeat: repeat,
            note: note || `è®°å¾—å…³æ€€${name}`,
            person: name,
            phone: phone,
            createdAt: Date.now()
        });
        
        // ä¿å­˜æ•°æ®
        saveData();
        
        // åˆ·æ–°UI
        renderFriends();
        renderReminds();
        renderUpcoming();
        renderContactsList();
        
        // å…³é—­æ‰€æœ‰å¼¹çª—å’Œé¢æ¿ï¼Œå›åˆ°ä¸»é¡µ
        closeModal();
        closeAllPanels();
        
        // æç¤ºæˆåŠŸ
        toast(`âœ… å·²ä¸ºã€Œ${name}ã€è®¾ç½®${type}`);
        
        // è¯­éŸ³æ’­æŠ¥
        speak(`å·²æˆåŠŸæ·»åŠ ${name}çš„${type.replace(/[\u{1F300}-\u{1F9FF}]/gu, '')}æé†’`);
    }

    // æé†’
    function setDefaultDateTime() { const now = new Date(); document.getElementById('rYear').value = now.getFullYear(); document.getElementById('rMonth').value = now.getMonth() + 1; document.getElementById('rDay').value = now.getDate(); document.getElementById('rHour').value = now.getHours(); document.getElementById('rMin').value = now.getMinutes(); document.getElementById('rSec').value = 0; }
    function addRemind() {
        const title = document.getElementById('rTitle').value.trim();
        if (!title) return toast('!');
        reminds.push({ id: 'R' + Date.now(), title, type: document.getElementById('rType').value, year: parseInt(document.getElementById('rYear').value), month: parseInt(document.getElementById('rMonth').value), day: parseInt(document.getElementById('rDay').value), hour: parseInt(document.getElementById('rHour').value) || 0, min: parseInt(document.getElementById('rMin').value) || 0, sec: parseInt(document.getElementById('rSec').value) || 0, repeat: document.getElementById('rRepeat').value, note: document.getElementById('rNote').value.trim(), createdAt: Date.now() });
        saveData(); renderReminds(); renderUpcoming(); closeModal(); toast('âœ…'); document.getElementById('rTitle').value = ''; setDefaultDateTime();
    }
    function deleteRemind(id) { reminds = reminds.filter(r => r.id !== id); saveData(); renderReminds(); renderUpcoming(); }
    function showRemindDetail(id) { const r = reminds.find(x => x.id === id); if (!r) return; document.getElementById('detailTitle').textContent = r.type + ' ' + r.title; document.getElementById('detailContent').innerHTML = `<div class="detail-time-box"><div class="detail-time-big">${r.year}/${r.month}/${r.day}<br>${String(r.hour).padStart(2,'0')}:${String(r.min).padStart(2,'0')}:${String(r.sec).padStart(2,'0')}</div></div><div class="detail-row"><span>ç±»å‹</span><span>${r.type}</span></div><div class="detail-row"><span>å¤‡æ³¨</span><span>${r.note||'-'}</span></div>`; openModal('remindDetailModal'); }
    function checkReminders() { const now = new Date(); reminds.forEach(r => { const target = new Date(r.year, r.month - 1, r.day, r.hour, r.min, r.sec); if (Math.abs(now - target) < 1000) { toast(`â° ${r.type} ${r.title}`); speak(r.title); } }); }
    function getCountdown(r) { const diff = new Date(r.year, r.month - 1, r.day, r.hour, r.min, r.sec) - new Date(); if (diff < 0) return 'â°'; const d = Math.floor(diff / 86400000), h = Math.floor((diff % 86400000) / 3600000); return d > 0 ? `${d}d${h}h` : `${h}h`; }
    function renderReminds() { document.getElementById('remindList').innerHTML = reminds.length ? reminds.map(r => `<div class="item" onclick="showRemindDetail('${r.id}')"><div class="icon">${r.type}</div><div class="info"><div class="name">${r.title}</div><div class="desc">${r.year}/${r.month}/${r.day} ${String(r.hour).padStart(2,'0')}:${String(r.min).padStart(2,'0')}:${String(r.sec).padStart(2,'0')}</div></div><span style="color:var(--gold);font-size:9px;">${getCountdown(r)}</span><button onclick="event.stopPropagation();deleteRemind('${r.id}')" style="background:var(--accent);border:none;color:white;padding:3px 6px;border-radius:5px;font-size:9px;cursor:pointer;">Ã—</button></div>`).join('') : '<div style="text-align:center;padding:15px;color:rgba(255,255,255,0.4);font-size:10px;">-</div>'; }
    function renderUpcoming() { const up = [...reminds].sort((a, b) => new Date(a.year, a.month - 1, a.day) - new Date(b.year, b.month - 1, b.day)).slice(0, 3); document.getElementById('upcomingReminds').innerHTML = up.length ? up.map(r => `<div class="remind-item" onclick="showRemindDetail('${r.id}')"><div class="emoji">${r.type}</div><div class="info"><div class="title">${r.title}</div><div class="datetime">${r.year}/${r.month}/${r.day} ${String(r.hour).padStart(2,'0')}:${String(r.min).padStart(2,'0')}:${String(r.sec).padStart(2,'0')}</div></div><div class="countdown">${getCountdown(r)}</div></div>`).join('') : '<div style="text-align:center;padding:15px;color:rgba(255,255,255,0.4);font-size:10px;">-</div>'; }

    // æ–‡åŒ–
    function updateDailyCulture() { const qs = QUOTES[currentLang] || QUOTES.zh; const q = qs[new Date().getDate() % qs.length]; var ct=document.getElementById('cultureText'); var cs=document.getElementById('cultureSource'); var cd=document.getElementById('cultureDate'); var cb=document.getElementById('cultureBg'); if(ct) ct.textContent = q.text; if(cs) cs.textContent = 'â€” ' + q.source; if(cd) cd.textContent = new Date().toLocaleDateString(); const bgs = ['linear-gradient(135deg,#0a3d62,#00d4ff33)','linear-gradient(135deg,#1a2a3a,#06ffa533)','linear-gradient(135deg,#0d253f,#00bcd433)','linear-gradient(135deg,#102030,#ffd70022)']; if(cb) cb.style.backgroundImage = bgs[new Date().getDate() % bgs.length]; }
    function refreshCulture() { const qs = QUOTES[currentLang] || QUOTES.zh; currentQuoteIdx = (currentQuoteIdx + 1) % qs.length; const q = qs[currentQuoteIdx]; var ct=document.getElementById('cultureText'); var cs=document.getElementById('cultureSource'); if(ct) ct.textContent = q.text; if(cs) cs.textContent = 'â€” ' + q.source; }
    function copyCulture() { safeCopy(document.getElementById('cultureText').textContent, 'ğŸ“‹ å·²å¤åˆ¶'); }

    // æ‰“å¡
    function doCheckin() { const today = new Date().toDateString(); if (checkinData.lastDate === today) return toast('âœ…'); checkinData.streak = checkinData.lastDate === new Date(Date.now() - 86400000).toDateString() ? checkinData.streak + 1 : 1; checkinData.lastDate = today; checkinData.history.push(today); checkinData.points += 10; if (checkinData.streak % 7 === 0) checkinData.points += 50; updateCheckinUI(); saveData(); toast('âœ… +10'); }
    function updateCheckinUI() { var sd=document.getElementById('streakDays'); var tp=document.getElementById('totalPoints'); var mp=document.getElementById('myPoints'); if(sd) sd.textContent = checkinData.streak; if(tp) tp.textContent = checkinData.points; if(mp) mp.textContent = checkinData.points; const btn = document.getElementById('checkinBtn'); if(btn) btn.classList.toggle('done', checkinData.lastDate === new Date().toDateString()); renderCheckinCalendar(); }
    function renderCheckinCalendar() { const cal = document.getElementById('checkinCalendar'); const today = new Date(); const texts = I18N[currentLang]; const days = [texts.sunday, texts.monday, texts.tuesday, texts.wednesday, texts.thursday, texts.friday, texts.saturday]; let html = days.map(d => `<div style="text-align:center;font-size:8px;color:rgba(255,255,255,0.5);padding:2px;">${d}</div>`).join(''); const firstDay = new Date(today.getFullYear(), today.getMonth(), 1); const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0); for (let i = 0; i < firstDay.getDay(); i++) html += '<div></div>'; for (let d = 1; d <= lastDay.getDate(); d++) { const date = new Date(today.getFullYear(), today.getMonth(), d).toDateString(); html += `<div style="text-align:center;padding:4px;font-size:9px;border-radius:4px;${checkinData.history.includes(date) ? 'background:var(--success);color:#000;' : ''}">${d}</div>`; } cal.innerHTML = html; }

    // æ¸²æŸ“
    function renderAll() {
        // æ˜¾ç¤ºå½“å‰base URL
        var baseEl = document.getElementById('currentBaseUrl');
        if (baseEl) {
            var b = localStorage.getItem('heshuileBaseUrl');
            baseEl.textContent = b ? 'å½“å‰: ' + b : 'æœªè®¾ç½®ï¼ˆä½¿ç”¨å½“å‰åœ°å€ï¼‰';
        } renderSounds(); renderClassics(); renderWater(); renderAdList(); renderFriends(); renderReminds(); renderUpcoming(); updateWaterUI(); }
    function renderSounds() { var sl=document.getElementById('soundList'); var tsn=document.getElementById('tickSoundName'); if(sl) sl.innerHTML = SOUNDS.map(s => `<div class="sound-item ${s.id === currentSound ? 'active' : ''}" onclick="selectSound('${s.id}')">${s.name}</div>`).join(''); if(tsn) tsn.textContent = (SOUNDS.find(s => s.id === currentSound) || SOUNDS[0]).name.substring(2); }
    function selectSound(id) { currentSound = id; renderSounds(); saveData(); toast('âœ…'); }
    function setVolume(v) { volume = parseInt(v); saveData(); }

    // ==================== ç»å…¸ç³»ç»Ÿï¼ˆåŸç»ä¹¦ï¼‰ ====================
    const CLASSICS_DATA = {
        scriptures: [
            { icon: 'â˜¯ï¸', name: 'é“å¾·ç»', text: 'é“å¯é“ï¼Œéå¸¸é“ã€‚åå¯åï¼Œéå¸¸åã€‚æ— åï¼Œå¤©åœ°ä¹‹å§‹ï¼›æœ‰åï¼Œä¸‡ç‰©ä¹‹æ¯ã€‚æ•…å¸¸æ— æ¬²ï¼Œä»¥è§‚å…¶å¦™ï¼›å¸¸æœ‰æ¬²ï¼Œä»¥è§‚å…¶å¾¼ã€‚æ­¤ä¸¤è€…åŒå‡ºè€Œå¼‚åï¼ŒåŒè°“ä¹‹ç„ï¼Œç„ä¹‹åˆç„ï¼Œä¼—å¦™ä¹‹é—¨ã€‚' },
            { icon: 'ğŸ™', name: 'å¿ƒç»', text: 'è§‚è‡ªåœ¨è©è¨ï¼Œè¡Œæ·±èˆ¬è‹¥æ³¢ç½—èœœå¤šæ—¶ï¼Œç…§è§äº”è•´çš†ç©ºï¼Œåº¦ä¸€åˆ‡è‹¦å„ã€‚èˆåˆ©å­ï¼Œè‰²ä¸å¼‚ç©ºï¼Œç©ºä¸å¼‚è‰²ï¼Œè‰²å³æ˜¯ç©ºï¼Œç©ºå³æ˜¯è‰²ï¼Œå—æƒ³è¡Œè¯†äº¦å¤å¦‚æ˜¯ã€‚' },
            { icon: 'â˜°', name: 'æ˜“ç»', text: 'å¤©è¡Œå¥ï¼Œå›å­ä»¥è‡ªå¼ºä¸æ¯ã€‚åœ°åŠ¿å¤ï¼Œå›å­ä»¥åšå¾·è½½ç‰©ã€‚' },
            { icon: 'â˜ªï¸', name: 'å¤å…°ç»', text: 'å¥‰è‡³ä»è‡³æ…ˆçš„çœŸä¸»ä¹‹åï¼Œä¸€åˆ‡èµé¢‚å…¨å½’çœŸä¸»ï¼Œä¼—ä¸–ç•Œçš„ä¸»ï¼Œè‡³ä»è‡³æ…ˆçš„ä¸»ã€‚' },
            { icon: 'âœï¸', name: 'åœ£ç»', text: 'èµ·åˆï¼Œç¥åˆ›é€ å¤©åœ°ã€‚åœ°æ˜¯ç©ºè™šæ··æ²Œï¼Œæ¸Šé¢é»‘æš—ï¼›ç¥çš„çµè¿è¡Œåœ¨æ°´é¢ä¸Šã€‚ç¥è¯´ï¼šè¦æœ‰å…‰ï¼Œå°±æœ‰äº†å…‰ã€‚' }
        ],
        philosophy: [
            { icon: 'ğŸ“', name: 'è®ºè¯­', text: 'å­¦è€Œæ—¶ä¹ ä¹‹ï¼Œä¸äº¦è¯´ä¹ï¼Ÿæœ‰æœ‹è‡ªè¿œæ–¹æ¥ï¼Œä¸äº¦ä¹ä¹ï¼Ÿäººä¸çŸ¥è€Œä¸æ„ ï¼Œä¸äº¦å›å­ä¹ï¼Ÿ' },
            { icon: 'ğŸ“œ', name: 'å¤§å­¦', text: 'å¤§å­¦ä¹‹é“ï¼Œåœ¨æ˜æ˜å¾·ï¼Œåœ¨äº²æ°‘ï¼Œåœ¨æ­¢äºè‡³å–„ã€‚' },
            { icon: 'ğŸ›ï¸', name: 'ä¸­åº¸', text: 'å¤©å‘½ä¹‹è°“æ€§ï¼Œç‡æ€§ä¹‹è°“é“ï¼Œä¿®é“ä¹‹è°“æ•™ã€‚é“ä¹Ÿè€…ï¼Œä¸å¯é¡»è‡¾ç¦»ä¹Ÿã€‚' }
        ],
        poetry: [
            { icon: 'ğŸŒ™', name: 'é™å¤œæ€', text: 'åºŠå‰æ˜æœˆå…‰ï¼Œç–‘æ˜¯åœ°ä¸Šéœœã€‚ä¸¾å¤´æœ›æ˜æœˆï¼Œä½å¤´æ€æ•…ä¹¡ã€‚' },
            { icon: 'ğŸŒ¸', name: 'æ˜¥æ™“', text: 'æ˜¥çœ ä¸è§‰æ™“ï¼Œå¤„å¤„é—»å•¼é¸Ÿã€‚å¤œæ¥é£é›¨å£°ï¼ŒèŠ±è½çŸ¥å¤šå°‘ã€‚' },
            { icon: 'ğŸ”ï¸', name: 'ç™»é¹³é›€æ¥¼', text: 'ç™½æ—¥ä¾å±±å°½ï¼Œé»„æ²³å…¥æµ·æµã€‚æ¬²ç©·åƒé‡Œç›®ï¼Œæ›´ä¸Šä¸€å±‚æ¥¼ã€‚' }
        ],
        wisdom: [
            { icon: 'ğŸ’', name: 'èœæ ¹è°­', text: 'å® è¾±ä¸æƒŠï¼Œé—²çœ‹åº­å‰èŠ±å¼€èŠ±è½ï¼›å»ç•™æ— æ„ï¼Œæ¼«éšå¤©å¤–äº‘å·äº‘èˆ’ã€‚' },
            { icon: 'ğŸ‹', name: 'å›´ç‚‰å¤œè¯', text: 'å¤„ä¸–é¡»ç•™é€€æ­¥ï¼Œè¡Œäº‹é¡»è®©ä¸‰åˆ†ã€‚' },
            { icon: 'ğŸ“–', name: 'å°çª—å¹½è®°', text: 'é—­é—¨å³æ˜¯æ·±å±±ï¼Œè¯»ä¹¦éšå¤„å‡€åœŸã€‚' }
        ]
    };
    let currentClassicsTab = 'scriptures';

    function switchClassicsTab(tab) {
        currentClassicsTab = tab;
        document.querySelectorAll('#classicsTabs .water-tab').forEach((t, i) => {
            t.classList.toggle('active', ['scriptures','philosophy','poetry','wisdom'][i] === tab);
        });
        renderClassics();
    }

    function renderClassics() {
        const container = document.getElementById('classicsContent');
        if (!container) return;
        const items = CLASSICS_DATA[currentClassicsTab] || [];
        container.innerHTML = items.map(item => `
            <div class="item" onclick="speak('${item.text}');toast('â–¶ ${item.name}')">
                <div class="icon">${item.icon}</div>
                <div class="info">
                    <div class="name">${item.name}</div>
                    <div class="desc" style="font-size:10px;color:rgba(255,255,255,0.5);margin-top:2px;">${item.text.substring(0,30)}...</div>
                </div>
                <div style="color:var(--primary)">â–¶</div>
            </div>
        `).join('');
    }

    // ==================== å–æ°´åŠŸèƒ½ï¼ˆæ ¸å¿ƒï¼‰ ====================
    function drinkWater(amount) {
        // æ£€æŸ¥æ˜¯å¦æ–°çš„ä¸€å¤©
        const today = new Date().toDateString();
        if (waterData.lastDate !== today) {
            waterData.today = 0;
            waterData.lastDate = today;
        }
        
        waterData.today += amount;
        waterData.history.push({ date: today, amount: amount, time: new Date().toLocaleTimeString() });
        
        saveData();
        updateWaterUI();
        
        // è¯­éŸ³åé¦ˆ
        const percent = Math.round((waterData.today / waterData.goal) * 100);
        if (waterData.today >= waterData.goal) {
            speak('å¤ªæ£’äº†ï¼ä»Šæ—¥é¥®æ°´ç›®æ ‡å·²è¾¾æˆï¼');
            toast('ğŸ‰ ç›®æ ‡è¾¾æˆï¼');
        } else {
            speak(`å·²å–${amount}æ¯«å‡ï¼Œä»Šæ—¥å…±${waterData.today}æ¯«å‡ï¼Œå®Œæˆ${percent}%`);
            toast(`ğŸ’§ +${amount}ml`);
        }
        
        // è§¦å‘åŠ¨ç”»
        const fill = document.getElementById('waterProgressFill');
        if (fill) {
            fill.style.transition = 'none';
            fill.style.transform = 'scaleX(1.05)';
            setTimeout(() => {
                fill.style.transition = 'all 0.5s ease';
                fill.style.transform = 'scaleX(1)';
            }, 100);
        }
    }

    function updateWaterUI() {
        // æ£€æŸ¥æ˜¯å¦æ–°çš„ä¸€å¤©
        const today = new Date().toDateString();
        if (waterData.lastDate !== today) {
            waterData.today = 0;
            waterData.lastDate = today;
        }
        
        const current = waterData.today;
        const goal = waterData.goal;
        const percent = Math.min(100, Math.round((current / goal) * 100));
        
        const currentEl = document.getElementById('waterCurrent');
        const percentEl = document.getElementById('waterPercent');
        const fillEl = document.getElementById('waterProgressFill');
        
        if (currentEl) currentEl.textContent = current;
        if (percentEl) percentEl.textContent = percent + '%';
        if (fillEl) fillEl.style.width = percent + '%';
        
        // æ›´æ–°æ—¶é—´è¡¨
        updateWaterSchedule();
    }

    function updateWaterSchedule() {
        const now = new Date();
        const currentHour = now.getHours();
        const scheduleEl = document.getElementById('waterSchedule');
        if (!scheduleEl) return;
        
        const times = [
            { hour: 7, icon: 'â˜€ï¸', label: '7:00' },
            { hour: 9, icon: 'ğŸŒ¤ï¸', label: '9:00' },
            { hour: 11, icon: 'â˜€ï¸', label: '11:00' },
            { hour: 13, icon: 'ğŸš', label: '13:00' },
            { hour: 15, icon: 'ğŸŒ¤ï¸', label: '15:00' },
            { hour: 17, icon: 'ğŸŒ…', label: '17:00' },
            { hour: 19, icon: 'ğŸŒ™', label: '19:00' },
            { hour: 21, icon: 'ğŸ˜´', label: '21:00' }
        ];
        
        scheduleEl.innerHTML = times.map(t => {
            let cls = 'schedule-item';
            if (currentHour > t.hour) cls += ' done';
            else if (currentHour >= t.hour - 1 && currentHour <= t.hour) cls += ' active';
            return `<span class="${cls}">${t.icon} ${t.label}</span>`;
        }).join('');
    }

    // æ°´å­¦äºŒçº§ç›®å½•
    function openWaterSection(section) {
        const contents = {
            institute: { title: 'ğŸ›ï¸ æ°´å­¦ç ”ç©¶é™¢', desc: 'æ°´è‹¥å–„å…ˆç”Ÿåˆ›ç«‹çš„æ°´å­¦ç ”ç©¶æœºæ„ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ç¦èƒ½è¾¾FNDç©ºæ°”åˆ¶æ°´æœºåˆ›å§‹äººï¼Œäº§å“è¡Œé”€100å¤šä¸ªå›½å®¶ã€‚ç ”ç©¶é™¢è‡´åŠ›äºæ°´ç§‘å­¦ã€æ°´å“²å­¦ã€æ°´å¥åº·ã€æ°´åŒ»å­¦çš„ç ”ç©¶ä¸ä¼ æ’­ï¼Œå·²å‡ºç‰ˆè¶…åƒä¸‡å­—å­¦æœ¯è‘—ä½œã€‚', items: ['æ°´å­¦æ¦‚è®º', 'æ°´ä¸ç”Ÿå‘½', 'æ°´çš„å“²ç†', 'æ°´ç–—å…»ç”Ÿ'] },
            tech: { title: 'ğŸ”§ æ°´ç§‘æŠ€', desc: 'å°†æ°´å­¦ç†è®ºåº”ç”¨äºç§‘æŠ€åˆ›æ–°ï¼ŒåŒ…æ‹¬æ°´å¤„ç†æŠ€æœ¯ã€èŠ‚æ°´æŠ€æœ¯ã€æ°´è´¨æ£€æµ‹ã€æ™ºèƒ½é¥®æ°´ç³»ç»Ÿç­‰ã€‚', items: ['æ™ºèƒ½æ°´æ¯', 'å‡€æ°´æŠ€æœ¯', 'èŠ‚æ°´æ–¹æ¡ˆ', 'æ°´è´¨ç›‘æµ‹'] },
            products: { title: 'ğŸ›’ æ°´äº§å“', desc: 'åŸºäºæ°´å­¦ç†è®ºç ”å‘çš„å¥åº·äº§å“ï¼ŒåŒ…æ‹¬åŠŸèƒ½æ€§é¥®ç”¨æ°´ã€æ°´ç–—äº§å“ã€å…»ç”Ÿå™¨å…·ç­‰ã€‚', items: ['æ´»æ€§æ°´', 'çŸ¿æ³‰æ°´', 'æ°´ç–—ä»ª', 'å…»ç”Ÿå£¶'] },
            inventions: { title: 'ğŸ’¡ æ°´å‘æ˜', desc: 'æ°´è‹¥å–„å…ˆç”Ÿçš„ä¸“åˆ©å‘æ˜ï¼ŒåŒ…æ‹¬æ°´å¤„ç†è®¾å¤‡ã€å¥åº·é¥®æ°´è£…ç½®ã€æ°´ç–—å™¨æ¢°ç­‰åˆ›æ–°æˆæœã€‚', items: ['ä¸“åˆ©ä¸€è§ˆ', 'å‘æ˜æ•…äº‹', 'æŠ€æœ¯åŸç†', 'åº”ç”¨æ¡ˆä¾‹'] }
        };
        const data = contents[section];
        if (!data) return;
        
        const html = `
            <div style="padding:15px;background:rgba(0,188,212,0.1);border-radius:12px;margin-top:10px;">
                <div style="font-size:16px;font-weight:bold;color:var(--water);margin-bottom:8px;">${data.title}</div>
                <div style="font-size:11px;color:rgba(255,255,255,0.7);line-height:1.6;margin-bottom:12px;">${data.desc}</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    ${data.items.map(item => `<div style="padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:11px;text-align:center;cursor:pointer;" onclick="toast('å³å°†æ¨å‡ºï¼š${item}')">${item}</div>`).join('')}
                </div>
            </div>
        `;
        
        // æ˜¾ç¤ºåœ¨æ°´å­¦é¢æ¿åº•éƒ¨
        let container = document.getElementById('waterSectionContent');
        if (!container) {
            container = document.createElement('div');
            container.id = 'waterSectionContent';
            document.getElementById('waterPanel').appendChild(container);
        }
        container.innerHTML = html;
    }

    // ==================== æ”¯ä»˜æ”¶è´¹ç³»ç»Ÿ ====================
    // ç®¡ç†å‘˜é…ç½®åŒºï¼ˆæ”¹è¿™é‡Œï¼‰
    var PAY_CONFIG = {
        contactPhone: '13800138000',    // â† æ”¹æˆä½ çš„æ‰‹æœºå·    // ä½ çš„æ”¶æ¬¾æ‰‹æœºå·ï¼ˆå¾®ä¿¡/æ”¯ä»˜å®ç»‘å®šçš„ï¼‰
        contactWechat: '',              // ä½ çš„å¾®ä¿¡å·ï¼ˆé€‰å¡«ï¼‰
        contactName: 'ç››å…´å´‘',           // æ”¶æ¬¾äººå§“å
        // æ”¶æ¬¾äºŒç»´ç å›¾ç‰‡ï¼ˆæ›¿æ¢ä¸ºä½ çš„çœŸå®æ”¶æ¬¾ç ï¼Œbase64æˆ–å›¾ç‰‡URLï¼‰
        // ç”Ÿæˆæ–¹æ³•ï¼šå¾®ä¿¡â†’æˆ‘â†’æœåŠ¡â†’æ”¶ä»˜æ¬¾â†’äºŒç»´ç æ”¶æ¬¾â†’ä¿å­˜å›¾ç‰‡â†’è½¬ä¸ºbase64æˆ–ä¸Šä¼ GitHub
        wechatPayQR: 'https://raw.githubusercontent.com/ericjbe/water-reminder/main/%E7%9B%9B%E5%85%B4%E5%B4%91%E6%94%B6%E6%AC%BE%E7%A0%81.jpg',   // å¾®ä¿¡æ”¶æ¬¾ç å›¾ç‰‡URL
        alipayQR: 'https://raw.githubusercontent.com/ericjbe/water-reminder/main/%E7%9B%9B%E5%85%B4%E5%B4%91%E6%94%B6%E6%AC%BE%E7%A0%81.jpg',      // æ”¯ä»˜å®æ”¶æ¬¾ç å›¾ç‰‡URL
        // ä»·æ ¼é…ç½®
        prices: {
            monthly:    { amount: 9.99,  display: 'Â¥9.99/æœˆ',   name: 'æœˆåº¦ä¼šå‘˜',  desc: 'æ— é™æé†’ Â· ç§’çº§ç²¾ç¡® Â· 10äººå…³æ€€' },
            quarterly:  { amount: 19.99, display: 'Â¥19.99/å­£',  name: 'å­£åº¦ä¼šå‘˜',  desc: 'çœ33% Â· å…¨éƒ¨å†…å®¹ Â· 20äººå…³æ€€' },
            yearly:     { amount: 199,   display: 'Â¥199/å¹´',    name: 'å¹´åº¦VIP ğŸ”¥', desc: 'çœ83% Â· éŸ³é¢‘è¯¾ç¨‹ Â· æ— å¹¿å‘Š Â· æ— é™å…³æ€€' },
            enterprise: { amount: 9999,  display: 'Â¥9999/å¹´',   name: 'ä¼ä¸šç‰ˆ',    desc: 'å“ç‰Œå®šåˆ¶ Â· åˆ†ç»„ç®¡ç† Â· ä¸“å±å®¢æœ' }
        }
    };
    
    var currentPayPlan = null;
    var currentPayMethod = null;
    
    // å¾…å®¡æ ¸è®¢å•åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰
    var pendingOrders = JSON.parse(localStorage.getItem('heshuilePendingOrders') || '[]');
    
    function upgradePlan(plan) {
        if (!user) {
            toast('è¯·å…ˆç™»å½•');
            return;
        }
        
        currentPayPlan = plan;
        var planInfo = PAY_CONFIG.prices[plan];
        if (!planInfo) return;
        
        // å¡«å……å¼¹çª—ä¿¡æ¯
        document.getElementById('payPlanName').textContent = planInfo.name;
        document.getElementById('payPlanPrice').textContent = planInfo.display;
        document.getElementById('payPlanDesc').textContent = planInfo.desc;
        document.getElementById('payTransferNote').textContent = 'å–æ°´' + plan + '-' + (user.name || user.phone);
        document.getElementById('payContactPhone').textContent = PAY_CONFIG.contactPhone;
        document.getElementById('payContactInfo').textContent = PAY_CONFIG.contactName + ' ' + PAY_CONFIG.contactPhone;
        
        // ç”Ÿæˆè®¢å•å·
        var orderId = 'HSL' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).slice(2,5).toUpperCase();
        document.getElementById('payOrderId').textContent = 'è®¢å•å·ï¼š' + orderId;
        
        // é‡ç½®çŠ¶æ€
        currentPayMethod = null;
        document.querySelectorAll('.pay-method-btn').forEach(function(b){ b.classList.remove('active'); });
        document.getElementById('payQrArea').classList.remove('show');
        document.getElementById('payTransferArea').classList.remove('show');
        
        // æ˜¾ç¤ºå¼¹çª—
        document.getElementById('payModal').classList.add('show');
        
        trackEvent('payment', 'open_pay', plan + '_' + planInfo.amount);
    }
    
    function selectPayMethod(method) {
        currentPayMethod = method;
        
        // é«˜äº®é€‰ä¸­
        document.querySelectorAll('.pay-method-btn').forEach(function(b){ b.classList.remove('active'); });
        event.currentTarget.classList.add('active');
        
        var qrArea = document.getElementById('payQrArea');
        var transferArea = document.getElementById('payTransferArea');
        var planInfo = PAY_CONFIG.prices[currentPayPlan];
        var amount = planInfo ? planInfo.amount : '';
        
        if (method === 'wechat' || method === 'alipay') {
            var isWechat = method === 'wechat';
            var qrUrl = isWechat ? PAY_CONFIG.wechatPayQR : PAY_CONFIG.alipayQR;
            var appName = isWechat ? 'å¾®ä¿¡' : 'æ”¯ä»˜å®';
            var emoji = isWechat ? 'ğŸ’š' : 'ğŸ”µ';
            
            qrArea.classList.add('show');
            transferArea.classList.remove('show');
            
            var qrImg = document.getElementById('payQrImage');
            if (qrUrl) {
                qrImg.innerHTML = '<img id="payQrRealImage" src="' + qrUrl + '" style="width:220px;height:220px;border-radius:12px;object-fit:contain;" crossorigin="anonymous">';
            } else {
                qrImg.innerHTML = '<div style="text-align:center;padding:20px;"><div style="font-size:50px;margin-bottom:10px;">' + emoji + '</div><div style="font-size:13px;color:#333;font-weight:bold;">' + appName + 'æ”¶æ¬¾ç </div><div style="font-size:10px;color:#999;margin-top:5px;">ç®¡ç†å‘˜è¯·åœ¨ä»£ç ä¸­<br>é…ç½®æ”¶æ¬¾ç å›¾ç‰‡</div></div>';
            }
            
            // æ›´æ–°æ“ä½œæŒ‡å¼•
            var instructionEl = document.getElementById('payQrInstruction');
            instructionEl.innerHTML = ''
                + '<div style="margin-bottom:12px;text-align:center;">'
                + '<div style="font-size:24px;font-weight:bold;color:var(--gold);margin-bottom:4px;">Â¥' + amount + '</div>'
                + '<button onclick="safeCopy(\'' + amount + '\',\'âœ… é‡‘é¢å·²å¤åˆ¶ï¼Œç²˜è´´åˆ°ä»˜æ¬¾é¡µé¢å³å¯\')" style="padding:4px 14px;border-radius:8px;border:1px solid rgba(255,215,0,0.4);background:rgba(255,215,0,0.1);color:var(--gold);font-size:11px;cursor:pointer;">ğŸ“‹ å¤åˆ¶é‡‘é¢</button>'
                + '</div>'
                + '<div style="font-size:12px;font-weight:bold;color:var(--primary);margin-bottom:8px;">æ“ä½œæ­¥éª¤ï¼š</div>'
                + '<div style="font-size:11px;line-height:2;color:rgba(255,255,255,0.7);">'
                + 'â‘  ç‚¹å‡»ä¸‹æ–¹æŒ‰é’® <strong style="color:var(--gold);">ä¿å­˜æ”¶æ¬¾ç </strong> åˆ°æ‰‹æœºç›¸å†Œ<br>'
                + 'â‘¡ æ‰“å¼€' + appName + ' â†’ æ‰«ä¸€æ‰« â†’ å³ä¸Šè§’ <strong>ç›¸å†Œ</strong><br>'
                + 'â‘¢ é€‰æ‹©åˆšä¿å­˜çš„æ”¶æ¬¾ç å›¾ç‰‡<br>'
                + 'â‘£ è¾“å…¥é‡‘é¢ <strong style="color:var(--gold);">Â¥' + amount + '</strong>ï¼ˆå¯å…ˆå¤åˆ¶ï¼‰â†’ ç¡®è®¤ä»˜æ¬¾<br>'
                + 'â‘¤ å›åˆ°è¿™é‡Œç‚¹ã€Œæˆ‘å·²ä»˜æ¬¾ã€æäº¤è®¢å•'
                + '</div>'
                + '<div style="display:flex;gap:8px;margin-top:12px;">'
                + '<button onclick="savePayQrCode()" style="flex:1;padding:10px;border-radius:12px;border:none;background:linear-gradient(135deg,#FFD700,#ff9800);color:#000;font-weight:bold;font-size:13px;cursor:pointer;">ğŸ’¾ ä¿å­˜æ”¶æ¬¾ç åˆ°ç›¸å†Œ</button>'
                + '</div>'
                + '<div style="font-size:9px;color:rgba(255,255,255,0.3);margin-top:8px;text-align:center;">å¤‡æ³¨è¯·å†™ï¼š<strong>å–æ°´' + (currentPayPlan || '') + '</strong></div>';
        } else if (method === 'transfer') {
            qrArea.classList.remove('show');
            transferArea.classList.add('show');
        } else if (method === 'contact') {
            qrArea.classList.remove('show');
            transferArea.classList.remove('show');
            var phone = PAY_CONFIG.contactPhone;
            var msg = 'ğŸ’° ç›´æ¥è”ç³»ä»˜æ¬¾\n\n';
            msg += 'ğŸ“± æ‰‹æœºå·ï¼š' + phone + '\n';
            msg += 'ğŸ’¬ å¾®ä¿¡ï¼šæœç´¢æ‰‹æœºå· ' + phone + ' æ·»åŠ å¥½å‹\n';
            msg += 'ğŸ“ ä¹Ÿå¯ç›´æ¥æ‹¨æ‰“ç”µè¯\n\n';
            msg += 'å‘Šè¯‰å¯¹æ–¹ä½ è¦å¼€é€šï¼š' + (PAY_CONFIG.prices[currentPayPlan]?PAY_CONFIG.prices[currentPayPlan].name:'ä¼šå‘˜');
            msg += '\né‡‘é¢ï¼šÂ¥' + amount;
            alert(msg);
        }
        
        trackEvent('payment', 'select_method', method);
    }
    
    // ä¿å­˜æ”¶æ¬¾ç å›¾ç‰‡åˆ°ç›¸å†Œ
    function savePayQrCode() {
        var img = document.getElementById('payQrRealImage');
        if (!img) { toast('æ”¶æ¬¾ç æœªåŠ è½½'); return; }
        
        var src = img.src;
        
        // æ–¹æ¡ˆ1ï¼šå°è¯•ç”¨ canvas ä¸‹è½½ï¼ˆæ”¯æŒè·¨åŸŸçš„æƒ…å†µï¼‰
        try {
            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');
            canvas.width = img.naturalWidth || 400;
            canvas.height = img.naturalHeight || 400;
            ctx.drawImage(img, 0, 0);
            
            canvas.toBlob(function(blob) {
                if (blob) {
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'pay-qrcode.jpg';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    toast('âœ… æ”¶æ¬¾ç å·²ä¿å­˜ï¼è¯·æ‰“å¼€å¾®ä¿¡/æ”¯ä»˜å®æ‰«ä¸€æ‰« â†’ ç›¸å†Œ');
                } else {
                    fallbackSaveQr(src);
                }
            }, 'image/jpeg', 0.95);
        } catch (e) {
            fallbackSaveQr(src);
        }
    }
    
    // é™çº§æ–¹æ¡ˆï¼šæ–°çª—å£æ‰“å¼€å›¾ç‰‡è®©ç”¨æˆ·é•¿æŒ‰ä¿å­˜
    function fallbackSaveQr(src) {
        var w = window.open('', '_blank');
        if (w) {
            w.document.write('<html><head><title>é•¿æŒ‰ä¿å­˜æ”¶æ¬¾ç </title><meta name="viewport" content="width=device-width,initial-scale=1"></head>'
                + '<body style="margin:0;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:#000;color:#fff;font-family:sans-serif;">'
                + '<p style="font-size:16px;margin-bottom:20px;">ğŸ‘‡ é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œ</p>'
                + '<img src="' + src + '" style="max-width:90vw;max-height:70vh;border-radius:12px;">'
                + '<p style="font-size:13px;color:#999;margin-top:20px;">ä¿å­˜åæ‰“å¼€å¾®ä¿¡/æ”¯ä»˜å® â†’ æ‰«ä¸€æ‰« â†’ ç›¸å†Œ</p>'
                + '</body></html>');
            w.document.close();
        } else {
            toast('è¯·é•¿æŒ‰ä¸Šæ–¹æ”¶æ¬¾ç å›¾ç‰‡ â†’ ä¿å­˜åˆ°ç›¸å†Œ');
        }
    }
    
    function confirmPayment() {
        if (!currentPayPlan) { toast('è¯·é€‰æ‹©å¥—é¤'); return; }
        if (!currentPayMethod) { toast('è¯·å…ˆé€‰æ‹©æ”¯ä»˜æ–¹å¼'); return; }
        if (!user) { toast('è¯·å…ˆç™»å½•'); return; }
        
        var planInfo = PAY_CONFIG.prices[currentPayPlan];
        var orderId = document.getElementById('payOrderId').textContent.replace('è®¢å•å·ï¼š','');
        
        // åˆ›å»ºå¾…å®¡æ ¸è®¢å•
        var order = {
            id: orderId,
            userId: user.phone,
            userName: user.name || user.phone,
            plan: currentPayPlan,
            planName: planInfo.name,
            amount: planInfo.amount,
            method: currentPayMethod,
            status: 'pending',  // pending â†’ approved â†’ rejected
            createTime: new Date().toISOString(),
            approveTime: null
        };
        
        pendingOrders.push(order);
        localStorage.setItem('heshuilePendingOrders', JSON.stringify(pendingOrders));
        
        trackEvent('payment', 'confirm_payment', currentPayPlan + '_' + planInfo.amount + '_' + currentPayMethod);
        
        closePayModal();
        
        // æ˜¾ç¤ºæäº¤æˆåŠŸ
        var msg = 'âœ… ä»˜æ¬¾ç”³è¯·å·²æäº¤ï¼\n\n'
            + 'å¥—é¤ï¼š' + planInfo.name + '\n'
            + 'é‡‘é¢ï¼š' + planInfo.display + '\n'
            + 'è®¢å•å·ï¼š' + orderId + '\n\n'
            + 'è¯·ç¡®ä¿å·²å®Œæˆä»˜æ¬¾ï¼Œç®¡ç†å‘˜å®¡æ ¸å\nå°†å‘é€æ¿€æ´»ç ç»™æ‚¨ã€‚\n\n'
            + 'æ”¶åˆ°æ¿€æ´»ç åï¼Œåœ¨"æˆ‘çš„"é¡µé¢\nè¾“å…¥æ¿€æ´»ç å³å¯ç«‹å³å‡çº§ã€‚';
        alert(msg);
        toast('ğŸ“‹ è®¢å•å·²æäº¤ï¼Œç­‰å¾…å®¡æ ¸');
    }
    
    function closePayModal() {
        document.getElementById('payModal').classList.remove('show');
    }
    
    // ==================== ç®¡ç†å‘˜è®¢å•å®¡æ ¸ ====================
    function showOrdersPanel() {
        pendingOrders = JSON.parse(localStorage.getItem('heshuilePendingOrders') || '[]');
        
        var pending = pendingOrders.filter(function(o){ return o.status === 'pending'; });
        var approved = pendingOrders.filter(function(o){ return o.status === 'approved'; });
        var all = pendingOrders.slice().reverse();
        
        var methodNames = { wechat: 'ğŸ’šå¾®ä¿¡', alipay: 'ğŸ”µæ”¯ä»˜å®', transfer: 'ğŸ¦è½¬è´¦' };
        
        var html = '<div style="background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.2);border-radius:12px;padding:12px;margin-bottom:12px;">'
            + '<div style="text-align:center;font-size:14px;font-weight:bold;color:var(--primary);margin-bottom:10px;">ğŸ’° è®¢å•ç®¡ç†</div>'
            
            // ç»Ÿè®¡
            + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;">'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:22px;font-weight:bold;color:#ff9800;">' + pending.length + '</div><div style="font-size:9px;color:rgba(255,255,255,0.5);">å¾…å®¡æ ¸</div></div>'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:22px;font-weight:bold;color:var(--success);">' + approved.length + '</div><div style="font-size:9px;color:rgba(255,255,255,0.5);">å·²é€šè¿‡</div></div>'
            + '<div style="text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;">'
            + '<div style="font-size:22px;font-weight:bold;color:var(--gold);">Â¥' + approved.reduce(function(s,o){return s+o.amount;},0) + '</div><div style="font-size:9px;color:rgba(255,255,255,0.5);">æ€»æ”¶å…¥</div></div>'
            + '</div>';
        
        // å¾…å®¡æ ¸åˆ—è¡¨
        if (pending.length > 0) {
            html += '<div style="font-size:11px;color:#ff9800;margin-bottom:5px;">â³ å¾…å®¡æ ¸è®¢å•</div>';
            pending.forEach(function(o) {
                html += '<div style="background:rgba(255,152,0,0.08);border:1px solid rgba(255,152,0,0.3);border-radius:10px;padding:10px;margin-bottom:6px;">'
                    + '<div style="display:flex;justify-content:space-between;align-items:center;">'
                    + '<div>'
                    + '<div style="font-size:12px;font-weight:bold;color:white;">' + o.userName + '</div>'
                    + '<div style="font-size:10px;color:rgba(255,255,255,0.5);">' + o.planName + ' Â· ' + (methodNames[o.method]||o.method) + ' Â· Â¥' + o.amount + '</div>'
                    + '<div style="font-size:9px;color:rgba(255,255,255,0.3);">' + (o.createTime||'').slice(0,16).replace('T',' ') + ' Â· ' + o.id + '</div>'
                    + '</div>'
                    + '<div style="display:flex;gap:4px;">'
                    + '<button onclick="approveOrder(&#39;' + o.id + '&#39;)" style="background:var(--success);border:none;color:#000;padding:6px 10px;border-radius:6px;font-size:10px;cursor:pointer;font-weight:bold;">âœ…é€šè¿‡</button>'
                    + '<button onclick="rejectOrder(&#39;' + o.id + '&#39;)" style="background:rgba(255,255,255,0.1);border:none;color:#ff6b6b;padding:6px 8px;border-radius:6px;font-size:10px;cursor:pointer;">âŒ</button>'
                    + '</div></div></div>';
            });
        } else {
            html += '<div style="text-align:center;color:rgba(255,255,255,0.3);font-size:11px;padding:15px;">æš‚æ— å¾…å®¡æ ¸è®¢å•</div>';
        }
        
        // å·²å¤„ç†åˆ—è¡¨ï¼ˆæœ€è¿‘10æ¡ï¼‰
        var processed = all.filter(function(o){return o.status !== 'pending';}).slice(0,10);
        if (processed.length > 0) {
            html += '<div style="font-size:11px;color:var(--primary);margin:10px 0 5px;">ğŸ“‹ æœ€è¿‘å¤„ç†</div>';
            processed.forEach(function(o) {
                var statusColor = o.status === 'approved' ? 'var(--success)' : '#ff6b6b';
                var statusText = o.status === 'approved' ? 'âœ…å·²å¼€é€š' : 'âŒå·²æ‹’ç»';
                html += '<div style="padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:10px;">'
                    + '<div style="display:flex;justify-content:space-between;">'
                    + '<span style="color:rgba(255,255,255,0.6);">' + o.userName + ' Â· ' + o.planName + ' Â· Â¥' + o.amount + '</span>'
                    + '<span style="color:' + statusColor + ';">' + statusText + '</span>'
                    + '</div>'
                    + (o.activationCode ? '<div style="margin-top:3px;"><div style="display:flex;justify-content:space-between;align-items:center;"><span style="color:var(--gold);font-family:monospace;font-size:9px;">ğŸ”‘ ' + o.activationCode + '</span><span onclick="safeCopy(\'' + o.activationCode + '\',\'ğŸ“‹ å·²å¤åˆ¶æ¿€æ´»ç \')" style="color:var(--primary);cursor:pointer;font-size:9px;">å¤åˆ¶ç </span></div>'
                    + (o.activationLink ? '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:2px;"><span style="color:var(--primary);font-size:9px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px;">ğŸ”— ' + o.activationLink + '</span><span onclick="safeCopy(\'' + o.activationLink + '\',\'ğŸ“‹ æ¿€æ´»é“¾æ¥å·²å¤åˆ¶\')" style="color:var(--gold);cursor:pointer;font-size:9px;white-space:nowrap;margin-left:4px;">å¤åˆ¶é“¾æ¥</span></div>' : '')
                    + '</div>' : '')
                    + '</div>';
            });
        }
        
        // äº‘ç«¯ä¼šå‘˜ç®¡ç†æŒ‰é’®
        var cloudMembers = JSON.parse(localStorage.getItem('heshuileCloudMembers') || '[]');
        html += '<div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);">'
            + '<div style="font-size:11px;color:var(--primary);margin-bottom:6px;">â˜ï¸ äº‘ç«¯ä¼šå‘˜åŒæ­¥ (' + cloudMembers.length + 'äºº)</div>'
            + '<div style="display:flex;gap:6px;">'
            + '<button onclick="exportMembersJSON()" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,212,255,0.3);background:rgba(0,212,255,0.08);color:var(--primary);font-size:11px;cursor:pointer;font-weight:bold;">ğŸ“¤ å¯¼å‡º members.json</button>'
            + '<button onclick="openGitHubMembersEdit()" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,215,0,0.3);background:rgba(255,215,0,0.08);color:var(--gold);font-size:11px;cursor:pointer;font-weight:bold;">âœï¸ åœ¨GitHubç¼–è¾‘</button>'
            + '</div>'
            + '<div style="font-size:9px;color:rgba(255,255,255,0.3);margin-top:6px;">å®¡æ‰¹åè‡ªåŠ¨è®°å½• â†’ å¯¼å‡ºJSON â†’ ä¸Šä¼ åˆ°GitHubä»“åº“ â†’ ç”¨æˆ·æ¢è®¾å¤‡ä¹Ÿèƒ½è‡ªåŠ¨æ¢å¤</div>'
            + '</div>';
        
        html += '</div>';
        
        document.getElementById('ordersContainer').innerHTML = html;
    }
    
    // å¯¼å‡º members.json å†…å®¹
    function exportMembersJSON() {
        var cloudMembers = JSON.parse(localStorage.getItem('heshuileCloudMembers') || '[]');
        
        if (cloudMembers.length === 0) {
            toast('æš‚æ— å·²å®¡æ‰¹ä¼šå‘˜ï¼Œå®¡æ‰¹è®¢å•åè‡ªåŠ¨ç”Ÿæˆ');
            return;
        }
        
        var json = JSON.stringify({
            _comment: 'å–æ°´äº†å— - ä¼šå‘˜æ•°æ® | è¯·å°†æ­¤æ–‡ä»¶ä¸Šä¼ åˆ° GitHub ä»“åº“æ ¹ç›®å½•',
            _updated: new Date().toISOString(),
            members: cloudMembers
        }, null, 2);
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        safeCopy(json, 'ğŸ“‹ members.json å†…å®¹å·²å¤åˆ¶ï¼\nè¯·ç²˜è´´åˆ° GitHub ä»“åº“çš„ members.json æ–‡ä»¶ä¸­');
        
        // åŒæ—¶å¼¹çª—æ˜¾ç¤º
        var msg = 'â•â• members.json â•â•\n\n' + json + '\n\n'
            + 'â”â”â”â”â”â”â”â”â”â”\n'
            + 'æ“ä½œæ­¥éª¤ï¼š\n'
            + '1. å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿\n'
            + '2. æ‰“å¼€ GitHub ä»“åº“ â†’ members.json\n'
            + '3. ç‚¹å‡»ç¼–è¾‘ â†’ ç²˜è´´å†…å®¹ â†’ æäº¤\n'
            + '4. ç”¨æˆ·ä¸‹æ¬¡æ‰“å¼€APPè‡ªåŠ¨æ¢å¤ä¼šå‘˜';
        alert(msg);
    }
    
    // ç›´æ¥æ‰“å¼€ GitHub ç¼–è¾‘é¡µé¢
    function openGitHubMembersEdit() {
        var cloudMembers = JSON.parse(localStorage.getItem('heshuileCloudMembers') || '[]');
        
        // å…ˆå¤åˆ¶JSONå†…å®¹
        var json = JSON.stringify({
            _comment: 'å–æ°´äº†å— - ä¼šå‘˜æ•°æ®',
            _updated: new Date().toISOString(),
            members: cloudMembers
        }, null, 2);
        safeCopy(json, 'ğŸ“‹ JSONå·²å¤åˆ¶ï¼Œå³å°†æ‰“å¼€GitHubç¼–è¾‘é¡µé¢...');
        
        // æ‰“å¼€GitHubç¼–è¾‘é¡µé¢
        var editUrl = 'https://github.com/ericjbe/water-reminder/edit/main/members.json';
        setTimeout(function() {
            window.open(editUrl, '_blank');
        }, 500);
    }
    
    // â•â•â• æ¿€æ´»ç ç³»ç»Ÿ â•â•â•
    var ACTIVATION_SECRET = 'heshuile2026shuiruoshan';  // æ¿€æ´»ç å¯†é’¥ï¼ˆå¯è‡ªè¡Œä¿®æ”¹ï¼‰
    
    // â•â•â• äº‘ç«¯ä¼šå‘˜æ ¡éªŒé…ç½® â•â•â•
    var MEMBERS_CLOUD = {
        enabled: true,
        // GitHubä»“åº“é‡Œçš„ members.json æ–‡ä»¶ï¼ˆrawåœ°å€ï¼‰
        url: 'https://raw.githubusercontent.com/ericjbe/water-reminder/main/members.json',
        // æ ¡éªŒé—´éš”ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤æ¯æ¬¡æ‰“å¼€APPæ£€æŸ¥ä¸€æ¬¡ï¼Œä½†æ¯6å°æ—¶æœ€å¤šæŸ¥ä¸€æ¬¡
        checkInterval: 6 * 60 * 60 * 1000
    };
    
    // ç®€å•å“ˆå¸Œå‡½æ•°ï¼ˆç”Ÿæˆå¯é‡ç°çš„çŸ­ç ï¼‰
    function simpleHash(str, salt) {
        var hash = salt || 5381;
        for (var i = 0; i < str.length; i++) {
            hash = ((hash << 5) + hash) ^ str.charCodeAt(i);
            hash = hash & 0x7FFFFFFF;
        }
        return hash.toString(36).toUpperCase();
    }
    
    // æ‰‹æœºå·å“ˆå¸Œï¼ˆç”¨äºäº‘ç«¯æ ¡éªŒï¼Œä¸å­˜æ˜æ–‡æ‰‹æœºå·ï¼‰
    function hashPhoneForCloud(phone) {
        return simpleHash(phone + ':member:' + ACTIVATION_SECRET, 314159).slice(0, 8);
    }
    
    // äº‘ç«¯ä¼šå‘˜æ ¡éªŒï¼šä» GitHub æ‹‰å– members.json è‡ªåŠ¨æ¢å¤ä¼šå‘˜
    async function checkCloudMembership() {
        if (!MEMBERS_CLOUD.enabled || !MEMBERS_CLOUD.url) return;
        if (!user || !user.phone) return;
        
        // å·²ç»æ˜¯ä»˜è´¹ç”¨æˆ·ï¼Œä¸éœ€è¦æ ¡éªŒ
        if (user.level && user.level !== 'free') return;
        
        // é¢‘ç‡é™åˆ¶
        var lastCheck = parseInt(localStorage.getItem('heshuileLastCloudCheck') || '0');
        if (Date.now() - lastCheck < MEMBERS_CLOUD.checkInterval) return;
        
        try {
            // åŠ æ—¶é—´æˆ³é˜²CDNç¼“å­˜
            var url = MEMBERS_CLOUD.url + '?t=' + Date.now();
            var resp = await fetch(url, { cache: 'no-store' });
            if (!resp.ok) return;
            
            var data = await resp.json();
            if (!data || !data.members) return;
            
            localStorage.setItem('heshuileLastCloudCheck', String(Date.now()));
            
            // ç”¨å“ˆå¸ŒåŒ¹é…å½“å‰ç”¨æˆ·
            var myHash = hashPhoneForCloud(user.phone);
            var match = null;
            for (var i = 0; i < data.members.length; i++) {
                if (data.members[i].hash === myHash && data.members[i].active !== false) {
                    match = data.members[i];
                    break;
                }
            }
            
            if (match) {
                // åŒ¹é…åˆ°ï¼è‡ªåŠ¨æ¢å¤ä¼šå‘˜
                var levelMap = { monthly: 'monthly', quarterly: 'quarterly', yearly: 'vip', enterprise: 'enterprise' };
                var newLevel = levelMap[match.plan] || 'vip';
                
                user.level = newLevel;
                user.paidAt = match.activated || new Date().toISOString();
                user.paidPlan = match.plan;
                user.cloudVerified = true;
                
                var users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}');
                if (users[user.phone]) {
                    users[user.phone].level = newLevel;
                    users[user.phone].paidAt = user.paidAt;
                    users[user.phone].paidPlan = match.plan;
                    users[user.phone].cloudVerified = true;
                }
                localStorage.setItem('heshuileUsers', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                updateUI();
                updateMembershipUI();
                
                var planNames = { monthly: 'æœˆåº¦ä¼šå‘˜ â­', quarterly: 'å­£åº¦ä¼šå‘˜ ğŸŒŸ', yearly: 'å¹´åº¦VIP ğŸ‘‘', enterprise: 'ä¼ä¸šç‰ˆ ğŸ¢' };
                trackEvent('payment', 'cloud_restore', match.plan);
                logActivity('payment', 'äº‘ç«¯è‡ªåŠ¨æ¢å¤ï¼š' + (planNames[match.plan] || match.plan));
                toast('â˜ï¸ ä¼šå‘˜å·²è‡ªåŠ¨æ¢å¤ï¼š' + (planNames[match.plan] || 'ä¼šå‘˜'));
            }
        } catch (e) {
            // ç½‘ç»œé”™è¯¯é™é»˜å¿½ç•¥
            console.log('äº‘ç«¯æ ¡éªŒè·³è¿‡:', e.message);
        }
    }
    
    // ç”Ÿæˆæ¿€æ´»ç ï¼šåŸºäºæ‰‹æœºå·+å¥—é¤+å¯†é’¥ï¼Œç¡®å®šæ€§ç”Ÿæˆ
    function generateActivationCode(phone, plan) {
        var seed = phone + ':' + plan + ':' + ACTIVATION_SECRET;
        var h1 = simpleHash(seed, 7919).slice(0, 4);
        var h2 = simpleHash(seed, 104729).slice(0, 4);
        var h3 = simpleHash(seed, 1299827).slice(0, 4);
        var prefix = { monthly: 'MON', quarterly: 'QTR', yearly: 'VIP', enterprise: 'ENT' };
        return (prefix[plan] || 'VIP') + '-' + h1 + '-' + h2 + '-' + h3;
    }
    
    // ç”¨æˆ·è¾“å…¥æ¿€æ´»ç éªŒè¯
    function activateByCode() {
        if (!user) { toast('è¯·å…ˆç™»å½•'); return; }
        
        var code = (document.getElementById('activationCodeInput').value || '').trim().toUpperCase();
        if (!code || code.length < 10) { toast('è¯·è¾“å…¥æ­£ç¡®çš„æ¿€æ´»ç '); return; }
        
        // å°è¯•åŒ¹é…æ‰€æœ‰å¥—é¤
        var plans = ['monthly', 'quarterly', 'yearly', 'enterprise'];
        var matchedPlan = null;
        
        for (var i = 0; i < plans.length; i++) {
            var expected = generateActivationCode(user.phone, plans[i]);
            if (code === expected) {
                matchedPlan = plans[i];
                break;
            }
        }
        
        if (!matchedPlan) {
            toast('âŒ æ¿€æ´»ç æ— æ•ˆï¼Œè¯·æ£€æŸ¥åé‡è¯•');
            return;
        }
        
        // æ¿€æ´»æˆåŠŸï¼å‡çº§ç”¨æˆ·
        var levelMap = { monthly: 'monthly', quarterly: 'quarterly', yearly: 'vip', enterprise: 'enterprise' };
        user.level = levelMap[matchedPlan] || 'vip';
        user.paidAt = new Date().toISOString();
        user.paidPlan = matchedPlan;
        user.activationCode = code;
        
        // åŒæ—¶æ›´æ–° users æ•°æ®åº“å’Œ currentUser
        var users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}');
        if (users[user.phone]) {
            users[user.phone].level = user.level;
            users[user.phone].paidAt = user.paidAt;
            users[user.phone].paidPlan = user.paidPlan;
            users[user.phone].activationCode = code;
        }
        localStorage.setItem('heshuileUsers', JSON.stringify(users));
        localStorage.setItem('currentUser', JSON.stringify(user));
        
        updateUI();
        updateMembershipUI();
        document.getElementById('activationCodeInput').value = '';
        
        var planNames = { monthly: 'æœˆåº¦ä¼šå‘˜ â­', quarterly: 'å­£åº¦ä¼šå‘˜ ğŸŒŸ', yearly: 'å¹´åº¦VIP ğŸ‘‘', enterprise: 'ä¼ä¸šç‰ˆ ğŸ¢' };
        trackEvent('payment', 'activate_code', matchedPlan);
        logActivity('payment', 'æ¿€æ´»ç å‡çº§ï¼š' + planNames[matchedPlan]);
        
        toast('ğŸ‰ æ¿€æ´»æˆåŠŸï¼å·²å‡çº§ä¸º ' + planNames[matchedPlan]);
        
        // å¼¹å‡ºç¥è´º
        setTimeout(function() {
            alert('ğŸ‰ æ­å–œå‡çº§ï¼\n\næ‚¨å·²æˆä¸º ' + planNames[matchedPlan] + '\n\näº«å—å…¨éƒ¨é«˜çº§åŠŸèƒ½ï¼š\nâœ… æ— é™æé†’ Â· ç§’çº§ç²¾ç¡®\nâœ… æ— é™å…³æ€€å¯¹è±¡\nâœ… å…¨éƒ¨ä¸»é¢˜é£æ ¼\nâœ… å…¨éƒ¨æ°´å­¦å†…å®¹\nâœ… æ— å¹¿å‘Šä½“éªŒ');
        }, 300);
    }
    
    // é€šè¿‡æ¿€æ´»é“¾æ¥è‡ªåŠ¨æ¿€æ´»
    function autoActivateByLink(code) {
        if (!user) return;
        code = code.trim().toUpperCase();
        
        var plans = ['monthly', 'quarterly', 'yearly', 'enterprise'];
        var matchedPlan = null;
        for (var i = 0; i < plans.length; i++) {
            if (code === generateActivationCode(user.phone, plans[i])) {
                matchedPlan = plans[i];
                break;
            }
        }
        
        if (!matchedPlan) {
            toast('âŒ æ¿€æ´»ç ä¸å½“å‰è´¦å·ä¸åŒ¹é…ï¼Œè¯·ç¡®è®¤ç™»å½•äº†æ­£ç¡®çš„è´¦å·');
            return;
        }
        
        // æ‰§è¡Œæ¿€æ´»
        var levelMap = { monthly: 'monthly', quarterly: 'quarterly', yearly: 'vip', enterprise: 'enterprise' };
        user.level = levelMap[matchedPlan] || 'vip';
        user.paidAt = new Date().toISOString();
        user.paidPlan = matchedPlan;
        user.activationCode = code;
        
        var users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}');
        if (users[user.phone]) {
            users[user.phone].level = user.level;
            users[user.phone].paidAt = user.paidAt;
            users[user.phone].paidPlan = user.paidPlan;
            users[user.phone].activationCode = code;
        }
        localStorage.setItem('heshuileUsers', JSON.stringify(users));
        localStorage.setItem('currentUser', JSON.stringify(user));
        localStorage.removeItem('heshuilePendingActivation');
        
        updateUI();
        updateMembershipUI();
        
        var planNames = { monthly: 'æœˆåº¦ä¼šå‘˜ â­', quarterly: 'å­£åº¦ä¼šå‘˜ ğŸŒŸ', yearly: 'å¹´åº¦VIP ğŸ‘‘', enterprise: 'ä¼ä¸šç‰ˆ ğŸ¢' };
        trackEvent('payment', 'activate_link', matchedPlan);
        logActivity('payment', 'é“¾æ¥æ¿€æ´»ï¼š' + planNames[matchedPlan]);
        
        alert('ğŸ‰ è‡ªåŠ¨æ¿€æ´»æˆåŠŸï¼\n\næ‚¨å·²å‡çº§ä¸º ' + planNames[matchedPlan] + '\n\näº«å—å…¨éƒ¨é«˜çº§åŠŸèƒ½ï¼š\nâœ… æ— é™æé†’ Â· ç§’çº§ç²¾ç¡®\nâœ… æ— é™å…³æ€€å¯¹è±¡\nâœ… å…¨éƒ¨ä¸»é¢˜é£æ ¼\nâœ… å…¨éƒ¨æ°´å­¦å†…å®¹\nâœ… æ— å¹¿å‘Šä½“éªŒ');
    }
    
    // ç”Ÿæˆæ¿€æ´»é“¾æ¥ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰
    function generateActivationLink(phone, plan) {
        var code = generateActivationCode(phone, plan);
        var base = localStorage.getItem('heshuileBaseUrl') || location.href.split('?')[0];
        base = base.split('?')[0].split('#')[0];
        return base + '?activate=' + encodeURIComponent(code);
    }
    
    function approveOrder(orderId) {
        pendingOrders = JSON.parse(localStorage.getItem('heshuilePendingOrders') || '[]');
        var order = pendingOrders.find(function(o){return o.id === orderId;});
        if (!order) { toast('è®¢å•ä¸å­˜åœ¨'); return; }
        
        order.status = 'approved';
        order.approveTime = new Date().toISOString();
        
        // ç”Ÿæˆæ¿€æ´»ç  + é“¾æ¥ + äº‘ç«¯å“ˆå¸Œ
        var code = generateActivationCode(order.userId, order.plan);
        var activateLink = generateActivationLink(order.userId, order.plan);
        var phoneHash = hashPhoneForCloud(order.userId);
        
        order.activationCode = code;
        order.activationLink = activateLink;
        order.phoneHash = phoneHash;
        
        // æ·»åŠ åˆ°äº‘ç«¯ä¼šå‘˜åˆ—è¡¨ï¼ˆæœ¬åœ°æš‚å­˜ï¼Œå¾…ç®¡ç†å‘˜å¯¼å‡ºï¼‰
        var cloudMembers = JSON.parse(localStorage.getItem('heshuileCloudMembers') || '[]');
        // å»é‡
        cloudMembers = cloudMembers.filter(function(m) { return m.hash !== phoneHash; });
        cloudMembers.push({
            hash: phoneHash,
            plan: order.plan,
            name: order.userName,
            activated: new Date().toISOString().slice(0, 10),
            orderId: order.id,
            active: true
        });
        localStorage.setItem('heshuileCloudMembers', JSON.stringify(cloudMembers));
        
        localStorage.setItem('heshuilePendingOrders', JSON.stringify(pendingOrders));
        
        // æœ¬åœ°ä¹Ÿå‡çº§ï¼ˆä»…å¯¹ç®¡ç†å‘˜æœ¬æœºæœ‰æ•ˆï¼‰
        var users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}');
        if (users[order.userId]) {
            var plan = order.plan;
            users[order.userId].level = (plan === 'yearly') ? 'vip' : plan;
            users[order.userId].paidAt = new Date().toISOString();
            users[order.userId].paidPlan = plan;
            localStorage.setItem('heshuileUsers', JSON.stringify(users));
            
            if (user && user.phone === order.userId) {
                user.level = users[order.userId].level;
                localStorage.setItem('currentUser', JSON.stringify(user));
                updateUI();
                updateMembershipUI();
            }
        }
        
        trackEvent('payment', 'approve_order', order.plan + '_' + order.amount);
        showOrdersPanel();
        
        // æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
        var msg = 'âœ… è®¢å•å·²é€šè¿‡ï¼\n\n'
            + 'ç”¨æˆ·ï¼š' + order.userName + '\n'
            + 'å¥—é¤ï¼š' + order.planName + ' Â· Â¥' + order.amount + '\n\n'
            + 'â”â”â” æ–¹å¼1ï¼šå‘æ¿€æ´»é“¾æ¥ï¼ˆæ¨èï¼‰â”â”â”\n'
            + activateLink + '\n'
            + 'ç”¨æˆ·ç‚¹å‡»å³è‡ªåŠ¨å‡çº§\n\n'
            + 'â”â”â” æ–¹å¼2ï¼šå‘æ¿€æ´»ç  â”â”â”\n'
            + code + '\n'
            + 'ç”¨æˆ·åœ¨"æˆ‘çš„"é¡µé¢æ‰‹åŠ¨è¾“å…¥\n\n'
            + 'â”â”â” æ–¹å¼3ï¼šäº‘ç«¯åŒæ­¥ï¼ˆæ°¸ä¹…ï¼‰â”â”â”\n'
            + 'ç‚¹"å¯¼å‡ºä¼šå‘˜JSON"â†’ æ›´æ–°åˆ°GitHubä»“åº“\n'
            + 'ç”¨æˆ·æ¢è®¾å¤‡/æ¸…ç¼“å­˜ä¹Ÿèƒ½è‡ªåŠ¨æ¢å¤';
        alert(msg);
        
        // è‡ªåŠ¨å¤åˆ¶æ¿€æ´»é“¾æ¥
        safeCopy(activateLink, 'ğŸ“‹ æ¿€æ´»é“¾æ¥å·²å¤åˆ¶ï¼è¯·å‘é€ç»™ ' + order.userName);
    }
    
    function rejectOrder(orderId) {
        if (!confirm('ç¡®å®šæ‹’ç»æ­¤è®¢å•ï¼Ÿ')) return;
        pendingOrders = JSON.parse(localStorage.getItem('heshuilePendingOrders') || '[]');
        var order = pendingOrders.find(function(o){return o.id === orderId;});
        if (!order) return;
        
        order.status = 'rejected';
        order.approveTime = new Date().toISOString();
        localStorage.setItem('heshuilePendingOrders', JSON.stringify(pendingOrders));
        trackEvent('payment', 'reject_order', orderId);
        toast('âŒ å·²æ‹’ç»');
        showOrdersPanel();
    }

    function updateMembershipUI() {
        if (!user) return;
        const levelNames = { free: 'ğŸ†“ å…è´¹ç”¨æˆ·', monthly: 'â­ æœˆåº¦ä¼šå‘˜', quarterly: 'ğŸŒŸ å­£åº¦ä¼šå‘˜', vip: 'ğŸ‘‘ å¹´åº¦VIP', enterprise: 'ğŸ¢ ä¼ä¸šç‰ˆ' };
        const titleEl = document.getElementById('membershipTitle');
        const limitsEl = document.getElementById('membershipLimits');
        
        // è¯•ç”¨æœŸçŠ¶æ€æ˜¾ç¤º
        var displayLevel = user.level || 'free';
        var trialBadge = '';
        if (displayLevel === 'free' && isInTrialPeriod()) {
            trialBadge = ' <span style="background:linear-gradient(135deg,#FFD700,#ff9800);color:#000;font-size:9px;padding:2px 6px;border-radius:8px;font-weight:bold;">è¯•ç”¨å‰© ' + getTrialDaysLeft() + ' å¤©</span>';
            displayLevel = 'vip'; // è¯•ç”¨æœŸé—´æ˜¾ç¤ºVIPæƒç›Š
        }
        
        if (titleEl) titleEl.innerHTML = (levelNames[user.level] || levelNames.free) + trialBadge;
        
        const limits = {
            free: 'â€¢ æé†’æ•°é‡ï¼šæ¯å¤©10æ¡<br>â€¢ ç²¾ç¡®åº¦ï¼šåˆ†é’Ÿçº§<br>â€¢ å…³æ€€å¯¹è±¡ï¼š3äºº<br>â€¢ ä¸»é¢˜é£æ ¼ï¼š2æ¬¾<br>â€¢ æ°´å­¦è¯¾ç¨‹ï¼šæ¯æ—¥5æ¡<br>â€¢ å¥åº·æŠ¥å‘Šï¼šæ— <br>â€¢ å¹¿å‘Šï¼šæœ‰',
            monthly: 'â€¢ æé†’æ•°é‡ï¼šæ— é™<br>â€¢ ç²¾ç¡®åº¦ï¼šç§’çº§<br>â€¢ å…³æ€€å¯¹è±¡ï¼šæ— é™<br>â€¢ ä¸»é¢˜é£æ ¼ï¼š4æ¬¾<br>â€¢ æ°´å­¦è¯¾ç¨‹ï¼šå…¨éƒ¨<br>â€¢ æ¯æ—¥å¥åº·æŠ¥å‘Š âœ…<br>â€¢ å¹¿å‘Šï¼šæ— ',
            quarterly: 'â€¢ æé†’æ•°é‡ï¼šæ— é™<br>â€¢ ç²¾ç¡®åº¦ï¼šç§’çº§<br>â€¢ å…³æ€€å¯¹è±¡ï¼šæ— é™<br>â€¢ ä¸»é¢˜é£æ ¼ï¼š4æ¬¾+è‡ªå®šä¹‰<br>â€¢ æ°´å­¦è¯¾ç¨‹ï¼šå…¨éƒ¨+éŸ³é¢‘<br>â€¢ æ¯æ—¥å¥åº·æŠ¥å‘Š âœ…<br>â€¢ å¹¿å‘Šï¼šæ— ',
            vip: 'â€¢ æé†’æ•°é‡ï¼šæ— é™<br>â€¢ ç²¾ç¡®åº¦ï¼šç§’çº§<br>â€¢ å…³æ€€å¯¹è±¡ï¼šæ— é™<br>â€¢ ä¸»é¢˜é£æ ¼ï¼š4æ¬¾+è‡ªå®šä¹‰<br>â€¢ æ°´å­¦è¯¾ç¨‹ï¼šå…¨éƒ¨+éŸ³é¢‘<br>â€¢ æ¯æ—¥å¥åº·æŠ¥å‘Š âœ…<br>â€¢ å¹¿å‘Šï¼šæ—  Â· ä¸“å±å®¢æœ',
            enterprise: 'â€¢ å…¨éƒ¨VIPåŠŸèƒ½<br>â€¢ åˆ†ç»„ç®¡ç†<br>â€¢ å“ç‰Œå®šåˆ¶<br>â€¢ ä¼ä¸šä¸“å±å†…å®¹<br>â€¢ æ¯æ—¥å¥åº·æŠ¥å‘Š âœ…<br>â€¢ å“ç‰Œå¹¿å‘Šä½'
        };
        if (limitsEl) limitsEl.innerHTML = limits[displayLevel] || limits.free;
        
        // â•â•â• æ¯æ—¥å¥åº·æŠ¥å‘Šå¡ç‰‡ â•â•â•
        var reportEl = document.getElementById('healthReportCard');
        if (!reportEl) {
            var memberBox = document.getElementById('memberBox');
            if (memberBox) {
                reportEl = document.createElement('div');
                reportEl.id = 'healthReportCard';
                // æ’å…¥åˆ°ä¼šå‘˜ä¿¡æ¯ä¹‹å
                var activationBox = memberBox.querySelector('div[style*="æ¿€æ´»ç "]') || memberBox.lastElementChild;
                if (activationBox) memberBox.insertBefore(reportEl, activationBox);
                else memberBox.appendChild(reportEl);
            }
        }
        if (reportEl) {
            if (isPaidMember()) {
                var report = generateHealthReport();
                if (report) {
                    var trendIcon = report.trend === 'good' ? 'ğŸŒŠ' : report.trend === 'ok' ? 'ğŸ’§' : 'ğŸœï¸';
                    var trendText = report.trend === 'good' ? 'è¶…æ£’ï¼è¾¾æ ‡äº†' : report.trend === 'ok' ? 'è¿˜ä¸é”™ï¼ŒåŠ æ²¹' : 'å–æ°´åå°‘å“¦';
                    var trendColor = report.trend === 'good' ? 'var(--success)' : report.trend === 'ok' ? 'var(--gold)' : '#ff6b6b';
                    
                    reportEl.innerHTML = '<div style="margin:12px 0;padding:14px;background:linear-gradient(135deg,rgba(0,212,255,0.08),rgba(255,215,0,0.06));border:1px solid rgba(0,212,255,0.15);border-radius:14px;">'
                        + '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">'
                        + '<span style="font-size:12px;font-weight:bold;color:var(--primary);">ğŸ“Š æ¯æ—¥å¥åº·æŠ¥å‘Š</span>'
                        + '<span style="font-size:9px;color:rgba(255,255,255,0.4);">' + report.date + '</span>'
                        + '</div>'
                        + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;text-align:center;">'
                        + '<div style="padding:8px;background:rgba(0,0,0,0.2);border-radius:10px;">'
                        + '<div style="font-size:18px;font-weight:bold;color:' + trendColor + ';">' + report.todayIntake + '<span style="font-size:10px;">ml</span></div>'
                        + '<div style="font-size:9px;color:rgba(255,255,255,0.5);">ä»Šæ—¥é¥®æ°´</div></div>'
                        + '<div style="padding:8px;background:rgba(0,0,0,0.2);border-radius:10px;">'
                        + '<div style="font-size:18px;font-weight:bold;color:var(--primary);">' + report.completionRate + '<span style="font-size:10px;">%</span></div>'
                        + '<div style="font-size:9px;color:rgba(255,255,255,0.5);">7æ—¥è¾¾æ ‡ç‡</div></div>'
                        + '<div style="padding:8px;background:rgba(0,0,0,0.2);border-radius:10px;">'
                        + '<div style="font-size:18px;font-weight:bold;color:var(--gold);">' + report.streakDays + '<span style="font-size:10px;">å¤©</span></div>'
                        + '<div style="font-size:9px;color:rgba(255,255,255,0.5);">è¿ç»­ç­¾åˆ°</div></div>'
                        + '</div>'
                        + '<div style="margin-top:8px;text-align:center;font-size:11px;color:' + trendColor + ';">'
                        + trendIcon + ' ' + trendText + ' Â· 7æ—¥å‡é‡ ' + report.avgIntake7d + 'ml/' + report.goal + 'ml'
                        + '</div></div>';
                } else {
                    reportEl.innerHTML = '';
                }
            } else {
                // å…è´¹ç”¨æˆ·çœ‹åˆ°æ¨¡ç³Šç‰ˆçš„æŠ¥å‘Šï¼ˆè¯±æƒ‘å‡çº§ï¼‰
                reportEl.innerHTML = '<div style="margin:12px 0;padding:14px;background:rgba(0,0,0,0.15);border:1px dashed rgba(255,215,0,0.25);border-radius:14px;position:relative;overflow:hidden;">'
                    + '<div style="filter:blur(4px);pointer-events:none;">'
                    + '<div style="font-size:12px;font-weight:bold;color:var(--primary);margin-bottom:8px;">ğŸ“Š æ¯æ—¥å¥åº·æŠ¥å‘Š</div>'
                    + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;text-align:center;">'
                    + '<div style="padding:6px;background:rgba(0,0,0,0.2);border-radius:8px;"><div style="font-size:16px;color:var(--primary);">1850ml</div><div style="font-size:8px;color:rgba(255,255,255,0.4);">ä»Šæ—¥é¥®æ°´</div></div>'
                    + '<div style="padding:6px;background:rgba(0,0,0,0.2);border-radius:8px;"><div style="font-size:16px;color:var(--gold);">85%</div><div style="font-size:8px;color:rgba(255,255,255,0.4);">7æ—¥è¾¾æ ‡</div></div>'
                    + '<div style="padding:6px;background:rgba(0,0,0,0.2);border-radius:8px;"><div style="font-size:16px;color:var(--success);">12å¤©</div><div style="font-size:8px;color:rgba(255,255,255,0.4);">è¿ç»­ç­¾åˆ°</div></div>'
                    + '</div></div>'
                    + '<div style="position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.2);">'
                    + '<span onclick="openPanel(\'memberPanel\');showUpgradePrompt();" style="padding:6px 16px;background:linear-gradient(135deg,var(--gold),#ff9800);border-radius:14px;color:#000;font-size:11px;font-weight:bold;cursor:pointer;">ğŸ”“ å‡çº§æŸ¥çœ‹æˆ‘çš„å¥åº·æŠ¥å‘Š</span>'
                    + '</div></div>';
            }
        }
        
        // â•â•â• æ˜¾ç¤ºè®¢å•çŠ¶æ€æé†’ â•â•â•
        var statusEl = document.getElementById('orderStatusNotice');
        if (!statusEl) {
            // åœ¨æ¿€æ´»ç è¾“å…¥æ¡†ä¸Šæ–¹æ’å…¥çŠ¶æ€åŒºåŸŸ
            var codeBox = document.getElementById('activationCodeInput');
            if (codeBox) {
                var wrapper = codeBox.closest('div[style*="background:rgba(0,212,255"]');
                if (wrapper) {
                    statusEl = document.createElement('div');
                    statusEl.id = 'orderStatusNotice';
                    wrapper.parentNode.insertBefore(statusEl, wrapper);
                }
            }
        }
        if (statusEl) {
            var orders = JSON.parse(localStorage.getItem('heshuilePendingOrders') || '[]');
            var myOrders = orders.filter(function(o){ return o.userId === user.phone; });
            var pending = myOrders.filter(function(o){ return o.status === 'pending'; });
            var approved = myOrders.filter(function(o){ return o.status === 'approved'; });
            
            var html = '';
            if (pending.length > 0 && user.level === 'free') {
                html += '<div style="margin-bottom:10px;padding:12px;background:rgba(255,152,0,0.1);border:1px solid rgba(255,152,0,0.3);border-radius:12px;">'
                    + '<div style="font-size:12px;color:#ff9800;font-weight:bold;">â³ æ‚¨æœ‰å¾…å®¡æ ¸çš„è®¢å•</div>'
                    + '<div style="font-size:11px;color:rgba(255,255,255,0.6);margin-top:4px;">' + pending[0].planName + ' Â· Â¥' + pending[0].amount + '</div>'
                    + '<div style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:4px;">ç®¡ç†å‘˜å®¡æ ¸åä¼šå‘é€æ¿€æ´»ç ç»™æ‚¨ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¿€æ´»ã€‚</div>'
                    + '</div>';
            }
            if (approved.length > 0 && user.level === 'free') {
                var lastApproved = approved[approved.length - 1];
                html += '<div style="margin-bottom:10px;padding:12px;background:rgba(0,200,83,0.1);border:1px solid rgba(0,200,83,0.3);border-radius:12px;">'
                    + '<div style="font-size:12px;color:var(--success);font-weight:bold;">âœ… è®¢å•å·²å®¡æ ¸é€šè¿‡ï¼</div>'
                    + '<div style="font-size:11px;color:rgba(255,255,255,0.6);margin-top:4px;">' + lastApproved.planName + ' Â· Â¥' + lastApproved.amount + '</div>'
                    + (lastApproved.activationCode ? '<div style="font-size:12px;color:#FFD700;margin-top:6px;font-weight:bold;">æ¿€æ´»ç ï¼š' + lastApproved.activationCode + '</div>' : '')
                    + '<div style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:4px;">è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¿€æ´»ç å®Œæˆå‡çº§ â†“</div>'
                    + '</div>';
            }
            statusEl.innerHTML = html;
        }
    }
    // ==================== æ°´å­¦è¯¾ç¨‹ç³»ç»Ÿ ====================
    const WATER_LESSONS = {
        science: [
            { title: 'ç¬¬1è¯¾ï¼šæ°´åˆ†å­çš„ç§˜å¯†', text: 'æ°´åˆ†å­ç”±ä¸¤ä¸ªæ°¢åŸå­å’Œä¸€ä¸ªæ°§åŸå­ç»„æˆï¼Œå½¢æˆ104.5åº¦çš„å¤¹è§’ã€‚è¿™ä¸ªè§’åº¦èµ‹äºˆäº†æ°´ç‹¬ç‰¹çš„ææ€§ï¼Œä½¿å®ƒæˆä¸º"ä¸‡èƒ½æº¶å‰‚"ã€‚ä¸€æ»´æ°´ä¸­çº¦å«æœ‰1.67Ã—10Â²Â¹ä¸ªæ°´åˆ†å­ï¼Œæ¯”å®‡å®™ä¸­çš„æ’æ˜Ÿè¿˜è¦å¤šã€‚', source: 'ã€Šæ°´ç§‘å­¦ã€‹ç¬¬ä¸€å·' },
            { title: 'ç¬¬2è¯¾ï¼šæ°´çš„ä¸‰æ€å¥‡è¿¹', text: 'æ°´æ˜¯å”¯ä¸€åœ¨è‡ªç„¶ç•Œä»¥å›ºæ€ã€æ¶²æ€ã€æ°”æ€ä¸‰ç§å½¢å¼å­˜åœ¨çš„ç‰©è´¨ã€‚å†°çš„å¯†åº¦æ¯”æ¶²æ€æ°´å°ï¼Œæ‰€ä»¥å†°èƒ½æµ®åœ¨æ°´é¢ï¼Œä¿æŠ¤äº†æ°´ä¸‹ç”Ÿç‰©åœ¨å¯’å†¬ä¸­å­˜æ´»ã€‚æ°´åœ¨4â„ƒæ—¶å¯†åº¦æœ€å¤§ï¼Œè¿™ä¸€ç‰¹æ€§å¯¹æ¹–æ³Šç”Ÿæ€è‡³å…³é‡è¦ã€‚', source: 'ã€Šæ°´ç§‘å­¦ã€‹ç¬¬ä¸€å·' },
            { title: 'ç¬¬3è¯¾ï¼šæ°¢é”®çš„åŠ›é‡', text: 'æ°´çš„æ¯”çƒ­å®¹æ˜¯æ‰€æœ‰å¸¸è§ç‰©è´¨ä¸­æœ€é«˜çš„ï¼Œè¿™ä½¿æ°´èƒ½å¤Ÿè°ƒèŠ‚åœ°çƒæ¸©åº¦ï¼Œç¨³å®šæ°”å€™ã€‚æ°´çš„è¡¨é¢å¼ åŠ›å¾ˆå¼ºï¼Œä½¿å°æ˜†è™«èƒ½åœ¨æ°´é¢è¡Œèµ°ï¼Œæ¤ç‰©èƒ½å°†æ°´ä»æ ¹éƒ¨è¾“é€åˆ°é¡¶ç«¯ã€‚è¿™ä¸€åˆ‡éƒ½æºäºæ°¢é”®â€”â€”æ°´åˆ†å­ä¹‹é—´çš„ç¥å¥‡çº½å¸¦ã€‚', source: 'ã€Šæ°´ç§‘å­¦ã€‹ç¬¬äºŒå·' },
            { title: 'ç¬¬4è¯¾ï¼šåœ°çƒçš„è¡€æ¶²', text: 'åœ°çƒä¸Šçš„æ°´æ€»é‡çº¦14äº¿ç«‹æ–¹åƒç±³ï¼Œä½†æ·¡æ°´ä»…å 2.5%ï¼Œå¯ç›´æ¥åˆ©ç”¨çš„æ›´ä¸åˆ°1%ã€‚æ°´å¾ªç¯æ˜¯åœ°çƒæœ€ä¼Ÿå¤§çš„å¾ªç¯ç³»ç»Ÿâ€”â€”è’¸å‘ã€å‡ç»“ã€é™æ°´ã€æ¸—æµï¼Œæ¯ä¸€æ»´æ°´éƒ½åœ¨æ°¸æ’åœ°æ—…è¡Œã€‚', source: 'ã€Šæ°´ç§‘å­¦ã€‹ç¬¬äºŒå·' },
            { title: 'ç¬¬5è¯¾ï¼šä¸‡èƒ½æº¶å‰‚', text: 'çº¯å‡€æ°´èƒ½æº¶è§£æ¯”ä»»ä½•å…¶ä»–æ¶²ä½“æ›´å¤šçš„ç‰©è´¨ã€‚æ°´åˆ†å­çš„ææ€§ä½¿å®ƒèƒ½æ‹†æ•£ç›ç±»çš„ç¦»å­é”®ï¼ŒåŒ…è£¹ä½æº¶è´¨åˆ†å­ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæµ·æ°´æ˜¯å’¸çš„ï¼Œè¡€æ¶²èƒ½è¿è¾“è¥å…»ã€‚æ°´çš„æº¶è§£èƒ½åŠ›æ˜¯ç”Ÿå‘½å­˜åœ¨çš„åŸºç¡€ã€‚', source: 'ã€Šæ°´ç§‘å­¦ã€‹ç¬¬ä¸‰å·' },
            { title: 'ç¬¬6è¯¾ï¼šæ°´ä¸å£°éŸ³', text: 'å£°éŸ³åœ¨æ°´ä¸­ä¼ æ’­é€Ÿåº¦çº¦1500ç±³æ¯ç§’ï¼Œæ˜¯ç©ºæ°”ä¸­çš„4.3å€ã€‚é²¸é±¼çš„æ­Œå£°å¯åœ¨æµ·æ´‹ä¸­ä¼ æ’­æ•°åƒå…¬é‡Œã€‚æ°´çš„å¯†åº¦ä½¿å®ƒæˆä¸ºä¼˜ç§€çš„å£°éŸ³ä¼ å¯¼ä»‹è´¨ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ°´ä¸‹èƒ½å¬åˆ°è¿œå¤„å£°éŸ³ã€‚', source: 'ã€Šæ°´ç§‘å­¦ã€‹ç¬¬ä¸‰å·' },
            { title: 'ç¬¬7è¯¾ï¼šæ°´çš„é¢œè‰²ä¹‹è°œ', text: 'çº¯å‡€çš„æ°´å…¶å®æ˜¯æ·¡è“è‰²çš„ï¼Œå› ä¸ºæ°´åˆ†å­ä¼šå¸æ”¶çº¢è‰²å…‰æ³¢ã€‚å¤§æµ·çš„è“è‰²æ¥è‡ªå¤©ç©ºçš„åå°„å’Œæ°´æœ¬èº«çš„å¸å…‰ç‰¹æ€§ã€‚ä¸åŒæ°´åŸŸå‘ˆç°ä¸åŒé¢œè‰²â€”â€”ç¿¡ç¿ æ¹–çš„ç»¿ã€é»„æ²³çš„é»„ï¼Œéƒ½ä¸æ°´ä¸­ç‰©è´¨æœ‰å…³ã€‚', source: 'ã€Šæ°´ç§‘å­¦ã€‹ç¬¬å››å·' },
            { title: 'ç¬¬8è¯¾ï¼šç©ºæ°”ä¸­çš„æ°´', text: 'å…¨çƒå¤§æ°”ä¸­å«æœ‰çº¦13ä¸‡äº¿å¨æ°´è’¸æ°”ï¼Œç›¸å½“äºåœ°çƒä¸Šæ‰€æœ‰æ²³æµæ°´é‡çš„6å€ã€‚å¤§æ°”æ°´å‘ç”Ÿå™¨AWGæŠ€æœ¯é€šè¿‡åˆ¶å†·å†·å‡ä»ç©ºæ°”ä¸­æå–é¥®ç”¨æ°´ï¼Œä¸ºç¼ºæ°´åœ°åŒºæä¾›å…¨æ–°æ°´æºæ–¹æ¡ˆã€‚ç¦èƒ½è¾¾FNDæ˜¯è¿™ä¸€é¢†åŸŸçš„å…ˆé©±ã€‚', source: 'ã€Šæ°´ç§‘å­¦ã€‹ç¬¬äº”å·' },
            { title: 'ç¬¬9è¯¾ï¼šæ°´çš„è®°å¿†äº‰è®®', text: 'æ°´æ˜¯å¦æœ‰"è®°å¿†"ï¼Ÿç§‘å­¦ç•Œé•¿æœŸäº‰è®ºã€‚ä»ç‰©ç†è§’åº¦çœ‹ï¼Œæ°´åˆ†å­çš„æ°¢é”®ç½‘ç»œæ¯çš®ç§’éƒ½åœ¨é‡ç»„ã€‚ä½†æ°´çš„å›¢ç°‡ç»“æ„ç­‰ç ”ç©¶æç¤ºï¼Œæ°´å¯èƒ½ä»¥æˆ‘ä»¬å°šæœªå®Œå…¨ç†è§£çš„æ–¹å¼ä¿å­˜ä¿¡æ¯ã€‚ç§‘å­¦æ¢ç´¢æ°¸æ— æ­¢å¢ƒã€‚', source: 'ã€Šæ°´ç§‘å­¦ã€‹ç¬¬äº”å·' },
            { title: 'ç¬¬10è¯¾ï¼šæœªæ¥æ°´ç§‘æŠ€', text: 'æµ·æ°´æ·¡åŒ–ã€å¤§æ°”å–æ°´ã€æ±¡æ°´å†ç”Ÿã€çº³ç±³å‡€æ°´è†œâ€¦â€¦æ°´ç§‘æŠ€æ­£åœ¨æ”¹å˜äººç±»ç”¨æ°´æ–¹å¼ã€‚åˆ°2050å¹´å…¨çƒå°†æœ‰50äº¿äººé¢ä¸´ç¼ºæ°´å±æœºã€‚æ°´ç§‘æŠ€ä¸ä»…æ˜¯å•†ä¸šæœºä¼šï¼Œæ›´æ˜¯äººç±»ç”Ÿå­˜çš„å¿…ç­”é¢˜ã€‚', source: 'ã€Šæ°´ç§‘å­¦ã€‹ç¬¬äº”å·' }
        ],
        philosophy: [
            { title: 'ç¬¬1è¯¾ï¼šä¸Šå–„è‹¥æ°´', text: 'è€å­ã€Šé“å¾·ç»ã€‹äº‘ï¼š"ä¸Šå–„è‹¥æ°´ï¼Œæ°´å–„åˆ©ä¸‡ç‰©è€Œä¸äº‰ï¼Œå¤„ä¼—äººä¹‹æ‰€æ¶ï¼Œæ•…å‡ äºé“ã€‚"æ°´çš„å“å¾·æ˜¯æ— ç§å¥‰çŒ®ã€æ»‹å…»ä¸‡ç‰©ï¼Œå´ä»ä¸è‡ªå¤¸ã€‚æ°´å¾€ä½å¤„æµï¼Œæ­£å¦‚è°¦å‘çš„æ™ºè€…ã€‚åšäººå½“å­¦æ°´ï¼Œåˆ©ä»–ä¸äº‰ã€‚', source: 'ã€Šæ°´å“²å­¦ã€‹ç¬¬ä¸€å·' },
            { title: 'ç¬¬2è¯¾ï¼šæ°´çš„æŸ”ä¸åˆš', text: 'æ°´è‡³æŸ”å´èƒ½ç©¿çŸ³ï¼Œè‡³å¼±å´èƒ½è½½èˆŸã€‚æ°´çš„åŠ›é‡ä¸åœ¨äºå¯¹æŠ—ï¼Œè€Œåœ¨äºé¡ºåŠ¿è€Œä¸ºã€æŒä¹‹ä»¥æ’ã€‚å¤©ä¸‹è«æŸ”å¼±äºæ°´ï¼Œè€Œæ”»åšå¼ºè€…è«ä¹‹èƒ½èƒœã€‚ä»¥æŸ”å…‹åˆšï¼ŒåšæŒä¸æ‡ˆï¼Œç»ˆèƒ½æˆå°±å¤§äº‹ã€‚', source: 'ã€Šæ°´å“²å­¦ã€‹ç¬¬ä¸€å·' },
            { title: 'ç¬¬3è¯¾ï¼šæ°´çš„æ™ºæ…§', text: 'æ°´æ— å¸¸å½¢ï¼Œéšå™¨è€Œå˜ï¼›æ°´æ— å¸¸æ€ï¼Œå› æ¸©è€ŒåŒ–ã€‚æ°´æ•™ä¼šæˆ‘ä»¬é€‚åº”ç¯å¢ƒã€çµæ´»å˜é€šã€‚ä¸å›ºæ‰§å·±è§ï¼Œä¸å¼ºæ±‚ç»“æœï¼Œé¡ºå…¶è‡ªç„¶ï¼Œæ–¹èƒ½æµ·çº³ç™¾å·ã€‚å­”å­æ›°ï¼š"æ™ºè€…ä¹æ°´"ï¼Œæ°´çš„æ™ºæ…§åœ¨äºåŒ…å®¹ä¸å˜é€šã€‚', source: 'ã€Šæ°´å“²å­¦ã€‹ç¬¬äºŒå·' },
            { title: 'ç¬¬4è¯¾ï¼šæ°´ä¸æ—¶é—´', text: 'æ°´æ»´çŸ³ç©¿ï¼Œéä¸€æ—¥ä¹‹åŠŸï¼›å†°å†»ä¸‰å°ºï¼Œéä¸€æ—¥ä¹‹å¯’ã€‚æ°´æ•™ä¼šæˆ‘ä»¬æ—¶é—´çš„åŠ›é‡ã€‚æ­£å¦‚ã€Œä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰ã€â€”â€”æ¯ä¸€ç§’çš„åšæŒï¼Œéƒ½æ˜¯æ°´æ»´ç©¿çŸ³çš„åŠ›é‡ã€‚çæƒœæ—¶é—´ï¼Œå°±æ˜¯çæƒœç”Ÿå‘½ä¸­çš„æ¯ä¸€æ»´æ°´ã€‚', source: 'ã€Šæ°´å“²å­¦ã€‹ç¬¬äºŒå·' },
            { title: 'ç¬¬5è¯¾ï¼šæµ·çº³ç™¾å·', text: 'å¤§æµ·ä¸ºä»€ä¹ˆèƒ½æˆä¸ºç™¾å·ä¹‹ç‹ï¼Ÿå› ä¸ºå®ƒå–„äºå¤„ä¸‹ã€‚æ±Ÿæ²³æ¹–æµ·ï¼Œä¸æ‹’ç»†æµï¼Œæ•…èƒ½æˆå…¶å¤§ã€‚ç®¡ç†ä¹‹é“äº¦å¦‚æ°´â€”â€”è¶Šæ˜¯è°¦é€ŠåŒ…å®¹ï¼Œè¶Šèƒ½æ±‡èšäººæ‰ã€‚æµ·çº³ç™¾å·ï¼Œæœ‰å®¹ä¹ƒå¤§ã€‚', source: 'ã€Šæ°´å“²å­¦ã€‹ç¬¬ä¸‰å·' },
            { title: 'ç¬¬6è¯¾ï¼šæ— ä¸ºä¹‹é“', text: 'æ°´ä¸åˆ»æ„è¿½æ±‚ä»€ä¹ˆï¼Œå´è‡ªç„¶è€Œç„¶åœ°æ»‹å…»äº†ä¸‡ç‰©ã€‚è¿™å°±æ˜¯"æ— ä¸ºè€Œæ— ä¸ä¸º"ã€‚ä¸æ˜¯ä»€ä¹ˆéƒ½ä¸åšï¼Œè€Œæ˜¯ä¸å¼ºä¸ºã€ä¸å¦„ä¸ºï¼Œé¡ºåº”è§„å¾‹å»åšã€‚æœ€é«˜çš„æ•ˆç‡ï¼Œå¾€å¾€æ¥è‡ªæœ€è‡ªç„¶çš„çŠ¶æ€ã€‚', source: 'ã€Šæ°´å“²å­¦ã€‹ç¬¬ä¸‰å·' },
            { title: 'ç¬¬7è¯¾ï¼šæ¸…æµŠä¹‹è¾¨', text: 'æ°´æ¸…åˆ™å¯é‰´äººï¼Œæ°´æµŠåˆ™ä¸å¯é¥®ã€‚ä¿æŒå†…å¿ƒæ¸…æ¾ˆï¼Œå°±åƒä¿æŒæ°´çš„çº¯å‡€ã€‚ä½†æ°´è‹¥å¤ªæ¸…åˆ™æ— é±¼â€”â€”åšäººæ—¢è¦æ¸…æ­£ï¼Œä¹Ÿè¦åŒ…å®¹ã€‚æ¸…æµŠä¹‹é—´çš„å¹³è¡¡ï¼Œå°±æ˜¯æ°´æ•™ç»™æˆ‘ä»¬çš„ä¸­åº¸ä¹‹é“ã€‚', source: 'ã€Šæ°´å“²å­¦ã€‹ç¬¬ä¸‰å·' },
            { title: 'ç¬¬8è¯¾ï¼šæ°´è‹¥å–„çš„ä¿¡å¿µ', text: 'æ°´è‹¥å–„ï¼Œå–è‡ª"ä¸Šå–„è‹¥æ°´"ä¹‹æ„ã€‚è‹¥â€”â€”å¦‚åŒã€å­¦ä¹ ï¼›å–„â€”â€”å–„è‰¯ã€ç¾å¥½ã€‚æ°´è‹¥å–„å°±æ˜¯åƒæ°´ä¸€æ ·å–„è‰¯ï¼Œåƒæ°´ä¸€æ ·æ™ºæ…§ã€‚æ¯ä¸€æ¯æ°´éƒ½è•´å«ç€å¤§è‡ªç„¶çš„å–„æ„ï¼Œæ¯ä¸€æ¬¡é¥®æ°´éƒ½æ˜¯ä¸ç”Ÿå‘½çš„å¯¹è¯ã€‚', source: 'æ°´è‹¥å–„' }
        ],
        health: [
            { title: 'ç¬¬1è¯¾ï¼šæ™¨èµ·ä¸€æ¯æ°´', text: 'æ—©æ™¨èµ·åºŠåç©ºè…¹å–ä¸€æ¯æ¸©æ°´ï¼Œå¯å”¤é†’è‚ èƒƒã€ç¨€é‡Šè¡€æ¶²ã€ä¿ƒè¿›æ’æ¯’ã€‚æœ€ä½³æ°´æ¸©35-40åº¦ï¼Œå¯åŠ å°‘è®¸èœ‚èœœæˆ–æŸ æª¬ã€‚è¿™æ˜¯å¼€å¯å¥åº·ä¸€å¤©çš„æœ€ä½³æ–¹å¼ã€‚ä¸­åŒ»è®¤ä¸ºæ™¨æ°´å…»é˜³ï¼Œæ¶¦æ³½äº”è„ã€‚', source: 'ã€Šæ°´å¥åº·ã€‹ç¬¬ä¸€å·' },
            { title: 'ç¬¬2è¯¾ï¼šé¥®æ°´ä¸æ’æ¯’', text: 'äººä½“çº¦70%æ˜¯æ°´ï¼Œå¤§è„‘å«æ°´é‡é«˜è¾¾80%ã€‚æ¯å¤©å–è¶³å¤Ÿçš„æ°´å¸®åŠ©æ’å‡ºæ¯’ç´ ï¼Œç»´æŒè‚¾è„å¥åº·ï¼Œé¢„é˜²è‚¾ç»“çŸ³ã€‚æ¯å¤©åº”é¥®ç”¨2000-3000æ¯«å‡ï¼Œå°‘é‡å¤šæ¬¡ä¸ºå®œã€‚è„±æ°´2%å°±èƒ½é™ä½æ³¨æ„åŠ›å’Œè®°å¿†åŠ›ã€‚', source: 'ã€Šæ°´å¥åº·ã€‹ç¬¬ä¸€å·' },
            { title: 'ç¬¬3è¯¾ï¼šæ°´ç–—çš„æ™ºæ…§', text: 'æ°´ç–—æ³•æºè¿œæµé•¿ï¼Œå¤å¸Œè…Šçš„å¸Œæ³¢å…‹æ‹‰åº•å°±æå€¡ç”¨æ°´æ²»ç—…ã€‚çƒ­æ°´ä¿ƒè¿›è¡€æ¶²å¾ªç¯ï¼Œå†·æ°´å¢å¼ºå…ç–«åŠ›ï¼Œäº¤æ›¿ä½¿ç”¨æ•ˆæœæ›´ä½³ã€‚æ¸©æ³‰æµ´å¯ç¼“è§£å…³èŠ‚ç–¼ç—›ï¼Œæ˜¯è‡ªç„¶ç•Œèµäºˆäººç±»çš„è‰¯è¯ã€‚', source: 'ã€Šæ°´å¥åº·ã€‹ç¬¬ä¸‰å·' },
            { title: 'ç¬¬4è¯¾ï¼šæ°´ä¸ç»ç»œ', text: 'ä¸­åŒ»è®¤ä¸ºæ°´æ¶²åœ¨ä½“å†…çš„è¿è¡Œä¸ç»ç»œå¯†åˆ‡ç›¸å…³ã€‚ä¸‰ç„¦æ˜¯æ°´æ¶²ä»£è°¢çš„é€šé“ï¼Œè†€èƒ±ç»ä¸»ç®¡æ°´æ¶²æ’æ³„ã€‚é€šè¿‡é’ˆç¸ã€æŒ‰æ‘©ç›¸å…³ç©´ä½ï¼Œå¯è°ƒèŠ‚æ°´æ¶²ä»£è°¢ã€‚é¥®æ°´å…»ç”Ÿï¼Œä¸å¯å¿½è§†ç»ç»œä¹‹é“ã€‚', source: 'ã€Šæ°´å¥åº·ã€‹ç¬¬å››å·' },
            { title: 'ç¬¬5è¯¾ï¼šç§‘å­¦é¥®æ°´æ—¶é—´è¡¨', text: 'æ—©7ç‚¹250æ¯«å‡å”¤é†’èº«ä½“ï¼Œ9ç‚¹200æ¯«å‡æå‡æ•ˆç‡ï¼Œ11ç‚¹åŠ200æ¯«å‡åŠ©æ¶ˆåŒ–ï¼Œä¸‹åˆ3ç‚¹200æ¯«å‡ç¼“è§£ç–²åŠ³ï¼Œå‚æ™š5ç‚¹200æ¯«å‡ä¿ƒä»£è°¢ï¼Œç¡å‰9ç‚¹100æ¯«å‡é˜²è„±æ°´ã€‚æ ¸å¿ƒåŸåˆ™ï¼šå°‘é‡å¤šæ¬¡ã€‚', source: 'ã€Šæ°´å¥åº·ã€‹ç¬¬äºŒå·' },
            { title: 'ç¬¬6è¯¾ï¼šè¿åŠ¨ä¸è¡¥æ°´', text: 'è¿åŠ¨å‰2å°æ—¶é¢„è¡¥æ°´300-500æ¯«å‡ã€‚è¿åŠ¨ä¸­æ¯15-20åˆ†é’Ÿè¡¥å……150-200æ¯«å‡ã€‚è¿åŠ¨å1å°æ—¶å†…è¡¥å……æµå¤±é‡çš„150%ã€‚å‰§çƒˆè¿åŠ¨è¶…1å°æ—¶å»ºè®®å«ç”µè§£è´¨çš„è¿åŠ¨é¥®æ–™è¡¥å……é’ é’¾ã€‚', source: 'ã€Šæ°´å¥åº·ã€‹ç¬¬äº”å·' },
            { title: 'ç¬¬7è¯¾ï¼šç‰¹æ®Šäººç¾¤é¥®æ°´', text: 'è€å¹´äººå£æ¸´æ„Ÿå‡é€€éœ€ä¸»åŠ¨å®šæ—¶é¥®æ°´ã€‚å„¿ç«¥1-3å²çº¦700æ¯«å‡ï¼Œ4-8å²çº¦1000æ¯«å‡ã€‚å­•å¦‡æ¯å¤©å»ºè®®2300æ¯«å‡ï¼Œå“ºä¹³æœŸ2700æ¯«å‡ä»¥ä¸Šã€‚æ…¢æ€§ç—…æ‚£è€…åœ¨åŒ»ç”ŸæŒ‡å¯¼ä¸‹è°ƒæ•´ã€‚', source: 'ã€Šæ°´å¥åº·ã€‹ç¬¬å…­å·' },
            { title: 'ç¬¬8è¯¾ï¼šæ°´ä¸ç¾å®¹', text: 'çš®è‚¤å«æ°´é‡çº¦70%ï¼Œç¼ºæ°´å¯¼è‡´å¹²ç‡¥ã€æš—æ²‰ã€ç»†çº¹ã€‚æ¯å¤©2000æ¯«å‡ä»¥ä¸Šçš„é¥®æ°´é‡æ˜¯åŸºç¡€æŠ¤è‚¤ã€‚å……è¶³é¥®æ°´åŠ é€‚å½“æŠ¤è‚¤æ˜¯é»„é‡‘ç»„åˆã€‚ä»å†…åˆ°å¤–çš„æ°´æ¶¦ï¼Œæ‰æ˜¯çœŸæ­£çš„ç¾ä¸½ã€‚', source: 'ã€Šæ°´å¥åº·ã€‹ç¬¬ä¸ƒå·' },
            { title: 'ç¬¬9è¯¾ï¼šæ°´ä¸ç¡çœ ', text: 'ç¡å‰1å°æ—¶é€‚é‡é¥®æ°´100-150æ¯«å‡å¯é¢„é˜²å¤œé—´è„±æ°´ï¼Œä½†ä¸å®œè¿‡å¤šä»¥å…èµ·å¤œã€‚å§å®¤ä¿æŒæ¹¿åº¦40-60%æœ‰åŠ©ç¡çœ ã€‚è„±æ°´ä¼šå¯¼è‡´å¤œé—´è…¿éƒ¨æŠ½ç­‹å’Œå£å¹²ï¼Œå½±å“ç¡çœ è´¨é‡ã€‚', source: 'ã€Šæ°´å¥åº·ã€‹ç¬¬å…«å·' },
            { title: 'ç¬¬10è¯¾ï¼šå››å­£é¥®æ°´å…»ç”Ÿ', text: 'æ˜¥é¥®èŠ±èŒ¶ç–è‚è§£éƒï¼Œå¤é¥®ç»¿èŒ¶æ¸…çƒ­æ¶ˆæš‘ï¼Œç§‹é¥®ä¹Œé¾™æ¶¦ç‡¥ç”Ÿæ´¥ï¼Œå†¬é¥®çº¢èŒ¶æ¸©èƒƒæš–èº«ã€‚ä¸åŒå­£èŠ‚é¥®æ°´æ¸©åº¦ä¹Ÿåº”è°ƒæ•´ï¼šå¤å­£å¯ç¨å‡‰ä¸ä½äº10åº¦ï¼Œå†¬å­£æ¸©çƒ­ä¸ºå®œã€‚é¡ºåº”èŠ‚æ°”ï¼Œæ°´åˆ°æ¸ æˆã€‚', source: 'ã€Šæ°´å¥åº·ã€‹ç¬¬åå·' }
        ]
    };

    // è‹æ ¼æ‹‰åº•å¯¹è¯æ ‘
    const SOCRATIC_TREE = [
        { id: 0, role: 'master', text: 'æ¬¢è¿æ¥åˆ°æ°´çš„æ™ºæ…§æ®¿å ‚ã€‚æˆ‘æ˜¯ä½ çš„æ°´å­¦å¯¼å¸ˆã€‚è®©æˆ‘ä»¬é€šè¿‡å¯¹è¯æ¥æ¢ç´¢æ°´çš„å¥¥ç§˜ã€‚è¯·é—®â€”â€”ä½ è®¤ä¸ºï¼Œæ°´æœ€é‡è¦çš„å“è´¨æ˜¯ä»€ä¹ˆï¼Ÿ',
          options: [
            { text: 'æˆ‘è§‰å¾—æ˜¯æ°´çš„æŸ”è½¯å’ŒåŒ…å®¹', next: 1 },
            { text: 'åº”è¯¥æ˜¯æ°´èƒ½æ»‹å…»ä¸‡ç‰©çš„èƒ½åŠ›', next: 2 },
            { text: 'æ°´èƒ½ä»¥æŸ”å…‹åˆšï¼Œçœ‹ä¼¼å¼±å®åˆ™å¼º', next: 3 }
          ]
        },
        { id: 1, role: 'master', text: 'å¾ˆå¥½çš„è§‚å¯Ÿï¼è€å­è¯´"ä¸Šå–„è‹¥æ°´"ã€‚æ°´ç¡®å®è‡³æŸ”è‡³é¡ºã€‚ä½†ä½ æ˜¯å¦æƒ³è¿‡â€”â€”æ°´çš„æŸ”è½¯æ°æ°æ˜¯å®ƒæœ€å¤§çš„åŠ›é‡ï¼Ÿè¯•æƒ³ï¼Œæ°´æ»´ä¸ºä½•èƒ½ç©¿çŸ³ï¼Ÿ',
          options: [
            { text: 'å› ä¸ºæ°´æŒä¹‹ä»¥æ’ï¼Œä»ä¸æ”¾å¼ƒ', next: 4 },
            { text: 'å› ä¸ºæ°´ä¸ä¸çŸ³å¤´ç¡¬ç¢°ç¡¬ï¼Œè€Œæ˜¯æ‰¾åˆ°ç¼éš™', next: 5 }
          ]
        },
        { id: 2, role: 'master', text: 'è¯´å¾—å¥½ï¼æ°´æ»‹å…»ä¸‡ç‰©å´ä¸äº‰åŠŸã€‚ä¸–é—´è¿˜æœ‰ä»€ä¹ˆæ¯”è¿™æ›´æ¥è¿‘"é“"å‘¢ï¼Ÿé‚£ä¹ˆæˆ‘é—®ä½ â€”â€”å¦‚æœæ°´åªæ»‹å…»è€Œä»ä¸ç´¢å–ï¼Œå®ƒä¼šæ¯ç«­å—ï¼Ÿ',
          options: [
            { text: 'ä¸ä¼šï¼Œå› ä¸ºæ°´æœ‰å¾ªç¯â€”â€”è’¸å‘ååˆä¼šå›æ¥', next: 6 },
            { text: 'ä¼šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦çæƒœæ°´èµ„æº', next: 7 }
          ]
        },
        { id: 3, role: 'master', text: 'å¥½ä¸€ä¸ª"ä»¥æŸ”å…‹åˆš"ï¼ã€Šé“å¾·ç»ã€‹äº‘ï¼š"å¤©ä¸‹è«æŸ”å¼±äºæ°´ï¼Œè€Œæ”»åšå¼ºè€…è«ä¹‹èƒ½èƒœã€‚"ä½ è§‰å¾—è¿™ä¸ªé“ç†å¯ä»¥ç”¨åœ¨ç”Ÿæ´»ä¸­çš„ä»€ä¹ˆåœ°æ–¹ï¼Ÿ',
          options: [
            { text: 'é¢å¯¹å›°éš¾æ—¶ï¼Œä¸è¦ç¡¬æ’‘ï¼Œè¦å­¦ä¼šå˜é€š', next: 8 },
            { text: 'ä¸äººç›¸å¤„æ—¶ï¼Œæ¸©å’Œæ¯”å¼ºç¡¬æ›´æœ‰åŠ›é‡', next: 9 }
          ]
        },
        { id: 4, role: 'master', text: 'æ­£æ˜¯å¦‚æ­¤ï¼åšæŒï¼Œæ˜¯æ—¶é—´èµ‹äºˆæ°´çš„æ­¦å™¨ã€‚æ­£å¦‚æˆ‘ä»¬è¯´ã€Œä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰ã€â€”â€”æ¯ä¸€ç§’çš„åšæŒéƒ½æ˜¯ä¸€æ»´æ°´ï¼Œç»ˆå°†ç©¿é€ä¸€åˆ‡é˜»ç¢ã€‚ä½ ç°åœ¨æ˜ç™½æ—¶é—´ä¸æ°´çš„å…³ç³»äº†å—ï¼Ÿ',
          options: [
            { text: 'æ˜ç™½äº†ï¼æ¯ä¸€ç§’éƒ½åƒä¸€æ»´æ°´ï¼Œç§¯å°‘æˆå¤š', next: 10 },
            { text: 'æˆ‘æƒ³ç»§ç»­æ¢ç´¢æ°´çš„å…¶ä»–æ™ºæ…§', next: 11 }
          ]
        },
        { id: 5, role: 'master', text: 'å¦™å“‰ï¼æ°´ä»ä¸æ­£é¢å¯¹æŠ—ï¼Œå®ƒæ€»æ˜¯æ‰¾åˆ°æœ€ä¼˜è·¯å¾„ã€‚å±±æŒ¡ä¸ä½æ°´ï¼ŒçŸ³æ‹¦ä¸ä½æ²³ã€‚æ°´æ•™ä¼šæˆ‘ä»¬ï¼šé‡åˆ°éšœç¢ä¸è¦ç¡¬ç¢°ï¼Œç»•è¿‡å»ï¼Œæˆ–è€…æ…¢æ…¢æ¸—é€ã€‚',
          options: [
            { text: 'è¿™å°±æ˜¯"é¡ºåŠ¿è€Œä¸º"çš„æ™ºæ…§', next: 10 },
            { text: 'æ°´è¿˜æœ‰ä»€ä¹ˆäººç”Ÿæ™ºæ…§ï¼Ÿ', next: 11 }
          ]
        },
        { id: 6, role: 'master', text: 'ç²¾å½©ï¼ä½ å‘ç°äº†æ°´å¾ªç¯çš„æ·±å±‚æ™ºæ…§ã€‚ç»™äºˆå¹¶ä¸æ„å‘³ç€å¤±å»â€”â€”æ°´è’¸å‘åˆ°å¤©ç©ºï¼ŒåŒ–ä¸ºé›¨éœ²é‡è¿”å¤§åœ°ã€‚å–„è¡Œå¦‚æ°´ï¼Œç»ˆå°†å›åˆ°è‡ªå·±èº«è¾¹ã€‚è¿™å°±æ˜¯"ä¸Šå–„è‹¥æ°´"çš„å®Œæ•´å«ä¹‰ã€‚',
          options: [
            { text: 'åŸæ¥"å–„"ä¹Ÿæœ‰å¾ªç¯ï¼Œä»˜å‡ºç»ˆæœ‰å›æŠ¥', next: 10 },
            { text: 'æˆ‘è¿˜æƒ³äº†è§£æ›´å¤š', next: 11 }
          ]
        },
        { id: 7, role: 'master', text: 'çæƒœï¼Œæ˜¯æ™ºæ…§çš„å¼€ç«¯ã€‚æ­£å¦‚çæƒœæ—¶é—´ä¸€æ ·ï¼Œæ¯ä¸€æ»´æ°´ã€æ¯ä¸€ç§’é’Ÿéƒ½å€¼å¾—æ•¬ç•ã€‚ã€Œåˆ†ç§’å¿…äº‰ã€ä¸ä»…æ˜¯å¯¹æ—¶é—´çš„æ€åº¦ï¼Œä¹Ÿæ˜¯å¯¹ç”Ÿå‘½ä¸­ä¸€åˆ‡çè´µäº‹ç‰©çš„æ€åº¦ã€‚',
          options: [
            { text: 'æˆ‘ç†è§£äº†ï¼Œçæƒœæ—¶é—´å°±æ˜¯çæƒœç”Ÿå‘½', next: 10 },
            { text: 'ç»§ç»­å­¦ä¹ æ°´çš„é“ç†', next: 11 }
          ]
        },
        { id: 8, role: 'master', text: 'å¯¹ï¼æ°´é‡åˆ°çŸ³å¤´ä¸ä¼šåœä¸‹ï¼Œè€Œæ˜¯æ”¹å˜æ–¹å‘ç»§ç»­æµåŠ¨ã€‚è¿™å°±æ˜¯"æ°´çš„å˜é€š"â€”â€”ä¸æ‰§ç€äºå½¢å¼ï¼Œåªæ‰§ç€äºç›®æ ‡ã€‚ç”Ÿæ´»ä¸­é‡åˆ°æŒ«æŠ˜ï¼Œæ¢æ¡è·¯èµ°ï¼Œä¾ç„¶èƒ½åˆ°è¾¾å¤§æµ·ã€‚',
          options: [{ text: 'å—æ•™äº†ï¼Œè°¢è°¢å¯¼å¸ˆçš„æŒ‡ç‚¹', next: 10 }]
        },
        { id: 9, role: 'master', text: 'å­”å­è¯´"æ™ºè€…ä¹æ°´"ã€‚æ¸©å’Œçš„æ°´çœ‹ä¼¼æ— åŠ›ï¼Œå´èƒ½æ„ŸåŒ–åšç¡¬çš„çŸ³å¤´ã€‚ä¸äººç›¸å¤„ï¼Œæ¸©æ¶¦å¦‚æ°´æ¯”é”‹åˆ©å¦‚åˆ€æ›´èƒ½èµ¢å¾—äººå¿ƒã€‚è¿™å°±æ˜¯æ°´çš„æ™ºæ…§â€”â€”åˆ©ä»–è€Œä¸äº‰ã€‚',
          options: [{ text: 'æ¸©æ¶¦å¦‚æ°´ï¼Œåˆ©ä»–ä¸äº‰ï¼Œæˆ‘è®°ä½äº†', next: 10 }]
        },
        { id: 10, role: 'master', text: 'ğŸ“ æ­å–œä½ å®Œæˆäº†è¿™æ®µæ°´çš„æ™ºæ…§å¯¹è¯ï¼è®°ä½ï¼šåƒæ°´ä¸€æ ·æŸ”è½¯ï¼Œåƒæ°´ä¸€æ ·åšæŒï¼Œåƒæ°´ä¸€æ ·åŒ…å®¹ã€‚çæƒœæ¯ä¸€ç§’ï¼Œå¦‚åŒçæƒœæ¯ä¸€æ»´æ°´ã€‚ã€Œä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰ã€â€”â€”æ„¿ä½ çš„äººç”Ÿå¦‚æ°´èˆ¬ä¸°ç›ˆã€‚',
          options: [{ text: 'ğŸ”„ é‡æ–°å¼€å§‹å¯¹è¯', next: 0 }, { text: 'ğŸ”Š æœ—è¯»æ€»ç»“', next: -1 }]
        },
        { id: 11, role: 'master', text: 'æ°´è¿˜æœ‰ä¸€ä¸ªé‡è¦å“è´¨â€”â€”åŒ…å®¹ã€‚å¤§æµ·ä¸ºä½•èƒ½æˆä¸ºç™¾å·ä¹‹ç‹ï¼Ÿå› ä¸ºå®ƒå¤„äºæœ€ä½å¤„ï¼Œä¸æ‹’ç»ä»»ä½•ä¸€æ¡æ²³æµã€‚è¶Šæ˜¯ä¼Ÿå¤§çš„äººï¼Œè¶Šæ˜¯è°¦é€ŠåŒ…å®¹ã€‚ä½ è§‰å¾—è‡ªå·±åœ¨ç”Ÿæ´»ä¸­å¤Ÿ"åŒ…å®¹"å—ï¼Ÿ',
          options: [
            { text: 'æœ‰æ—¶å€™åšä¸åˆ°ï¼Œä½†æˆ‘æ„¿æ„å­¦ä¹ ', next: 10 },
            { text: 'åŒ…å®¹å¾ˆéš¾ï¼Œä½†æ°´ç»™äº†æˆ‘å¯å‘', next: 10 }
          ]
        }
    ];

    let currentWaterCategory = 'science';
    let currentWaterIndex = 0;
    let socraticNode = 0;
    
    // æ°´å­¦å­¦ä¹ è¿›åº¦è¿½è¸ª
    let waterLearning = { viewed: [], listened: [], totalViewed: 0, freeQuota: 5, quotaUsed: 0, unlocked: false };

    function switchWaterTab(tab) {
        currentWaterCategory = tab;
        currentWaterIndex = 0;
        document.querySelectorAll('.water-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        const lessonArea = document.getElementById('waterLessonContent');
        const socraticArea = document.getElementById('socraticSection');
        if (tab === 'socratic') {
            lessonArea.style.display = 'none';
            socraticArea.style.display = 'block';
            startSocratic();
        } else {
            lessonArea.style.display = 'block';
            socraticArea.style.display = 'none';
            renderWaterLesson();
        }
    }

    function renderWaterLesson() {
        const lessons = WATER_LESSONS[currentWaterCategory] || WATER_LESSONS.science;
        const lesson = lessons[currentWaterIndex] || lessons[0];
        const lessonKey = currentWaterCategory + '_' + currentWaterIndex;
        const isViewed = waterLearning.viewed.includes(lessonKey);
        const isListened = waterLearning.listened.includes(lessonKey);
        
        // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå…è´¹é…é¢ï¼ˆè¯•ç”¨æœŸä¹Ÿç®—ä»˜è´¹ï¼‰
        const isLocked = !waterLearning.unlocked && !isPaidMember() && waterLearning.quotaUsed >= waterLearning.freeQuota && !isViewed;
        
        if (isLocked) {
            // æ˜¾ç¤ºå†…å®¹ä½†æ¨¡ç³ŠåŒ–ï¼Œè®©ç”¨æˆ·çœ‹åˆ°"å·®ä¸€ç‚¹å°±èƒ½çœ‹åˆ°"çš„è¯±æƒ‘
            document.getElementById('waterLessonContent').innerHTML = `
                <div class="water-lesson" style="position:relative;overflow:hidden;">
                    <div style="filter:blur(5px);pointer-events:none;user-select:none;">
                        <div class="title">${lesson.title}</div>
                        <div class="text">${lesson.text.substring(0, 60)}...</div>
                        <div class="source">â€” ${lesson.source}</div>
                    </div>
                    <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;">
                        <div style="text-align:center;padding:15px;">
                            <div style="font-size:32px;margin-bottom:8px;">ğŸ”’</div>
                            <div style="font-size:13px;font-weight:bold;color:var(--gold);margin-bottom:6px;">å·²å­¦å®Œ ${waterLearning.freeQuota} æ¡å…è´¹å†…å®¹</div>
                            <div style="font-size:10px;color:rgba(255,255,255,0.6);margin-bottom:12px;">
                                å‡çº§è§£é”å…¨éƒ¨ ${getTotalLessons()} è¯¾ + AIè¯­éŸ³é—®ç­”
                            </div>
                            <button onclick="showUpgradePrompt()" style="padding:10px 24px;background:linear-gradient(135deg,var(--gold),#ff9800);border:none;border-radius:20px;color:#000;font-weight:bold;font-size:12px;cursor:pointer;">
                                âœ¨ å‡çº§è§£é”
                            </button>
                            <div style="margin-top:8px;">
                                <span onclick="resetFreeQuota()" style="color:var(--water);font-size:10px;cursor:pointer;text-decoration:underline;">
                                    ğŸ å…è´¹ç»­æ¯+5æ¡
                                </span>
                            </div>
                        </div>
                    </div>
                </div>`;
            return;
        }
        
        // è®°å½•å·²é˜…è¯»
        if (!isViewed) {
            waterLearning.viewed.push(lessonKey);
            waterLearning.totalViewed++;
            waterLearning.quotaUsed++;
            saveData();
        }
        
        const progressPct = Math.round((waterLearning.totalViewed / getTotalLessons()) * 100);
        document.getElementById('waterLessonContent').innerHTML = `
            <div class="water-lesson">
                <div class="title">${lesson.title} ${isListened ? 'ğŸ”Š' : ''}</div>
                <div class="text">${lesson.text}</div>
                <div class="source">â€” ${lesson.source}</div>
            </div>
            <div style="margin:8px 0;padding:6px 10px;background:rgba(0,188,212,0.08);border-radius:8px;">
                <div style="display:flex;justify-content:space-between;font-size:9px;color:rgba(255,255,255,0.5);margin-bottom:3px;">
                    <span>ğŸ“Š å­¦ä¹ è¿›åº¦ ${waterLearning.totalViewed}/${getTotalLessons()}</span>
                    <span>${progressPct}%</span>
                </div>
                <div style="height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;">
                    <div style="height:100%;width:${progressPct}%;background:linear-gradient(90deg,var(--water),var(--gold));border-radius:2px;transition:width 0.5s;"></div>
                </div>
            </div>
            <div style="text-align:center;font-size:9px;color:rgba(255,255,255,0.4);">${currentWaterIndex + 1} / ${lessons.length}${!waterLearning.unlocked && !isPaidMember() ? ' Â· å…è´¹ ' + Math.max(0, waterLearning.freeQuota - waterLearning.quotaUsed) + '/' + waterLearning.freeQuota : isInTrialPeriod() ? ' Â· ğŸ è¯•ç”¨ä¸­ å‰©' + getTrialDaysLeft() + 'å¤©' : ''}</div>`;
    }
    
    function getTotalLessons() { return Object.values(WATER_LESSONS).reduce((sum, cat) => sum + cat.length, 0); }
    
    function resetFreeQuota() { waterLearning.quotaUsed = 0; waterLearning.freeQuota = Math.min(waterLearning.freeQuota + 5, 15); saveData(); renderWaterLesson(); toast('ğŸ +5æ¡'); speak('å¤ªæ£’äº†ï¼ç»§ç»­å­¦ä¹ æ°´çš„æ™ºæ…§å§ï¼'); }
    
    function showUpgradePrompt() {
        const modal = document.createElement('div');
        modal.id = 'upgradeModal';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;';
        modal.innerHTML = `<div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:20px;padding:24px;max-width:340px;width:100%;border:1px solid rgba(255,215,0,0.3);text-align:center;">
            <div style="font-size:36px;margin-bottom:10px;">ğŸ‘‘</div>
            <div style="font-size:16px;font-weight:bold;color:var(--gold);margin-bottom:6px;">å‡çº§æ°´å­¦ä¼šå‘˜</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:16px;line-height:1.6;">è§£é”å…¨éƒ¨${getTotalLessons()}è¯¾æ°´å­¦è¯¾ç¨‹ + AIè¯­éŸ³é—®ç­”</div>
            <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">
                <div onclick="doUpgrade('monthly')" style="padding:12px;background:rgba(0,188,212,0.15);border:1px solid rgba(0,188,212,0.4);border-radius:12px;cursor:pointer;">
                    <div style="font-size:13px;font-weight:bold;color:var(--water);">ğŸŒŠ æ°´å¥åº·å¤§ä½¿</div>
                    <div style="font-size:18px;font-weight:bold;color:white;">Â¥9.9</div>
                    <div style="font-size:9px;color:rgba(255,255,255,0.5);">æ°´ç§‘å­¦åŸºç¡€ + è‹æ ¼æ‹‰åº•å¯¹è¯</div>
                </div>
                <div onclick="doUpgrade('quarterly')" style="padding:12px;background:rgba(6,255,165,0.1);border:1px solid rgba(6,255,165,0.3);border-radius:12px;cursor:pointer;">
                    <div style="font-size:13px;font-weight:bold;color:#06ffa5;">ğŸŒ¿ æ°´å¥åº·ä¿¡ä½¿</div>
                    <div style="font-size:18px;font-weight:bold;color:white;">Â¥19.9</div>
                    <div style="font-size:9px;color:rgba(255,255,255,0.5);">å…¨ç§‘è¯¾ç¨‹ + AIè¯­éŸ³é—®ç­”</div>
                </div>
                <div onclick="doUpgrade('vip')" style="padding:12px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:12px;cursor:pointer;">
                    <div style="font-size:13px;font-weight:bold;color:var(--gold);">â­ æ°´å¥åº·ç®¡ç†å¸ˆ</div>
                    <div style="font-size:18px;font-weight:bold;color:white;">Â¥49.9</div>
                    <div style="font-size:9px;color:rgba(255,255,255,0.5);">ä¸“ä¸šè¯¾ç¨‹ + å…¨åº“ + è®¤è¯</div>
                </div>
            </div>
            <button onclick="this.closest('#upgradeModal').remove()" style="padding:8px 20px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:14px;color:rgba(255,255,255,0.6);font-size:11px;cursor:pointer;">ç¨åå†è¯´</button>
        </div>`;
        document.body.appendChild(modal);
    }
    
    function doUpgrade(level) {
        if (!user) { toast('è¯·å…ˆç™»å½•'); document.getElementById('upgradeModal')?.remove(); return; }
        user.level = level;
        waterLearning.unlocked = true;
        const users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}');
        users[user.phone] = user;
        localStorage.setItem('heshuileUsers', JSON.stringify(users));
        localStorage.setItem('currentUser', JSON.stringify(user));
        saveData(); updateUI();
        document.getElementById('upgradeModal')?.remove();
        toast('ğŸ‘‘ å‡çº§æˆåŠŸï¼');
        speak('æ­å–œä½ æˆä¸ºæ°´å­¦ä¼šå‘˜ï¼å…¨éƒ¨è¯¾ç¨‹å·²è§£é”ï¼Œè®©æˆ‘ä»¬ç»§ç»­æ¢ç´¢æ°´çš„æ™ºæ…§ã€‚');
        renderWaterLesson();
    }

    function prevWaterLesson() { const lessons = WATER_LESSONS[currentWaterCategory]; if (!lessons) return; currentWaterIndex = (currentWaterIndex - 1 + lessons.length) % lessons.length; renderWaterLesson(); }
    function nextWaterLesson() { const lessons = WATER_LESSONS[currentWaterCategory]; if (!lessons) return; currentWaterIndex = (currentWaterIndex + 1) % lessons.length; renderWaterLesson(); }
    function speakWaterLesson() {
        if (currentWaterCategory === 'socratic') { speak('æ°´çš„è‹æ ¼æ‹‰åº•å¯¹è¯æ­£åœ¨è¿›è¡Œä¸­'); return; }
        const lessons = WATER_LESSONS[currentWaterCategory]; if (!lessons) return;
        const lesson = lessons[currentWaterIndex];
        const lessonKey = currentWaterCategory + '_' + currentWaterIndex;
        if (!waterLearning.listened.includes(lessonKey)) {
            waterLearning.listened.push(lessonKey);
            saveData();
        }
        speak(lesson.title + 'ã€‚' + lesson.text);
        toast('ğŸ”Š æ­£åœ¨æœ—è¯»...');
        renderWaterLesson();
    }

    // è‹æ ¼æ‹‰åº•å¯¹è¯
    function startSocratic() {
        // å…è´¹ç”¨æˆ·é™åˆ¶è‹æ ¼æ‹‰åº•å¯¹è¯
        const isPaid = user?.level && !['free'].includes(user.level);
        if (!isPaid && !waterLearning.unlocked) {
            document.getElementById('socraticChat').innerHTML = '<div style="text-align:center;padding:30px 15px;"><div style="font-size:36px;margin-bottom:10px;">ğŸ›ï¸</div><div style="font-size:13px;font-weight:bold;color:var(--gold);margin-bottom:8px;">è‹æ ¼æ‹‰åº•å¯¹è¯ Â· ä¼šå‘˜ä¸“å±</div><div style="font-size:11px;color:rgba(255,255,255,0.5);line-height:1.6;margin-bottom:12px;">ä¸AIæ°´å­¦å¯¼å¸ˆæ·±åº¦å¯¹è¯<br>é€šè¿‡æé—®å¼•å¯¼ä½ å‘ç°æ°´çš„æ™ºæ…§<br>å…ˆå­¦ä¹ åŸºç¡€è¯¾ç¨‹ï¼Œå†å‡çº§è§£é”</div><button onclick="showUpgradePrompt()" style="padding:8px 20px;background:linear-gradient(135deg,var(--gold),#ff9800);border:none;border-radius:16px;color:#000;font-weight:bold;font-size:11px;cursor:pointer;">âœ¨ å‡çº§è§£é”</button></div>';
            document.getElementById('socraticOptions').innerHTML = '';
            return;
        }
        socraticNode = 0;
        document.getElementById('socraticChat').innerHTML = '';
        renderSocraticNode(0);
    }

    function renderSocraticNode(nodeId) {
        if (nodeId === -1) { speak('æ­å–œä½ å®Œæˆäº†æ°´çš„æ™ºæ…§å¯¹è¯ï¼åƒæ°´ä¸€æ ·æŸ”è½¯ï¼Œåƒæ°´ä¸€æ ·åšæŒï¼Œåƒæ°´ä¸€æ ·åŒ…å®¹ã€‚ä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰ã€‚'); return; }
        const node = SOCRATIC_TREE.find(n => n.id === nodeId);
        if (!node) return;
        socraticNode = nodeId;

        const chatDiv = document.getElementById('socraticChat');
        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble master';
        bubble.innerHTML = `<div class="role">ğŸ›ï¸ æ°´å­¦å¯¼å¸ˆ</div>${node.text}`;
        chatDiv.appendChild(bubble);
        chatDiv.scrollTop = chatDiv.scrollHeight;

        // è‡ªåŠ¨æœ—è¯»å¯¼å¸ˆçš„è¯
        speak(node.text);

        const optDiv = document.getElementById('socraticOptions');
        optDiv.innerHTML = node.options.map((opt, i) => `<div class="socratic-opt" onclick="chooseSocratic(${nodeId}, ${i})">${opt.text}</div>`).join('');
    }

    function chooseSocratic(nodeId, optIndex) {
        const node = SOCRATIC_TREE.find(n => n.id === nodeId);
        if (!node) return;
        const opt = node.options[optIndex];

        const chatDiv = document.getElementById('socraticChat');
        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble student';
        bubble.innerHTML = `<div class="role">ğŸ™‹ ä½ </div>${opt.text}`;
        chatDiv.appendChild(bubble);
        chatDiv.scrollTop = chatDiv.scrollHeight;

        document.getElementById('socraticOptions').innerHTML = '<div style="text-align:center;padding:10px;color:rgba(255,255,255,0.3);font-size:10px;">å¯¼å¸ˆæ€è€ƒä¸­...</div>';
        setTimeout(() => renderSocraticNode(opt.next), 1200);
    }

    function renderWater() { renderWaterLesson(); }

    // ==================== æ˜¥èŠ‚æ¬¢è¿ ====================
    function showCNYWelcome() {
        const now = new Date();
        const month = now.getMonth() + 1;
        const day = now.getDate();
        // 2026å¹´æ˜¥èŠ‚æœŸé—´ 2æœˆ14æ—¥-2æœˆ28æ—¥ï¼ˆé™¤å¤•åˆ°å…ƒå®µï¼‰
        if (month !== 2 || day < 14 || day > 28) return;
        const shown = localStorage.getItem('cnyWelcome2026');
        if (shown === 'true') return;
        
        setTimeout(() => {
            const banner = document.createElement('div');
            banner.id = 'cnyBanner';
            banner.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10001;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.5s;';
            banner.innerHTML = `<div style="background:linear-gradient(135deg,#8B0000,#B01D23,#1a1a2e);border-radius:24px;padding:30px 24px;max-width:340px;width:100%;text-align:center;border:2px solid rgba(255,215,0,0.4);box-shadow:0 0 40px rgba(255,215,0,0.2);">
                <div style="font-size:48px;margin-bottom:8px;">ğŸ§§ğŸ´ğŸ§§</div>
                <div style="font-size:24px;font-weight:bold;color:#FFD700;margin-bottom:4px;">é©¬å¹´å¤§å‰</div>
                <div style="font-size:14px;color:rgba(255,255,255,0.8);margin-bottom:12px;">æ­è´ºæ–°ç¦§ Â· ä¸‡äº‹å¦‚æ„</div>
                <div style="font-size:12px;color:rgba(255,215,0,0.7);line-height:1.8;margin-bottom:16px;padding:12px;background:rgba(0,0,0,0.3);border-radius:12px;">
                    ä¸Šå–„è‹¥æ°´ï¼Œæ°´å–„åˆ©ä¸‡ç‰©è€Œä¸äº‰<br>
                    æ–°çš„ä¸€å¹´ï¼Œæ„¿ä½ å¦‚æ°´èˆ¬<br>
                    <span style="color:#FFD700;">æŸ”éŸ§ Â· åŒ…å®¹ Â· åšæŒ Â· æ™ºæ…§</span>
                </div>
                <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:16px;">
                    ğŸ æ–°å¹´ç‰¹åˆ«ç¦åˆ©ï¼šåˆ†äº«ç»™å¥½å‹<br>å…è´¹ä½“éªŒæ°´å­¦æ™ºæ…§è¯¾ç¨‹
                </div>
                <div style="display:flex;gap:8px;">
                    <button onclick="this.closest('#cnyBanner').remove();localStorage.setItem('cnyWelcome2026','true');openPanel('promoPanel');" style="flex:1;padding:10px;background:linear-gradient(135deg,#FFD700,#ff9800);border:none;border-radius:14px;color:#000;font-weight:bold;font-size:12px;cursor:pointer;">ğŸ§§ åˆ†äº«æ–°å¹´ç¥ç¦</button>
                    <button onclick="this.closest('#cnyBanner').remove();localStorage.setItem('cnyWelcome2026','true');" style="flex:1;padding:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:14px;color:white;font-size:12px;cursor:pointer;">å¼€å§‹ä½¿ç”¨</button>
                </div>
                <div style="margin-top:10px;font-size:10px;color:rgba(255,255,255,0.3);">æ°´è‹¥å–„ Â· å–æ°´äº†å—</div>
            </div>`;
            document.body.appendChild(banner);
            speak('é©¬å¹´å¤§å‰ï¼æ–°å¹´å¿«ä¹ï¼é©¬åˆ°æˆåŠŸï¼Œä¸Šå–„è‹¥æ°´ï¼Œç¥ä½ æ–°çš„ä¸€å¹´ä¸‡äº‹å¦‚æ„ï¼');
        }, 1500);
    }

    // ==================== è¯­éŸ³å”¤é†’ç³»ç»Ÿã€Œæ™ºå›ã€ ====================
    let voiceRecognition = null;
    let isVoiceListening = false;
    let isVoiceAwake = false;

    function initVoiceSystem() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            console.log('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
            return;
        }
        voiceRecognition = new SpeechRecognition();
        voiceRecognition.lang = 'zh-CN';
        voiceRecognition.continuous = true;
        voiceRecognition.interimResults = true;

        voiceRecognition.onresult = function(event) {
            let transcript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                transcript += event.results[i][0].transcript;
            }
            transcript = transcript.toLowerCase().trim();
            showVoiceStatus('ğŸ¤ ' + transcript);

            // å”¤é†’è¯æ£€æµ‹
            if (!isVoiceAwake) {
                if (transcript.includes('æ™ºå›') || transcript.includes('çŸ¥å›') || transcript.includes('å¿—å›') || transcript.includes('ä¹‹å›')) {
                    isVoiceAwake = true;
                    speak('æˆ‘åœ¨ï¼Œè¯·å©å’');
                    showVoiceStatus('âœ… å·²å”¤é†’ï¼è¯·è¯´æŒ‡ä»¤æˆ–é—®æ°´å­¦é—®é¢˜...');
                    setTimeout(() => { isVoiceAwake = false; showVoiceStatus('ğŸ’¤ ç­‰å¾…å”¤é†’è¯ã€Œæ™ºå›ã€'); }, 15000);
                }
                return;
            }

            // æŒ‡ä»¤å¤„ç†
            if (event.results[event.resultIndex].isFinal) {
                processVoiceCommand(transcript);
                isVoiceAwake = false;
                setTimeout(() => showVoiceStatus('ğŸ’¤ ç­‰å¾…å”¤é†’è¯ã€Œæ™ºå›ã€'), 3000);
            }
        };

        voiceRecognition.onend = function() {
            if (isVoiceListening) {
                try { voiceRecognition.start(); } catch(e) {}
            }
        };

        voiceRecognition.onerror = function(event) {
            if (event.error !== 'no-speech' && event.error !== 'aborted') {
                showVoiceStatus('âš ï¸ è¯­éŸ³é”™è¯¯: ' + event.error);
            }
        };
    }

    function processVoiceCommand(cmd) {
        showVoiceStatus('ğŸ”„ å¤„ç†: ' + cmd);
        
        if (cmd.includes('å‡ ç‚¹') || cmd.includes('æ—¶é—´') || cmd.includes('ç°åœ¨')) {
            const now = new Date();
            speak(`ç°åœ¨æ˜¯${now.getHours()}ç‚¹${now.getMinutes()}åˆ†${now.getSeconds()}ç§’`);
        } else if (cmd.includes('æ—¥æœŸ') || cmd.includes('ä»Šå¤©') || cmd.includes('æ˜ŸæœŸ')) {
            const now = new Date();
            const weekDays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
            speak(`ä»Šå¤©æ˜¯${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ï¼Œæ˜ŸæœŸ${weekDays[now.getDay()]}`);
        } else if (cmd.includes('å–äº†å¤šå°‘') || cmd.includes('ä»Šæ—¥é¥®æ°´') || cmd.includes('å–æ°´è¿›åº¦') || cmd.includes('é¥®æ°´é‡')) {
            const percent = Math.round((waterData.today / waterData.goal) * 100);
            speak(`ä»Šæ—¥å·²å–${waterData.today}æ¯«å‡ï¼Œç›®æ ‡${waterData.goal}æ¯«å‡ï¼Œå®Œæˆ${percent}%`);
        } else if (cmd.includes('å–æ°´') && !cmd.includes('å¤šå°‘') && !cmd.includes('ä»€ä¹ˆæ—¶å€™') && !cmd.includes('å¥½å¤„') && !cmd.includes('æ¸©åº¦')) {
            drinkWater(250);
        } else if (cmd.includes('æé†’') && (cmd.includes('æ–°å»º') || cmd.includes('æ·»åŠ ') || cmd.includes('åˆ›å»º') || cmd.includes('è®¾ç½®'))) {
            openPanel('settingsPanel');
            speak('å·²æ‰“å¼€æé†’è®¾ç½®ï¼Œè¯·åˆ›å»ºæ–°æé†’');
        } else if (cmd.includes('æé†’') && cmd.includes('æŸ¥çœ‹')) {
            if (reminds.length === 0) { speak('æš‚æ— æé†’'); }
            else { speak(`ä½ æœ‰${reminds.length}ä¸ªæé†’ã€‚æœ€è¿‘çš„æ˜¯ï¼š${reminds[0].title}`); }
        } else if (cmd.includes('æ‰“å¡') || cmd.includes('ç­¾åˆ°')) {
            doCheckin();
            speak('æ‰“å¡æˆåŠŸï¼');
        } else if (cmd.includes('æ°´å­¦') || cmd.includes('æ°´è¯¾') || cmd.includes('è¯¾ç¨‹')) {
            openPanel('waterPanel');
            speak('å·²æ‰“å¼€æ°´å­¦è¯¾ç¨‹');
        } else if (cmd.includes('ç»å…¸') || cmd.includes('ç»ä¹¦') || cmd.includes('é“å¾·ç»') || cmd.includes('å¿ƒç»')) {
            openPanel('classicsPanel');
            speak('å·²æ‰“å¼€ç»å…¸');
        } else if (cmd.includes('å…³æ€€') || cmd.includes('å¥½å‹') || cmd.includes('é€šè®¯å½•')) {
            openPanel('carePanel');
            speak('å·²æ‰“å¼€æ™ºèƒ½å…³æ€€');
        } else if (cmd.includes('ç§¯åˆ†') || cmd.includes('åˆ†æ•°')) {
            speak(`ä½ å½“å‰æœ‰${checkinData.points}ç§¯åˆ†ï¼Œè¿ç»­æ‰“å¡${checkinData.streak}å¤©`);
        } else if (cmd.includes('è®¾ç½®')) {
            openPanel('settingsPanel');
            speak('å·²æ‰“å¼€è®¾ç½®');
        } else if (cmd.includes('å¯¹è¯') || cmd.includes('è‹æ ¼æ‹‰åº•') || cmd.includes('é—®ç­”')) {
            openPanel('waterPanel');
            switchWaterTab('socratic');
            speak('å·²è¿›å…¥æ°´çš„è‹æ ¼æ‹‰åº•å¯¹è¯');
        } else if (cmd.includes('æœ—è¯»') || cmd.includes('è¯»')) {
            speakWaterLesson();
        } else if (cmd.includes('å¸®åŠ©') || cmd.includes('ä½ èƒ½')) {
            speak('é©¬å¹´å¤§å‰ï¼æˆ‘å¯ä»¥å¸®ä½ ï¼šå–æ°´ã€æŸ¥çœ‹å–æ°´è¿›åº¦ã€æŸ¥çœ‹æ—¶é—´ã€æ–°å»ºæé†’ã€æ‰“å¡ç­¾åˆ°ã€æ‰“å¼€æ°´å­¦è¯¾ç¨‹ã€æ‰“å¼€ç»å…¸ã€æŸ¥çœ‹ç§¯åˆ†ã€‚ä½ ä¹Ÿå¯ä»¥é—®æˆ‘æ°´å­¦é—®é¢˜ï¼Œæ¯”å¦‚ï¼šæ¯å¤©è¯¥å–å¤šå°‘æ°´ï¼Ÿæ˜¥èŠ‚æ€ä¹ˆå–æ°´ï¼Ÿè¯´æ™ºå›å”¤é†’æˆ‘åè¯´æŒ‡ä»¤å³å¯ã€‚');
        } else {
            // æ°´å­¦çŸ¥è¯†åº“æ™ºèƒ½é—®ç­”
            const answer = matchWaterKB(cmd);
            if (answer) {
                speak(answer);
                showVoiceStatus('ğŸ’§ ' + answer.substring(0, 30) + '...');
            } else {
                speak('æˆ‘æ²¡å¬æ‡‚ã€‚ä½ å¯ä»¥è¯´ï¼šå–æ°´ã€å–æ°´è¿›åº¦ã€å‡ ç‚¹äº†ã€æ‰“å¼€æ°´å­¦ï¼Œä¹Ÿå¯ä»¥é—®æ°´å­¦é—®é¢˜ï¼Œæ¯”å¦‚ï¼šæ¯å¤©è¯¥å–å¤šå°‘æ°´ï¼Ÿ');
            }
        }
    }

    // ==================== æ°´å­¦çŸ¥è¯†åº“ï¼ˆè¯­éŸ³é—®ç­”å¼•æ“ï¼‰====================
    const WATER_KB = [
        { keys: ['å¤šå°‘æ°´','å–å¤šå°‘','é¥®æ°´é‡','æ¯å¤©','ä¸€å¤©å–','å…«æ¯','æ¯æ°´'], a: 'æˆå¹´äººæ¯å¤©å»ºè®®é¥®æ°´1500åˆ°2500æ¯«å‡ï¼Œå…·ä½“å–å†³äºä½“é‡ã€è¿åŠ¨é‡å’Œæ°”å€™ã€‚ç®€å•ç®—æ³•æ˜¯ä½“é‡å…¬æ–¤æ•°ä¹˜ä»¥30æ¯«å‡ã€‚æ¯”å¦‚60å…¬æ–¤çš„äººå¤§çº¦éœ€è¦1800æ¯«å‡ã€‚å°‘é‡å¤šæ¬¡æœ€ä½³ï¼Œæ¯æ¬¡200åˆ°250æ¯«å‡ã€‚è§‚å¯Ÿå°¿æ¶²é¢œè‰²ï¼Œæ·¡é»„è‰²è¯´æ˜æ°´åˆ†å……è¶³ã€‚' },
        { keys: ['æ¸©åº¦','æ°´æ¸©','çƒ­æ°´','å†·æ°´','å†°æ°´','å‡‰æ°´','å¤šçƒ­','çƒ«'], a: 'æ—¥å¸¸é¥®æ°´æœ€ä½³æ¸©åº¦æ˜¯25åˆ°37åº¦ï¼Œæ¥è¿‘ä½“æ¸©æœ€åˆ©äºå¸æ”¶ã€‚å†°æ°´ä¼šåˆºæ¿€èƒƒè‚ æ”¶ç¼©ï¼Œç©ºè…¹æ—¶å°¤å…¶ä¸å»ºè®®ã€‚è¿åŠ¨åå¯ä»¥å–10åˆ°15åº¦çš„å‡‰æ°´å¸®åŠ©é™æ¸©ã€‚ç‰¹åˆ«æ³¨æ„ï¼Œè¶…è¿‡65åº¦çš„çƒ­é¥®è¢«ä¸–ç•Œå«ç”Ÿç»„ç»‡åˆ—ä¸º2Aç±»è‡´ç™Œå› ç´ ï¼Œä¸€å®šè¦é¿å…çƒ«å˜´çš„æ°´ã€‚' },
        { keys: ['æ—©ä¸Š','æ™¨èµ·','èµ·åºŠ','æ—©æ™¨','ç©ºè…¹','æ—©èµ·'], a: 'æ™¨èµ·é¥®æ°´æ˜¯å¾ˆå¥½çš„å…»ç”Ÿä¹ æƒ¯ã€‚ç»è¿‡ä¸ƒå…«ä¸ªå°æ—¶çš„ç¡çœ ï¼Œèº«ä½“é€šè¿‡å‘¼å¸å’Œçš®è‚¤è’¸å‘äº†å¤§çº¦450æ¯«å‡æ°´åˆ†ã€‚å»ºè®®èµ·åºŠåå…ˆåˆ·ç‰™ï¼Œå†ç©ºè…¹å–200åˆ°300æ¯«å‡æ¸©æ°´ï¼Œç­‰20åˆ†é’Ÿååƒæ—©é¤ã€‚å¯ä»¥ä¿ƒè¿›è‚ èƒƒè •åŠ¨ï¼Œç¨€é‡Šè¡€æ¶²ï¼Œé™ä½å¿ƒè„‘è¡€ç®¡é£é™©ã€‚' },
        { keys: ['ä»€ä¹ˆæ—¶å€™','æ—¶é—´è¡¨','æœ€ä½³æ—¶é—´','å‡ ç‚¹','æ—¶é—´æ®µ'], a: 'ç§‘å­¦é¥®æ°´æ—¶é—´è¡¨ï¼šæ—©ä¸Š7ç‚¹ï¼Œæ™¨èµ·ä¸€æ¯250æ¯«å‡å”¤é†’èº«ä½“ã€‚ä¸Šåˆ9ç‚¹ï¼Œè¡¥å……200æ¯«å‡æå‡æ•ˆç‡ã€‚11ç‚¹åŠåˆé¤å‰200æ¯«å‡åŠ©æ¶ˆåŒ–ã€‚ä¸‹åˆ3ç‚¹200æ¯«å‡ç¼“è§£ç–²åŠ³ã€‚å‚æ™š5ç‚¹200æ¯«å‡ä¿ƒè¿›ä»£è°¢ã€‚ç¡å‰9ç‚¹å°åŠæ¯100æ¯«å‡é¢„é˜²è„±æ°´ã€‚æ ¸å¿ƒåŸåˆ™æ˜¯å°‘é‡å¤šæ¬¡ã€‚' },
        { keys: ['è„±æ°´','ç¼ºæ°´','å£æ¸´','æ¸´','ä¸å¤Ÿ','ä¸è¶³'], a: 'ä»…ç™¾åˆ†ä¹‹ä¸€åˆ°äºŒçš„è„±æ°´å°±ä¼šæ˜¾è‘—å½±å“è®¤çŸ¥åŠŸèƒ½ã€‚è½»åº¦è„±æ°´ç—‡çŠ¶åŒ…æ‹¬å£æ¸´ã€å°¿æ¶²æ·±é»„ã€ç–²åŠ³ã€æ³¨æ„åŠ›ä¸‹é™ã€å¤´ç—›ã€‚æ„Ÿåˆ°å£æ¸´æ—¶èº«ä½“å…¶å®å·²ç»è½»åº¦è„±æ°´äº†ã€‚é•¿æœŸè½»åº¦è„±æ°´ä¼šå¢åŠ è‚¾ç»“çŸ³ã€å°¿è·¯æ„ŸæŸ“ã€ä¾¿ç§˜ç­‰é£é™©ã€‚å»ºè®®ä¸»åŠ¨å®šæ—¶é¥®æ°´ã€‚' },
        { keys: ['è¿åŠ¨','å¥èº«','å‡ºæ±—','è·‘æ­¥','é”»ç‚¼','è¿åŠ¨å'], a: 'è¿åŠ¨å‰2å°æ—¶å»ºè®®é¢„å…ˆè¡¥æ°´300åˆ°500æ¯«å‡ã€‚è¿åŠ¨ä¸­æ¯15åˆ°20åˆ†é’Ÿè¡¥å……150åˆ°200æ¯«å‡ï¼Œä¸è¦ç­‰å£æ¸´æ‰å–ã€‚è¿åŠ¨å1å°æ—¶å†…è¡¥å……æµå¤±é‡çš„150%ã€‚å‰§çƒˆè¿åŠ¨è¶…è¿‡1å°æ—¶ï¼Œå»ºè®®å«ç”µè§£è´¨çš„è¿åŠ¨é¥®æ–™è¡¥å……é’ å’Œé’¾ã€‚' },
        { keys: ['å‡è‚¥','ç˜¦èº«','ä½“é‡','é¥­å‰å–'], a: 'é¥­å‰30åˆ†é’Ÿå–ä¸€æ¯æ°´å¤§çº¦300æ¯«å‡ï¼Œå¯ä»¥å¢åŠ é¥±è…¹æ„Ÿï¼Œæœ‰åŠ©äºæ§åˆ¶è¿›é£Ÿé‡ã€‚ç ”ç©¶æ˜¾ç¤ºè¿™ä¸ªä¹ æƒ¯å¯ä»¥å¸®åŠ©å‡å°‘æ¯é¤å¤§çº¦75å¤§å¡çš„æ‘„å…¥ã€‚ä½†å–æ°´å‡è‚¥åªæ˜¯è¾…åŠ©ï¼Œä¸èƒ½æ›¿ä»£åˆç†çš„é¥®é£Ÿå’Œè¿åŠ¨è®¡åˆ’ã€‚' },
        { keys: ['çš®è‚¤','ç¾å®¹','æŠ¤è‚¤','ä¿æ¹¿','ç¾ç™½'], a: 'çš®è‚¤å«æ°´é‡çº¦ç™¾åˆ†ä¹‹ä¸ƒåï¼Œç¼ºæ°´ä¼šå¯¼è‡´å¹²ç‡¥ã€æš—æ²‰ã€ç»†çº¹åŠ é€Ÿã€‚å»ºè®®æ¯å¤©2000æ¯«å‡ä»¥ä¸Šçš„é¥®æ°´é‡ã€‚ä½†å¤šå–æ°´å°±èƒ½ç¾ç™½æ˜¯å¤¸å¤§è¯´æ³•ï¼Œçš®è‚¤çŠ¶æ€å—å¤šç§å› ç´ ç»¼åˆå½±å“ã€‚å……è¶³é¥®æ°´åŠ ä¸Šé€‚å½“æŠ¤è‚¤æ˜¯å¥½çš„ç»„åˆã€‚' },
        { keys: ['å’–å•¡','èŒ¶','é¥®æ–™','æœæ±','å¥¶èŒ¶','å¯ä¹'], a: 'å’–å•¡å’ŒèŒ¶è™½ç„¶å«æ°´åˆ†ï¼Œä½†å’–å•¡å› æœ‰è½»å¾®åˆ©å°¿ä½œç”¨ï¼Œä¸èƒ½å®Œå…¨æ›¿ä»£ç™½æ°´ã€‚å«ç³–é¥®æ–™å’Œæœæ±ä¼šå¢åŠ ç³–åˆ†æ‘„å…¥ã€‚å»ºè®®æ¯å¤©è‡³å°‘ä¸€åŠçš„é¥®æ°´é‡æ¥è‡ªç™½æ°´æˆ–æ·¡èŒ¶ï¼Œå…¶ä»–é¥®å“ä½œä¸ºè¡¥å……ã€‚' },
        { keys: ['ç¡å‰','æ™šä¸Š','å¤œé—´','èµ·å¤œ','å¤±çœ '], a: 'ç¡å‰1å°æ—¶é€‚é‡é¥®æ°´100åˆ°150æ¯«å‡å¯ä»¥é¢„é˜²å¤œé—´è„±æ°´ï¼Œä½†ä¸å®œè¿‡å¤šä»¥å…é¢‘ç¹èµ·å¤œå½±å“ç¡çœ ã€‚å¦‚æœç»å¸¸èµ·å¤œï¼Œå»ºè®®ç¡å‰2å°æ—¶å‡å°‘é¥®æ°´é‡ã€‚' },
        { keys: ['çŸ¿æ³‰æ°´','çº¯å‡€æ°´','å‡€æ°´','è‡ªæ¥æ°´','æ»¤èŠ¯','å‡€æ°´å™¨'], a: 'å¤©ç„¶çŸ¿æ³‰æ°´å«æœ‰é”¶ã€åç¡…é…¸ã€é’™ã€é•ç­‰æœ‰ç›ŠçŸ¿ç‰©è´¨ã€‚å®¶ç”¨å‡€æ°´æ ¹æ®æ°´è´¨é€‰æ‹©ï¼šä¸€èˆ¬åŸå¸‚è‡ªæ¥æ°´ç”¨æ´»æ€§ç‚­æ»¤èŠ¯å»é™¤ä½™æ°¯å’Œå¼‚å‘³ï¼Œæ°´è´¨ç¡¬çš„åœ°åŒºå»ºè®®åæ¸—é€è†œã€‚å…³é”®æ˜¯æŒ‰æ—¶æ›´æ¢æ»¤èŠ¯ï¼Œå¦åˆ™åè€Œæ»‹ç”Ÿç»†èŒã€‚' },
        { keys: ['ç©ºæ°”æ°´','å¤§æ°”æ°´','AWG','ç©ºæ°”å–æ°´','ç¦èƒ½è¾¾','FND','åˆ¶æ°´æœº'], a: 'ç©ºæ°”åˆ¶æ°´æ˜¯ä»ç©ºæ°”ä¸­æå–é¥®ç”¨æ°´çš„å‰æ²¿æŠ€æœ¯ã€‚ç¦èƒ½è¾¾FNDæ˜¯è¿™ä¸ªè¡Œä¸šçš„é¢†å†›ä¼ä¸šï¼Œæ·±è€•è¶…è¿‡åå¹´ï¼Œäº§å“é”€å¾€100å¤šä¸ªå›½å®¶ï¼Œä¸º80å¤šä¸ªå“ç‰Œä»£å·¥ã€‚å…¨çƒç©ºæ°”ä¸­å«æœ‰çº¦13ä¸‡äº¿å¨æ°´è’¸æ°”ï¼ŒAWGè®¾å¤‡é€šè¿‡å†·å‡æŠ€æœ¯æå–çº¯å‡€é¥®ç”¨æ°´ï¼Œäº§æ°´æˆæœ¬çº¦ä¸€æ¯›åˆ°äº”æ¯›æ¯å‡ï¼Œå·²åœ¨ä¸­ä¸œã€éæ´²ç­‰ç¼ºæ°´åœ°åŒºå¹¿æ³›åº”ç”¨ã€‚' },
        { keys: ['ä¸Šå–„è‹¥æ°´','å“²å­¦','æ–‡åŒ–','è€å­','é“å¾·ç»','æ™ºæ…§'], a: 'è€å­é“å¾·ç»è¯´ï¼šä¸Šå–„è‹¥æ°´ï¼Œæ°´å–„åˆ©ä¸‡ç‰©è€Œä¸äº‰ï¼Œå¤„ä¼—äººä¹‹æ‰€æ¶ï¼Œæ•…å‡ äºé“ã€‚æ°´çš„å“å¾·æ˜¯æ— ç§å¥‰çŒ®ã€æ»‹å…»ä¸‡ç‰©å´ä»ä¸è‡ªå¤¸ã€‚æ°´å¾€ä½å¤„æµï¼Œæ­£å¦‚è°¦å‘çš„æ™ºè€…ã€‚åšäººå½“å­¦æ°´ï¼Œåˆ©ä»–ä¸äº‰ï¼Œå¤„ä¸‹ä¸å‘ã€‚' },
        { keys: ['æ°´åˆ†å­','H2O','åˆ†å­','æ°¢é”®','ç»“æ„','åŒ–å­¦'], a: 'æ°´åˆ†å­ç”±ä¸¤ä¸ªæ°¢åŸå­å’Œä¸€ä¸ªæ°§åŸå­ç»„æˆï¼Œå½¢æˆ104.5åº¦çš„å¤¹è§’ã€‚è¿™ä¸ªè§’åº¦èµ‹äºˆæ°´ç‹¬ç‰¹çš„ææ€§ï¼Œä½¿å®ƒæˆä¸ºä¸‡èƒ½æº¶å‰‚ã€‚æ°´çš„å¼‚å¸¸ç‰¹æ€§ï¼Œå†°æ¯”æ°´è½»ã€é«˜æ¯”çƒ­å®¹ã€é«˜è¡¨é¢å¼ åŠ›ï¼Œéƒ½æºäºæ°¢é”®ã€‚' },
        { keys: ['è€äºº','è€å¹´','é•¿è¾ˆ','å¹´çºªå¤§'], a: 'è€å¹´äººå£æ¸´æ„Ÿè§‰ä¼šå‡é€€ï¼Œæ›´å®¹æ˜“ä¸çŸ¥ä¸è§‰è„±æ°´ã€‚å»ºè®®ä¸»åŠ¨å®šæ—¶é¥®æ°´ï¼Œä¸è¦ç­‰å£æ¸´å†å–ï¼Œæ¯å¤©è‡³å°‘1500æ¯«å‡ã€‚å¿ƒè‚¾åŠŸèƒ½ä¸å¥½çš„è€äººéœ€åœ¨åŒ»ç”ŸæŒ‡å¯¼ä¸‹æ§åˆ¶é¥®æ°´é‡ã€‚å®šæ—¶æé†’é•¿è¾ˆå–æ°´ï¼Œè¿™ä¹Ÿæ˜¯è¯·ä½ å–æ°´çš„åˆå¿ƒã€‚' },
        { keys: ['å°å­©','å„¿ç«¥','å®å®','å­©å­'], a: 'å„¿ç«¥é¥®æ°´å‚è€ƒï¼šä¸€åˆ°ä¸‰å²çº¦700æ¯«å‡æ¯å¤©ï¼Œå››åˆ°å…«å²çº¦1000æ¯«å‡ï¼Œä¹åˆ°åä¸‰å²çº¦1300åˆ°1500æ¯«å‡ã€‚ç™½æ°´ä¸ºä¸»ï¼Œé¿å…å«ç³–é¥®æ–™ã€‚å¯ä»¥ç”¨æœ‰è¶£çš„æ°´æ¯ã€å®šæ—¶æé†’å¸®åŠ©å­©å­å…»æˆä¸»åŠ¨å–æ°´çš„å¥½ä¹ æƒ¯ã€‚' },
        { keys: ['å­•å¦‡','æ€€å­•','å“ºä¹³','å­•æœŸ'], a: 'å­•å¦‡æ¯å¤©å»ºè®®é¥®æ°´2300æ¯«å‡å·¦å³ï¼Œå“ºä¹³æœŸéœ€å¢åŠ åˆ°2700æ¯«å‡ä»¥ä¸Šã€‚å­•æœŸåº”é¿å…å’–å•¡å› è¶…è¿‡200æ¯«å…‹æ¯å¤©ã€‚æ¸©æ°´ä¸ºä¸»ï¼Œé¿å…å†°é¥®åˆºæ¿€ã€‚å¦‚æœ‰å¦Šå¨ æ°´è‚¿ï¼Œä¸è¦ç›²ç›®é™æ°´ï¼Œè¯·å’¨è¯¢åŒ»ç”Ÿã€‚' },
        { keys: ['å¥½å¤„','ä¸ºä»€ä¹ˆ','é‡è¦','ä½œç”¨','åŠŸæ•ˆ'], a: 'æ°´å äººä½“çº¦ç™¾åˆ†ä¹‹å…­ååˆ°ä¸ƒåã€‚å……è¶³é¥®æ°´å¯ä»¥ä¿ƒè¿›æ–°é™ˆä»£è°¢ã€å¸®åŠ©æ’æ¯’ã€ç»´æŒè‚¾è„å¥åº·ã€æ”¹å–„çš®è‚¤çŠ¶æ€ã€æå‡æ³¨æ„åŠ›å’Œè®°å¿†åŠ›ã€é¢„é˜²ä¾¿ç§˜å’Œè‚¾ç»“çŸ³ã€‚ç ”ç©¶è¡¨æ˜ä¿æŒå……è¶³é¥®æ°´å¯ä»¥æå‡ç™¾åˆ†ä¹‹åäº”åˆ°äºŒåçš„å·¥ä½œæ•ˆç‡ã€‚' },
        { keys: ['æ°´è‹¥å–„','ä½ æ˜¯è°','å…³äº','åˆ›å§‹äºº','ç¦èƒ½è¾¾','FND'], a: 'æˆ‘æ˜¯æ°´è‹¥å–„ï¼Œæœ¬åæ¥è‡ªä¸Šå–„è‹¥æ°´ä¹‹æ„ï¼Œæ˜¯ç¦èƒ½è¾¾FNDç©ºæ°”åˆ¶æ°´æœºçš„åˆ›å§‹äººï¼Œæ·±è€•ç©ºæ°”åˆ¶æ°´è¡Œä¸šè¶…è¿‡åå¹´ï¼Œäº§å“é”€å¾€100å¤šä¸ªå›½å®¶ï¼Œä¸ºè¶…è¿‡80ä¸ªå“ç‰Œä»£å·¥ã€‚æˆ‘ä¸“æ³¨äºæ°´å­¦ç ”ç©¶ï¼Œå·²è‘—æœ‰ã€Šæ°´ç§‘å­¦ã€‹ã€Šæ°´åŒ»å­¦ã€‹ã€Šæ°´å¥åº·ã€‹ã€Šæ°´å“²å­¦ã€‹ç­‰ç³»åˆ—è‘—ä½œè¶…åƒä¸‡å­—ã€‚æ„¿æœ›æ˜¯è®©æ¯ä¸ªäººéƒ½æ‡‚æ°´ã€çˆ±æ°´ã€ç§‘å­¦é¥®æ°´ã€‚' },
    ];

    function matchWaterKB(text) {
        const t = text.toLowerCase();
        let best = null, bestScore = 0;
        for (const item of WATER_KB) {
            let score = 0;
            for (const k of item.keys) {
                if (t.includes(k)) score += (k.length >= 3 ? 3 : 1);
            }
            if (score > bestScore) { bestScore = score; best = item; }
        }
        return bestScore > 0 ? best.a : null;
    }

    function toggleVoiceRecognition() {
        if (!voiceRecognition) {
            initVoiceSystem();
            if (!voiceRecognition) { toast('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³'); return; }
        }
        
        const voiceBtn = document.querySelector('.func-btn.voice');
        if (isVoiceListening) {
            isVoiceListening = false;
            voiceRecognition.stop();
            if (voiceBtn) voiceBtn.style.background = '';
            showVoiceStatus('ğŸ”‡ è¯­éŸ³å·²å…³é—­');
            setTimeout(() => document.getElementById('voiceStatus').classList.remove('show'), 2000);
            speak('è¯­éŸ³åŠ©æ‰‹å·²å…³é—­');
        } else {
            isVoiceListening = true;
            try { voiceRecognition.start(); } catch(e) {}
            if (voiceBtn) voiceBtn.style.background = 'linear-gradient(135deg, #ff006e, #ff4444)';
            showVoiceStatus('ğŸ¤ è¯­éŸ³å·²å¼€å¯ï¼Œè¯´ã€Œæ™ºå›ã€å”¤é†’æˆ‘');
            speak('è¯­éŸ³åŠ©æ‰‹å·²å¼€å¯ï¼Œè¯´æ™ºå›å”¤é†’æˆ‘');
        }
    }

    function showVoiceStatus(text) {
        const el = document.getElementById('voiceStatus');
        el.textContent = text;
        el.classList.add('show');
        clearTimeout(el._timer);
        if (!text.includes('ç­‰å¾…å”¤é†’') && !text.includes('å·²å¼€å¯')) {
            el._timer = setTimeout(() => el.classList.remove('show'), 4000);
        }
    }
    function speak(t) { speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(t); const langMap = {zh:'zh-CN',en:'en-US',ja:'ja-JP',ko:'ko-KR',es:'es-ES',ar:'ar-SA',he:'he-IL'}; u.lang = langMap[currentLang] || 'en-US'; speechSynthesis.speak(u); }

    // æ˜¥èŠ‚åˆ†äº«
    const CNY_GREETINGS = [
        'ğŸ§§ é©¬å¹´å¤§å‰ï¼é©¬åˆ°æˆåŠŸï¼Œä¸Šå–„è‹¥æ°´ï¼Œæ„¿æ–°çš„ä¸€å¹´ä½ å¦‚æ°´èˆ¬æŸ”éŸ§åšå¼ºã€‚è®°å¾—æ¯å¤©å–å¤Ÿæ°´å“¦ï¼ç‚¹å‡»ä½“éªŒï¼š',
        'ğŸ´ éªé©¬å¥”è…¾ï¼æ°´å–„åˆ©ä¸‡ç‰©è€Œä¸äº‰â€”â€”æ–°å¹´é€ä½ ä¸€ä»½æ°´çš„æ™ºæ…§ã€‚ç§‘å­¦é¥®æ°´ï¼Œå¥åº·ä¸€æ•´å¹´ï¼š',
        'âœ¨ æ–°æ˜¥å¿«ä¹ï¼ä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰ã€‚æ–°çš„ä¸€å¹´ï¼Œè®©æ»´ç­”å£°æé†’ä½ çæƒœæ¯ä¸€åˆ»ï¼Œä¹Ÿåˆ«å¿˜äº†å–æ°´ï¼š',
        'ğŸ§§ é©¬å¹´å‰ç¥¥ï¼æ°´è‹¥å–„ï¼Œå–„è‹¥æ°´ã€‚é€ä½ ä¸€æ¬¾ä¼šæé†’å–æ°´çš„æ™ºæ…§æ—¶é’Ÿï¼Œè¿˜èƒ½å­¦æ°´å­¦çŸ¥è¯†å“¦ï¼š',
        'ğŸŒŠ æ–°å¹´å¥½ï¼ä½ çŸ¥é“å—ï¼Ÿå¤§è„‘80%æ˜¯æ°´ï¼Œæ¯å¤©å–å¤Ÿ2000æ¯«å‡èƒ½æå‡15%å·¥ä½œæ•ˆç‡ã€‚è¯•è¯•è¿™ä¸ªï¼š',
    ];
    
    function shareCNY(method) {
        logActivity('share', 'åˆ†äº«ç¥ç¦ï¼ˆ' + method + 'ï¼‰');
        siteStats.shares.total=(siteStats.shares.total||0)+1; if(!siteStats.shares.methods)siteStats.shares.methods={}; siteStats.shares.methods[method]=(siteStats.shares.methods[method]||0)+1; trackEvent('share','cny_share',method); saveStats();
        const greeting = CNY_GREETINGS[Math.floor(Math.random() * CNY_GREETINGS.length)];
        const url = user ? getShareUrl('invite=' + user.id) : getShareUrl('');
        const fullText = greeting + ' ' + url;
        
        if (method === 'copy') {
            safeCopy(fullText, 'ğŸ“‹ å·²å¤åˆ¶ç¥ç¦ï¼'); speak('æ–°å¹´ç¥ç¦å·²å¤åˆ¶ï¼Œå¿«å»å‘ç»™å¥½å‹å§ï¼');
        } else if (method === 'wechat') {
            safeCopy(fullText, 'ğŸ“‹ å·²å¤åˆ¶ï¼Œè¯·æ‰“å¼€å¾®ä¿¡ç²˜è´´å‘é€'); speak('ç¥ç¦å·²å¤åˆ¶ï¼Œæ‰“å¼€å¾®ä¿¡ç²˜è´´ç»™å¥½å‹å§ï¼');
        } else if (method === 'sms') {
            window.open('sms:?body=' + encodeURIComponent(fullText));
        } else if (method === 'poster') {
            generateCNYPoster();
        }
    }
    
    function generateCNYPoster() {
        const canvas = document.createElement('canvas');
        canvas.width = 600; canvas.height = 900;
        const ctx = canvas.getContext('2d');
        
        // èƒŒæ™¯æ¸å˜
        const grad = ctx.createLinearGradient(0, 0, 0, 900);
        grad.addColorStop(0, '#8B0000');
        grad.addColorStop(0.5, '#B01D23');
        grad.addColorStop(1, '#1a1a2e');
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, 600, 900);
        
        // è£…é¥°
        ctx.fillStyle = 'rgba(255,215,0,0.1)';
        ctx.beginPath(); ctx.arc(300, 300, 200, 0, Math.PI * 2); ctx.fill();
        
        // æ–‡å­—
        ctx.textAlign = 'center';
        ctx.fillStyle = '#FFD700';
        ctx.font = 'bold 60px serif';
        ctx.fillText('ğŸ§§', 300, 160);
        ctx.font = 'bold 48px serif';
        ctx.fillText('é©¬å¹´å¤§å‰', 300, 260);
        
        ctx.fillStyle = '#FFFFFF';
        ctx.font = '20px sans-serif';
        ctx.fillText('ä¸Šå–„è‹¥æ°´ Â· æ°´å–„åˆ©ä¸‡ç‰©è€Œä¸äº‰', 300, 340);
        
        ctx.fillStyle = 'rgba(255,255,255,0.8)';
        ctx.font = '16px sans-serif';
        ctx.fillText('ä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåˆ†ç§’å¿…äº‰', 300, 400);
        ctx.fillText('è®°å¾—æ¯å¤©å–å¤Ÿ2000æ¯«å‡æ°´', 300, 430);
        
        ctx.fillStyle = '#FFD700';
        ctx.font = 'bold 22px sans-serif';
        ctx.fillText('æ™ºå› Â· è¯·ä½ å–æ°´', 300, 520);
        
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.font = '14px sans-serif';
        ctx.fillText('æ‰«ç æˆ–é•¿æŒ‰è¯†åˆ«ï¼Œå¼€å¯æ°´å­¦æ™ºæ…§ä¹‹æ—…', 300, 580);
        
        // ä¸‹è½½åŒºåŸŸ
        ctx.fillStyle = 'rgba(255,255,255,0.1)';
        ctx.roundRect(200, 620, 200, 200, 16);
        ctx.fill();
        ctx.fillStyle = '#FFFFFF';
        ctx.font = '13px sans-serif';
        ctx.fillText('æ°´è‹¥å–„ Â· æ°´å­¦ç ”ç©¶é™¢', 300, 860);
        ctx.fillText('â€” å–æ°´äº†å— â€”', 300, 885);
        
        // ä¸‹è½½
        const link = document.createElement('a');
        link.download = 'é©¬å¹´å¤§å‰_æ™ºå›è¯·ä½ å–æ°´.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        toast('ğŸ–¼ï¸ æµ·æŠ¥å·²ä¿å­˜ï¼');
        speak('æ–°å¹´æµ·æŠ¥å·²ç”Ÿæˆï¼Œåˆ†äº«ç»™å¥½å‹å§ï¼');
    }

    // â•â•â• æ˜¥èŠ‚ç¥ç¦é¦† Â· åˆä¸€åˆ°åäº” â•â•â•
    const FEST_DAYS = [
        { day:0, name:'é™¤å¤•', folk:'è¾æ—§è¿æ–°', emoji:'ğŸ†', greeting:'é™¤æ—§å¸ƒæ–°ï¼Œé©¬åˆ°æˆåŠŸï¼', water:'å¹´å¤œé¥­é—´åˆ«å¿˜å–æ°´ï¼Œå¤§é±¼å¤§è‚‰æ›´éœ€è¦æ°´æ¥å¸®åŠ©æ¶ˆåŒ–ã€‚', bg:'linear-gradient(135deg,#1a0a2e,#4A0E4E,#8B0000,#FFD700)', accent:'#FFD700' },
        { day:1, name:'æ­£æœˆåˆä¸€', folk:'æ‹œå¹´è¿æ–°', emoji:'ğŸ§§', greeting:'é©¬å¹´å¤§å‰ï¼Œä¸‡äº‹å¦‚æ„ï¼', water:'æ–°å¹´ç¬¬ä¸€æ¯æ°´ï¼Œå”¤é†’ä¸€æ•´å¹´çš„æ´»åŠ›ã€‚', bg:'linear-gradient(135deg,#8B0000,#FF4500,#FFD700)', accent:'#FFD700' },
        { day:2, name:'æ­£æœˆåˆäºŒ', folk:'å›å¨˜å®¶', emoji:'ğŸ ', greeting:'é˜–å®¶å›¢åœ†ï¼Œå¹¸ç¦å®‰åº·ï¼', water:'å›å®¶è·¯ä¸Šåˆ«å¿˜å–æ°´ï¼Œæ¸©æš–ä»ä¸€æ¯æ°´å¼€å§‹ã€‚', bg:'linear-gradient(135deg,#B01D23,#E74C3C,#F39C12)', accent:'#F39C12' },
        { day:3, name:'æ­£æœˆåˆä¸‰', folk:'å®‰ç¡æ—¥', emoji:'ğŸ˜´', greeting:'é™å¿ƒå…»ç¥ï¼Œè“„åŠ›å‰è¡Œï¼', water:'ä¼‘æ¯æ—¥ä¹Ÿè¦æŒ‰æ—¶é¥®æ°´ï¼Œèº«ä½“åœ¨ä¿®å¤ä¸­æ›´éœ€è¦æ°´ã€‚', bg:'linear-gradient(135deg,#1a1a3e,#2d1b69,#6B3FA0)', accent:'#B388FF' },
        { day:4, name:'æ­£æœˆåˆå››', folk:'è¿ç¶ç¥', emoji:'ğŸ”¥', greeting:'ç¶ç¥å½’ä½ï¼Œäº”è°·ä¸°ç™»ï¼', water:'å¨æˆ¿é‡Œçš„æ°´æœ€æœ‰ç”Ÿå‘½åŠ›ï¼Œç…®ä¸€å£¶å¥½æ°´è¿ç¶ç¥ã€‚', bg:'linear-gradient(135deg,#8B0000,#C0392B,#E67E22)', accent:'#E67E22' },
        { day:5, name:'æ­£æœˆåˆäº”', folk:'è¿è´¢ç¥', emoji:'ğŸ’°', greeting:'è´¢æºæ»šæ»šï¼Œé©¬åˆ°æˆåŠŸï¼', water:'è´¢å¯Œå¦‚æ°´ï¼Œå–„æµåˆ™ä¸°ã€‚ä»Šå¤©å–å¤Ÿ8æ¯æ°´ï¼Œè´¢è¿äº¨é€šï¼', bg:'linear-gradient(135deg,#B8860B,#DAA520,#FFD700)', accent:'#FFF8DC' },
        { day:6, name:'æ­£æœˆåˆå…­', folk:'é€ç©·Â·å¼€å¸‚', emoji:'ğŸŠ', greeting:'é€ç©·è¿å¯Œï¼Œå¼€å·¥å¤§å‰ï¼', water:'æ–°å¹´å¼€å·¥ç¬¬ä¸€äº‹ï¼šç»™èº«ä½“è¡¥æ»¡æ°´ï¼Œç²¾åŠ›å……æ²›åˆ›ä½³ç»©ã€‚', bg:'linear-gradient(135deg,#006400,#228B22,#32CD32)', accent:'#7FFF00' },
        { day:7, name:'æ­£æœˆåˆä¸ƒ', folk:'äººæ—¥', emoji:'ğŸ§‘', greeting:'äººå¯¿å¹´ä¸°ï¼Œå¥åº·å¸¸åœ¨ï¼', water:'äººæ—¥è¯å¥åº·ï¼šäººä½“60%æ˜¯æ°´ï¼Œçˆ±è‡ªå·±ä»å–æ°´å¼€å§‹ã€‚', bg:'linear-gradient(135deg,#0a3d62,#00bcd4,#00d4ff)', accent:'#00d4ff' },
        { day:8, name:'æ­£æœˆåˆå…«', folk:'è°·æ—¥Â·é¡ºæ˜Ÿ', emoji:'â­', greeting:'è°·ç‰©ä¸°æ”¶ï¼Œæ˜Ÿè¾°æŒ‡å¼•ï¼', water:'æ˜Ÿè¾°å¤§æµ·éƒ½ç”±æ°´ç»„æˆï¼Œä¸€æ¯æ°´è¿æ¥ä½ ä¸å®‡å®™ã€‚', bg:'linear-gradient(135deg,#0d1b2a,#1b2838,#34495e)', accent:'#85C1E9' },
        { day:9, name:'æ­£æœˆåˆä¹', folk:'å¤©å…¬ç”Ÿ', emoji:'ğŸ™', greeting:'å¤©å…¬èµç¦ï¼Œå‰ç¥¥å¦‚æ„ï¼', water:'å¤©é™ç”˜éœ–æ˜¯æœ€å¤§çš„æ©èµï¼Œæ¯ä¸€æ»´æ°´éƒ½å€¼å¾—æ„Ÿæ©ã€‚', bg:'linear-gradient(135deg,#4A0E4E,#812F91,#C56CD6)', accent:'#E1BEE7' },
        { day:10, name:'æ­£æœˆåˆå', folk:'çŸ³å¤´ç”Ÿæ—¥', emoji:'ğŸª¨', greeting:'ç¨³å¦‚ç£çŸ³ï¼ŒåšéŸ§ä¸æ‹”ï¼', water:'æ°´æ»´çŸ³ç©¿çš„æ™ºæ…§ï¼šæŸ”èƒ½å…‹åˆšï¼Œæ’èƒ½èƒœä¸€åˆ‡ã€‚', bg:'linear-gradient(135deg,#2C3E50,#34495E,#5D6D7E)', accent:'#AEB6BF' },
        { day:11, name:'æ­£æœˆåä¸€', folk:'è¯·å¥³å©¿', emoji:'ğŸ¥‚', greeting:'å¥³å©¿æ‹œå¹´ï¼Œå…¶ä¹èèï¼', water:'ä»¥æ°´ä»£é…’æ•¬é•¿è¾ˆï¼Œå¥åº·æ˜¯æœ€å¥½çš„ç¤¼ç‰©ã€‚', bg:'linear-gradient(135deg,#78281F,#B03A2E,#E74C3C)', accent:'#FADBD8' },
        { day:12, name:'æ­£æœˆåäºŒ', folk:'æ­ç¯æ£š', emoji:'ğŸ”¨', greeting:'å¼ ç¯ç»“å½©ï¼Œå–œè¿å…ƒå®µï¼', water:'æ­å»ºæ¢¦æƒ³å¦‚æ­ç¯æ£šï¼Œæ¯å¤©å…«æ¯æ°´ä¸ºèº«ä½“æ‰“å¥½åœ°åŸºã€‚', bg:'linear-gradient(135deg,#7B241C,#C0392B,#F1C40F)', accent:'#F1C40F' },
        { day:13, name:'æ­£æœˆåä¸‰', folk:'ç¯å¤´ç”Ÿæ—¥', emoji:'ğŸ’¡', greeting:'ç‚¹äº®å¿ƒç¯ï¼Œç…§äº®å‰ç¨‹ï¼', water:'æ°´çš„æŠ˜å°„è®©å…‰æ›´ç¾ä¸½ï¼Œæ¸…æ¾ˆçš„èº«ä½“è®©å¿ƒçµæ›´æ˜äº®ã€‚', bg:'linear-gradient(135deg,#1B4F72,#2E86C1,#5DADE2)', accent:'#AED6F1' },
        { day:14, name:'æ­£æœˆåå››', folk:'è¯•èŠ±ç¯', emoji:'ğŸ®', greeting:'èŠ±ç¯åˆä¸Šï¼Œç¾ä¸èƒœæ”¶ï¼', water:'æ˜å¤©å°±æ˜¯å…ƒå®µèŠ‚ï¼Œæå‰å–å¥½æ°´ï¼Œæ˜å¤©æ›´ç²¾å½©ï¼', bg:'linear-gradient(135deg,#922B21,#E74C3C,#F39C12)', accent:'#FDEBD0' },
        { day:15, name:'æ­£æœˆåäº”', folk:'å…ƒå®µèŠ‚', emoji:'ğŸ¥®', greeting:'æœˆåœ†äººåœ†ï¼Œå…ƒå®µå¿«ä¹ï¼', water:'æ±¤åœ†é…æ¸©æ°´ï¼Œå›¢å›¢åœ†åœ†åˆå¥åº·ã€‚ä¸Šå–„è‹¥æ°´ï¼Œåˆ†ç§’å¿…äº‰ï¼', bg:'linear-gradient(135deg,#8B0000,#DC143C,#FF6347,#FFD700)', accent:'#FFD700' }
    ];
    let currentFestDay = 0;

    function renderFestGrid() {
        // è‡ªåŠ¨å¡«å……ç™»å½•ç”¨æˆ·åå­—
        var fn = document.getElementById('festName');
        if (fn && !fn.value && user && user.name) fn.value = user.name;
        const grid = document.getElementById('festDayGrid');
        if (!grid) return;
        const today = new Date();
        const cnyStart = new Date(2026, 1, 16); // 2026-02-16 é™¤å¤•=day0, åˆä¸€=day1
        const daysSinceCNY = Math.floor((today - cnyStart) / 86400000);
        grid.innerHTML = FEST_DAYS.map((d,i) => {
            const isToday = d.day === daysSinceCNY;
            const isPast = d.day < daysSinceCNY;
            const isFuture = d.day > daysSinceCNY;
            return `<div onclick="openFestPage(${i})" style="padding:10px 4px;border-radius:12px;text-align:center;cursor:pointer;background:${d.bg};position:relative;border:${isToday?'2px solid #fff':'1px solid rgba(255,255,255,0.15)'};opacity:${isFuture?'0.6':'1'};transition:transform .2s;" onmouseenter="this.style.transform='scale(1.05)'" onmouseleave="this.style.transform='scale(1)'">
                ${isToday?'<div style="position:absolute;top:-6px;right:-6px;background:#ff4757;color:#fff;font-size:8px;padding:1px 5px;border-radius:8px;">ä»Šå¤©</div>':''}
                <div style="font-size:22px;">${d.emoji}</div>
                <div style="font-size:11px;font-weight:bold;color:#fff;margin:3px 0;">${d.name}</div>
                <div style="font-size:9px;color:rgba(255,255,255,0.8);">${d.folk}</div>
            </div>`;
        }).join('');
    }

    // â•â•â• ä¸‡é©¬å¥”è…¾SVGï¼ˆå­˜ä¸ºå˜é‡é¿å…è½¬ä¹‰é—®é¢˜ï¼‰â•â•â•
    const HORSE_SVG = "data:image/svg+xml," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 400"><g fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" opacity="0.5"><path d="M80 280Q90 240 110 230Q130 220 140 200L150 180Q160 160 170 165L180 170Q175 150 180 140L195 130Q200 125 205 130L210 140Q215 150 210 160L200 170Q210 165 220 170L240 180Q260 190 270 210Q280 230 290 240L310 260Q320 270 330 275L350 280Q340 285 320 290L300 285Q280 280 260 275L240 265Q220 258 200 260L180 265Q160 270 140 278L100 290Z"/><path d="M195 130Q200 110 210 100L220 95Q225 92 220 100"/><path d="M150 180Q142 170 138 175L130 185"/><path d="M400 260Q410 220 430 210Q450 200 460 180L470 160Q480 140 490 145L500 150Q495 130 500 120L515 110Q520 105 525 110L530 120Q535 130 530 140L520 150Q530 145 540 150L560 160Q580 170 590 190Q600 210 610 220L630 240Q640 250 650 255L670 260Q660 265 640 270L620 265Q600 260 580 255L560 245Q540 238 520 240L500 245Q480 250 460 258L420 270Z"/><path d="M515 110Q520 90 530 80L540 75Q545 72 540 80"/><path d="M470 160Q462 150 458 155L450 165"/><path d="M620 290Q630 260 650 250Q665 242 672 228L678 215Q685 200 692 204L698 208Q695 192 700 185L710 178Q714 174 718 178L722 186Q726 194 722 202L714 210Q722 206 730 210L745 218Q760 226 768 242Q774 256 780 264L792 278"/><path d="M710 178Q714 162 722 154L728 150"/><path d="M0 320Q10 290 25 282Q38 275 44 262L50 250Q56 236 62 240L66 244Q64 230 68 224L78 218Q82 214 85 218L88 226Q92 234 88 240L82 248Q88 244 95 248L108 256Q122 264 128 278Q134 290 140 298L155 310"/><path d="M50 250Q42 240 38 245L30 255"/></g></svg>');

    function openFestPage(idx) {
        currentFestDay = idx;
        const d = FEST_DAYS[idx];
        const name = document.getElementById('festName') ? document.getElementById('festName').value.trim() : '';
        const page = document.getElementById('festPage');
        page.style.background = d.bg;

        // æ„å»ºHTMLï¼ˆé¿å…æ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¹‰é—®é¢˜ï¼‰
        var html = '';
        // ä¸‡é©¬å¥”è…¾èƒŒæ™¯å±‚
        html += '<div style="position:absolute;top:0;left:0;right:0;bottom:0;background-image:url(' + HORSE_SVG + ');background-size:cover;background-position:center bottom;background-repeat:no-repeat;pointer-events:none;opacity:1;"></div>';
        // å†…å®¹å±‚
        html += '<div style="position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;">';
        html += '<div style="font-size:60px;margin-bottom:8px;filter:drop-shadow(0 4px 12px rgba(0,0,0,0.3));">' + d.emoji + '</div>';
        html += '<div style="font-size:14px;color:rgba(255,255,255,0.7);letter-spacing:4px;margin-bottom:4px;">ä¸™åˆé©¬å¹´</div>';
        html += '<div style="font-size:36px;font-weight:900;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,0.3);margin-bottom:4px;">' + d.name + '</div>';
        html += '<div style="font-size:16px;color:' + d.accent + ';margin-bottom:16px;">' + d.folk + '</div>';
        html += '<div style="width:50px;height:2px;background:' + d.accent + ';margin:0 auto 16px;border-radius:2px;"></div>';
        // ä¸ªæ€§åŒ–ç¥ç¦ â€” ç‹¬ç«‹ä¸€è¡Œ
        if (name) {
            html += '<div style="font-size:16px;color:' + d.accent + ';margin-bottom:10px;letter-spacing:3px;opacity:0.95;font-weight:500;">ğŸ‹ ' + name + 'ç¥ç¦æ‚¨</div>';
        }
        // ç¥ç¦è¯­ï¼ˆä¸å«åå­—ï¼Œå¹²å‡€ç‹¬ç«‹ï¼‰
        html += '<div style="font-size:22px;font-weight:700;color:#fff;line-height:1.6;margin-bottom:12px;max-width:300px;text-shadow:0 1px 4px rgba(0,0,0,0.3);">' + d.greeting + '</div>';
        html += '<div style="font-size:14px;color:rgba(255,255,255,0.85);line-height:1.8;max-width:280px;margin-bottom:24px;padding:12px;background:rgba(255,255,255,0.08);border-radius:12px;backdrop-filter:blur(4px);">ğŸ’§ ' + d.water + '</div>';
        html += '<div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:4px;">â€” é•¿å¯¿ç™¾å²ï¼Œåˆ«å¿˜å–æ°´ â€”</div>';
        html += '<div style="font-size:11px;color:rgba(255,255,255,0.4);">å–æ°´äº†å—</div>';
        html += '<div style="font-size:11px;color:' + d.accent + ';margin-top:8px;">å–æ°´äº†å— ğŸ’§</div>';
        html += '</div>';

        page.innerHTML = html;
        document.getElementById('festOverlay').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function showViralLanding(dayIdx, senderName, inviterId) {
        siteStats.festivals.views=(siteStats.festivals.views||0)+1; if(!siteStats.festivals.days)siteStats.festivals.days={}; siteStats.festivals.days['day'+dayIdx]=(siteStats.festivals.days['day'+dayIdx]||0)+1; trackEvent('festival','viral_landing','day='+dayIdx+'&from='+(senderName||'')); saveStats();
        var d = FEST_DAYS[dayIdx] || FEST_DAYS[0];
        var ov = document.createElement('div');
        ov.id = 'viralLanding';
        ov.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:30000;overflow-y:auto;';

        var bgColors = d.bg;
        var html = '';
        html += '<div style="min-height:100vh;background:' + bgColors + ';display:flex;flex-direction:column;align-items:center;padding:40px 20px 120px;text-align:center;position:relative;">';

        // ä¸‡é©¬å¥”è…¾èƒŒæ™¯
        html += '<div style="position:absolute;top:0;left:0;right:0;bottom:0;background-image:url(' + HORSE_SVG + ');background-size:cover;background-position:center bottom;pointer-events:none;opacity:1;"></div>';

        // å†…å®¹
        html += '<div style="position:relative;z-index:1;max-width:360px;">';

        // emoji + é©¬å¹´
        html += '<div style="font-size:70px;margin-bottom:8px;filter:drop-shadow(0 4px 16px rgba(0,0,0,0.3));animation:bounce 2s infinite;">' + d.emoji + '</div>';
        html += '<div style="font-size:13px;color:rgba(255,255,255,0.6);letter-spacing:5px;margin-bottom:6px;">ä¸™åˆé©¬å¹´ Â· ' + d.name + '</div>';

        // ä¸ªæ€§åŒ–å‘é€è€…ä¿¡æ¯
        if (senderName) {
            html += '<div style="background:rgba(255,255,255,0.1);backdrop-filter:blur(8px);border:1px solid rgba(255,215,0,0.3);border-radius:16px;padding:12px 20px;margin:12px 0;">';
            html += '<div style="font-size:13px;color:rgba(255,255,255,0.6);">æ¥è‡ª</div>';
            html += '<div style="font-size:20px;font-weight:bold;color:#FFD700;margin:4px 0;">ğŸ‹ ' + decodeURIComponent(senderName) + '</div>';
            html += '<div style="font-size:13px;color:rgba(255,255,255,0.6);">çš„æ–°å¹´ç¥ç¦</div>';
            html += '</div>';
        }

        // ç¥ç¦è¯­
        html += '<div style="font-size:28px;font-weight:900;color:#fff;line-height:1.5;margin:20px 0 12px;text-shadow:0 2px 8px rgba(0,0,0,0.3);">' + d.greeting + '</div>';
        html += '<div style="font-size:15px;color:rgba(255,255,255,0.85);line-height:1.8;padding:14px 18px;background:rgba(255,255,255,0.08);border-radius:14px;backdrop-filter:blur(4px);margin-bottom:20px;">ğŸ’§ ' + d.water + '</div>';

        html += '<div style="width:40px;height:2px;background:' + d.accent + ';margin:0 auto 20px;border-radius:2px;"></div>';

        // â•â•â• è£‚å˜æ ¸å¿ƒï¼š3ä¸ªè¡ŒåŠ¨æŒ‰é’® â•â•â•
        html += '<div style="display:flex;flex-direction:column;gap:10px;width:100%;">';

        // æŒ‰é’®1: æˆ‘ä¹Ÿè¦å‘ç¥ç¦ï¼ˆè¿›å…¥appåˆ›å»ºè‡ªå·±çš„ï¼‰
        html += '<button onclick="enterAppFromLanding()" style="width:100%;padding:14px;border-radius:16px;border:none;background:linear-gradient(135deg,#FFD700,#FF9500);color:#000;font-size:16px;font-weight:bold;cursor:pointer;box-shadow:0 4px 15px rgba(255,215,0,0.4);">';
        html += 'ğŸ§§ æˆ‘ä¹Ÿè¦å‘ç¥ç¦ç»™æœ‹å‹</button>';

        // æŒ‰é’®2: è½¬å‘è¿™æ¡ç¥ç¦
        html += '<button onclick="viralReShare(' + dayIdx + ')" style="width:100%;padding:14px;border-radius:16px;border:none;background:#07C160;color:#fff;font-size:16px;font-weight:bold;cursor:pointer;box-shadow:0 4px 15px rgba(7,193,96,0.3);">';
        html += 'ğŸ’¬ è½¬å‘ç»™æˆ‘çš„æœ‹å‹</button>';

        // æŒ‰é’®3: ä¿å­˜å›¾ç‰‡
        html += '<button onclick="viralSavePoster(' + dayIdx + ')" style="width:100%;padding:14px;border-radius:16px;border:none;background:rgba(255,255,255,0.15);color:#fff;font-size:16px;font-weight:bold;cursor:pointer;backdrop-filter:blur(8px);">';
        html += 'ğŸ–¼ï¸ ä¿å­˜ç¥ç¦å›¾ç‰‡</button>';

        html += '</div>';

        // åº•éƒ¨ä¿¡æ¯
        html += '<div style="margin-top:30px;font-size:12px;color:rgba(255,255,255,0.4);">ä¸Šå–„è‹¥æ°´ Â· åˆ†ç§’å¿…äº‰</div>';
        html += '<div style="font-size:11px;color:rgba(255,255,255,0.3);margin-top:4px;">æ°´è‹¥å–„ Â· å–æ°´äº†å—</div>';

        html += '</div></div>';

        // åº•éƒ¨å›ºå®šï¼šä½“éªŒå®Œæ•´ç‰ˆ
        html += '<div style="position:fixed;bottom:0;left:0;right:0;z-index:30001;background:rgba(0,0,0,0.8);backdrop-filter:blur(12px);padding:12px 20px;padding-bottom:max(12px,env(safe-area-inset-bottom));text-align:center;">';
        html += '<div style="font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:6px;">ğŸ’§ æ™ºèƒ½å–æ°´æé†’ Â· AIæ°´å­¦åŠ©æ‰‹ Â· å¥åº·ç®¡ç†</div>';
        html += '<button onclick="enterAppFromLanding()" style="padding:10px 30px;border-radius:20px;border:none;background:linear-gradient(135deg,#00d4ff,#06ffa5);color:#000;font-weight:bold;font-size:14px;cursor:pointer;">âœ¨ å…è´¹ä½“éªŒå®Œæ•´ç‰ˆ</button>';
        html += '</div>';

        ov.innerHTML = html;
        document.body.appendChild(ov);
        document.body.style.overflow = 'hidden';
    }

    function enterAppFromLanding() {
        var landing = document.getElementById('viralLanding');
        if (landing) {
            landing.style.transition = 'opacity 0.5s';
            landing.style.opacity = '0';
            setTimeout(function() {
                landing.remove();
                document.body.style.overflow = '';
                // æ¸…é™¤URLå‚æ•°
                history.replaceState(null, '', location.pathname);
                // ç›´æ¥æ‰“å¼€ç¥ç¦é¦†è®©ç”¨æˆ·åˆ›å»ºè‡ªå·±çš„
                openPanel('festivalPanel');
                toast('ğŸ§§ åˆ›å»ºä½ è‡ªå·±çš„ç¥ç¦å‘ç»™æœ‹å‹å§ï¼');
            }, 500);
        }
    }

    function viralReShare(dayIdx) {
        var d = FEST_DAYS[dayIdx] || FEST_DAYS[0];
        // å¼¹å‡ºè¾“å…¥åå­—æ¡†
        var nameInput = prompt('è¾“å…¥ä½ çš„åå­—ï¼ˆä¼šæ˜¾ç¤ºåœ¨ç¥ç¦ä¸­ï¼‰:');
        if (nameInput === null) return;
        nameInput = nameInput.trim();
        var url = getShareUrl('day=' + dayIdx + (nameInput ? '&name=' + encodeURIComponent(nameInput) : ''));
        var text = d.emoji + ' ' + d.name + ' Â· ' + d.folk;
        if (nameInput) text += '\nğŸ‹ ' + nameInput + 'ç¥ç¦æ‚¨';
        text += '\n' + d.greeting + '\nğŸ’§ ' + d.water + '\nâ€” ä¸Šå–„è‹¥æ°´ Â· åˆ†ç§’å¿…äº‰ â€”\nğŸ‘‰ ' + url;

        // ç”Ÿæˆæµ·æŠ¥å¹¶åˆ†äº«
        var c = document.createElement('canvas');
        c.width = 600; c.height = 900;
        var ctx = c.getContext('2d');
        var grad = ctx.createLinearGradient(0,0,600,900);
        var colors = d.bg.match(/#[A-Fa-f0-9]{6}/g) || ['#8B0000','#FF4500','#FFD700'];
        colors.forEach(function(col,i){ grad.addColorStop(i/(colors.length-1), col); });
        ctx.fillStyle = grad; ctx.fillRect(0,0,600,900);
        ctx.fillStyle = 'rgba(255,255,255,0.04)'; ctx.beginPath(); ctx.arc(300,300,180,0,Math.PI*2); ctx.fill();
        ctx.textAlign = 'center'; ctx.fillStyle = '#fff';
        ctx.font = '60px serif'; ctx.fillText(d.emoji, 300, 140);
        ctx.font = '12px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.fillText('ä¸™åˆé©¬å¹´', 300, 175);
        ctx.font = 'bold 40px serif'; ctx.fillStyle = '#fff'; ctx.fillText(d.name, 300, 240);
        ctx.font = '18px sans-serif'; ctx.fillStyle = d.accent; ctx.fillText(d.folk, 300, 275);
        var ny = 340;
        if (nameInput) { ctx.font = '16px sans-serif'; ctx.fillStyle = d.accent; ctx.fillText('ğŸ‹ ' + nameInput + 'ç¥ç¦æ‚¨', 300, ny); ny += 35; }
        ctx.font = 'bold 22px sans-serif'; ctx.fillStyle = '#fff'; wrapText(ctx, d.greeting, 300, ny, 480, 32);
        ctx.font = '14px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.7)'; wrapText(ctx, 'ğŸ’§ ' + d.water, 300, ny+70, 460, 22);
        ctx.fillStyle = d.accent; ctx.font = '13px sans-serif'; ctx.fillText('ä¸Šå–„è‹¥æ°´ Â· åˆ†ç§’å¿…äº‰', 300, 720);
        ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.font = '11px sans-serif'; ctx.fillText('æ°´è‹¥å–„ Â· å–æ°´äº†å—', 300, 745);
        // åº•éƒ¨æç¤ºï¼šé•¿æŒ‰è¯†åˆ« / æ‰«ç 
        ctx.fillStyle = 'rgba(255,255,255,0.15)'; roundRect(ctx, 150, 780, 300, 60, 12); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.font = '12px sans-serif';
        ctx.fillText('ğŸ‘‰ é•¿æŒ‰å›¾ç‰‡ â†’ è¯†åˆ«é“¾æ¥ â†’ å‘é€ç¥ç¦', 300, 808);
        ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.font = '10px sans-serif';
        ctx.fillText(url, 300, 830);

        c.toBlob(function(blob) {
            if (!blob) { safeCopy(text, 'ğŸ“‹ ç¥ç¦å·²å¤åˆ¶ï¼'); return; }
            var file = new File([blob], d.name + '_é©¬å¹´ç¥ç¦.png', { type: 'image/png' });
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                navigator.share({ title: d.name + ' Â· é©¬å¹´ç¥ç¦', text: text, files: [file] }).catch(function(e){
                    if (e.name !== 'AbortError') safeCopy(text, 'ğŸ“‹ ç¥ç¦å·²å¤åˆ¶ï¼');
                });
            } else if (navigator.share) {
                navigator.share({ title: d.name + ' Â· é©¬å¹´ç¥ç¦', text: text, url: url }).catch(function(){
                    safeCopy(text, 'ğŸ“‹ ç¥ç¦å·²å¤åˆ¶ï¼');
                });
            } else {
                var a = document.createElement('a'); a.download = d.name + '_é©¬å¹´ç¥ç¦.png'; a.href = URL.createObjectURL(blob); a.click(); URL.revokeObjectURL(a.href);
                safeCopy(text, 'ğŸ“‹ ç¥ç¦+å›¾ç‰‡å·²ä¿å­˜ï¼å‘é€ç»™æœ‹å‹å§');
            }
        }, 'image/png');
    }

    function viralSavePoster(dayIdx) {
        var d = FEST_DAYS[dayIdx] || FEST_DAYS[0];
        var c = document.createElement('canvas');
        c.width = 600; c.height = 900;
        var ctx = c.getContext('2d');
        var grad = ctx.createLinearGradient(0,0,600,900);
        var colors = d.bg.match(/#[A-Fa-f0-9]{6}/g) || ['#8B0000','#FF4500','#FFD700'];
        colors.forEach(function(col,i){ grad.addColorStop(i/(colors.length-1), col); });
        ctx.fillStyle = grad; ctx.fillRect(0,0,600,900);
        ctx.fillStyle = 'rgba(255,255,255,0.04)'; ctx.beginPath(); ctx.arc(300,300,180,0,Math.PI*2); ctx.fill();
        ctx.textAlign = 'center'; ctx.fillStyle = '#fff';
        ctx.font = '60px serif'; ctx.fillText(d.emoji, 300, 140);
        ctx.font = '12px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.fillText('ä¸™åˆé©¬å¹´', 300, 175);
        ctx.font = 'bold 40px serif'; ctx.fillStyle = '#fff'; ctx.fillText(d.name, 300, 240);
        ctx.font = '18px sans-serif'; ctx.fillStyle = d.accent; ctx.fillText(d.folk, 300, 275);
        ctx.font = 'bold 22px sans-serif'; ctx.fillStyle = '#fff'; wrapText(ctx, d.greeting, 300, 340, 480, 32);
        ctx.font = '14px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.7)'; wrapText(ctx, 'ğŸ’§ ' + d.water, 300, 410, 460, 22);
        ctx.fillStyle = d.accent; ctx.font = '13px sans-serif'; ctx.fillText('ä¸Šå–„è‹¥æ°´ Â· åˆ†ç§’å¿…äº‰', 300, 720);
        ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.font = '11px sans-serif'; ctx.fillText('æ°´è‹¥å–„ Â· å–æ°´äº†å—', 300, 745);
        var url = getShareUrl('day=' + dayIdx);
        ctx.fillStyle = 'rgba(255,255,255,0.15)'; roundRect(ctx, 150, 780, 300, 60, 12); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.font = '12px sans-serif';
        ctx.fillText('ğŸ‘‰ é•¿æŒ‰å›¾ç‰‡ â†’ å‘é€ç¥ç¦ç»™æœ‹å‹', 300, 808);
        ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.font = '10px sans-serif'; ctx.fillText(url, 300, 830);
        var link = document.createElement('a');
        link.download = d.name + '_é©¬å¹´ç¥ç¦.png';
        link.href = c.toDataURL('image/png');
        link.click();
        toast('ğŸ–¼ï¸ å›¾ç‰‡å·²ä¿å­˜ï¼è½¬å‘ç»™æœ‹å‹å³å¯è£‚å˜ä¼ æ’­');
    }

    function closeFestOverlay() {
        document.getElementById('festOverlay').style.display = 'none';
        document.body.style.overflow = '';
    }

    function festShareTo(channel) {
        var d = FEST_DAYS[currentFestDay];
        var senderForLog = (document.getElementById('festName') ? document.getElementById('festName').value.trim() : '') || (user ? user.name : 'åŒ¿å');
        logActivity('send_blessing', senderForLog + ' å‘é€ ' + d.name + ' ç¥ç¦ï¼ˆ' + channel + 'ï¼‰');
        var name = document.getElementById('festName') ? document.getElementById('festName').value.trim() : '';
        var url = getShareUrl('day=' + currentFestDay + (name ? '&name=' + encodeURIComponent(name) : '') + (user ? '&invite=' + user.id : ''));
        var blessing = name ? '\nğŸ‹ ' + name + 'ç¥ç¦æ‚¨' : '';
        var text = d.emoji + ' ' + d.name + 'Â·' + d.folk + blessing + '\n' + d.greeting + '\nğŸ’§ ' + d.water + '\nâ€” æ°´è‹¥å–„ Â· å–æ°´äº†å— â€”\nğŸ‘‰ ' + url;
        if (channel === 'wechat') {
            // ç”Ÿæˆæµ·æŠ¥å›¾ç‰‡å¹¶è°ƒèµ·ç³»ç»Ÿåˆ†äº«ï¼ˆæ‰‹æœºä¸Šç›´æ¥å¼¹å‡ºå¾®ä¿¡é€‰é¡¹ï¼‰
            shareWithPoster(d, name, text, url);
        } else if (channel === 'sms') {
            window.open('sms:?body=' + encodeURIComponent(text));
        } else if (channel === 'contacts') {
            showFestContactsPicker(text);
        } else if (channel === 'copy') {
            safeCopy(text, 'ğŸ“‹ ' + d.name + 'ç¥ç¦å·²å¤åˆ¶ï¼');
        }
    }

    function shareWithPoster(d, name, text, url) {
        // ç”Ÿæˆç¥ç¦æµ·æŠ¥
        var c = document.createElement('canvas');
        c.width = 600; c.height = 800;
        var ctx = c.getContext('2d');
        // èƒŒæ™¯æ¸å˜
        var grad = ctx.createLinearGradient(0, 0, 600, 800);
        var colors = d.bg.match(/#[A-Fa-f0-9]{6}/g) || ['#8B0000','#FF4500','#FFD700'];
        colors.forEach(function(col, i) { grad.addColorStop(i/(colors.length-1), col); });
        ctx.fillStyle = grad; ctx.fillRect(0,0,600,800);
        // è£…é¥°
        ctx.fillStyle = 'rgba(255,255,255,0.04)';
        ctx.beginPath(); ctx.arc(300,280,180,0,Math.PI*2); ctx.fill();
        // æ–‡å­—
        ctx.textAlign = 'center'; ctx.fillStyle = '#fff';
        ctx.font = '60px serif'; ctx.fillText(d.emoji, 300, 140);
        ctx.font = '12px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.fillText('ä¸™åˆé©¬å¹´', 300, 175);
        ctx.font = 'bold 40px serif'; ctx.fillStyle = '#fff'; ctx.fillText(d.name, 300, 240);
        ctx.font = '18px sans-serif'; ctx.fillStyle = d.accent; ctx.fillText(d.folk, 300, 275);
        var ny = 340;
        if (name) { ctx.font = '16px sans-serif'; ctx.fillStyle = d.accent; ctx.fillText('ğŸ‹ ' + name + 'ç¥ç¦æ‚¨', 300, ny); ny += 35; }
        ctx.font = 'bold 22px sans-serif'; ctx.fillStyle = '#fff'; wrapText(ctx, d.greeting, 300, ny, 480, 32);
        ctx.font = '14px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.7)'; wrapText(ctx, 'ğŸ’§ ' + d.water, 300, ny + 70, 460, 22);
        ctx.fillStyle = d.accent; ctx.font = '14px sans-serif'; ctx.fillText('ä¸Šå–„è‹¥æ°´ Â· åˆ†ç§’å¿…äº‰', 300, 680);
        ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.font = '11px sans-serif'; ctx.fillText('æ°´è‹¥å–„ Â· å–æ°´äº†å— Â· ä¸Šå–„è‹¥æ°´', 300, 710);
        ctx.fillStyle = 'rgba(255,255,255,0.25)'; ctx.font = '10px sans-serif'; ctx.fillText(url, 300, 740);
        // è½¬ä¸ºBlobå¹¶è°ƒç”¨ç³»ç»Ÿåˆ†äº«
        c.toBlob(function(blob) {
            if (!blob) { safeCopy(text, 'ğŸ“‹ ç¥ç¦å·²å¤åˆ¶ï¼è¯·æ‰‹åŠ¨å‘é€'); return; }
            var file = new File([blob], d.name + '_é©¬å¹´ç¥ç¦.png', { type: 'image/png' });
            // æ£€æµ‹navigator.shareæ˜¯å¦æ”¯æŒæ–‡ä»¶åˆ†äº«
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                navigator.share({
                    title: d.name + ' Â· é©¬å¹´ç¥ç¦',
                    text: text,
                    files: [file]
                }).then(function(){ toast('âœ… åˆ†äº«æˆåŠŸï¼'); }).catch(function(e){
                    if (e.name !== 'AbortError') safeCopy(text, 'ğŸ“‹ ç¥ç¦å·²å¤åˆ¶ï¼');
                });
            } else if (navigator.share) {
                // ä¸æ”¯æŒæ–‡ä»¶ä½†æ”¯æŒæ–‡æœ¬åˆ†äº«
                navigator.share({ title: d.name + ' Â· é©¬å¹´ç¥ç¦', text: text, url: url }).catch(function(){
                    safeCopy(text, 'ğŸ“‹ ç¥ç¦å·²å¤åˆ¶ï¼æ‰“å¼€å¾®ä¿¡ç²˜è´´å‘é€');
                });
            } else {
                // éƒ½ä¸æ”¯æŒï¼Œä¸‹è½½å›¾ç‰‡+å¤åˆ¶æ–‡å­—
                var a = document.createElement('a');
                a.download = d.name + '_é©¬å¹´ç¥ç¦.png';
                a.href = URL.createObjectURL(blob);
                a.click(); URL.revokeObjectURL(a.href);
                safeCopy(text, 'ğŸ“‹ ç¥ç¦+å›¾ç‰‡å·²ä¿å­˜ï¼å‘é€ç»™å¥½å‹å§');
            }
        }, 'image/png');
    }

    function showFestContactsPicker(shareText) {
        window._festShareText = shareText;
        window._festPeople = [];
        if (typeof contacts !== 'undefined' && contacts && contacts.length) {
            contacts.forEach(function(c,i){ window._festPeople.push({name:c.name, phone:c.phone||'', tag:c.group||'', idx:i, src:'c'}); });
        }
        if (typeof friends !== 'undefined' && friends && friends.length) {
            friends.forEach(function(f,i){ window._festPeople.push({name:f.name, phone:f.phone||'', tag:f.relation||'', idx:i, src:'f'}); });
        }
        var ov = document.createElement('div');
        ov.id = 'festContactsPicker';
        ov.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:20000;background:rgba(0,0,0,0.85);display:flex;flex-direction:column;justify-content:flex-end;';
        ov.onclick = function(e){ if(e.target===ov) closeFestPicker(); };
        var box = document.createElement('div');
        box.style.cssText = 'width:100%;max-height:65vh;background:#1a1a2e;border-radius:20px 20px 0 0;padding:16px;overflow-y:auto;';
        var title = document.createElement('div');
        title.style.cssText = 'text-align:center;margin-bottom:12px;';
        title.innerHTML = '<div style="font-size:16px;font-weight:bold;color:#FFD700;">ğŸ“‡ é€‰æ‹©å‘é€å¯¹è±¡</div>';
        box.appendChild(title);
        var list = document.createElement('div');
        list.id = 'festPickerList';
        var colors = ['#00d4ff','#06ffa5','#FFD700','#ff6b9d','#8338ec'];
        window._festPeople.forEach(function(p, i) {
            var row = document.createElement('div');
            row.className = 'fp-item';
            row.setAttribute('data-name', p.name);
            row.setAttribute('data-idx', i);
            row.style.cssText = 'display:flex;align-items:center;gap:10px;padding:10px 8px;border-radius:10px;cursor:pointer;margin-bottom:3px;background:rgba(255,255,255,0.03);';
            row.onclick = function(){ sendFestByIdx(i); };
            var avatar = document.createElement('div');
            avatar.style.cssText = 'width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:bold;color:#000;background:'+colors[i%colors.length];
            avatar.textContent = p.name.charAt(0);
            row.appendChild(avatar);
            var info = document.createElement('div');
            info.style.cssText = 'flex:1;';
            info.innerHTML = '<div style="font-size:13px;color:#fff;">'+p.name+'</div><div style="font-size:10px;color:rgba(255,255,255,0.3);">'+p.tag+'</div>';
            row.appendChild(info);
            var btn = document.createElement('div');
            btn.style.cssText = 'padding:4px 10px;background:rgba(255,215,0,0.15);border-radius:12px;font-size:11px;color:#FFD700;';
            btn.textContent = 'å‘é€';
            row.appendChild(btn);
            list.appendChild(row);
        });
        if (window._festPeople.length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.4);font-size:13px;">æš‚æ— è”ç³»äºº<br><span style="font-size:11px;">è¯·å…ˆåœ¨"æ™ºèƒ½å…³æ€€"ä¸­æˆæƒé€šè®¯å½•</span></div>';
        }
        box.appendChild(list);
        var cancelBtn = document.createElement('button');
        cancelBtn.style.cssText = 'width:100%;padding:12px;margin-top:8px;border-radius:12px;border:none;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);font-size:14px;cursor:pointer;';
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.onclick = closeFestPicker;
        box.appendChild(cancelBtn);
        ov.appendChild(box);
        document.body.appendChild(ov);
    }

    function closeFestPicker() {
        var el = document.getElementById('festContactsPicker');
        if (el) el.remove();
    }

    function filterFestPicker() {
        var q = (document.getElementById('festPickerSearch')?.value || '').toLowerCase();
        document.querySelectorAll('.fp-item').forEach(function(el){
            var n = (el.getAttribute('data-name')||'').toLowerCase();
            el.style.display = (!q || n.indexOf(q) >= 0) ? 'flex' : 'none';
        });
    }

    function sendFestByIdx(globalIdx) {
        var p = window._festPeople[globalIdx];
        if (!p) return;
        var text = window._festShareText || '';
        var person = p.src === 'c' ? contacts[p.idx] : friends[p.idx];
        var phone = person.phone || '';
        if (phone && phone.indexOf('*') < 0) {
            window.open('sms:' + phone + '?body=' + encodeURIComponent(text));
            toast('ğŸ“± æ­£åœ¨å‘é€ç»™ ' + person.name);
        } else {
            safeCopy(text, 'ğŸ“‹ å·²å¤åˆ¶ï¼è¯·æ‰‹åŠ¨å‘é€ç»™ ' + person.name);
        }
        closeFestPicker();
    }



    function saveFestPoster() {
        var d = FEST_DAYS[currentFestDay];
        var name = document.getElementById('festName') ? document.getElementById('festName').value.trim() : '';
        var c = document.createElement('canvas');
        c.width = 600; c.height = 1000;
        var ctx = c.getContext('2d');
        // æ¸å˜èƒŒæ™¯
        var grad = ctx.createLinearGradient(0, 0, 600, 1000);
        var colors = d.bg.match(/#[A-Fa-f0-9]{6}/g) || ['#8B0000','#FF4500','#FFD700'];
        colors.forEach(function(col, i) { grad.addColorStop(i/(colors.length-1), col); });
        ctx.fillStyle = grad; ctx.fillRect(0,0,600,1000);
        // è£…é¥°åœˆ
        ctx.fillStyle = 'rgba(255,255,255,0.05)';
        ctx.beginPath(); ctx.arc(300,350,180,0,Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(300,350,250,0,Math.PI*2); ctx.fill();
        // ä¸‡é©¬å¥”è…¾çº¿æ¡
        ctx.strokeStyle = 'rgba(255,255,255,0.3)';
        ctx.lineWidth = 3; ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(60,750); ctx.quadraticCurveTo(90,720,110,710); ctx.quadraticCurveTo(130,700,138,685); ctx.lineTo(145,668); ctx.quadraticCurveTo(152,655,158,660); ctx.quadraticCurveTo(155,645,160,638); ctx.lineTo(170,630); ctx.quadraticCurveTo(174,638,170,648);
        ctx.moveTo(170,648); ctx.quadraticCurveTo(178,644,186,650); ctx.lineTo(200,660); ctx.quadraticCurveTo(218,672,228,692); ctx.lineTo(248,720);
        ctx.moveTo(350,740); ctx.quadraticCurveTo(375,710,392,702); ctx.quadraticCurveTo(408,694,416,678); ctx.lineTo(424,660); ctx.quadraticCurveTo(432,646,438,650); ctx.quadraticCurveTo(436,636,440,630); ctx.lineTo(450,624); ctx.quadraticCurveTo(454,632,450,642);
        ctx.moveTo(450,642); ctx.quadraticCurveTo(458,638,466,644); ctx.lineTo(480,654); ctx.quadraticCurveTo(496,664,504,682); ctx.lineTo(520,710);
        ctx.stroke();
        // æ–‡å­—å†…å®¹
        ctx.textAlign = 'center';
        ctx.fillStyle = '#fff';
        ctx.font = '80px serif'; ctx.fillText(d.emoji, 300, 200);
        ctx.font = '14px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.6)';
        ctx.fillText('ä¸™åˆé©¬å¹´', 300, 250);
        ctx.font = 'bold 48px serif'; ctx.fillStyle = '#fff';
        ctx.fillText(d.name, 300, 320);
        ctx.font = '20px sans-serif'; ctx.fillStyle = d.accent;
        ctx.fillText(d.folk, 300, 360);
        // ä¸ªæ€§åŒ–ç¥ç¦ç‹¬ç«‹è¡Œ
        var nextY = 430;
        if (name) {
            ctx.font = '18px sans-serif'; ctx.fillStyle = d.accent;
            ctx.fillText('ğŸ‹ ' + name + 'ç¥ç¦æ‚¨', 300, nextY);
            nextY += 40;
        }
        // ç¥ç¦è¯­
        ctx.font = 'bold 26px sans-serif'; ctx.fillStyle = '#fff';
        wrapText(ctx, d.greeting, 300, nextY, 480, 36);
        // æ°´æ™ºæ…§
        ctx.font = '16px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.8)';
        wrapText(ctx, 'ğŸ’§ ' + d.water, 300, nextY + 80, 460, 26);
        // åº•éƒ¨å“ç‰Œ
        ctx.fillStyle = 'rgba(255,255,255,0.3)';
        ctx.fillRect(100, 780, 400, 1);
        ctx.font = '18px sans-serif'; ctx.fillStyle = d.accent;
        ctx.fillText('ä¸Šå–„è‹¥æ°´ Â· åˆ†ç§’å¿…äº‰', 300, 820);
        ctx.font = '14px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.fillText('æ°´è‹¥å–„ Â· å–æ°´äº†å— Â· ä¸Šå–„è‹¥æ°´', 300, 855);
        ctx.font = '12px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.3)';
        ctx.fillText(location.href.split('?')[0], 300, 890);
        // æ‰«ç æç¤º
        ctx.fillStyle = 'rgba(255,255,255,0.08)';
        roundRect(ctx, 225, 910, 150, 50, 10); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.font = '11px sans-serif';
        ctx.fillText('æ‰«ç ä½“éªŒ Â· æ™ºå›è¯·ä½ å–æ°´', 300, 942);
        // ä¿å­˜ä¸‹è½½
        var link = document.createElement('a');
        link.download = d.name + '_é©¬å¹´ç¥ç¦_æ™ºå›è¯·ä½ å–æ°´.png';
        link.href = c.toDataURL('image/png');
        link.click();
        toast('ğŸ–¼ï¸ ' + d.name + ' æµ·æŠ¥å·²ä¿å­˜ï¼');
    }
    function wrapText(ctx, text, x, y, maxW, lineH) {
        var line = ''; var chars = text.split('');
        for (var i = 0; i < chars.length; i++) {
            var test = line + chars[i];
            if (ctx.measureText(test).width > maxW && i > 0) {
                ctx.fillText(line, x, y); y += lineH; line = chars[i];
            } else { line = test; }
        }
        ctx.fillText(line, x, y);
    }
    function roundRect(ctx, x, y, w, h, r) {
        ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y);
        ctx.quadraticCurveTo(x+w,y,x+w,y+r); ctx.lineTo(x+w,y+h-r);
        ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h); ctx.lineTo(x+r,y+h);
        ctx.quadraticCurveTo(x,y+h,x,y+h-r); ctx.lineTo(x,y+r);
        ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath();
    }

    // åˆå§‹åŒ–ç¥ç¦é¦†
    setTimeout(renderFestGrid, 100);


    // å¥½å‹
    function addFriend() { const name = document.getElementById('fName').value.trim(); if (!name) return toast('!'); friends.push({ id: 'F' + Date.now(), name, phone: document.getElementById('fPhone').value.trim(), relation: document.getElementById('fRelation').value }); document.getElementById('fName').value = ''; saveData(); closeModal(); renderFriends(); toast('âœ…'); }
    function renderFriends() { document.getElementById('friendList').innerHTML = friends.length ? friends.map(f => `<div class="item"><div class="icon">ğŸ‘¤</div><div class="info"><div class="name">${f.name}</div><div class="desc">${f.relation}</div></div><button onclick="friends=friends.filter(x=>x.id!=='${f.id}');saveData();renderFriends();" style="background:none;border:none;color:rgba(255,255,255,0.3);font-size:14px;cursor:pointer;">Ã—</button></div>`).join('') : '<div style="text-align:center;padding:15px;color:rgba(255,255,255,0.4);font-size:10px;">-</div>'; }

    // ä¸»é¢˜
    function setTheme(name) { currentTheme = name; applyTheme(name); document.querySelectorAll('.theme-item').forEach(t => t.classList.remove('active')); document.querySelector(`.theme-item.${name}`)?.classList.add('active'); saveData(); toast('ğŸ¨'); }
    function applyTheme(name) { const t = THEMES[name] || THEMES.classic; document.documentElement.style.setProperty('--primary', t.primary); document.body.style.background = `linear-gradient(135deg, ${t.bg1}, ${t.bg2})`; document.getElementById('clockFace').style.borderColor = t.primary; }

    function toggleVoice() { toggleVoiceRecognition(); }

    function openPanel(id) { closeAllPanels(); document.getElementById(id).classList.add('open'); document.getElementById('overlay').classList.add('show'); if(!siteStats.panels)siteStats.panels={}; siteStats.panels[id]=(siteStats.panels[id]||0)+1; trackEvent('panel','open',id); if (id === 'carePanel') updateContactsUI(); if (id === 'memberPanel') { showMyActivity(); updateMembershipUI(); } if (id === 'festivalPanel') renderFestGrid(); }
    function closeAllPanels() { document.querySelectorAll('.panel').forEach(p => p.classList.remove('open')); document.getElementById('overlay').classList.remove('show'); }
    function openModal(id) { document.getElementById(id).classList.add('show'); }
    function closeModal() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('show')); }

    function doLogin() { 
        const p = document.getElementById('phoneInput').value.trim(), n = document.getElementById('nameInput').value.trim(), w = document.getElementById('pwdInput').value; 
        if (!p || p.length !== 11) return toast('è¯·è¾“å…¥11ä½æ‰‹æœºå·'); 
        if (!w || w.length < 6) return toast('å¯†ç è‡³å°‘6ä½'); 
        const users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}'); 
        if (users[p]) { 
            if (users[p].pwd !== w) return toast('âŒ å¯†ç é”™è¯¯'); 
            user = users[p]; 
        } else { 
            if (!n) return toast('æ–°ç”¨æˆ·è¯·å¡«å†™æ˜µç§°'); 
            user = { id: 'U' + Date.now().toString(36).toUpperCase(), phone: p, name: n, pwd: w, level: 'free' }; 
            users[p] = user; 
            localStorage.setItem('heshuileUsers', JSON.stringify(users));
            // æ–°ç”¨æˆ·è‡ªåŠ¨å¼€å§‹VIPè¯•ç”¨
            startVipTrial();
        } 
        
        // â•â•â• è‡ªåŠ¨æ¢å¤ä¼šå‘˜çŠ¶æ€ â•â•â•
        // æ£€æŸ¥1ï¼šæœ¬åœ°æ˜¯å¦æœ‰è¯¥ç”¨æˆ·çš„å·²å®¡æ‰¹è®¢å•ï¼ˆåŒè®¾å¤‡ç®¡ç†å‘˜+ç”¨æˆ·åœºæ™¯ï¼‰
        var orders = JSON.parse(localStorage.getItem('heshuilePendingOrders') || '[]');
        var approvedOrder = null;
        for (var i = orders.length - 1; i >= 0; i--) {
            if (orders[i].userId === p && orders[i].status === 'approved') {
                approvedOrder = orders[i];
                break;
            }
        }
        if (approvedOrder && (!user.level || user.level === 'free')) {
            var levelMap = { monthly: 'monthly', quarterly: 'quarterly', yearly: 'vip', enterprise: 'enterprise' };
            user.level = levelMap[approvedOrder.plan] || 'vip';
            user.paidAt = approvedOrder.approveTime;
            user.paidPlan = approvedOrder.plan;
            if (approvedOrder.activationCode) user.activationCode = approvedOrder.activationCode;
            users[p] = user;
            localStorage.setItem('heshuileUsers', JSON.stringify(users));
        }
        
        // æ£€æŸ¥2ï¼šå¦‚æœä¹‹å‰ç”¨è¿‡æ¿€æ´»ç ï¼Œç¡®ä¿ level ä¸è¢«é‡ç½®
        if (user.activationCode && (!user.level || user.level === 'free')) {
            var plans = ['monthly', 'quarterly', 'yearly', 'enterprise'];
            var levelMap2 = { monthly: 'monthly', quarterly: 'quarterly', yearly: 'vip', enterprise: 'enterprise' };
            for (var j = 0; j < plans.length; j++) {
                if (user.activationCode === generateActivationCode(p, plans[j])) {
                    user.level = levelMap2[plans[j]];
                    users[p] = user;
                    localStorage.setItem('heshuileUsers', JSON.stringify(users));
                    break;
                }
            }
        }
        
        // æ£€æŸ¥3ï¼šæ˜¯å¦æœ‰ä»æ¿€æ´»é“¾æ¥ä¿å­˜çš„å¾…æ¿€æ´»ç 
        var pendingCode = localStorage.getItem('heshuilePendingActivation');
        if (pendingCode) {
            localStorage.removeItem('heshuilePendingActivation');
            setTimeout(function() { autoActivateByLink(pendingCode); }, 600);
        }
        
        localStorage.setItem('currentUser', JSON.stringify(user)); 
        updateUI(); 
        updateMembershipUI();
        toast('âœ… æ¬¢è¿ ' + user.name + (user.level && user.level !== 'free' ? ' ğŸ‘‘' : '')); 
        logActivity('login', user.name + ' ç™»å½•'); 
        var fn=document.getElementById('festName'); if(fn&&user.name)fn.value=user.name; 
    }
    function logout() { user = null; localStorage.removeItem('currentUser'); updateUI(); closeAllPanels(); toast('ğŸ‘‹'); }
    function upgrade() { if (!user) return; user.level = 'vip'; const users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}'); users[user.phone] = user; localStorage.setItem('heshuileUsers', JSON.stringify(users)); localStorage.setItem('currentUser', JSON.stringify(user)); updateUI(); toast('ğŸ‘‘'); }
    // å®‰å…¨å¤åˆ¶ï¼ˆå…¼å®¹éHTTPSç¯å¢ƒï¼‰
    function safeCopy(text, successMsg) {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => toast(successMsg)).catch(() => fallbackCopy(text, successMsg));
        } else { fallbackCopy(text, successMsg); }
    }
    function fallbackCopy(text, msg) {
        const ta = document.createElement('textarea');
        ta.value = text; ta.style.cssText = 'position:fixed;left:-9999px;';
        document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); toast(msg); } catch(e) { toast('é•¿æŒ‰ä¸‹æ–¹æ–‡å­—å¤åˆ¶ï¼š'); prompt('å¤åˆ¶æ­¤å†…å®¹ï¼š', text); }
        document.body.removeChild(ta);
    }
    function safeShare(title, text, url, fallbackMsg) {
        if (navigator.share) {
            navigator.share({ title, text, url }).catch(() => safeCopy(text + '\n' + url, fallbackMsg));
        } else { safeCopy(text + '\nğŸ‘‰ ' + url, fallbackMsg); }
    }

    function copyInviteLink() { const link = user ? getShareUrl('invite=' + user.id) : getShareUrl(''); safeShare('å–æ°´äº†å—ï¼Ÿ', 'ğŸ´ é©¬å¹´å¿«ä¹ï¼é€ä½ ä¸€ä¸ªæ™ºèƒ½å–æ°´æé†’ï¼Œæ¯å¤©å…«æ¯æ°´ï¼Œå¥åº·ä¸€æ•´å¹´ï½', link, 'ğŸ“‹ é“¾æ¥å·²å¤åˆ¶ï¼Œå¿«å»åˆ†äº«å§ï¼'); }
    function shareNewYear() { trackEvent('share','new_year'); const msgs = ['ğŸ´ğŸ§§ é©¬å¹´å¤§å‰ï¼å–æ°´äº†å—ï¼Ÿé€ä½ ä¸€ä¸ªAIæ™ºèƒ½å–æ°´æé†’ï¼Œè¯­éŸ³é—®å®ƒä»»ä½•å…³äºæ°´å’Œå¥åº·çš„é—®é¢˜ï¼','ğŸ§§ğŸ’§ æ–°æ˜¥å¿«ä¹ï¼è¿™ä¸ªå°å·¥å…·èƒ½æé†’ä½ æ¯å¤©å–å¤Ÿå…«æ¯æ°´ï¼Œè¿˜æœ‰æ°´å­¦çŸ¥è¯†ã€æ»´ç­”æ—¶é’Ÿï¼Œè¶…å¥½ç”¨ï¼','ğŸ´âœ¨ æ–°å¹´æ–°ä¹ æƒ¯ï¼è¯•è¯•è¿™ä¸ªå–æ°´æé†’APPï¼Œæ¯å¤©å…«æ¯æ°´ï¼Œå¥åº·ä¸€æ•´å¹´ï½ä¸Šå–„è‹¥æ°´ï¼Œåˆ†ç§’å¿…äº‰ï¼']; const msg = msgs[Math.floor(Math.random()*msgs.length)]; const link = user ? getShareUrl('invite='+user.id) : getShareUrl(''); safeShare('å–æ°´äº†å— | æ–°å¹´å¿«ä¹', msg, link, 'ğŸ§§ æ–°å¹´ç¥ç¦å·²å¤åˆ¶ï¼'); }
    function updateUI() { const btn = document.getElementById('userBtn'); const qr = document.getElementById('promoQR'); qr.innerHTML = ''; const baseUrl = location.href.split('?')[0]; if (user) { btn.textContent = user.level === 'vip' ? 'ğŸ‘‘' : 'ğŸ‘¤'; document.getElementById('loginBox').style.display = 'none'; document.getElementById('memberBox').style.display = 'block'; document.getElementById('avatar').textContent = user.name.charAt(0); document.getElementById('userName').textContent = user.name; document.getElementById('userLevel').textContent = user.level === 'vip' ? 'ğŸ‘‘ VIP' : 'Free'; document.getElementById('inviteCode').textContent = user.id; if (typeof QRCode !== 'undefined') QRCode.toCanvas(baseUrl + '?invite=' + user.id, { width: 100, margin: 2 }, (e, c) => { if (!e) qr.appendChild(c); }); } else { btn.textContent = I18N[currentLang].login; document.getElementById('loginBox').style.display = 'block'; document.getElementById('memberBox').style.display = 'none'; document.getElementById('inviteCode').textContent = 'ç™»å½•åè·å–'; if (typeof QRCode !== 'undefined') QRCode.toCanvas(baseUrl, { width: 100, margin: 2 }, (e, c) => { if (!e) qr.appendChild(c); }); } }

    function toast(m) { const t = document.createElement('div'); t.className = 'toast'; t.textContent = m; document.body.appendChild(t); setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 2000); }

    function saveData() { localStorage.setItem('heshuileData', JSON.stringify({ tickOn, currentTheme, currentSound, volume, friends, ads, reminds, checkinData, centerData, contactsAuthorized, contacts, waterData, waterLearning })); }
    function loadData() { 
        try { 
            const d = JSON.parse(localStorage.getItem('heshuileData')); 
            if (d) { 
                tickOn = d.tickOn ?? true; currentTheme = d.currentTheme || 'classic'; 
                currentSound = d.currentSound || 'classic'; volume = d.volume ?? 50; 
                friends = d.friends || []; ads = d.ads || ads; reminds = d.reminds || []; 
                checkinData = d.checkinData || checkinData; centerData = d.centerData || centerData; 
                contactsAuthorized = d.contactsAuthorized || false; contacts = d.contacts || []; 
                waterData = d.waterData || waterData; waterLearning = d.waterLearning || waterLearning; 
            } 
            const u = localStorage.getItem('currentUser'); 
            if (u) user = JSON.parse(u); 
            
            // â•â•â• é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ¢å¤ä¼šå‘˜çŠ¶æ€ â•â•â•
            if (user && (!user.level || user.level === 'free')) {
                var orders = JSON.parse(localStorage.getItem('heshuilePendingOrders') || '[]');
                for (var i = orders.length - 1; i >= 0; i--) {
                    if (orders[i].userId === user.phone && orders[i].status === 'approved') {
                        var levelMap = { monthly: 'monthly', quarterly: 'quarterly', yearly: 'vip', enterprise: 'enterprise' };
                        user.level = levelMap[orders[i].plan] || 'vip';
                        user.paidAt = orders[i].approveTime;
                        user.paidPlan = orders[i].plan;
                        if (orders[i].activationCode) user.activationCode = orders[i].activationCode;
                        // åŒæ­¥æ›´æ–°æ‰€æœ‰å­˜å‚¨
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        var users = JSON.parse(localStorage.getItem('heshuileUsers') || '{}');
                        if (users[user.phone]) { 
                            users[user.phone].level = user.level; 
                            users[user.phone].paidAt = user.paidAt;
                            users[user.phone].paidPlan = user.paidPlan;
                            localStorage.setItem('heshuileUsers', JSON.stringify(users)); 
                        }
                        break;
                    }
                }
            }
        } catch (e) {} 
    }
    </script>

    <!-- æ”¯ä»˜å¼¹çª— -->
    <div class="pay-modal-bg" id="payModal">
        <div class="pay-modal">
            <div style="text-align:right;"><button onclick="closePayModal()" style="background:none;border:none;color:white;font-size:22px;cursor:pointer;">Ã—</button></div>
            
            <div class="pay-header">
                <div class="pay-plan-name" id="payPlanName">å¹´åº¦VIP</div>
                <div class="pay-plan-price" id="payPlanPrice">Â¥199/å¹´</div>
                <div class="pay-plan-desc" id="payPlanDesc">æ— é™æé†’ Â· æ— å¹¿å‘Š Â· éŸ³é¢‘è¯¾ç¨‹ Â· å…¨éƒ¨å†…å®¹</div>
            </div>
            
            <!-- æ”¯ä»˜æ–¹å¼é€‰æ‹© -->
            <div class="pay-methods">
                <div style="font-size:12px;color:var(--gold);margin-bottom:8px;">é€‰æ‹©æ”¯ä»˜æ–¹å¼</div>
                
                <div class="pay-method-btn" onclick="selectPayMethod('wechat')">
                    <div class="pay-method-icon">ğŸ’š</div>
                    <div>
                        <div class="pay-method-name">å¾®ä¿¡æ”¯ä»˜</div>
                        <div class="pay-method-desc">æ‰«ç æˆ–é•¿æŒ‰è¯†åˆ«ä»˜æ¬¾</div>
                    </div>
                </div>
                
                <div class="pay-method-btn" onclick="selectPayMethod('alipay')">
                    <div class="pay-method-icon">ğŸ”µ</div>
                    <div>
                        <div class="pay-method-name">æ”¯ä»˜å®</div>
                        <div class="pay-method-desc">æ‰«ç ä»˜æ¬¾</div>
                    </div>
                </div>
                
                <div class="pay-method-btn" onclick="selectPayMethod('transfer')">
                    <div class="pay-method-icon">ğŸ¦</div>
                    <div>
                        <div class="pay-method-name">é“¶è¡Œè½¬è´¦ / çº¢åŒ…</div>
                        <div class="pay-method-desc">å¾®ä¿¡çº¢åŒ… Â· é“¶è¡Œè½¬è´¦ Â· å…¶ä»–æ–¹å¼</div>
                    </div>
                </div>
                
                <div class="pay-method-btn" onclick="selectPayMethod('contact')" style="border-color:rgba(6,255,165,0.3);">
                    <div class="pay-method-icon">ğŸ“±</div>
                    <div>
                        <div class="pay-method-name">ç›´æ¥è”ç³»ä»˜æ¬¾</div>
                        <div class="pay-method-desc">åŠ å¾®ä¿¡/æ‰“ç”µè¯ Â· å½“é¢æˆ–è¿œç¨‹ä»˜æ¬¾</div>
                    </div>
                </div>
            </div>
            
            <!-- äºŒç»´ç åŒºåŸŸ -->
            <div class="pay-qr-area" id="payQrArea">
                <div class="pay-qr-placeholder" id="payQrImage">
                    <div style="text-align:center;">
                        <div style="font-size:40px;margin-bottom:8px;" id="payQrEmoji">ğŸ’š</div>
                        <div id="payQrText" style="font-size:12px;">è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼</div>
                    </div>
                </div>
                <div class="pay-qr-tip">
                    <div id="payQrInstruction" style="line-height:1.8;">
                        é€‰æ‹©æ”¯ä»˜æ–¹å¼åï¼Œå°†æ˜¾ç¤ºæ“ä½œæ­¥éª¤
                    </div>
                </div>
            </div>
            
            <!-- è½¬è´¦ä¿¡æ¯ -->
            <div class="pay-confirm-area" id="payTransferArea">
                <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:15px;text-align:left;font-size:12px;line-height:2;">
                    <div style="color:var(--gold);font-weight:bold;margin-bottom:8px;">ğŸ’° è½¬è´¦æ–¹å¼ï¼ˆä»»é€‰ä¸€ç§ï¼‰</div>
                    <div>å¾®ä¿¡çº¢åŒ…ï¼šæœç´¢æ‰‹æœºå· <strong style="color:var(--primary);" id="payContactPhone">-</strong></div>
                    <div>è½¬è´¦å¤‡æ³¨ï¼š<strong style="color:var(--gold);" id="payTransferNote">å–æ°´VIP-æ‚¨çš„æ˜µç§°</strong></div>
                    <div style="margin-top:8px;color:rgba(255,255,255,0.4);font-size:10px;">è½¬è´¦åè¯·ç‚¹å‡»ä¸‹æ–¹ã€Œæˆ‘å·²ä»˜æ¬¾ã€æŒ‰é’®</div>
                </div>
            </div>
            
            <!-- å·²ä»˜æ¬¾ç¡®è®¤ -->
            <div style="margin-top:15px;">
                <div id="payOrderId" style="text-align:center;font-size:10px;color:rgba(255,255,255,0.3);margin-bottom:8px;">è®¢å•å·ï¼š--</div>
                <button class="btn btn-gold" style="width:100%;font-size:14px;padding:12px;" onclick="confirmPayment()">
                    âœ… æˆ‘å·²ä»˜æ¬¾ï¼Œç”³è¯·å¼€é€š
                </button>
                <div style="text-align:center;margin-top:8px;">
                    <div style="font-size:10px;color:rgba(255,255,255,0.5);">ä»˜æ¬¾åç®¡ç†å‘˜ä¼šå‘é€ <strong style="color:var(--gold);">æ¿€æ´»ç </strong> ç»™æ‚¨</div>
                    <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:4px;">æ”¶åˆ°æ¿€æ´»ç ååœ¨"æˆ‘çš„"é¡µé¢è¾“å…¥å³å¯å‡çº§</div>
                    <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:4px;">è”ç³»å®¢æœï¼š<span id="payContactInfo">ç®¡ç†å‘˜</span></div>
                </div>
            </div>
            
        </div>
    </div>

</body>
</html>
